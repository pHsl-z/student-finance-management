<!DOCTYPE html>
<!--
/**
 * 托管班管理系统 v3.5.0
 * 
 * 这是一个完整的托管班管理Web应用，采用React 18 + Supabase架构
 * 所有代码集成在单个HTML文件中，便于部署和维护
 * 
 * 【快速开始】
 * 1. 配置Supabase连接信息（见第107-109行）
 * 2. 在浏览器中直接打开此文件
 * 3. 使用测试账号登录：13800000001/admin123
 * 
 * 【核心功能】
 * - 仪表盘：数据概览、学校名称可自定义
 * - 学生管理：学生信息的增删改查、智能数据同步
 * - 收支管理：收入记录管理
 * - 财务管理：全面的财务管理
 * - 考勤管理：出勤记录、自动出勤
 * - 成绩管理：成绩录入和查询
 * - 作业管理：作业发布和批改
 * - 学习计划：计划制定和跟踪
 * - 通知管理：消息通知功能
 * - 数据导出：Excel/PDF导出
 * - 工具箱：系统工具集合
 * 
 * 【技术栈】
 * - 前端框架：React 18 (CDN)
 * - 样式系统：Tailwind CSS + Glassmorphism
 * - 后端服务：Supabase (PostgreSQL + Auth + Real-time)
 * - 图表库：Chart.js
 * - 表格导出：SheetJS (xlsx)
 * - 代码编辑器：CodeMirror
 * 
 * 【重要配置】
 * Supabase配置：第107-109行
 * 学校名称：第525行（或通过界面编辑）
 * 主题颜色：第24-50行
 * 节假日列表：第588-596行、第1562-1570行
 * 默认签到时间：第1585行
 * 
 * 【文档】
 * - README.md - 本地部署指南
 * - PROJECT_STRUCTURE.md - 项目结构说明
 * - CONFIGURATION_GUIDE.md - 配置文件说明
 * - FINAL_TEST_RESULTS_AND_FIX_GUIDE.md - 测试结果与修复指南
 * 
 * 【系统要求】
 * - 现代浏览器（Chrome 90+, Firefox 88+, Safari 14+, Edge 90+）
 * - 互联网连接（用于加载CDN资源和连接Supabase）
 * - Supabase账户和项目
 * 
 * 【数据库表】
 * 系统需要以下表：
 * - students - 学生信息
 * - transactions - 收支记录（重要：需要notes和payment_method列）
 * - attendance_records - 考勤记录
 * - payment_records - 缴费记录
 * - notifications - 通知
 * - learning_plans - 学习计划
 * 
 * 【安全提示】
 * - 部署前修改默认密码
 * - 不要将Supabase密钥提交到公开仓库
 * - 生产环境使用HTTPS
 * - 启用RLS（行级安全）策略
 * 
 * 作者：MiniMax Agent
 * 最后更新：2025-11-09
 * 版本：v3.5.0
 * 许可：仅供学习和内部使用
 */
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>托管班管理系统</title>
    
    <!-- React 18 - 前端框架 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone - JSX转译 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS - 样式框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS - 后端服务 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    
    <!-- Chart.js - 图表库 -->
    <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- XLSX - Excel导出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- CodeMirror 编辑器 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    
    <!-- Google Fonts - Inter字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS 配置 -->
    <script>
        // Tailwind CSS 主题配置
        // 可以在此处修改主题颜色、字体等
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#EBF5FF',
                            500: '#007AFF',
                            700: '#0056B3',
                        },
                        neutral: {
                            0: '#F8F9FA',
                            100: 'rgba(255, 255, 255, 0.6)',
                            400: '#A1A1AA',
                            700: '#3F3F46',
                            900: '#18181B',
                        },
                        success: '#28A745',
                        warning: '#FFC107',
                        error: '#DC3545',
                    },
                    backdropBlur: {
                        '20': '20px',
                        '16': '16px',
                    }
                }
            }
        }
    </script>
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        .card-hover {
            transition: transform 250ms cubic-bezier(0.25, 0.1, 0.25, 1), 
                       box-shadow 250ms cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(24, 24, 27, 0.12);
        }
        
        .sidebar-transition {
            transition: transform 300ms ease-in-out;
        }
        
        @media (max-width: 768px) {
            .sidebar-mobile {
                transform: translateX(-100%);
            }
            
            .sidebar-mobile.open {
                transform: translateX(0);
            }
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        /* 苹果风格切换开关增强样式 */
        .apple-switch {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        
        .apple-switch-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .apple-switch-button:hover {
            transform: scale(1.05) translateY(-1px);
        }
        
        .apple-switch-button.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4),
                        0 0 0 1px rgba(16, 185, 129, 0.2);
        }
        
        .apple-switch-button.active[data-days="0"] {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4),
                        0 0 0 1px rgba(239, 68, 68, 0.2);
        }
        
        .apple-switch-button.active[data-days="3"] {
            background: linear-gradient(135deg, #34d399, #10b981);
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4),
                        0 0 0 1px rgba(52, 211, 153, 0.2);
        }
        
        .apple-switch-button.active[data-days="7"] {
            background: linear-gradient(135deg, #6ee7b7, #34d399);
            box-shadow: 0 4px 15px rgba(110, 231, 183, 0.4),
                        0 0 0 1px rgba(110, 231, 183, 0.2);
        }
        
        .apple-switch-button.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .apple-switch-button:not(.active):hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* 简笔画风格图标 */
        .sketch-icon {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 60px;
        }
        
        .sketch-bell {
            width: 100%;
            height: 100%;
            stroke: #9ca3af;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .sketch-check {
            width: 100%;
            height: 100%;
            stroke: #10b981;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.2));
        }
        
        .sketch-check-circle {
            stroke: #10b981;
            stroke-width: 2;
            fill: rgba(16, 185, 129, 0.1);
        }
        
        .sketch-success {
            width: 100%;
            height: 100%;
            stroke: #10b981;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.2));
        }
    </style>
</head>
<body class="font-inter bg-neutral-0 text-neutral-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        /**
         * Supabase配置
         * 
         * 【重要】请将以下配置替换为您自己的Supabase项目信息
         * 
         * 获取方式：
         * 1. 登录 https://supabase.com/dashboard
         * 2. 选择您的项目
         * 3. 进入 Settings → API
         * 4. 复制 Project URL 和 anon public key
         * 
         * 注意：
         * - anon key 是公开密钥，可以在前端使用
         * - service_role key 是私密密钥，不能在前端使用
         * - 不要将包含真实密钥的文件提交到公开仓库
         */
        const supabaseUrl = 'https://grotxbswdnchodtvefyx.supabase.co';  // 替换为您的Project URL
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdyb3R4YnN3ZG5jaG9kdHZlZnl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjY1MzYsImV4cCI6MjA3Nzk0MjUzNn0.6RlEzM6besK6fpwJjsQs2d5NLvIWWV5XmZQnr3P5zic';  // 替换为您的anon public key
        
        // 初始化Supabase客户端
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        /**
         * 数据库结构检查和更新函数
         * 用于确保数据库表包含所有必需的列
         */
        const checkAndUpdateDatabaseSchema = async () => {
            try {
                console.log('开始检查数据库结构...');
                
                // 检查 students 表是否包含 student_type 列
                const { data: tableData, error: tableError } = await supabase
                    .from('students')
                    .select('*')
                    .limit(1);
                
                if (tableError) {
                    console.error('检查数据库表失败:', tableError);
                    return false;
                }
                
                // 如果表存在但没有数据，我们仍然需要检查列结构
                // 尝试查询 student_type 列
                const { data: typeData, error: typeError } = await supabase
                    .from('students')
                    .select('student_type')
                    .limit(1);
                
                if (typeError) {
                    console.log('student_type 列不存在，需要添加...');
                    
                    // 由于 Supabase 客户端不能直接执行 ALTER TABLE，
                    // 我们需要通过 SQL 控制台或 Supabase 仪表板添加列
                    console.log('请手动在 Supabase 控制台中执行以下 SQL:');
                    console.log('ALTER TABLE students ADD COLUMN student_type VARCHAR(50) DEFAULT \'月托\';');
                    
                    // 显示用户友好的消息
                    alert('数据库需要更新：\n\n请在 Supabase 控制台中执行以下 SQL 命令来添加托管方式字段：\n\nALTER TABLE students ADD COLUMN student_type VARCHAR(50) DEFAULT \'月托\';\n\n执行后刷新页面即可正常显示托管方式。');
                    
                    return false;
                } else {
                    console.log('数据库结构检查完成，student_type 列已存在');
                    return true;
                }
            } catch (error) {
                console.error('数据库结构检查失败:', error);
                return false;
            }
        };

        /**
         * ============================================
         * 图标组件库
         * ============================================
         * 所有UI图标都使用SVG实现
         * 统一风格：Outline风格，统一尺寸
         */
        const DashboardIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z" />
            </svg>
        );

        const StudentsIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
            </svg>
        );

        const FinanceIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
            </svg>
        );

        const IncomeExpenseIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
        );

        const AttendanceIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
        );

        const MenuIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        );

        const CloseIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const PlusIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
        );

        const EditIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
        );

        const DeleteIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const HomeworkIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const CheckIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
        );

        const TemplateIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
        );

        const LogoutIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        );

        const UserIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        );

        const GradesIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        );

        const UsersIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
        );

        const NotificationIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        );

        const ExportIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const ToolboxIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 6a3 3 0 013-3h12a3 3 0 013 3v12a3 3 0 01-3 3H6a3 3 0 01-3-3V6z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6M12 9v6" />
            </svg>
        );

        const FileIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
        );

        const StudyPlanIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
        );

        const DownloadIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const UploadIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L9 8m4-4v12" />
            </svg>
        );

        const InfoIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const ClockIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const CalendarIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const ChartIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        );

        const AlertIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );

        const ImageIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const SettingsIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const DatabaseIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
            </svg>
        );

        /**
         * ============================================
         * 全局工具函数 - 工作日计算相关
         * ============================================
         * 这些函数被多个组件共享使用，解决 getExtendedWorkday 未定义错误
         */
        
        // 判断是否为周末
        const isWeekend = (dateStr) => {
            const date = new Date(dateStr);
            const day = date.getDay();
            return day === 0 || day === 6; // 0=周日, 6=周六
        };

        // 判断是否为法定节假日（简化版，可根据实际需求扩展）
        const isHoliday = (dateStr) => {
            // 这里可以添加节假日判断逻辑
            // 示例：春节、国庆等
            const holidays = [
                '2025-01-01', // 元旦
                '2025-02-10', '2025-02-11', '2025-02-12', // 春节示例
                '2025-04-05', // 清明
                '2025-05-01', '2025-05-02', '2025-05-03', // 劳动节
                '2025-10-01', '2025-10-02', '2025-10-03', // 国庆
            ];
            return holidays.includes(dateStr);
        };

        // 判断是否为工作日（非周末且非节假日）
        const isWorkday = (dateStr) => {
            return !isWeekend(dateStr) && !isHoliday(dateStr);
        };

        // 计算下一个工作日（跳过周末和节假日）
        const getNextWorkday = (dateStr, daysToAdd = 1) => {
            let currentDate = new Date(dateStr);
            let daysAdded = 0;
            
            while (daysAdded < daysToAdd) {
                currentDate.setDate(currentDate.getDate() + 1);
                const dateStr = currentDate.toISOString().split('T')[0];
                if (isWorkday(dateStr)) {
                    daysAdded++;
                }
            }
            
            return currentDate.toISOString().split('T')[0];
        };
        
        // 计算延期后的工作日日期（考虑延期天数）- 修复 getExtendedWorkday 未定义错误
        const getExtendedWorkday = (baseDateStr, extensionDays) => {
            let currentDate = new Date(baseDateStr);
            let daysAdded = 0;
            
            // 逐天增加，只计算工作日
            while (daysAdded < extensionDays) {
                currentDate.setDate(currentDate.getDate() + 1);
                const dateStr = currentDate.toISOString().split('T')[0];
                if (isWorkday(dateStr)) {
                    daysAdded++;
                }
            }
            
            return currentDate.toISOString().split('T')[0];
        };
        
        // 计算延期后的日期（不考虑工作日，适用于月托和学期）
        const getExtendedDate = (baseDateStr, extensionDays) => {
            const currentDate = new Date(baseDateStr);
            currentDate.setDate(currentDate.getDate() + extensionDays);
            return currentDate.toISOString().split('T')[0];
        };
        
        // 根据学生类型计算延期日期
        const calculateExtensionDate = (baseDateStr, extensionDays, studentType) => {
            if (studentType === '日托') {
                // 日托考虑工作日
                return getExtendedWorkday(baseDateStr, extensionDays);
            } else {
                // 月托和学期不考虑工作日
                return getExtendedDate(baseDateStr, extensionDays);
            }
        };

        // 手机号码转换为email格式的工具函数
        const phoneToEmail = (phone) => {
            return `${phone}@phone.local`;
        };

        // 验证手机号码格式（中国大陆11位手机号）
        const isValidPhone = (phone) => {
            return /^1[3-9]\d{9}$/.test(phone);
        };

        // 计算下次续费日期（从指定日期开始，加一个月）
        const calculateNextRenewalDate = (fromDate) => {
            const date = new Date(fromDate);
            const currentDay = date.getDate();
            const currentMonth = date.getMonth();
            const currentYear = date.getFullYear();
            
            // 计算下个月
            let nextMonth = currentMonth + 1;
            let nextYear = currentYear;
            
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear += 1;
            }
            
            // 获取下月的天数
            const daysInNextMonth = new Date(nextYear, nextMonth + 1, 0).getDate();
            
            // 处理特殊情况：如果当前日期是31号，而下月不足31天，则使用下月的最后一天
            let nextMonthDay;
            if (currentDay === 31 && daysInNextMonth < 31) {
                nextMonthDay = daysInNextMonth; // 使用下月的最后一天
            } else {
                nextMonthDay = Math.min(currentDay, daysInNextMonth); // 使用较小的值
            }
            
            // 设置下月缴费日期
            const nextDate = new Date(nextYear, nextMonth, nextMonthDay);
            return nextDate.toISOString().split('T')[0];
        };



        // 判断续费日期是否在提前提醒范围内
        const isRenewalDueSoon = (renewalDate, reminderDays) => {
            if (!renewalDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const renewal = new Date(renewalDate);
            renewal.setHours(0, 0, 0, 0);
            const diffTime = renewal - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // 特殊处理：当reminderDays为0时，返回所有已过期的记录
            if (reminderDays === 0) {
                return diffDays < 0;
            }
            
            // 正常情况：返回指定天数内到期的记录
            return diffDays >= 0 && diffDays <= reminderDays;
        };

        // 格式化日期为YYYY-MM-DD
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };



        // 登录页面组件
        const LoginPage = ({ onLoginSuccess }) => {
            const [phone, setPhone] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');

                // 验证手机号码格式
                if (!isValidPhone(phone)) {
                    setError('请输入有效的11位手机号码');
                    return;
                }

                setLoading(true);

                try {
                    // 将手机号码转换为email格式进行认证
                    const email = phoneToEmail(phone);
                    
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password,
                    });

                    if (error) throw error;

                    if (data.user) {
                        // 获取用户角色 - 添加详细的错误处理和调试信息
                        try {
                            console.log('开始获取用户角色，用户ID:', data.user.id);
                            console.log('Supabase配置:', { 
                                url: supabaseUrl, 
                                hasAnonKey: !!supabaseAnonKey,
                                userId: data.user.id 
                            });
                            
                            const { data: profile, error: profileError } = await supabase
                                .from('user_profiles')
                                .select('role, full_name, phone')
                                .eq('id', data.user.id)
                                .maybeSingle();

                            if (profileError) {
                                console.error('获取用户角色失败:', profileError);
                                console.error('错误详情:', {
                                    message: profileError.message,
                                    code: profileError.code,
                                    details: profileError.details,
                                    hint: profileError.hint
                                });
                                
                                // 降级处理：使用默认角色
                                console.log('使用默认角色: teacher');
                                onLoginSuccess(data.user, 'teacher', '用户');
                            } else if (profile) {
                                console.log('成功获取用户角色:', profile.role);
                                onLoginSuccess(data.user, profile.role, profile.full_name);
                            } else {
                                console.log('用户配置文件不存在，使用默认角色');
                                onLoginSuccess(data.user, 'teacher', '用户');
                            }
                        } catch (fetchError) {
                            console.error('获取用户角色时发生网络错误:', fetchError);
                            console.error('错误类型:', fetchError.constructor.name);
                            console.error('错误消息:', fetchError.message);
                            
                            // 网络错误降级处理
                            if (fetchError.message.includes('Failed to fetch')) {
                                console.log('检测到网络连接问题，使用离线模式');
                                alert('网络连接失败，系统将以离线模式运行。部分功能可能受限。');
                            }
                            
                            // 使用默认角色继续
                            onLoginSuccess(data.user, 'teacher', '用户');
                        }
                    }
                } catch (error) {
                    setError(error.message || '登录失败，请检查手机号码和密码');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="glass-morphism rounded-2xl p-8 w-full max-w-md shadow-2xl">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-neutral-900 mb-2">托管班管理系统</h1>
                            <p className="text-neutral-600">请登录您的账户</p>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">手机号码</label>
                                <input
                                    type="tel"
                                    value={phone}
                                    onChange={(e) => setPhone(e.target.value.replace(/\D/g, ''))}
                                    className="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入11位手机号码"
                                    maxLength="11"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">密码</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入密码"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-primary-500 text-white py-3 px-4 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                            >
                                {loading ? '登录中...' : '登录'}
                            </button>
                        </form>

                        <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                            <p className="text-xs text-neutral-600 mb-2 font-semibold">测试账户：</p>
                            <p className="text-xs text-neutral-600">管理员：13800000001 / admin123</p>
                            <p className="text-xs text-neutral-600">教师：13800000002 / teacher123</p>
                        </div>
                    </div>
                </div>
            );
        };

        // 侧边栏组件
        const Sidebar = ({ activeTab, setActiveTab, isMobileOpen, setIsMobileOpen, userRole, userName, onLogout }) => {
            // 定义所有菜单项及其所需角色
            const allMenuItems = [
                { id: 'dashboard', label: '仪表盘', icon: <DashboardIcon />, roles: ['admin', 'teacher'] },
                { id: 'students', label: '学生管理', icon: <StudentsIcon />, roles: ['admin'] },
                { id: 'finance', label: '财务管理', icon: <FinanceIcon />, roles: ['admin'] },
                { id: 'attendance', label: '考勤管理', icon: <AttendanceIcon />, roles: ['admin', 'teacher'] },
                { id: 'grades', label: '成绩管理', icon: <GradesIcon />, roles: ['admin', 'teacher'] },
                { id: 'homework', label: '作业管理', icon: <HomeworkIcon />, roles: ['admin', 'teacher'] },
                { id: 'files', label: '文件管理', icon: <FileIcon />, roles: ['admin', 'teacher'] },
                { id: 'study-plans', label: '学习计划', icon: <StudyPlanIcon />, roles: ['admin', 'teacher'] },
                { id: 'notifications', label: '通知管理', icon: <NotificationIcon />, roles: ['admin'] },
                { id: 'export', label: '数据导出', icon: <ExportIcon />, roles: ['admin'] },
                { id: 'toolbox', label: '工具箱', icon: <ToolboxIcon />, roles: ['admin', 'teacher'] },
                { id: 'users', label: '用户管理', icon: <UsersIcon />, roles: ['admin'] },
                { id: 'database', label: '数据库管理', icon: <DatabaseIcon />, roles: ['admin'] },
                { id: 'settings', label: '设置', icon: <SettingsIcon />, roles: ['admin'] },
            ];

            // 根据用户角色过滤菜单项
            const menuItems = allMenuItems.filter(item => item.roles.includes(userRole));

            return (
                <>
                    {/* 移动端遮罩 */}
                    {isMobileOpen && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"
                            onClick={() => setIsMobileOpen(false)}
                        />
                    )}
                    
                    {/* 侧边栏 */}
                    <div className={`
                        fixed left-0 top-0 h-full w-60 glass-morphism border-r border-neutral-200 z-50
                        sidebar-transition md:relative md:translate-x-0 flex flex-col
                        ${isMobileOpen ? 'translate-x-0' : '-translate-x-full'}
                    `}>
                        <div className="p-6 flex-1 overflow-y-auto">
                            <div className="flex items-center justify-between mb-8">
                                <h1 className="text-xl font-bold text-neutral-900">托管班系统</h1>
                                <button 
                                    className="md:hidden p-2 hover:bg-neutral-100 rounded-lg"
                                    onClick={() => setIsMobileOpen(false)}
                                >
                                    <CloseIcon />
                                </button>
                            </div>
                            
                            <nav className="space-y-2">
                                {menuItems.map((item) => (
                                    <button
                                        key={item.id}
                                        onClick={() => {
                                            setActiveTab(item.id);
                                            setIsMobileOpen(false);
                                        }}
                                        className={`
                                            w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left
                                            transition-all duration-200 hover:bg-primary-50 hover:text-primary-500
                                            ${activeTab === item.id 
                                                ? 'bg-primary-500 text-white' 
                                                : 'text-neutral-700'
                                            }
                                        `}
                                    >
                                        {item.icon}
                                        <span className="font-medium">{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                        </div>

                        {/* 用户信息和登出按钮 */}
                        <div className="p-6 border-t border-neutral-200">
                            <div className="flex items-center space-x-3 mb-3">
                                <div className="p-2 bg-primary-100 rounded-lg text-primary-500">
                                    <UserIcon />
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-medium text-neutral-900 truncate">{userName || '用户'}</p>
                                    <p className="text-xs text-neutral-600">
                                        {userRole === 'admin' ? '管理员' : '教师'}
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={onLogout}
                                className="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors"
                            >
                                <LogoutIcon />
                                <span className="font-medium">退出登录</span>
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        // 仪表盘组件
        const Dashboard = () => {
            const { selectedMonth, getMonthRange } = React.useContext(GlobalMonthContext);
            const [students, setStudents] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [paymentRecords, setPaymentRecords] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [learningPlans, setLearningPlans] = useState([]);
            const [attendanceRecords, setAttendanceRecords] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [schoolName, setSchoolName] = useState(() => {
                const savedSettings = localStorage.getItem('systemSettings');
                if (savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);
                        return settings.institutionName || localStorage.getItem('schoolName') || '蓝月牙教育';
                    } catch (error) {
                        return localStorage.getItem('schoolName') || '蓝月牙教育';
                    }
                }
                return localStorage.getItem('schoolName') || '蓝月牙教育';
            });
            const [reminderDays, setReminderDays] = useState(7);
            const [parentNeedsNote, setParentNeedsNote] = useState('');
            const [showParentNeedsEdit, setShowParentNeedsEdit] = useState(false);
            
            // 导航函数：触发全局导航事件
            const navigateToPage = (page) => {
                const event = new CustomEvent('app-navigate', { detail: { page } });
                window.dispatchEvent(event);
            };

            // 从localStorage加载学校名称
            useEffect(() => {
                const savedName = localStorage.getItem('schoolName');
                if (savedName) {
                    setSchoolName(savedName);
                }
            }, []);

            useEffect(() => {
                fetchDashboardData();
            }, [selectedMonth]);

            useEffect(() => {
                try {
                    const note = localStorage.getItem('parentNeedsNote');
                    if (note) setParentNeedsNote(note);
                } catch (e) {}
            }, []);



            const fetchDashboardData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('用户未登录');
                        return;
                    }

                    const { start, end } = getMonthRange();
                    const today = new Date().toISOString().split('T')[0];
                    const futureDate = new Date();
                    futureDate.setDate(futureDate.getDate() + 30);
                    const future30Days = futureDate.toISOString().split('T')[0];

                    // 并行获取所有数据（包括今日考勤记录）
                    const [studentsRes, transactionsRes, paymentRes, notificationsRes, plansRes, attendanceRes] = await Promise.all([
                        supabase.from('students').select('*').eq('user_id', user.id).order('created_at', { ascending: false }),
                        supabase.from('transactions').select('*').eq('user_id', user.id).gte('transaction_date', start).lte('transaction_date', end).order('created_at', { ascending: false }).limit(5),
                        supabase.from('payment_records').select('*').eq('status', 'active').lte('next_due_date', future30Days).order('next_due_date', { ascending: true }),
                        supabase.from('notifications').select('*').eq('user_id', user.id).order('created_at', { ascending: false }).limit(5),
                        supabase.from('learning_plans').select('*').eq('user_id', user.id).gte('start_date', today).order('start_date', { ascending: true }).limit(5),
                        supabase.from('attendance_records').select('*').eq('user_id', user.id).eq('attendance_date', today)
                    ]);

                    if (studentsRes.error) throw studentsRes.error;
                    if (transactionsRes.error) throw transactionsRes.error;

                    setStudents(studentsRes.data || []);
                    setTransactions(transactionsRes.data || []);
                    setPaymentRecords(paymentRes.data || []);
                    setNotifications(notificationsRes.data || []);
                    setLearningPlans(plansRes.data || []);
                    setAttendanceRecords(attendanceRes.data || []);
                } catch (err) {
                    console.error('获取仪表盘数据失败:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const getUpcomingPayments = (days) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // 重置到当天0点
                const futureDate = new Date();
                futureDate.setDate(today.getDate() + days);
                futureDate.setHours(23, 59, 59, 999); // 设置到当天23:59:59

                return paymentRecords.filter(record => {
                    const dueDate = new Date(record.next_due_date);
                    dueDate.setHours(0, 0, 0, 0);
                    // 返回所有已过期的记录和未来days天内到期的记录
                    return dueDate <= futureDate;
                }).sort((a, b) => {
                    // 按到期日期排序，最早的在前面
                    return new Date(a.next_due_date) - new Date(b.next_due_date);
                });
            };

            // 获取即将续费的学生
            const getUpcomingRenewals = () => {
                // 从localStorage读取续费设置
                let renewalSettings = {
                    enableMonthlyRenewal: true,
                    renewalReminderDays: 3
                };
                try {
                    const savedSettings = localStorage.getItem('systemSettings');
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        renewalSettings = {
                            enableMonthlyRenewal: settings.enableMonthlyRenewal || false,
                            renewalReminderDays: settings.renewalReminderDays !== undefined ? settings.renewalReminderDays : 3
                        };
                    }
                } catch (error) {
                    console.error('读取续费设置失败:', error);
                }

                if (!renewalSettings.enableMonthlyRenewal) {
                    return [];
                }

                return students.filter(student => {
                    return student.next_renewal_date && 
                           student.status === 'active' &&
                           isRenewalDueSoon(student.next_renewal_date, renewalSettings.renewalReminderDays);
                }).sort((a, b) => {
                    return new Date(a.next_renewal_date) - new Date(b.next_renewal_date);
                });
            };

            const [upcomingHolidays, setUpcomingHolidays] = useState([]);
            const [upcomingSemesterReminders, setUpcomingSemesterReminders] = useState([]);
            
            // 获取学期提醒设置
            const getSemesterReminderSettings = () => {
                const defaultSettings = {
                    enableSemesterReminder: true,
                    semesterReminderDays: 7,
                    enableCustomSemesterDates: true,
                    springStartDate: '02-20',
                    autumnStartDate: '09-01'
                };
                
                try {
                    const savedSettings = localStorage.getItem('systemSettings');
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        return {
                            enableSemesterReminder: settings.enableSemesterReminder !== undefined ? settings.enableSemesterReminder : true,
                            semesterReminderDays: settings.semesterReminderDays || 7,
                            enableCustomSemesterDates: settings.enableCustomSemesterDates !== undefined ? settings.enableCustomSemesterDates : true,
                            springStartDate: settings.springStartDate || '02-20',
                            autumnStartDate: settings.autumnStartDate || '09-01'
                        };
                    }
                } catch (error) {
                    console.error('读取学期提醒设置失败:', error);
                }
                
                return defaultSettings;
            };

            // 计算学期开始提醒
            const calculateSemesterReminders = () => {
                const settings = getSemesterReminderSettings();
                if (!settings.enableSemesterReminder) {
                    setUpcomingSemesterReminders([]);
                    return;
                }

                const today = new Date();
                const currentYear = today.getFullYear();
                const reminders = [];

                // 春季学期提醒
                const springStartMonth = parseInt(settings.springStartDate.split('-')[0]);
                const springStartDay = parseInt(settings.springStartDate.split('-')[1]);
                const springStartDate = new Date(currentYear, springStartMonth - 1, springStartDay);
                
                // 如果春季学期已经开始，检查下一年
                if (springStartDate < today) {
                    springStartDate.setFullYear(currentYear + 1);
                }
                
                const springDaysAway = Math.ceil((springStartDate - today) / (1000 * 60 * 60 * 24));
                
                if (springDaysAway <= settings.semesterReminderDays && springDaysAway >= 0) {
                    reminders.push({
                        name: '春季学期开学',
                        date: springStartDate.toISOString().split('T')[0],
                        daysAway: springDaysAway,
                        type: 'spring',
                        urgency: springDaysAway <= 3 ? 'high' : 'medium'
                    });
                }

                // 秋季学期提醒
                const autumnStartMonth = parseInt(settings.autumnStartDate.split('-')[0]);
                const autumnStartDay = parseInt(settings.autumnStartDate.split('-')[1]);
                const autumnStartDate = new Date(currentYear, autumnStartMonth - 1, autumnStartDay);
                
                // 如果秋季学期已经开始，检查下一年
                if (autumnStartDate < today) {
                    autumnStartDate.setFullYear(currentYear + 1);
                }
                
                const autumnDaysAway = Math.ceil((autumnStartDate - today) / (1000 * 60 * 60 * 24));
                
                if (autumnDaysAway <= settings.semesterReminderDays && autumnDaysAway >= 0) {
                    reminders.push({
                        name: '秋季学期开学',
                        date: autumnStartDate.toISOString().split('T')[0],
                        daysAway: autumnDaysAway,
                        type: 'autumn',
                        urgency: autumnDaysAway <= 3 ? 'high' : 'medium'
                    });
                }

                setUpcomingSemesterReminders(reminders.sort((a, b) => a.daysAway - b.daysAway));
            };

            useEffect(() => {
                const y = new Date().getFullYear();
                const url = `https://timor.tech/api/holiday/year/${y}`;
                fetch(url)
                    .then(r => r.ok ? r.json() : Promise.reject(new Error('holiday fetch failed')))
                    .then(json => {
                        const today = new Date();
                        const items = Object.entries(json?.holiday || {})
                            .filter(([, v]) => v?.holiday === true)
                            .map(([d, v]) => ({ name: v?.name || '节假日', date: d }))
                            .map(h => ({
                                ...h,
                                daysAway: Math.ceil((new Date(h.date) - today) / (1000 * 60 * 60 * 24))
                            }))
                            .filter(h => h.daysAway > 0)
                            .sort((a, b) => a.daysAway - b.daysAway)
                            .slice(0, 3);
                        setUpcomingHolidays(items);
                    })
                    .catch(() => {
                        const fallback = [
                            { name: '元旦', date: `${y}-01-01` },
                            { name: '春节', date: `${y}-02-10` },
                            { name: '清明节', date: `${y}-04-05` }
                        ];
                        const today = new Date();
                        const items = fallback.map(h => ({
                            ...h,
                            daysAway: Math.ceil((new Date(h.date) - today) / (1000 * 60 * 60 * 24))
                        })).filter(h => h.daysAway > 0).sort((a, b) => a.daysAway - b.daysAway).slice(0, 3);
                        setUpcomingHolidays(items);
                    });
                
                // 计算学期提醒
                calculateSemesterReminders();
            }, []);

            // 同步学校名称与设置
            useEffect(() => {
                const syncSchoolName = () => {
                    const savedSettings = localStorage.getItem('systemSettings');
                    if (savedSettings) {
                        try {
                            const settings = JSON.parse(savedSettings);
                            if (settings.institutionName && settings.institutionName !== schoolName) {
                                setSchoolName(settings.institutionName);
                            }
                        } catch (error) {
                            console.error('同步学校名称失败:', error);
                        }
                    }
                };

                // 初始同步
                syncSchoolName();

                // 监听localStorage变化
                const handleStorageChange = (e) => {
                    if (e.key === 'systemSettings') {
                        syncSchoolName();
                    }
                };

                window.addEventListener('storage', handleStorageChange);
                
                // 定期检查设置变化（每5秒）
                const interval = setInterval(syncSchoolName, 5000);

                return () => {
                    window.removeEventListener('storage', handleStorageChange);
                    clearInterval(interval);
                };
            }, [schoolName]);

            // 监听续费设置更新事件
            useEffect(() => {
                const handleRenewalSettingsUpdate = (event) => {
                    // 强制重新渲染续费提醒组件
                    setStudents(prevStudents => [...prevStudents]);
                };

                window.addEventListener('renewalSettingsUpdated', handleRenewalSettingsUpdate);
                
                return () => {
                    window.removeEventListener('renewalSettingsUpdated', handleRenewalSettingsUpdate);
                };
            }, []);

            // 监听学期设置更新事件
            useEffect(() => {
                const handleSemesterSettingsUpdate = (event) => {
                    // 重新计算学期提醒
                    calculateSemesterReminders();
                };

                window.addEventListener('semesterSettingsUpdated', handleSemesterSettingsUpdate);
                
                return () => {
                    window.removeEventListener('semesterSettingsUpdated', handleSemesterSettingsUpdate);
                };
            }, []);

            // 定期检查日托学生缴费期限，过期自动暂停（每小时执行一次）
            useEffect(() => {
                const checkDeadlines = async () => {
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (!user) {
                            console.error('用户未登录，无法检查缴费期限');
                            return;
                        }

                        // 获取所有日托学生
                        const { data: students, error } = await supabase
                            .from('students')
                            .select('*')
                            .eq('user_id', user.id)
                            .eq('student_type', '日托');

                        if (error) {
                            console.error('获取日托学生失败:', error);
                            return;
                        }

                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        for (const student of students) {
                            if (student.next_renewal_date) {
                                const nextRenewalDate = new Date(student.next_renewal_date);
                                nextRenewalDate.setHours(0, 0, 0, 0);

                                // 如果过了缴费期限且学生状态是在读，自动暂停
                                if (nextRenewalDate < today && student.status === 'active') {
                                    console.log(`学生 ${student.name} 缴费期限已过，自动暂停`);
                                    
                                    // 更新学生状态为暂停
                                    const { error: updateError } = await supabase
                                        .from('students')
                                        .update({ status: 'suspended' })
                                        .eq('id', student.id)
                                        .eq('user_id', user.id);

                                    if (updateError) {
                                        console.error(`更新学生 ${student.name} 状态失败:`, updateError);
                                    } else {
                                        // 停用缴费记录
                                        await supabase
                                            .from('payment_records')
                                            .update({ status: 'inactive' })
                                            .eq('student_id', student.id);
                                        
                                        // 显示通知
                                        showToast(`学生 ${student.name} 缴费期限已过，已自动暂停`, 'warning');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('检查缴费期限失败:', error);
                    }
                };

                // 初始执行一次
                checkDeadlines();
                
                // 每小时执行一次
                const interval = setInterval(checkDeadlines, 3600000);
                
                return () => clearInterval(interval);
            }, []);

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-lg text-neutral-600">加载中...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p className="text-red-600">加载失败: {error}</p>
                        <button onClick={fetchDashboardData} className="mt-2 text-sm text-red-600 hover:text-red-800 underline">重试</button>
                    </div>
                );
            }

            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'active').length;
            const pendingTasks = getUpcomingPayments(7).length + (notifications.filter(n => n.status === 'scheduled').length || 0);
            // 计算缺勤人数：在读学生 - 今日已签到学生
            const todayAttendedCount = attendanceRecords.filter(r => r.status === '已到' || r.status === '准时' || r.status === '迟到').length;
            const absentCount = activeStudents - todayAttendedCount;

            return (
                <div className="space-y-6">
                    {/* 顶部横幅 - 浅蓝色背景 */}
                    <div className="relative rounded-2xl overflow-hidden" style={{
                        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%)',
                        boxShadow: '0 10px 40px rgba(102, 126, 234, 0.3)'
                    }}>
                        <div className="absolute inset-0" style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            opacity: '0.9'
                        }}></div>
                        <div className="absolute inset-0" style={{
                            background: 'url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'0.1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")',
                            opacity: '0.3'
                        }}></div>
                        <div className="relative px-8 py-12 text-center">
                            <div className="flex items-center justify-center gap-3 mb-3">
                                <h1 className="text-5xl font-bold text-white" style={{
                                    textShadow: '0 2px 20px rgba(0,0,0,0.2)',
                                    letterSpacing: '0.05em'
                                }}>{schoolName}</h1>
                            </div>
                            <p className="text-white text-lg opacity-90">托管班智能管理系统</p>
                            <div className="mt-6 flex justify-center items-center gap-6 text-white flex-wrap">
                                <div className="text-center">
                                    <p className="text-3xl font-bold">{totalStudents}</p>
                                    <p className="text-sm opacity-80 mt-1">总学生数</p>
                                </div>
                                <div className="w-px h-12 bg-white opacity-30"></div>
                                <div className="text-center">
                                    <p className="text-3xl font-bold">{activeStudents}</p>
                                    <p className="text-sm opacity-80 mt-1">在读学生</p>
                                </div>
                                <div className="w-px h-12 bg-white opacity-30"></div>
                                <div 
                                    className="text-center cursor-pointer hover:scale-105 transition-transform"
                                    onClick={() => navigateToPage('attendance')}
                                    title="点击查看考勤详情"
                                >
                                    <p className="text-3xl font-bold text-red-200">{absentCount}</p>
                                    <p className="text-sm opacity-80 mt-1">今日缺勤</p>
                                </div>
                                <div className="w-px h-12 bg-white opacity-30"></div>
                                <div className="text-center">
                                    <p className="text-3xl font-bold">{pendingTasks}</p>
                                    <p className="text-sm opacity-80 mt-1">待处理事项</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 主要内容区域 */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* 左侧列 - 即将到期缴费提醒 */}
                        <div className="lg:col-span-2 space-y-6">
                            {/* 月缴续费提醒 - 常驻显示 */}
                            <div className="glass-morphism rounded-xl p-6 border-2 border-blue-200">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2">
                                        <CalendarIcon />
                                        续费提醒
                                    </h3>
                                    {/* 苹果风格切换开关 */}
                                    <div className="apple-switch flex items-center gap-1 p-1 rounded-full">
                                        {[
                                            { days: 0, label: '已过期' },
                                            { days: 3, label: '3天内' },
                                            { days: 7, label: '7天内' }
                                        ].map((option) => {
                                            let isActive = false;
                                            let renewalReminderDays = 3; // 默认为3天内
                                            
                                            try {
                                                const savedSettings = localStorage.getItem('systemSettings');
                                                if (savedSettings) {
                                                    const settings = JSON.parse(savedSettings);
                                                    renewalReminderDays = settings.renewalReminderDays !== undefined ? settings.renewalReminderDays : 3;
                                                }
                                                isActive = renewalReminderDays === option.days;
                                            } catch (error) {
                                                // 如果解析失败，默认为3天内
                                                renewalReminderDays = 3;
                                                isActive = option.days === 3;
                                            }
                                            
                                            const handleClick = () => {
                                                try {
                                                    const savedSettings = localStorage.getItem('systemSettings');
                                                    let settings = savedSettings ? JSON.parse(savedSettings) : {
                                                        enableMonthlyRenewal: true,
                                                        renewalReminderDays: 3
                                                    };
                                                    
                                                    settings.renewalReminderDays = option.days;
                                                    localStorage.setItem('systemSettings', JSON.stringify(settings));
                                                    
                                                    // 触发自定义事件通知设置更新，而不是刷新页面
                                                    window.dispatchEvent(new CustomEvent('renewalSettingsUpdated', { 
                                                        detail: { renewalReminderDays: option.days } 
                                                    }));
                                                } catch (error) {
                                                    console.error('更新提醒天数失败:', error);
                                                }
                                            };
                                            
                                            return (
                                                <button
                                                    key={option.days}
                                                    onClick={handleClick}
                                                    data-days={option.days}
                                                    className={`apple-switch-button relative px-4 py-2 rounded-full text-sm font-medium ${
                                                        isActive 
                                                            ? 'active text-white' 
                                                            : 'text-neutral-600 hover:text-neutral-800'
                                                    }`}
                                                >
                                                    {option.label}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                                
                                {(() => {
                                    const upcomingRenewals = getUpcomingRenewals();
                                    const renewalSettings = {
                                        enableMonthlyRenewal: true,
                                        renewalReminderDays: 3
                                    };
                                    
                                    try {
                                        const savedSettings = localStorage.getItem('systemSettings');
                                        if (savedSettings) {
                                            const settings = JSON.parse(savedSettings);
                                            renewalSettings.enableMonthlyRenewal = settings.enableMonthlyRenewal || false;
                                            renewalSettings.renewalReminderDays = settings.renewalReminderDays || 3;
                                        }
                                    } catch (error) {}
                                    
                                    if (!renewalSettings.enableMonthlyRenewal) {
                                        return (
                                            <div className="flex flex-col items-center justify-center py-8 text-center">
                                                <div className="sketch-icon mb-4">
                                                    <svg className="sketch-bell" viewBox="0 0 24 24">
                                                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                                        <circle cx="12" cy="4" r="1"/>
                                                        <path d="M8 12h8M8 16h8"/>
                                                    </svg>
                                                </div>
                                                <h4 className="text-lg font-medium text-neutral-700 mb-2">月度续费提醒功能未启用</h4>
                                                <p className="text-sm text-neutral-500 max-w-md">
                                                    请在"设置"中启用月度续费提醒功能，系统将自动提醒您即将到期的续费
                                                </p>
                                            </div>
                                        );
                                    }
                                    
                                    if (upcomingRenewals.length === 0) {
                                        return (
                                            <div className="flex flex-col items-center justify-center py-8 text-center">
                                                <div className="sketch-icon mb-4">
                                                    <svg className="sketch-check" viewBox="0 0 24 24">
                                                        <circle className="sketch-check-circle" cx="12" cy="12" r="10"/>
                                                        <path d="M8 12l3 3 5-6"/>
                                                    </svg>
                                                </div>
                                                <h4 className="text-lg font-medium text-neutral-700 mb-2">暂无即将到期的续费</h4>
                                                <p className="text-sm text-neutral-500 max-w-md">
                                                    所有学生的续费日期都在{renewalSettings.renewalReminderDays}天之后，无需担心
                                                </p>
                                            </div>
                                        );
                                    }
                                    
                                    return (
                                        <div className="space-y-3 max-h-80 overflow-y-auto">
                                            {upcomingRenewals.map((student) => {
                                                const today = new Date();
                                                today.setHours(0, 0, 0, 0);
                                                const renewalDate = new Date(student.next_renewal_date);
                                                renewalDate.setHours(0, 0, 0, 0);
                                                const diffTime = renewalDate - today;
                                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                                
                                                let reminderText = '';
                                                let reminderColor = 'text-blue-600';
                                                let bgGradient = 'from-blue-50 to-indigo-50';
                                                let borderColor = 'border-blue-200';
                                                
                                                if (diffDays < 0) {
                                                    reminderText = `已过期${Math.abs(diffDays)}天`;
                                                    reminderColor = 'text-red-600';
                                                    bgGradient = 'from-red-50 to-orange-50';
                                                    borderColor = 'border-red-200';
                                                } else if (diffDays === 0) {
                                                    reminderText = '今日应续费';
                                                    reminderColor = 'text-red-600';
                                                    bgGradient = 'from-red-50 to-orange-50';
                                                    borderColor = 'border-red-200';
                                                } else if (diffDays <= 3) {
                                                    reminderText = `还有${diffDays}天到期`;
                                                    reminderColor = 'text-orange-600';
                                                    bgGradient = 'from-orange-50 to-amber-50';
                                                    borderColor = 'border-orange-200';
                                                } else {
                                                    reminderText = `还有${diffDays}天到期`;
                                                    reminderColor = 'text-blue-600';
                                                }
                                                
                                                return (
                                                    <div key={student.id} className={`flex items-center justify-between py-3 px-4 bg-gradient-to-r ${bgGradient} rounded-lg border ${borderColor} hover:shadow-md transition-shadow cursor-pointer`}>
                                                        <div className="flex-1">
                                                            <p className="font-medium text-neutral-900 text-lg">{student.name}</p>
                                                            <p className="text-sm text-neutral-600 mt-1">
                                                                续费日期：{student.next_renewal_date}
                                                                <span className={`ml-2 font-semibold ${reminderColor}`}>
                                                                    ({reminderText})
                                                                </span>
                                                            </p>
                                                            <p className="text-xs text-neutral-500 mt-1">
                                                                {student.grade} · {student.phone}
                                                            </p>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })()}
                            </div>

                            {/* 学期时间设置提醒 - 新增功能 */}
                            <div className="glass-morphism rounded-xl p-6 border-2 border-green-200">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold text-neutral-900 flex items-center gap-2">
                                        <ClockIcon />
                                        学期时间设置提醒
                                    </h3>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-neutral-500">开学前</span>
                                        <select 
                                            className="text-xs border border-neutral-300 rounded px-2 py-1"
                                            onChange={(e) => {
                                                const days = parseInt(e.target.value);
                                                try {
                                                    const savedSettings = localStorage.getItem('systemSettings');
                                                    let settings = savedSettings ? JSON.parse(savedSettings) : {};
                                                    settings.semesterReminderDays = days;
                                                    localStorage.setItem('systemSettings', JSON.stringify(settings));
                                                    calculateSemesterReminders();
                                                } catch (error) {
                                                    console.error('更新提醒天数失败:', error);
                                                }
                                            }}
                                            defaultValue={(() => {
                                                try {
                                                    const savedSettings = localStorage.getItem('systemSettings');
                                                    if (savedSettings) {
                                                        const settings = JSON.parse(savedSettings);
                                                        return settings.semesterReminderDays || 7;
                                                    }
                                                } catch (error) {}
                                                return 7;
                                            })()}
                                        >
                                            <option value={3}>3天</option>
                                            <option value={7}>7天</option>
                                            <option value={14}>14天</option>
                                            <option value={30}>30天</option>
                                        </select>
                                        <button
                                            onClick={() => {
                                                try {
                                                    const savedSettings = localStorage.getItem('systemSettings');
                                                    let settings = savedSettings ? JSON.parse(savedSettings) : {};
                                                    settings.enableSemesterReminder = !settings.enableSemesterReminder;
                                                    localStorage.setItem('systemSettings', JSON.stringify(settings));
                                                    calculateSemesterReminders();
                                                } catch (error) {
                                                    console.error('切换提醒状态失败:', error);
                                                }
                                            }}
                                            className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                                                (() => {
                                                    try {
                                                        const savedSettings = localStorage.getItem('systemSettings');
                                                        if (savedSettings) {
                                                            const settings = JSON.parse(savedSettings);
                                                            return settings.enableSemesterReminder !== false ? 'bg-green-100 text-green-800' : 'bg-neutral-100 text-neutral-600';
                                                        }
                                                    } catch (error) {}
                                                    return 'bg-green-100 text-green-800';
                                                })()
                                            }`}
                                        >
                                            {(() => {
                                                try {
                                                    const savedSettings = localStorage.getItem('systemSettings');
                                                    if (savedSettings) {
                                                        const settings = JSON.parse(savedSettings);
                                                        return settings.enableSemesterReminder !== false ? '已启用' : '已禁用';
                                                    }
                                                } catch (error) {}
                                                return '已启用';
                                            })()}
                                        </button>
                                    </div>
                                </div>
                                
                                {(() => {
                                    if (upcomingSemesterReminders.length === 0) {
                                        const settings = getSemesterReminderSettings();
                                        if (!settings.enableSemesterReminder) {
                                            return (
                                                <div className="flex flex-col items-center justify-center py-8 text-center">
                                                    <div className="sketch-icon mb-4">
                                                        <svg className="sketch-bell" viewBox="0 0 24 24">
                                                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                                            <circle cx="12" cy="4" r="1"/>
                                                        </svg>
                                                    </div>
                                                    <h4 className="text-lg font-medium text-neutral-700 mb-2">学期时间提醒功能已禁用</h4>
                                                    <p className="text-sm text-neutral-500 max-w-md">
                                                        点击上方按钮启用提醒功能，系统将在开学前提醒您设置学期时间
                                                    </p>
                                                </div>
                                            );
                                        }
                                        
                                        return (
                                            <div className="flex flex-col items-center justify-center py-8 text-center">
                                                <div className="sketch-icon mb-4">
                                                    <svg className="sketch-check" viewBox="0 0 24 24">
                                                        <circle className="sketch-check-circle" cx="12" cy="12" r="10"/>
                                                        <path d="M8 12l3 3 5-6"/>
                                                    </svg>
                                                </div>
                                                <h4 className="text-lg font-medium text-neutral-700 mb-2">暂无即将到来的学期</h4>
                                                <p className="text-sm text-neutral-500 max-w-md">
                                                    当前没有需要设置学期时间的提醒，下次开学前{settings.semesterReminderDays || 7}天将提醒您
                                                </p>
                                            </div>
                                        );
                                    }
                                    
                                    return (
                                        <div className="space-y-3 max-h-80 overflow-y-auto">
                                            {upcomingSemesterReminders.map((reminder, index) => {
                                                let bgGradient = 'from-green-50 to-emerald-50';
                                                let borderColor = 'border-green-200';
                                                let urgencyColor = 'text-green-600';
                                                let actionText = '设置学期时间';
                                                
                                                if (reminder.urgency === 'high') {
                                                    bgGradient = 'from-orange-50 to-red-50';
                                                    borderColor = 'border-orange-200';
                                                    urgencyColor = 'text-orange-600';
                                                    actionText = '立即设置学期时间';
                                                }
                                                
                                                return (
                                                    <div key={index} className={`flex items-center justify-between py-3 px-4 bg-gradient-to-r ${bgGradient} rounded-lg border ${borderColor} hover:shadow-md transition-shadow`}>
                                                        <div className="flex-1">
                                                            <p className="font-medium text-neutral-900 text-lg">{reminder.name}</p>
                                                            <p className="text-sm text-neutral-600 mt-1">
                                                                开学日期：{reminder.date}
                                                                <span className={`ml-2 font-semibold ${urgencyColor}`}>
                                                                    (还有{reminder.daysAway}天)
                                                                </span>
                                                            </p>
                                                            {reminder.urgency === 'high' && (
                                                                <p className="text-xs text-orange-600 mt-1 font-medium">
                                                                    ⚠️ 即将开学，请及时设置学期时间
                                                                </p>
                                                            )}
                                                        </div>
                                                        <button
                                                            onClick={() => navigateToPage('settings')}
                                                            className="ml-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                                                        >
                                                            {actionText}
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })()}
                            </div>

                            {/* 家长需求 - 当日家长交代事项 */}
                            <div className="glass-morphism rounded-xl p-6">
                            <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                                <StudentsIcon />
                                家长需求
                                <button onClick={() => setShowParentNeedsEdit(true)} className="ml-auto px-2 py-1 text-xs bg-neutral-100 text-neutral-700 rounded hover:bg-neutral-200">编辑</button>
                            </h3>
                            {parentNeedsNote ? (
                                <div className="mb-3 p-3 bg-neutral-50 border border-neutral-200 rounded text-sm text-neutral-700">{parentNeedsNote}</div>
                            ) : (
                                <p className="text-neutral-500 text-center py-4">暂无家长需求</p>
                            )}
                            {showParentNeedsEdit && (
                                <div className="mb-3 p-3 bg-white border border-neutral-200 rounded">
                                    <textarea value={parentNeedsNote} onChange={(e)=>setParentNeedsNote(e.target.value)} rows="3" className="w-full px-3 py-2 border border-neutral-300 rounded" placeholder="输入家长需求说明..."/>
                                    <div className="mt-2 flex gap-2">
                                        <button onClick={()=>{try{localStorage.setItem('parentNeedsNote',parentNeedsNote)}catch(e){}; setShowParentNeedsEdit(false);}} className="px-3 py-1 bg-primary-500 text-white rounded">保存</button>
                                        <button onClick={()=>setShowParentNeedsEdit(false)} className="px-3 py-1 bg-neutral-200 text-neutral-700 rounded">取消</button>
                                    </div>
                                </div>
                            )}
                            </div>
                        </div>

                        {/* 右侧列 */}
                        <div className="space-y-6">
                            {/* 最近通知 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                                    <NotificationIcon />
                                    最近通知
                                </h3>
                                <div className="space-y-3">
                                    {notifications.length === 0 ? (
                                        <p className="text-neutral-500 text-center py-4 text-sm">暂无通知</p>
                                    ) : (
                                        notifications.map((notif) => (
                                            <div key={notif.id} className="py-3 px-4 bg-blue-50 rounded-lg border border-blue-100">
                                                <p className="font-medium text-neutral-900 text-sm">{notif.title || notif.message}</p>
                                                <p className="text-xs text-neutral-600 mt-1">
                                                    {new Date(notif.created_at).toLocaleDateString('zh-CN')}
                                                </p>
                                                <span className={`inline-block mt-2 text-xs px-2 py-1 rounded-full ${
                                                    notif.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                                }`}>
                                                    {notif.status === 'sent' ? '已发送' : '待发送'}
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>

                            {/* 接下来的节假日 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                                    <CalendarIcon />
                                    接下来的节假日
                                </h3>
                                <div className="space-y-3">
                                    {upcomingHolidays.map((holiday, index) => (
                                        <div key={index} className="py-3 px-4 bg-purple-50 rounded-lg border border-purple-100">
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <p className="font-medium text-neutral-900">{holiday.name}</p>
                                                    <p className="text-sm text-neutral-600">{holiday.date}</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-lg font-bold text-purple-600">{holiday.daysAway}</p>
                                                    <p className="text-xs text-neutral-600">天后</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* 接下来的学习计划 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4 flex items-center gap-2">
                                    <StudyPlanIcon />
                                    接下来的学习计划
                                </h3>
                                <div className="space-y-3">
                                    {learningPlans.length === 0 ? (
                                        <p className="text-neutral-500 text-center py-4 text-sm">暂无学习计划</p>
                                    ) : (
                                        learningPlans.map((plan) => (
                                            <div key={plan.id} className="py-3 px-4 bg-green-50 rounded-lg border border-green-100">
                                                <p className="font-medium text-neutral-900 text-sm">{plan.title}</p>
                                                <p className="text-xs text-neutral-600 mt-1">
                                                    {plan.start_date} - {plan.end_date}
                                                </p>
                                                <span className={`inline-block mt-2 text-xs px-2 py-1 rounded-full ${
                                                    plan.status === 'active' ? 'bg-green-100 text-green-800' : 
                                                    plan.status === 'completed' ? 'bg-blue-100 text-blue-800' : 
                                                    'bg-neutral-100 text-neutral-800'
                                                }`}>
                                                    {plan.status === 'active' ? '进行中' : plan.status === 'completed' ? '已完成' : '待开始'}
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 学生详细档案页面组件
        const StudentProfilePage = ({ student, onBack, onUpdate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [profileData, setProfileData] = useState(student);
            const [examScores, setExamScores] = useState([]);
            const [attendanceRecords, setAttendanceRecords] = useState([]);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                loadProfileData();
            }, [student]);

            const loadProfileData = async () => {
                try {
                    setLoading(true);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    // 加载考试成绩（最近5次）
                    const { data: scores } = await supabase
                        .from('exam_scores')
                        .select('*')
                        .eq('student_name', student.name)
                        .order('exam_date', { ascending: false })
                        .limit(5);
                    setExamScores(scores || []);

                    // 加载考勤记录（最近10条）
                    const { data: attendance } = await supabase
                        .from('attendance_records')
                        .select('*')
                        .eq('student_name', student.name)
                        .order('attendance_date', { ascending: false })
                        .limit(10);
                    setAttendanceRecords(attendance || []);
                } catch (error) {
                    console.error('加载档案数据失败:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleSave = async () => {
                try {
                    setSaving(true);
                    const { data, error } = await supabase
                        .from('students')
                        .update({
                            name: profileData.name,
                            gender: profileData.gender,
                            birth_date: profileData.birth_date,
                            grade: profileData.grade,
                            class: profileData.class,
                            address: profileData.address,
                            registration_date: profileData.registration_date,
                            renewal_date: profileData.renewal_date,
                            father_name: profileData.father_name,
                            mother_name: profileData.mother_name,
                            parent_phone: profileData.parent_phone,
                            care_needs: profileData.care_needs,
                            daycare_days: profileData.daycare_days,
                            learning_status: profileData.learning_status,
                            special_notes: profileData.special_notes,
                            student_type: profileData.student_type,
                            custom_field1: profileData.custom_field1,
                            custom_field2: profileData.custom_field2,
                            custom_field3: profileData.custom_field3,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', student.id)
                        .select()
                        .single();

                    if (error) throw error;
                    
                    setProfileData(data);
                    setIsEditing(false);
                    if (onUpdate) onUpdate(data);
                    alert('保存成功！');
                } catch (error) {
                    console.error('保存失败:', error);
                    alert('保存失败：' + error.message);
                } finally {
                    setSaving(false);
                }
            };

            const calculateAge = (birthDate) => {
                if (!birthDate) return '-';
                const today = new Date();
                const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            };

            return (
                <div className="space-y-6">
                    {/* 头部 */}
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div className="flex items-center space-x-4">
                            <button
                                onClick={onBack}
                                className="p-2 hover:bg-neutral-100 rounded-lg transition-colors"
                                title="返回学生列表"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div>
                                <h2 className="text-2xl font-bold text-neutral-900">{profileData.name} 的详细档案</h2>
                                <p className="text-neutral-600">学生档案管理</p>
                            </div>
                        </div>
                        <div className="flex space-x-2">
                            {isEditing ? (
                                <>
                                    <button
                                        onClick={() => {
                                            setProfileData(student);
                                            setIsEditing(false);
                                        }}
                                        className="px-4 py-2 bg-neutral-200 text-neutral-700 rounded-lg hover:bg-neutral-300 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleSave}
                                        disabled={saving}
                                        className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50"
                                    >
                                        {saving ? '保存中...' : '保存'}
                                    </button>
                                </>
                            ) : (
                                <button
                                    onClick={() => setIsEditing(true)}
                                    className="flex items-center space-x-2 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-700 transition-colors"
                                >
                                    <EditIcon />
                                    <span>编辑档案</span>
                                </button>
                            )}
                        </div>
                    </div>

                    {loading ? (
                        <div className="flex items-center justify-center p-12">
                            <div className="text-center">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                                <p className="mt-2 text-neutral-600">加载中...</p>
                            </div>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* 左侧：基本信息 */}
                            <div className="lg:col-span-2 space-y-6">
                                {/* 基本信息 */}
                                <div className="glass-morphism rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-neutral-900 mb-4">基本信息</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">姓名</label>
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={profileData.name || ''}
                                                    onChange={(e) => setProfileData({...profileData, name: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.name || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">性别</label>
                                            {isEditing ? (
                                                <select
                                                    value={profileData.gender || ''}
                                                    onChange={(e) => setProfileData({...profileData, gender: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                >
                                                    <option value="">请选择</option>
                                                    <option value="男">男</option>
                                                    <option value="女">女</option>
                                                </select>
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.gender || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">出生日期</label>
                                            {isEditing ? (
                                                <input
                                                    type="date"
                                                    value={profileData.birth_date || ''}
                                                    onChange={(e) => setProfileData({...profileData, birth_date: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.birth_date || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">年龄</label>
                                            <p className="text-neutral-900 py-2">{calculateAge(profileData.birth_date)} 岁</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">年级</label>
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={profileData.grade || ''}
                                                    onChange={(e) => setProfileData({...profileData, grade: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.grade || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">班级</label>
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={profileData.class || ''}
                                                    onChange={(e) => setProfileData({...profileData, class: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.class || '-'}</p>
                                            )}
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">家庭住址</label>
                                            {isEditing ? (
                                                <textarea
                                                    value={profileData.address || ''}
                                                    onChange={(e) => setProfileData({...profileData, address: e.target.value})}
                                                    rows="2"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.address || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">报名日期</label>
                                            {isEditing ? (
                                                <input
                                                    type="date"
                                                    value={profileData.registration_date || ''}
                                                    onChange={(e) => setProfileData({...profileData, registration_date: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.registration_date || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">续费日期</label>
                                            {isEditing ? (
                                                <input
                                                    type="date"
                                                    value={profileData.renewal_date || ''}
                                                    onChange={(e) => setProfileData({...profileData, renewal_date: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.renewal_date || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">托管方式</label>
                                            {isEditing ? (
                                                <select
                                                    value={profileData.student_type || '月托'}
                                                    onChange={(e) => setProfileData({...profileData, student_type: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                >
                                                    <option value="日托">日托</option>
                                                    <option value="月托">月托</option>
                                                    <option value="学期">学期</option>
                                                </select>
                                            ) : (
                                                <p className="text-neutral-900 py-2">
                                                    <span className={`px-2 py-1 text-xs rounded-full ${
                                                        profileData.student_type === '日托' ? 'bg-blue-100 text-blue-800' :
                                                        profileData.student_type === '月托' ? 'bg-green-100 text-green-800' :
                                                        profileData.student_type === '学期' ? 'bg-purple-100 text-purple-800' :
                                                        'bg-neutral-100 text-neutral-800'
                                                    }`}>
                                                        {profileData.student_type || '月托'}
                                                    </span>
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* 家长信息 */}
                                <div className="glass-morphism rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-neutral-900 mb-4">家长信息</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">父亲姓名</label>
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={profileData.father_name || ''}
                                                    onChange={(e) => setProfileData({...profileData, father_name: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.father_name || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">母亲姓名</label>
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={profileData.mother_name || ''}
                                                    onChange={(e) => setProfileData({...profileData, mother_name: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.mother_name || '-'}</p>
                                            )}
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">联系电话</label>
                                            {isEditing ? (
                                                <input
                                                    type="tel"
                                                    value={profileData.parent_phone || ''}
                                                    onChange={(e) => setProfileData({...profileData, parent_phone: e.target.value})}
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.parent_phone || '-'}</p>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* 托管需求和学习情况 */}
                                <div className="glass-morphism rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-neutral-900 mb-4">托管需求与学习情况</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">日托需求</label>
                                            {isEditing ? (
                                                <textarea
                                                    value={profileData.care_needs || ''}
                                                    onChange={(e) => setProfileData({...profileData, care_needs: e.target.value})}
                                                    rows="3"
                                                    placeholder="例如：需要辅导作业、接送服务等"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2 whitespace-pre-wrap">{profileData.care_needs || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">日托天数</label>
                                            {isEditing ? (
                                                <input
                                                    type="number"
                                                    value={profileData.daycare_days || ''}
                                                    onChange={(e) => setProfileData({...profileData, daycare_days: e.target.value})}
                                                    min="0"
                                                    placeholder="0"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2">{profileData.daycare_days || 0} 天</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">学习情况</label>
                                            {isEditing ? (
                                                <textarea
                                                    value={profileData.learning_status || ''}
                                                    onChange={(e) => setProfileData({...profileData, learning_status: e.target.value})}
                                                    rows="3"
                                                    placeholder="例如：各科成绩情况、学习态度等"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2 whitespace-pre-wrap">{profileData.learning_status || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">特殊关注事项</label>
                                            {isEditing ? (
                                                <textarea
                                                    value={profileData.special_notes || ''}
                                                    onChange={(e) => setProfileData({...profileData, special_notes: e.target.value})}
                                                    rows="3"
                                                    placeholder="例如：过敏、特殊要求等"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2 whitespace-pre-wrap">{profileData.special_notes || '-'}</p>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* 自定义字段 */}
                                <div className="glass-morphism rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-neutral-900 mb-4">自定义信息</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">自定义字段 1</label>
                                            {isEditing ? (
                                                <textarea
                                                    value={profileData.custom_field1 || ''}
                                                    onChange={(e) => setProfileData({...profileData, custom_field1: e.target.value})}
                                                    rows="2"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2 whitespace-pre-wrap">{profileData.custom_field1 || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">自定义字段 2</label>
                                            {isEditing ? (
                                                <textarea
                                                    value={profileData.custom_field2 || ''}
                                                    onChange={(e) => setProfileData({...profileData, custom_field2: e.target.value})}
                                                    rows="2"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2 whitespace-pre-wrap">{profileData.custom_field2 || '-'}</p>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-600 mb-1">自定义字段 3</label>
                                            {isEditing ? (
                                                <textarea
                                                    value={profileData.custom_field3 || ''}
                                                    onChange={(e) => setProfileData({...profileData, custom_field3: e.target.value})}
                                                    rows="2"
                                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                />
                                            ) : (
                                                <p className="text-neutral-900 py-2 whitespace-pre-wrap">{profileData.custom_field3 || '-'}</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 右侧：考试成绩和考勤记录 */}
                            <div className="space-y-6">
                                {/* 最近考试成绩 */}
                                <div className="glass-morphism rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-neutral-900 mb-4">最近考试成绩</h3>
                                    {examScores.length === 0 ? (
                                        <p className="text-center text-neutral-500 py-4">暂无考试记录</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {examScores.map((score) => (
                                                <div key={score.id} className="bg-neutral-50 rounded-lg p-3">
                                                    <div className="flex justify-between items-start mb-1">
                                                        <div className="flex-1">
                                                            <div className="font-medium text-neutral-900">{score.subject}</div>
                                                            <div className="text-xs text-neutral-500">{score.exam_date}</div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-lg font-bold text-primary-500">{score.score}</div>
                                                            <div className="text-xs text-neutral-500">/{score.full_score}</div>
                                                        </div>
                                                    </div>
                                                    {score.notes && (
                                                        <div className="text-xs text-neutral-600 mt-1">{score.notes}</div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* 考勤记录 */}
                                <div className="glass-morphism rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-neutral-900 mb-4">考勤记录</h3>
                                    {attendanceRecords.length === 0 ? (
                                        <p className="text-center text-neutral-500 py-4">暂无考勤记录</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {attendanceRecords.map((record) => (
                                                <div key={record.id} className="flex justify-between items-center py-2 border-b border-neutral-100 last:border-0">
                                                    <div>
                                                        <div className="text-sm text-neutral-900">{record.attendance_date}</div>
                                                        {record.check_in_time && (
                                                            <div className="text-xs text-neutral-500">签到：{record.check_in_time}</div>
                                                        )}
                                                    </div>
                                                    <span className={`px-2 py-1 text-xs rounded-full ${
                                                        record.status === 'present' ? 'bg-green-100 text-green-800' :
                                                        record.status === 'late' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}>
                                                        {record.status === 'present' ? '出勤' : 
                                                         record.status === 'late' ? '迟到' : '缺勤'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* 账户信息 */}
                                <div className="glass-morphism rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-neutral-900 mb-4">账户信息</h3>
                                    <div className="space-y-3">

                                        <div className="flex justify-between items-center">
                                            <span className="text-neutral-600">状态</span>
                                            <span className={`px-2 py-1 text-xs rounded-full ${
                                                profileData.status === 'active' 
                                                    ? 'bg-green-100 text-green-800' 
                                                    : 'bg-neutral-100 text-neutral-800'
                                            }`}>
                                                {profileData.status === 'active' ? '在读' : '暂停'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Toast通知组件
        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(() => {
                    onClose();
                }, 3000);
                return () => clearTimeout(timer);
            }, []);

            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';

            return (
                <div className="fixed top-4 right-4 z-[9999] animate-fade-in">
                    <div className={`${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3`}>
                        <div>
                            {type === 'success' ? (
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                            ) : (
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            )}
                        </div>
                        <span className="font-medium">{message}</span>
                        <button onClick={onClose} className="ml-4 text-white hover:text-neutral-200">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            );
        };

        // 学生管理组件
        const Students = () => {
            const { refreshStudentData, studentDataRefresh } = React.useContext(GlobalMonthContext);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingStudent, setEditingStudent] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [showDetailModal, setShowDetailModal] = useState(false);
            const [viewMode, setViewMode] = useState('list'); // 'list' 或 'profile'
            const [profileStudent, setProfileStudent] = useState(null);
            const [submitting, setSubmitting] = useState(false);
            const [toast, setToast] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingStudentId, setDeletingStudentId] = useState(null);
            const [showMergeConfirm, setShowMergeConfirm] = useState(false);
            const [mergeStudents, setMergeStudents] = useState([]);
            const [pendingStudentData, setPendingStudentData] = useState(null);
            const [importing, setImporting] = useState(false);
            const [importProgress, setImportProgress] = useState(0);
            const [importStatus, setImportStatus] = useState('');

            const showToast = (message, type = 'success') => {
                setToast({ message, type });
            };

            useEffect(() => {
                checkAndUpdateDatabaseSchema();
                loadStudents();
            }, [studentDataRefresh]);

            const loadStudents = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('用户未登录');
                        return;
                    }

                    const { data, error } = await supabase
                        .from('students')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setStudents(data || []);
                } catch (error) {
                    console.error('加载学生数据失败:', error);
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            const filteredStudents = students.filter(student =>
                student.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                student.grade.toLowerCase().includes(searchTerm.toLowerCase()) ||
                student.class.toLowerCase().includes(searchTerm.toLowerCase())
            );

            // 格式化年级班级显示：五年级1班 -> 五.1班
            const formatGradeClass = (grade, classNum) => {
                // 如果年级或班级为空，返回"未知"
                if (!grade || !classNum) {
                    return '未知';
                }
                
                // 提取年级中的汉字（一、二、三等）
                const gradeMatch = grade.match(/[一二三四五六七八九]/);  
                const gradeChar = gradeMatch ? gradeMatch[0] : grade;
                
                // 提取班级中的数字
                const classMatch = classNum.match(/\d+/);
                const classNumber = classMatch ? classMatch[0] : classNum;
                
                return `${gradeChar}-${classNumber} 班`;
            };

            // 处理合并确认
            const handleMergeConfirm = async (shouldMerge) => {
                setShowMergeConfirm(false);
                
                if (shouldMerge && mergeStudents.length > 0) {
                    // 合并到第一个同名学生
                    const targetStudent = mergeStudents[0];
                    try {
                        await handleMergeStudent(targetStudent.id, pendingStudentData);
                    } catch (error) {
                        console.error('合并学生失败:', error);
                    }
                } else if (shouldMerge === false && pendingStudentData) {
                    // 用户选择创建新记录，继续添加学生流程
                    await continueAddStudent(pendingStudentData);
                }
                // 如果 shouldMerge 为 null 或其他值（如用户点击关闭或背景），不执行任何操作
                
                // 清理状态
                setMergeStudents([]);
                setPendingStudentData(null);
            };

            // 继续添加学生（当用户选择不合并时）
            const continueAddStudent = async (studentData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const registrationDate = studentData.registration_date || new Date().toISOString().split('T')[0];
                    
                    // 根据学生类型计算缴费日期
                    let nextRenewalDate;
                    if (studentData.student_type === '日托') {
                        // 日托学生：根据daycare_days天数计算缴费日期
                        const careDays = parseInt(studentData.daycare_days) || 1;
                        const startDate = new Date(registrationDate);
                        
                        if (careDays === 1) {
                            // 托管1天：缴费日期为当天
                            nextRenewalDate = registrationDate;
                        } else {
                            // 托管多天：计算工作日
                            nextRenewalDate = getExtendedWorkday(registrationDate, careDays - 1);
                        }
                    } else {
                        // 月托和学期学生：使用原来的月份计算
                        nextRenewalDate = calculateNextRenewalDate(registrationDate);
                    }

                    const { data, error } = await supabase
                        .from('students')
                        .insert([{
                            ...studentData,
                            user_id: user.id,
                            status: 'active',
                            next_renewal_date: nextRenewalDate
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    
                    // 先更新本地状态，确保UI立即响应
                    setStudents([data, ...students]);
                    
                    // 延迟关闭表单，确保状态更新完成
                    setTimeout(() => {
                        setShowAddForm(false);
                    }, 100);
                    
                    // 处理缴费和自动同步（异步执行，不阻塞主流程）
                    handleStudentPaymentAndSync(data).catch(error => {
                        console.error('同步财务和考勤记录失败:', error);
                        // 不影响主流程，只记录错误
                    });
                    
                    // 延迟触发全局刷新，确保数据一致性
                    setTimeout(() => {
                        refreshStudentData();
                    }, 200);
                    
                    showToast('添加学生成功！', 'success');
                } catch (error) {
                    console.error('添加学生失败:', error);
                    showToast('添加失败：' + error.message, 'error');
                } finally {
                    setSubmitting(false);
                }
            };

            // 合并学生信息
            const handleMergeStudent = async (studentId, newStudentData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    // 获取现有学生信息
                    const { data: existingStudent, error: fetchError } = await supabase
                        .from('students')
                        .select('*')
                        .eq('id', studentId)
                        .eq('user_id', user.id)
                        .single();

                    if (fetchError) throw fetchError;

                    // 合并数据：保留原有信息，更新新信息
                    const mergedData = {
                        ...existingStudent,
                        ...newStudentData,
                        id: studentId, // 保持原有ID
                        user_id: user.id,
                        status: 'active', // 激活状态
                        updated_at: new Date().toISOString()
                    };

                    // 更新学生记录
                    const { data, error } = await supabase
                        .from('students')
                        .update(mergedData)
                        .eq('id', studentId)
                        .eq('user_id', user.id)
                        .select()
                        .single();

                    if (error) throw error;

                    // 更新本地状态
                    setStudents(prev => prev.map(student => 
                        student.id === studentId ? data : student
                    ));

                    // 关闭表单
                    setTimeout(() => {
                        setShowAddForm(false);
                    }, 100);

                    showToast('学生信息合并成功！', 'success');
                    
                    // 延迟触发全局刷新
                    setTimeout(() => {
                        refreshStudentData();
                    }, 200);

                    return data;
                } catch (error) {
                    console.error('合并学生失败:', error);
                    showToast('合并失败：' + error.message, 'error');
                    throw error;
                }
            };

            const handleAddStudent = async (studentData) => {
                try {
                    setSubmitting(true);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    // 检查同名学生
                    const { data: existingStudents, error: checkError } = await supabase
                        .from('students')
                        .select('id, name, grade, class, status, parent, phone')
                        .eq('name', studentData.name)
                        .eq('user_id', user.id);

                    if (checkError) throw checkError;

                    // 如果有同名学生，询问是否合并
                    if (existingStudents && existingStudents.length > 0) {
                        setMergeStudents(existingStudents);
                        setPendingStudentData(studentData);
                        setShowMergeConfirm(true);
                        setSubmitting(false);
                        return;
                    }

                    const registrationDate = studentData.registration_date || new Date().toISOString().split('T')[0];
                    
                    // 根据学生类型计算缴费日期
                    let nextRenewalDate;
                    if (studentData.student_type === '日托') {
                        // 日托学生：根据daycare_days天数计算缴费日期
                        const careDays = parseInt(studentData.daycare_days) || 1;
                        const startDate = new Date(registrationDate);
                        
                        if (careDays === 1) {
                            // 托管1天：缴费日期为当天
                            nextRenewalDate = registrationDate;
                        } else {
                            // 托管多天：计算工作日
                            nextRenewalDate = getExtendedWorkday(registrationDate, careDays - 1);
                        }
                    } else {
                        // 月托和学期学生：使用原来的月份计算
                        nextRenewalDate = calculateNextRenewalDate(registrationDate);
                    }

                    const { data, error } = await supabase
                        .from('students')
                        .insert([{
                            ...studentData,
                            user_id: user.id,
                            status: 'active',
                            next_renewal_date: nextRenewalDate
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    
                    // 先更新本地状态，确保UI立即响应
                    setStudents([data, ...students]);
                    
                    // 延迟关闭表单，确保状态更新完成
                    setTimeout(() => {
                        setShowAddForm(false);
                    }, 100);
                    
                    // 处理缴费和自动同步（异步执行，不阻塞主流程）
                    handleStudentPaymentAndSync(data).catch(error => {
                        console.error('同步财务和考勤记录失败:', error);
                        // 不影响主流程，只记录错误
                    });
                    
                    // 延迟触发全局刷新，确保数据一致性
                    setTimeout(() => {
                        refreshStudentData();
                    }, 200);
                    
                    showToast('添加学生成功！', 'success');
                } catch (error) {
                    console.error('添加学生失败:', error);
                    showToast('添加失败：' + error.message, 'error');
                } finally {
                    setSubmitting(false);
                }
            };

            // 处理学生缴费和自动同步财务、考勤记录
            const handleStudentPaymentAndSync = async (student) => {
                try {
                    console.log('=== 开始同步财务和考勤记录 ===');
                    console.log('学生信息:', student);
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        console.error('❌ 未找到用户信息，无法同步');
                        throw new Error('用户未登录');
                    }
                    console.log('当前用户ID:', user.id);

                    // 如果学生有学费，添加收入记录
                    if (student.monthly_payment && parseFloat(student.monthly_payment) > 0) {
                        const paymentRecord = {
                            user_id: user.id,
                            student_name: student.name,
                            type: '学费收入',
                            amount: student.monthly_payment,
                            status: 'paid',
                            transaction_date: student.registration_date || new Date().toISOString().split('T')[0],
                            payment_method: '现金',
                            notes: `首次缴费 - ${student.name}的${student.monthly_payment}元学费`,
                            source: 'student_payment' // 标记为学生缴费记录
                        };
                        console.log('准备插入学费记录:', paymentRecord);
                        
                        const { data, error } = await supabase
                            .from('transactions')
                            .insert([paymentRecord]);
                        
                        if (error) {
                            console.error('❌ 学费记录插入失败:', error);
                            console.error('错误详情:', JSON.stringify(error, null, 2));
                            throw new Error('学费记录创建失败: ' + error.message);
                        } else {
                            console.log('✅ 学费记录插入成功:', data);
                        }
                        // 创建/更新缴费记录（payment_records）用于续费提醒
                        try {
                            const { error: prError } = await supabase
                                .from('payment_records')
                                .upsert({
                                    student_id: student.id,
                                    user_id: user.id,
                                    status: 'active',
                                    next_due_date: student.next_renewal_date || null
                                }, { onConflict: 'student_id' });
                            if (prError) {
                                console.error('创建/更新缴费记录失败:', prError);
                            } else {
                                console.log('缴费记录已同步到 payment_records');
                            }
                        } catch (e) {
                            console.error('处理缴费记录异常:', e);
                        }
                    } else {
                        console.log('⚠️ 无学费信息，跳过学费记录');
                    }

                    // 创建考勤记录（工作日17:40自动出勤）
                    console.log('开始创建考勤记录...');
                    await createAttendanceRecord(student);
                    console.log('=== 同步流程完成 ===');
                    
                    return { success: true };

                } catch (error) {
                    console.error('❌❌❌ 同步财务和考勤记录失败 ❌❌❌');
                    console.error('错误对象:', error);
                    console.error('错误消息:', error.message);
                    console.error('错误堆栈:', error.stack);
                    console.error('完整错误:', JSON.stringify(error, null, 2));
                    throw error; // 重新抛出错误，让调用方处理
                }
            };

            // 创建考勤记录
            const createAttendanceRecord = async (student) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        console.error('未找到用户信息，无法创建考勤记录');
                        return;
                    }

                    const today = new Date().toISOString().split('T')[0];
                    
                    // 检查学生状态，只有在读学生才创建考勤记录
                    if (student.status !== 'active') {
                        console.log(`学生 ${student.name} 状态为 ${student.status}，不创建考勤记录`);
                        return;
                    }
                    
                    // 只在工作日创建考勤记录
                    if (!isWorkday(today)) {
                        console.log('今天是周末或节假日，不创建考勤记录');
                        return;
                    }
                    
                    console.log('创建考勤记录，日期:', today);
                    
                    // 创建今天的考勤记录（17:30自动出勤）
                    const { data, error } = await supabase
                        .from('attendance_records')
                        .insert([{
                            user_id: user.id,
                            student_name: student.name,
                            attendance_date: today,
                            check_in_time: '17:30',
                            status: 'present'
                        }])
                        .select();
                    
                    if (error) {
                        console.error('创建考勤记录失败:', error);
                        throw new Error('考勤记录创建失败: ' + error.message);
                    }
                    
                    console.log('考勤记录创建成功:', data);
                    
                    // 如果是日托学生，更新剩余天数
                    if (student.daycare_days && parseInt(student.daycare_days) > 0) {
                        const remainingDays = parseInt(student.daycare_days) - 1;
                        await supabase
                            .from('students')
                            .update({ daycare_days: String(remainingDays) }) // 使用daycare_days字段存储日托天数
                            .eq('id', student.id)
                            .eq('user_id', user.id);
                        
                        console.log(`日托学生剩余天数更新: ${student.daycare_days} → ${remainingDays}`);
                        
                        // 如果剩余天数为0，自动暂停
                        if (remainingDays <= 0) {
                            await supabase
                                .from('students')
                                .update({ status: 'suspended' })
                                .eq('id', student.id)
                                .eq('user_id', user.id);
                            
                            console.log(`学生 ${student.name} 日托天数用完，已自动暂停`);
                            showToast(`学生 ${student.name} 日托天数用完，已自动暂停`, 'warning');
                        }
                    }
                } catch (error) {
                    console.error('创建考勤记录失败:', error);
                    // 不抛出错误，避免影响学生创建流程，但记录详细错误信息
                    console.error('错误详情:', error.message);
                }
            };

            const handleEditStudent = async (studentData) => {
                try {
                    setSubmitting(true);
                    const prev = editingStudent;
                    
                    // 如果修改了入学时间或学生类型，需要重新计算缴费日期
                    let updatedData = { ...studentData };
                    
                    // 检查是否需要重新计算缴费日期
                    const shouldRecalculateRenewal = 
                        (studentData.registration_date && studentData.registration_date !== prev.registration_date) ||
                        (studentData.student_type && studentData.student_type !== prev.student_type) ||
                        (studentData.daycare_days && studentData.daycare_days !== prev.daycare_days);
                    
                    if (shouldRecalculateRenewal) {
                        const registrationDate = studentData.registration_date || prev.registration_date;
                        const studentType = studentData.student_type || prev.student_type;
                        const daycareDays = studentData.daycare_days || prev.daycare_days;
                        
                        // 根据学生类型重新计算缴费日期
                        let nextRenewalDate;
                        if (studentType === '日托') {
                            // 日托学生：根据daycare_days天数计算缴费日期
                            const careDays = parseInt(daycareDays) || 1;
                            const startDate = new Date(registrationDate);
                            
                            if (careDays === 1) {
                                // 托管1天：缴费日期为当天
                                nextRenewalDate = registrationDate;
                            } else {
                                // 托管多天：计算工作日
                                nextRenewalDate = getExtendedWorkday(registrationDate, careDays - 1);
                            }
                        } else {
                            // 月托和学期学生：使用原来的月份计算
                            nextRenewalDate = calculateNextRenewalDate(registrationDate);
                        }
                        
                        updatedData.next_renewal_date = nextRenewalDate;
                    }
                    
                    const { data, error } = await supabase
                        .from('students')
                        .update(updatedData)
                        .eq('id', editingStudent.id)
                        .select()
                        .single();

                    if (error) throw error;
                    setStudents(students.map(s => s.id === editingStudent.id ? data : s));
                    setEditingStudent(null);
                    
                    // 触发全局学生数据刷新
                    refreshStudentData();
                    await syncStudentEditChanges(prev, data);
                    
                    showToast('更新学生成功！', 'success');
                } catch (error) {
                    console.error('更新学生失败:', error);
                    showToast('更新失败：' + error.message, 'error');
                } finally {
                    setSubmitting(false);
                }
            };

            const syncStudentEditChanges = async (prev, updated) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;
                    
                    // 同步姓名变更
                    if (prev.name !== updated.name) {
                        await Promise.all([
                            supabase.from('transactions').update({ student_name: updated.name }).eq('user_id', user.id).eq('student_name', prev.name),
                            supabase.from('attendance_records').update({ student_name: updated.name }).eq('user_id', user.id).eq('student_name', prev.name),
                            supabase.from('exam_scores').update({ student_name: updated.name }).eq('user_id', user.id).eq('student_name', prev.name)
                        ]);
                    }
                    
                    // 处理费用变更 - 当费用发生变化时创建新的财务记录
                    const monthlyPaymentChanged = prev.monthly_payment !== updated.monthly_payment;
                    const studentTypeChanged = prev.student_type !== updated.student_type;
                    const daycareDaysChanged = prev.daycare_days !== updated.daycare_days;
                    
                    if (monthlyPaymentChanged || studentTypeChanged || daycareDaysChanged) {
                        console.log('费用信息变更，创建新的财务记录:', {
                            studentName: updated.name,
                            oldType: prev.student_type,
                            newType: updated.student_type,
                            oldAmount: prev.monthly_payment,
                            newAmount: updated.monthly_payment,
                            oldDays: prev.daycare_days,
                            newDays: updated.daycare_days
                        });
                        
                        // 获取当前日期
                        const today = new Date().toISOString().split('T')[0];
                        
                        // 根据学生类型创建相应的财务记录
                        let paymentRecord = {
                            user_id: user.id,
                            student_name: updated.name,
                            type: '学费收入',
                            amount: updated.monthly_payment,
                            status: 'paid',
                            transaction_date: today,
                            payment_method: '现金',
                            notes: '',
                            source: 'student_payment'
                        };
                        
                        // 根据托管类型设置不同的记录信息
                        if (updated.student_type === '日托') {
                            paymentRecord.payment_method = '日托';
                            paymentRecord.notes = `编辑后缴费 - ${updated.name}的${updated.monthly_payment}元日托费用（${updated.daycare_days}天）`;
                        } else if (updated.student_type === '月托') {
                            paymentRecord.payment_method = '月托';
                            paymentRecord.notes = `编辑后缴费 - ${updated.name}的${updated.monthly_payment}元月托费用`;
                        } else if (updated.student_type === '学期') {
                            paymentRecord.payment_method = '学期';
                            paymentRecord.notes = `编辑后缴费 - ${updated.name}的${updated.monthly_payment}元学期费用`;
                        }
                        
                        let newTransactionId = null;
                        
                        // 只有在费用大于0时才创建记录
                        if (parseFloat(updated.monthly_payment) > 0) {
                            // 首先删除相同入学时间的旧记录（保留最新的）
                            console.log('删除相同入学时间的旧记录，学生:', updated.name, '入学时间:', updated.enrollment_date);
                            const { error: deleteError } = await supabase
                                .from('transactions')
                                .delete()
                                .eq('user_id', user.id)
                                .eq('student_name', updated.name)
                                .eq('type', '学费收入')
                                .eq('source', 'student_payment')
                                .ilike('notes', '%编辑后缴费%');
                            
                            if (deleteError) {
                                console.error('删除旧记录失败:', deleteError);
                            } else {
                                console.log('已删除相同入学时间的旧记录');
                            }
                            
                            // 创建新记录
                            const { data: newTransaction, error: txError } = await supabase
                                .from('transactions')
                                .insert([paymentRecord])
                                .select()
                                .single();
                            
                            if (txError) {
                                console.error('创建财务记录失败:', txError);
                                showToast('财务记录创建失败：' + txError.message, 'error');
                            } else {
                                console.log('财务记录创建成功:', newTransaction);
                                console.log('新记录详情:', {
                                    student_name: newTransaction.student_name,
                                    amount: newTransaction.amount,
                                    source: newTransaction.source,
                                    type: newTransaction.type
                                });
                                newTransactionId = newTransaction.id;
                                showToast('财务记录已更新', 'success');
                            }
                        }
                        
                        if (updateError) {
                            console.error('更新现有财务记录失败:', updateError);
                        }
                    }
                    
                    // 同步续费日期到缴费记录
                    if (updated.next_renewal_date) {
                        await supabase
                            .from('payment_records')
                            .upsert({
                                student_id: updated.id,
                                user_id: user.id,
                                status: 'active',
                                next_due_date: updated.next_renewal_date
                            }, { onConflict: 'student_id' });
                    }
                } catch (err) {
                    console.error('同步学生编辑变更失败:', err);
                    showToast('同步变更失败：' + err.message, 'error');
                }
            };

            // 打开删除确认对话框
            const openDeleteConfirm = React.useCallback((id) => {
                console.log('打开删除确认对话框, 学生ID:', id);
                setDeletingStudentId(id);
                setShowDeleteConfirm(true);
            }, []);

            // 关闭删除确认对话框
            const closeDeleteConfirm = React.useCallback(() => {
                console.log('关闭删除确认对话框');
                setShowDeleteConfirm(false);
                setDeletingStudentId(null);
            }, []);

            // 执行删除操作
            const confirmDeleteStudent = React.useCallback(async () => {
                const id = deletingStudentId;
                if (!id) {
                    console.error('没有要删除的学生ID');
                    return;
                }

                try {
                    console.log('=== 开始删除学生 ===', id);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    // 获取要删除的学生信息
                    const studentToDelete = students.find(s => s.id === id);
                    if (!studentToDelete) throw new Error('学生不存在');

                    console.log('=== 开始删除学生及相关记录 ===');
                    console.log('学生信息:', studentToDelete);

                    // 1. 删除财务记录（transactions表）
                    console.log('步骤1: 删除财务记录...');
                    const { error: transError, count: transCount } = await supabase
                        .from('transactions')
                        .delete({ count: 'exact' })
                        .eq('user_id', user.id)
                        .eq('student_name', studentToDelete.name);
                    
                    if (transError) {
                        console.error('删除财务记录失败:', transError);
                        throw new Error('删除财务记录失败: ' + transError.message);
                    }
                    console.log(`已删除 ${transCount || 0} 条财务记录`);

                    // 2. 删除考勤记录（attendance_records表）
                    console.log('步骤2: 删除考勤记录...');
                    const { error: attendError, count: attendCount } = await supabase
                        .from('attendance_records')
                        .delete({ count: 'exact' })
                        .eq('user_id', user.id)
                        .eq('student_name', studentToDelete.name);
                    
                    if (attendError) {
                        console.error('删除考勤记录失败:', attendError);
                        throw new Error('删除考勤记录失败: ' + attendError.message);
                    }
                    console.log(`已删除 ${attendCount || 0} 条考勤记录`);

                    // 3. 删除成绩记录（exam_scores表）
                    console.log('步骤3: 删除成绩记录...');
                    const { error: scoresError, count: scoresCount } = await supabase
                        .from('exam_scores')
                        .delete({ count: 'exact' })
                        .eq('user_id', user.id)
                        .eq('student_name', studentToDelete.name);
                    
                    if (scoresError) {
                        console.error('删除成绩记录失败:', scoresError);
                        // 成绩记录可能不存在，不抛出错误
                        console.log('成绩记录可能不存在，继续执行');
                    } else {
                        console.log(`已删除 ${scoresCount || 0} 条成绩记录`);
                    }

                    // 4. 最后删除学生记录
                    console.log('步骤4: 删除学生记录...');
                    const { error: studentError } = await supabase
                        .from('students')
                        .delete()
                        .eq('id', id);

                    if (studentError) {
                        console.error('删除学生记录失败:', studentError);
                        throw new Error('删除学生记录失败: ' + studentError.message);
                    }
                    console.log('学生记录删除成功');

                    // 更新本地状态
                    setStudents(students.filter(s => s.id !== id));
                    
                    // 触发全局学生数据刷新
                    refreshStudentData();
                    
                    // 显示成功消息
                    const totalDeleted = (transCount || 0) + (attendCount || 0) + (scoresCount || 0) + 1;
                    showToast(`删除成功！共清理 ${totalDeleted} 条相关记录`, 'success');
                    console.log('=== 删除流程完成 ===');
                    
                    // 关闭确认对话框
                    closeDeleteConfirm();

                } catch (error) {
                    console.error('删除学生失败:', error);
                    showToast('删除失败：' + error.message, 'error');
                    closeDeleteConfirm();
                }
            }, [deletingStudentId, students, refreshStudentData, closeDeleteConfirm]);

            // 执行确认后的状态修改
            const handleStatusChangeConfirmed = async (studentId, newStatus) => {
                try {
                    const { data, error } = await supabase
                        .from('students')
                        .update({ status: newStatus })
                        .eq('id', studentId)
                        .select()
                        .single();

                    if (error) throw error;
                    setStudents(students.map(s => s.id === studentId ? data : s));
                    // 非在读状态时停用缴费记录
                    if (newStatus !== 'active') {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (user) {
                            await supabase
                                .from('payment_records')
                                .update({ status: 'inactive' })
                                .eq('student_id', studentId);
                        }
                    }
                } catch (error) {
                    console.error('更新学生状态失败:', error);
                    alert('更新状态失败：' + error.message);
                }
            };

            const handleStatusChange = async (studentId, newStatus) => {
                try {
                    // 直接执行状态修改，移除重新入学确认逻辑
                    await handleStatusChangeConfirmed(studentId, newStatus);
                } catch (error) {
                    console.error('更新学生状态失败:', error);
                    alert('更新状态失败：' + error.message);
                }
            };

            // 计算已消耗天数（当前日期减去缴费日期）
            const calculateConsumedDays = (registrationDate) => {
                if (!registrationDate) {
                    return 0;
                }
                const today = new Date();
                const regDate = new Date(registrationDate);
                const diffTime = Math.abs(today - regDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            // 计算每日消耗金额（已简化，返回固定值）
            const calculateDailyConsumption = (monthlyPayment, date) => {
                // 月托模式不再计算每日消费，返回固定值0
                return 0;
            };

            // 计算学生当前实时余额（已简化）
            const calculateCurrentBalance = (student) => {
                // 返回固定值0，不再进行复杂的余额计算
                return 0;
            };

            // 检查日托学生缴费期限，过期自动暂停
            const checkDaycarePaymentDeadlines = async () => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        console.error('用户未登录，无法检查缴费期限');
                        return;
                    }

                    // 获取所有日托学生
                    const { data: students, error } = await supabase
                        .from('students')
                        .select('*')
                        .eq('user_id', user.id)
                        .eq('student_type', '日托');

                    if (error) {
                        console.error('获取日托学生失败:', error);
                        return;
                    }

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    for (const student of students) {
                        if (student.next_renewal_date) {
                            const nextRenewalDate = new Date(student.next_renewal_date);
                            nextRenewalDate.setHours(0, 0, 0, 0);

                            // 如果过了缴费期限且学生状态是在读，自动暂停
                            if (nextRenewalDate < today && student.status === 'active') {
                                console.log(`学生 ${student.name} 缴费期限已过，自动暂停`);
                                
                                // 更新学生状态为暂停
                                const { error: updateError } = await supabase
                                    .from('students')
                                    .update({ status: 'suspended' })
                                    .eq('id', student.id)
                                    .eq('user_id', user.id);

                                if (updateError) {
                                    console.error(`更新学生 ${student.name} 状态失败:`, updateError);
                                } else {
                                    // 停用缴费记录
                                    await supabase
                                        .from('payment_records')
                                        .update({ status: 'inactive' })
                                        .eq('student_id', student.id);
                                    
                                    showToast(`学生 ${student.name} 缴费期限已过，已自动暂停`, 'warning');
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('检查缴费期限失败:', error);
                }
            };

            const downloadExcelTemplate = () => {
                const template = [
                    ['姓名', '年级', '班级', '学校', '家长', '联系方式', '缴费日期', '续费日期', '缴费金额']
                ];
                const ws = XLSX.utils.aoa_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '学生信息模板');
                XLSX.writeFile(wb, '学生信息导入模板.xlsx');
            };

            const handleExcelImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    setImporting(true);
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            if (jsonData.length <= 1) {
                                alert('Excel文件为空或格式不正确');
                            setImporting(false);
                            setImportProgress(0);
                            setImportStatus('');
                                return;
                            }

                            const { data: { user } } = await supabase.auth.getUser();
                            if (!user) throw new Error('用户未登录');

                            let successCount = 0;
                            let errorCount = 0;
                            let duplicateCount = 0;
                            const errors = [];

                            // 获取所有现有学生姓名用于重名检测
                            const { data: existingStudents } = await supabase
                                .from('students')
                                .select('name, grade, class');

                            const existingNames = new Set();
                            existingStudents.forEach(student => {
                                const key = `${student.name}-${student.grade}-${student.class}`;
                                existingNames.add(key);
                            });

                            const totalRows = jsonData.length - 1;
                            let processedRows = 0;

                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                processedRows++;
                                
                                // 更新进度条和状态
                                const progress = Math.round((processedRows / totalRows) * 100);
                                setImportProgress(progress);
                                setImportStatus(`正在处理第 ${processedRows}/${totalRows} 条记录...`);

                                if (!row[0] || !row[1] || !row[2]) {
                                    errors.push(`第${i+1}行：缺少必填字段（姓名、年级、班级）`);
                                    errorCount++;
                                    continue;
                                }

                                // 重名检测
                                const nameKey = `${row[0]}-${row[1]}-${row[2]}`;
                                if (existingNames.has(nameKey)) {
                                    duplicateCount++;
                                    errors.push(`第${i+1}行（${row[0]}）：该学生已存在（${row[1]}年级${row[2]}班）`);
                                    continue;
                                }

                                const payment = parseFloat(row[8]) || 0;
                                const regDate = row[6] || new Date().toISOString().split('T')[0];

                                const studentData = {
                                    name: row[0],
                                    grade: row[1],
                                    class: row[2],
                                    school: row[3] || '',
                                    parent: row[4] || '',
                                    phone: row[5] || '',
                                    registration_date: regDate,
                                    next_renewal_date: row[7] || null,
                                    monthly_payment: payment,
                                    daily_consumption: 0,
                                    balance: 0,
                                    user_id: user.id,
                                    status: 'active'
                                };

                                try {
                                    const { error } = await supabase
                                        .from('students')
                                        .insert([studentData]);

                                    if (error) throw error;
                                    successCount++;
                                    
                                    // 添加到已存在集合中，避免后续重复
                                    existingNames.add(nameKey);
                                } catch (err) {
                                    errors.push(`第${i+1}行（${row[0]}）：${err.message}`);
                                    errorCount++;
                                }
                            }

                            setImporting(false);
                            setImportProgress(0);
                            setImportStatus('');

                            let message = `导入完成！\n成功：${successCount} 条`;
                            if (duplicateCount > 0) {
                                message += `\n重复跳过：${duplicateCount} 条`;
                            }
                            if (errorCount > 0) {
                                message += `\n失败：${errorCount} 条`;
                            }
                            if (errors.length > 0) {
                                message += `\n\n详情：\n${errors.slice(0, 10).join('\n')}`;
                                if (errors.length > 10) {
                                    message += `\n... 还有 ${errors.length - 10} 条错误信息`;
                                }
                            }
                            alert(message);

                            loadStudents();
                            e.target.value = '';
                        } catch (error) {
                            console.error('解析Excel失败:', error);
                            alert('解析Excel失败：' + error.message);
                            setImporting(false);
                            setImportProgress(0);
                            setImportStatus('');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('读取文件失败:', error);
                    alert('读取文件失败：' + error.message);
                    setImporting(false);
                    setImportProgress(0);
                    setImportStatus('');
                }
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center p-12">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                            <p className="mt-2 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="p-6">
                        <div className="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded">
                            <p className="font-bold">加载失败</p>
                            <p>{error}</p>
                            <button 
                                onClick={loadStudents}
                                className="mt-2 text-sm underline hover:no-underline"
                            >
                                重试
                            </button>
                        </div>
                    </div>
                );
            }

            // 如果是档案视图模式，显示学生档案页面
            if (viewMode === 'profile' && profileStudent) {
                return (
                    <StudentProfilePage
                        student={profileStudent}
                        onBack={() => {
                            setViewMode('list');
                            setProfileStudent(null);
                            loadStudents(); // 刷新学生列表
                        }}
                        onUpdate={(updatedStudent) => {
                            // 更新本地学生列表中的数据
                            setStudents(students.map(s => s.id === updatedStudent.id ? updatedStudent : s));
                            setProfileStudent(updatedStudent);
                        }}
                    />
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-neutral-900">学生管理</h2>
                            <p className="text-neutral-600">管理学生信息和档案</p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <button 
                                onClick={() => downloadExcelTemplate()}
                                className="flex items-center space-x-2 bg-neutral-100 text-neutral-700 px-4 py-2 rounded-lg hover:bg-neutral-200 transition-colors border border-neutral-300"
                            >
                                <DownloadIcon />
                                <span>下载模板</span>
                            </button>
                            <button 
                                onClick={() => document.getElementById('excelFileInput').click()}
                                className="flex items-center space-x-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                            >
                                <UploadIcon />
                                <span>导入Excel</span>
                            </button>
                            <input 
                                id="excelFileInput"
                                type="file" 
                                accept=".xlsx,.xls" 
                                onChange={handleExcelImport}
                                className="hidden"
                            />
                            <button 
                                onClick={() => setShowAddForm(true)}
                                className="flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                            >
                                <PlusIcon />
                                <span>添加学生</span>
                            </button>
                        </div>
                    </div>

                    <div className="glass-morphism rounded-xl p-6">
                        {/* 导入进度条 */}
                        {importing && (
                            <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-sm font-medium text-blue-700">正在导入学生数据...</span>
                                    <span className="text-sm text-blue-600">{importProgress}%</span>
                                </div>
                                <div className="w-full bg-blue-200 rounded-full h-2">
                                    <div 
                                        className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${importProgress}%` }}
                                    ></div>
                                </div>
                                {importStatus && (
                                    <p className="text-xs text-blue-600 mt-2">{importStatus}</p>
                                )}
                            </div>
                        )}
                        
                        <div className="flex flex-col sm:flex-row gap-4 mb-6">
                            <div className="flex-1">
                                <input
                                    type="text"
                                    placeholder="搜索学生姓名、年级或班级..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                />
                            </div>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-neutral-200">
                                        <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">姓名</th>
                                        <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">年级班级</th>
                                        <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">托管方式</th>
                                        <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">学校</th>
                                        <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">下次续费日期</th>
                                        <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">状态</th>
                                        <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredStudents.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" className="py-8 px-4 text-center text-neutral-500">
                                                <div className="flex flex-col items-center justify-center">
                                                    <svg className="w-12 h-12 text-neutral-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                                    </svg>
                                                    <p className="text-lg font-medium">暂无学生数据</p>
                                                    <p className="text-sm text-neutral-400 mt-1">点击"添加学生"按钮创建第一个学生记录</p>
                                                </div>
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredStudents.map((student) => (
                                        <tr key={student.id} className="border-b border-neutral-100 hover:bg-neutral-0 transition-colors">
                                            <td className="py-4 px-4">
                                                <button 
                                                    onClick={() => {
                                                        setProfileStudent(student);
                                                        setViewMode('profile');
                                                    }}
                                                    className="font-medium text-primary-500 hover:text-primary-700 hover:underline text-left transition-colors"
                                                >
                                                    {student.name}
                                                </button>
                                            </td>
                                            <td className="py-4 px-4 text-neutral-700">
                                                {formatGradeClass(student.grade, student.class)}
                                            </td>
                                            <td className="py-4 px-4 text-neutral-700">
                                                <span className={`px-2 py-1 text-xs rounded-full ${
                                                    student.student_type === '日托' ? 'bg-blue-100 text-blue-800' :
                                                    student.student_type === '月托' ? 'bg-green-100 text-green-800' :
                                                    student.student_type === '学期' ? 'bg-purple-100 text-purple-800' :
                                                    'bg-neutral-100 text-neutral-800'
                                                }`}>
                                                    {student.student_type || '-'}
                                                </span>
                                            </td>
                                            <td className="py-4 px-4 text-neutral-700">{student.school || '-'}</td>
                                            <td className="py-4 px-4 text-neutral-700">{student.next_renewal_date || '-'}</td>
                                            <td className="py-4 px-4">
                                                <select
                                                    value={student.status || 'active'}
                                                    onChange={(e) => handleStatusChange(student.id, e.target.value)}
                                                    className={`px-3 py-1 text-xs rounded-full border-0 cursor-pointer ${
                                                        student.status === 'active' ? 'bg-green-100 text-green-800' :
                                                        student.status === 'suspended' ? 'bg-yellow-100 text-yellow-800' :
                                                        student.status === 'transferred' ? 'bg-blue-100 text-blue-800' :
                                                        student.status === 'withdrawn' ? 'bg-red-100 text-red-800' :
                                                        student.status === 'graduated' ? 'bg-purple-100 text-purple-800' :
                                                        'bg-neutral-100 text-neutral-800'
                                                    }`}
                                                >
                                                    <option value="active">在读</option>
                                                    <option value="suspended">暂停</option>
                                                    <option value="transferred">转学</option>
                                                    <option value="withdrawn">退学</option>
                                                    <option value="graduated">毕业</option>
                                                </select>
                                            </td>
                                            <td className="py-4 px-4">
                                                <div className="flex space-x-2">
                                                    <button 
                                                        onClick={() => setEditingStudent(student)}
                                                        className="p-1 text-neutral-600 hover:text-primary-500 transition-colors"
                                                    >
                                                        <EditIcon />
                                                    </button>
                                                    <button 
                                                        onClick={(e) => {
                                                            e.preventDefault();
                                                            e.stopPropagation();
                                                            console.log('删除按钮被点击，学生ID:', student.id);
                                                            openDeleteConfirm(student.id);
                                                        }}
                                                        className="p-1 text-neutral-600 hover:text-red-500 transition-colors"
                                                        title="删除学生"
                                                        type="button"
                                                    >
                                                        <DeleteIcon />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    )))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* 添加/编辑学生表单 */}
                    {(showAddForm || editingStudent) && (
                        <StudentForm 
                            student={editingStudent}
                            onSave={editingStudent ? handleEditStudent : handleAddStudent}
                            onCancel={() => {
                                setShowAddForm(false);
                                setEditingStudent(null);
                            }}
                            submitting={submitting}
                        />
                    )}

                    {/* 学生详情模态框 */}
                    {showDetailModal && selectedStudent && (
                        <StudentDetailModal 
                            student={selectedStudent}
                            onClose={() => {
                                setShowDetailModal(false);
                                setSelectedStudent(null);
                            }}
                        />
                    )}
                    
                    {/* 删除确认对话框 */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="glass-morphism rounded-2xl p-6 max-w-md w-full">
                                <div className="text-center">
                                    <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                        <svg className="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                    </div>
                                    <h3 className="text-xl font-bold mb-2 text-neutral-900">确认删除学生</h3>
                                    <p className="text-neutral-600 mb-6">
                                        此操作将同时删除该学生的所有财务记录、考勤记录和成绩记录，<span className="text-red-600 font-semibold">不可恢复</span>！
                                    </p>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={closeDeleteConfirm}
                                            className="flex-1 px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors"
                                        >
                                            取消
                                        </button>
                                        <button
                                            onClick={confirmDeleteStudent}
                                            className="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                        >
                                            确认删除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 同名学生合并确认对话框 */}
                    {showMergeConfirm && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                            onClick={(e) => {
                                // 点击背景关闭对话框
                                if (e.target === e.currentTarget) {
                                    handleMergeConfirm(null);
                                }
                            }}
                        >
                            <div className="glass-morphism rounded-2xl p-6 max-w-lg w-full relative">
                                {/* 关闭按钮 */}
                                <button
                                    onClick={() => handleMergeConfirm(null)}
                                    className="absolute top-4 right-4 text-neutral-400 hover:text-neutral-600 transition-colors"
                                >
                                    <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                
                                <div className="text-center pr-8">
                                    <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                                        <svg className="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                    </div>
                                    <h3 className="text-xl font-bold mb-4 text-neutral-900">发现同名学生</h3>
                                    <p className="text-neutral-600 mb-4">
                                        发现 {mergeStudents.length} 个同名学生，请选择操作：
                                    </p>
                                    <div className="bg-neutral-50 rounded-lg p-4 mb-6 max-h-40 overflow-y-auto">
                                        {mergeStudents.map((student, index) => (
                                            <div key={student.id} className="flex justify-between items-center py-2 border-b border-neutral-200 last:border-b-0">
                                                <div className="text-left">
                                                    <div className="font-medium text-neutral-900">{student.name}</div>
                                                    <div className="text-sm text-neutral-600">
                                                        {student.grade}{student.class} · 状态: {student.status === 'active' ? '在读' : '暂停'}
                                                    </div>
                                                    {student.parent && (
                                                        <div className="text-xs text-neutral-500">
                                                            家长: {student.parent} {student.phone && `· ${student.phone}`}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <p className="text-sm text-neutral-500 mb-6">
                                        点击"合并"将更新现有学生信息，点击"新建"将创建新的学生记录
                                    </p>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => handleMergeConfirm(false)}
                                            className="flex-1 px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors"
                                        >
                                            新建记录
                                        </button>
                                        <button
                                            onClick={() => handleMergeConfirm(true)}
                                            className="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                                        >
                                            合并更新
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast通知 */}
                    {toast && (
                        <Toast 
                            message={toast.message}
                            type={toast.type}
                            onClose={() => setToast(null)}
                        />
                    )}
                </div>
            );
        };

        // 自动判断学期类型的函数
        const getSemesterType = (date) => {
            const currentDate = new Date(date);
            const month = currentDate.getMonth() + 1; // 1-12
            
            // 春季学期：2月-7月
            if (month >= 2 && month <= 7) {
                return '春季学期';
            }
            // 秋季学期：8月-次年1月
            else {
                return '秋季学期';
            }
        };

        // 获取学期时间范围的函数（基于四川成都地区实际数据）
        const getSemesterDateRange = (semesterType, year) => {
            const currentYear = year || new Date().getFullYear();
            const settings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
            
            // 如果启用了自定义学期时间设置，使用自定义设置
            if (settings.enableCustomSemesterDates) {
                if (semesterType === '春季学期') {
                    return {
                        startDate: settings.springStartDate || `${currentYear}-02-20`,
                        endDate: settings.springEndDate || `${currentYear}-07-10`,
                        description: `${currentYear}年春季学期`
                    };
                } else {
                    return {
                        startDate: settings.autumnStartDate || `${currentYear}-09-01`,
                        endDate: settings.autumnEndDate || `${currentYear + 1}-01-20`,
                        description: `${currentYear}年秋季学期`
                    };
                }
            }
            
            // 默认使用四川成都地区的学期时间
            if (semesterType === '春季学期') {
                return {
                    startDate: `${currentYear}-02-20`, // 春季学期开始（2月20日，符合四川地区2月中下旬开学）
                    endDate: `${currentYear}-07-10`,   // 春季学期结束（7月10日，符合四川地区7月上旬结束）
                    description: `${currentYear}年春季学期`
                };
            } else {
                return {
                    startDate: `${currentYear}-09-01`, // 秋季学期开始（9月1日，四川地区固定开学时间）
                    endDate: `${currentYear + 1}-01-20`, // 秋季学期结束（次年1月20日，符合1月中下旬结束）
                    description: `${currentYear}年秋季学期`
                };
            }
        };

        // 获取当前学期信息的函数
        const getCurrentSemesterInfo = () => {
            const now = new Date();
            const currentYear = now.getFullYear();
            const semesterType = getSemesterType(now);
            const dateRange = getSemesterDateRange(semesterType, currentYear);
            
            return {
                type: semesterType,
                year: currentYear,
                ...dateRange
            };
        };

        // 学生表单组件
        const StudentForm = ({ student, onSave, onCancel, submitting }) => {
            const [formData, setFormData] = useState(student || {
                name: '',
                grade: '',
                class: '6班',
                school: '',
                parent: '',
                phone: '',
                balance: 0,
                registration_date: new Date().toISOString().split('T')[0],
                monthly_payment: 0,
                daily_consumption: 0,
                student_type: '月托',
                daycare_days: '0', // 使用daycare_days字段存储日托天数
            });
            const [showCustomParentInput, setShowCustomParentInput] = useState(false);
            const [customSuffix, setCustomSuffix] = useState('');
            const [showCustomPaymentInput, setShowCustomPaymentInput] = useState(false);
            const [customPayment, setCustomPayment] = useState('');
            const [showSemesterDate, setShowSemesterDate] = useState(false);
            const [semesterDate, setSemesterDate] = useState('');
            const [currentSemesterInfo, setCurrentSemesterInfo] = useState(null);
            
            // 获取系统设置
            const getSettings = () => {
                try {
                    const savedSettings = localStorage.getItem('systemSettings');
                    if (savedSettings) {
                        return JSON.parse(savedSettings);
                    }
                } catch (e) {
                    console.error('Failed to load settings:', e);
                }
                
                // 如果没有保存的设置，返回默认设置
                return {
                    dailyCarePrice: 59,
                    enableSemesterReminder: true,
                    semesterReminderDays: 7,
                    enableCustomSemesterDates: true,
                    springStartDate: '02-20',
                    springEndDate: '07-10',
                    autumnStartDate: '09-01',
                    autumnEndDate: '01-20',
                    enableMonthlyRenewal: true,
                    renewalReminderDays: 3,
                    quickTuitionA: 800,
                    quickTuitionB: 1000,
                    parentTitle: '家长'
                };
            };
            
            // Cookie 工具函数 - 可靠的跨会话存储
            const setCookie = (name, value, days = 365) => {
                try {
                    const expires = new Date();
                    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
                    document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/';
                    console.log('Cookie saved:', name, '=', value);
                } catch (e) {
                    console.error('Failed to save cookie:', e);
                }
            };
            
            const getCookie = (name) => {
                try {
                    const nameEQ = name + '=';
                    const ca = document.cookie.split(';');
                    for (let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) === 0) {
                            const value = decodeURIComponent(c.substring(nameEQ.length, c.length));
                            console.log('Cookie loaded:', name, '=', value);
                            return value;
                        }
                    }
                    console.log('Cookie not found:', name);
                    return '';
                } catch (e) {
                    console.error('Failed to read cookie:', e);
                    return '';
                }
            };
            
            // 从 Cookie 加载自定义记忆
            const loadCustomMemory = (key, defaultValue = '') => {
                const saved = getCookie('student_pref_' + key);
                return saved || defaultValue;
            };
            
            // 保存自定义记忆到 Cookie
            const saveCustomMemory = (key, value) => {
                setCookie('student_pref_' + key, value, 365);
            };

            // 计算每日消耗金额
            const calculateDailyConsumption = (monthlyPayment, date) => {
                if (!monthlyPayment || monthlyPayment <= 0) return 0;
                
                // 获取当月天数
                const dateObj = date ? new Date(date) : new Date();
                const year = dateObj.getFullYear();
                const month = dateObj.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                // 计算每日消耗 = 当月缴费金额 / 当月天数
                return (parseFloat(monthlyPayment) / daysInMonth).toFixed(2);
            };

            // 计算已消耗天数（当前日期减去缴费日期）
            const calculateConsumedDays = (registrationDate) => {
                if (!registrationDate) {
                    return 0;
                }
                const today = new Date();
                const regDate = new Date(registrationDate);
                const diffTime = Math.abs(today - regDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };


            const handleSubmit = (e) => {
                e.preventDefault();
                
                // 根据学生类型计算续费日期
                let nextRenewal;
                if (formData.student_type === '日托') {
                    // 日托学生：基于daycare_days天数计算续费日期
                    const careDays = parseInt(formData.daycare_days) || 1;
                    if (careDays === 1) {
                        // 1天日托：续费日期为当天
                        nextRenewal = new Date().toISOString().split('T')[0];
                    } else {
                        // 多天日托：计算延长的工作日
                        nextRenewal = getExtendedWorkday(new Date(), careDays - 1);
                    }
                } else {
                    // 月托和学期学生：保持原来的月度续费逻辑
                    nextRenewal = calculateNextRenewalDate(formData.registration_date);
                }
                
                onSave({
                    ...formData,
                    daily_consumption: 0, // 固定值0，不再计算每日消耗
                    next_renewal_date: nextRenewal
                });
            };

            // 快捷选择年级
            const handleQuickGrade = (grade) => {
                setFormData({...formData, grade});
            };

            // 家长快捷选择
            const handleParentQuick = (suffix) => {
                if (!formData.name.trim()) {
                    alert('请先输入学生姓名');
                    return;
                }
                setFormData({...formData, parent: formData.name + suffix});
            };

            // 自定义家长称呼
            const handleCustomParent = () => {
                if (!formData.name.trim()) {
                    alert('请先输入学生姓名');
                    return;
                }
                // 加载上次保存的自定义称谓
                const savedSuffix = loadCustomMemory('customParentSuffix', '');
                setCustomSuffix(savedSuffix);
                setShowCustomParentInput(true);
            };

            const confirmCustomParent = () => {
                if (customSuffix.trim()) {
                    setFormData({...formData, parent: formData.name + customSuffix});
                    // 保存自定义称谓到 localStorage
                    saveCustomMemory('customParentSuffix', customSuffix);
                    setShowCustomParentInput(false);
                    setCustomSuffix('');
                }
            };

            // 当月缴费快捷选择（移除余额计算）
            const handleQuickPayment = (amount) => {
                setFormData({
                    ...formData, 
                    monthly_payment: amount,
                    daily_consumption: 0, // 固定值0
                    balance: 0 // 固定值0
                });
            };
            
            // 自定义当月缴费
            const handleCustomPayment = () => {
                // 加载上次保存的自定义缴费金额
                const savedPayment = loadCustomMemory('customPaymentAmount', '');
                setCustomPayment(savedPayment);
                setShowCustomPaymentInput(true);
            };
            
            const confirmCustomPayment = () => {
                console.log('=== confirmCustomPayment called ===');
                console.log('customPayment value:', customPayment);
                
                if (customPayment.trim()) {
                    console.log('customPayment passed trim check');
                    const amount = parseFloat(customPayment) || 0;
                    console.log('parsed amount:', amount);
                    
                    if (amount > 0) {
                        console.log('amount > 0, updating payment amount');
                        setFormData({
                            ...formData, 
                            monthly_payment: amount,
                            daily_consumption: 0, // 固定值0
                            balance: 0 // 固定值0
                        });
                        console.log('formData updated');
                    }
                    // 保存自定义缴费金额到 Cookie
                    console.log('saving to cookie: customPaymentAmount =', customPayment.trim());
                    saveCustomMemory('customPaymentAmount', customPayment.trim());
                    console.log('cookie save called');
                    setShowCustomPaymentInput(false);
                    setCustomPayment('');
                    console.log('=== confirmCustomPayment completed ===');
                } else {
                    console.log('customPayment is empty, not saving');
                }
            };

            // 当月缴费金额变化时更新月缴费金额（移除每日消耗和余额计算）
            const handleMonthlyPaymentChange = (value) => {
                const payment = parseFloat(value) || 0;
                setFormData({
                    ...formData, 
                    monthly_payment: payment,
                    daily_consumption: 0, // 固定值0
                    balance: 0 // 固定值0
                });
            };

            const handleSemesterMembership = () => {
                try {
                    // 获取当前学期信息
                    const semesterInfo = getCurrentSemesterInfo();
                    setCurrentSemesterInfo(semesterInfo);
                    
                    const savedSettings = localStorage.getItem('systemSettings');
                    const cfg = savedSettings ? JSON.parse(savedSettings) : {};
                    
                    // 使用自动判断的学期日期范围
                    setSemesterDate(semesterInfo.endDate);
                    
                    // 设置学期学费，优先使用系统设置中的学期费用，默认3800元
                    const semesterFee = parseFloat(cfg.semesterTuitionFee || 3800);
                    
                    setFormData(prev => ({
                        ...prev,
                        registration_date: semesterInfo.startDate, // 自动填充开始日期
                        next_renewal_date: semesterInfo.endDate,   // 自动填充结束日期
                        monthly_payment: semesterFee // 设置学期学费
                    }));
                    setShowSemesterDate(true);
                } catch (e) {
                    console.error('学期设置失败:', e);
                }
            };

            useEffect(() => {
                if (!student) {
                    try {
                        const savedSettings = localStorage.getItem('systemSettings');
                        if (savedSettings) {
                            const cfg = JSON.parse(savedSettings);
                            const defaultFee = parseFloat(cfg.defaultTuitionFee || 0) || 0;
                            if (defaultFee > 0) {
                                setFormData(prev => ({
                                    ...prev,
                                    monthly_payment: defaultFee,
                                    daily_consumption: 0, // 固定值0
                                    balance: 0 // 固定值0
                                }));
                            }
                        } else {
                            // 如果没有系统设置，设置日托默认值
                            const settings = getSettings();
                            const dailyPrice = settings.dailyCarePrice || 59;
                            setFormData(prev => ({
                                ...prev,
                                student_type: '日托',
                                daycare_days: '1', // 默认1天
                                monthly_payment: dailyPrice, // 默认日托费用
                                daily_consumption: dailyPrice, // 日托每日消费就是当日费用
                                balance: dailyPrice
                            }));
                        }
                    } catch (e) {
                        // 如果获取系统设置失败，设置日托默认值
                        const settings = getSettings();
                        const dailyPrice = settings.dailyCarePrice || 59;
                        setFormData(prev => ({
                            ...prev,
                            student_type: '日托',
                            daycare_days: '1', // 默认1天
                            monthly_payment: dailyPrice, // 默认日托费用
                            daily_consumption: dailyPrice, // 日托每日消费就是当日费用
                            balance: dailyPrice
                        }));
                    }
                }
            }, []);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold text-neutral-900 mb-4">
                            {student ? '编辑学生' : '添加学生'}
                        </h3>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-2">托管方式</label>
                                
                                {/* 托管方式快捷选择按钮 */}
                                <div className="flex gap-2 mb-2">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            const settings = getSettings();
                                            const dailyPrice = settings.dailyCarePrice || 59;
                                            // 日托模式：设置当日结算费用
                                            setFormData(prev => ({
                                                ...prev,
                                                student_type: '日托',
                                                monthly_payment: dailyPrice, // 使用系统设置或默认日托费用
                                                daily_consumption: dailyPrice, // 日托每日消费就是当日费用
                                                balance: dailyPrice,
                                                daycare_days: '1' // 使用daycare_days字段存储日托天数，默认1天
                                            }));
                                        }}
                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                            formData.student_type === '日托' 
                                                ? 'bg-blue-500 text-white shadow-md' 
                                                : 'bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200'
                                        }`}
                                    >
                                        日托
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => {
                                            // 月托模式：设置月度费用
                                            setFormData(prev => ({
                                                ...prev,
                                                student_type: '月托',
                                                monthly_payment: 1000, // 默认月托费用1000元
                                                daily_consumption: parseFloat((1000 / 30).toFixed(2)), // 计算每日消费
                                                balance: 0
                                            }));
                                        }}
                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                            formData.student_type === '月托' 
                                                ? 'bg-green-500 text-white shadow-md' 
                                                : 'bg-green-50 text-green-700 hover:bg-green-100 border border-green-200'
                                        }`}
                                    >
                                        月托
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => {
                                            // 学期模式：显示日期范围选择
                                            setFormData(prev => ({
                                                ...prev,
                                                student_type: '学期'
                                            }));
                                            // 延迟执行，确保状态更新完成后再处理学期逻辑
                                            setTimeout(() => {
                                                handleSemesterMembership(); // 调用学期会员功能
                                            }, 100);
                                        }}
                                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                            formData.student_type === '学期' 
                                                ? 'bg-purple-500 text-white shadow-md' 
                                                : 'bg-purple-50 text-purple-700 hover:bg-purple-100 border border-purple-200'
                                        }`}
                                    >
                                        学期
                                    </button>
                                </div>
                                <p className="text-xs text-neutral-500 mb-4">默认为月托，可根据实际情况选择</p>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">姓名</label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium text-neutral-700 mb-2">年级</label>
                                    
                                    {/* 快捷选择按钮 */}
                                    <div className="flex gap-2 mb-3">
                                        <button
                                            type="button"
                                            onClick={() => handleQuickGrade('三年级')}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.grade === '三年级' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            三年级
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => handleQuickGrade('四年级')}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.grade === '四年级' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            四年级
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => handleQuickGrade('五年级')}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.grade === '五年级' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            五年级
                                        </button>
                                    </div>
                                    
                                    {/* 完整年级选择器 */}
                                    <select
                                        value={formData.grade}
                                        onChange={(e) => setFormData({...formData, grade: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="">选择年级（可选）</option>
                                        <option value="一年级">一年级</option>
                                        <option value="二年级">二年级</option>
                                        <option value="三年级">三年级</option>
                                        <option value="四年级">四年级</option>
                                        <option value="五年级">五年级</option>
                                        <option value="六年级">六年级</option>
                                        <option value="七年级">七年级</option>
                                        <option value="八年级">八年级</option>
                                        <option value="九年级">九年级</option>
                                    </select>
                                </div>
                                
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium text-neutral-700 mb-2">
                                        班级
                                        <span className="text-neutral-400 text-xs ml-1">(可选)</span>
                                    </label>
                                    
                                    {/* 班级快捷选择按钮 */}
                                    <div className="flex gap-2 mb-3">
                                        <button
                                            type="button"
                                            onClick={() => setFormData({...formData, class: '1班'})}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.class === '1班' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            1班
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setFormData({...formData, class: '2班'})}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.class === '2班' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            2班
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setFormData({...formData, class: '3班'})}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.class === '3班' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            3班
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setFormData({...formData, class: '4班'})}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.class === '4班' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            4班
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setFormData({...formData, class: '5班'})}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.class === '5班' 
                                                    ? 'bg-primary-500 text-white shadow-md' 
                                                    : 'bg-primary-50 text-primary-700 hover:bg-primary-100 border border-primary-200'
                                            }`}
                                        >
                                            5班
                                        </button>
                                    </div>
                                    
                                    {/* 班级输入框，默认6班 */}
                                    <input
                                        type="text"
                                        value={formData.class || ''}
                                        onChange={(e) => setFormData({...formData, class: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="输入班级（可选，默认6班）"
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">
                                    学校
                                    <span className="text-neutral-400 text-xs ml-1">(可选)</span>
                                </label>
                                <input
                                    type="text"
                                    value={formData.school || ''}
                                    onChange={(e) => setFormData({...formData, school: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入学校名称"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-2">
                                    家长
                                    <span className="text-neutral-400 text-xs ml-1">(可选)</span>
                                </label>
                                
                                {/* 家长快捷选择按钮 */}
                                <div className="flex gap-2 mb-2">
                                    <button
                                        type="button"
                                        onClick={() => handleParentQuick('爸爸')}
                                        className="flex-1 px-3 py-2 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 transition-all"
                                    >
                                        爸爸
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => handleParentQuick('妈妈')}
                                        className="flex-1 px-3 py-2 rounded-lg text-sm font-medium bg-pink-50 text-pink-700 hover:bg-pink-100 border border-pink-200 transition-all"
                                    >
                                        妈妈
                                    </button>
                                    <button
                                        type="button"
                                        onClick={handleCustomParent}
                                        className="flex-1 px-3 py-2 rounded-lg text-sm font-medium bg-neutral-50 text-neutral-700 hover:bg-neutral-100 border border-neutral-300 transition-all"
                                    >
                                        自定义
                                    </button>
                                </div>
                                
                                <input
                                    type="text"
                                    value={formData.parent}
                                    onChange={(e) => setFormData({...formData, parent: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="可直接输入或使用上方按钮"
                                />
                            </div>
                            

                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">
                                    联系电话
                                    <span className="text-neutral-400 text-xs ml-1">(可选)</span>
                                </label>
                                <input
                                    type="tel"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">入学日期</label>
                                <input
                                    type="date"
                                    value={formData.registration_date || ''}
                                    onChange={(e) => {
                                        const newDate = e.target.value;
                                        const nextRenewal = calculateNextRenewalDate(newDate);
                                        setFormData({
                                            ...formData, 
                                            registration_date: newDate,
                                            daily_consumption: 0, // 固定值0，不再计算每日消耗
                                            balance: 0, // 固定值0，不再计算余额
                                            next_renewal_date: nextRenewal
                                        });
                                    }}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                />
                                <p className="text-xs text-neutral-500 mt-1">入学日期等同首次缴费日期，变更将同步下月缴费日期</p>
                            </div>
                            
                            {/* 学费设置区域 - 根据托管方式动态显示 */}
                            {formData.student_type === '日托' && (
                                <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                                    <label className="block text-base font-bold text-blue-800 mb-2 flex items-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        日托天数设置（按天计费）
                                    </label>
                                    <p className="text-sm text-blue-700 mb-3">选择托管天数，系统将自动计算费用</p>
                                    
                                    {/* 日托快捷天数按钮 */}
                                    <div className="flex gap-2 mb-3">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const settings = getSettings();
                                                const days = 5;
                                                const dailyPrice = settings.dailyCarePrice || 59;
                                                const totalAmount = days * dailyPrice;
                                                setFormData(prev => ({
                                                    ...prev,
                                                    daycare_days: String(days), // 使用daycare_days字段存储日托天数
                                                    monthly_payment: totalAmount,
                                                    daily_consumption: dailyPrice,
                                                    balance: totalAmount
                                                }));
                                            }}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.daily_care_days === 5 
                                                    ? 'bg-blue-600 text-white shadow-md' 
                                                    : 'bg-white text-blue-700 hover:bg-blue-100 border-2 border-blue-300'
                                            }`}
                                        >
                                            5天
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const settings = getSettings();
                                                const days = 10;
                                                const dailyPrice = settings.dailyCarePrice || 59;
                                                const totalAmount = days * dailyPrice;
                                                setFormData(prev => ({
                                                    ...prev,
                                                    daycare_days: String(days), // 使用daycare_days字段存储日托天数
                                                    monthly_payment: totalAmount,
                                                    daily_consumption: dailyPrice,
                                                    balance: totalAmount
                                                }));
                                            }}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.daily_care_days === 10 
                                                    ? 'bg-blue-600 text-white shadow-md' 
                                                    : 'bg-white text-blue-700 hover:bg-blue-100 border-2 border-blue-300'
                                            }`}
                                        >
                                            10天
                                        </button>
                                    </div>
                                    
                                    {/* 自定义天数输入 */}
                                    <div className="mb-3">
                                        <label className="block text-xs font-medium text-blue-700 mb-1">自定义天数</label>
                                        <input
                                            type="number"
                                            value={formData.daycare_days || ''}
                                            onChange={(e) => {
                                                const settings = getSettings();
                                                const days = parseInt(e.target.value) || 0;
                                                const dailyPrice = settings.dailyCarePrice || 59;
                                                const totalAmount = days * dailyPrice;
                                                setFormData(prev => ({
                                                    ...prev,
                                                    daycare_days: String(days), // 使用daycare_days字段存储日托天数
                                                    monthly_payment: totalAmount,
                                                    daily_consumption: dailyPrice,
                                                    balance: totalAmount
                                                }));
                                            }}
                                            className="w-full px-4 py-2 text-lg font-semibold border-2 border-blue-400 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            min="0"
                                            max="365"
                                            placeholder="输入托管天数"
                                        />
                                    </div>
                                    
                                    {/* 费用显示 */}
                                    <div className="bg-white rounded-lg p-3 border border-blue-200">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm text-blue-700">单价：</span>
                                            <span className="text-lg font-semibold text-blue-800">¥{getSettings().dailyCarePrice || 59}/天</span>
                                        </div>
                                        <div className="flex justify-between items-center mt-1">
                                            <span className="text-sm text-blue-700">天数：</span>
                                            <span className="text-lg font-semibold text-blue-800">{formData.daycare_days || 0}天</span>
                                        </div>
                                        <div className="flex justify-between items-center mt-1 border-t border-blue-200 pt-2">
                                            <span className="text-sm font-medium text-blue-800">总计：</span>
                                            <span className="text-xl font-bold text-blue-900">¥{formData.monthly_payment || 0}</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {formData.student_type === '月托' && (
                                <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                                    <label className="block text-base font-bold text-green-800 mb-2 flex items-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        月托费用设置（月度缴费）
                                    </label>
                                    <p className="text-sm text-green-700 mb-3">设置月度缴费金额，系统将自动计算每日消耗和账户余额</p>
                                    
                                    {/* 月托快捷金额按钮 */}
                                    <div className="flex gap-2 mb-3">
                                        <button
                                            type="button"
                                            onClick={() => handleQuickPayment(800)}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.monthly_payment === 800 
                                                    ? 'bg-green-600 text-white shadow-md' 
                                                    : 'bg-white text-green-700 hover:bg-green-100 border-2 border-green-300'
                                            }`}
                                        >
                                            800元
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => handleQuickPayment(1000)}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.monthly_payment === 1000 
                                                    ? 'bg-green-600 text-white shadow-md' 
                                                    : 'bg-white text-green-700 hover:bg-green-100 border-2 border-green-300'
                                            }`}
                                        >
                                            1000元
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => handleQuickPayment(1200)}
                                            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                formData.monthly_payment === 1200 
                                                    ? 'bg-green-600 text-white shadow-md' 
                                                    : 'bg-white text-green-700 hover:bg-green-100 border-2 border-green-300'
                                            }`}
                                        >
                                            1200元
                                        </button>
                                    </div>
                                    
                                    <input
                                        type="number"
                                        value={formData.monthly_payment || ''}
                                        onChange={(e) => handleMonthlyPaymentChange(e.target.value)}
                                        className="w-full px-4 py-3 text-lg font-semibold border-2 border-green-400 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        min="0"
                                        step="0.01"
                                        placeholder="输入月托费用"
                                    />
                                </div>
                            )}

                            {formData.student_type === '学期' && (
                                <div className="bg-purple-50 border-2 border-purple-300 rounded-lg p-4">
                                    <label className="block text-base font-bold text-purple-800 mb-2 flex items-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        学期托管设置（日期范围）
                                    </label>
                                    <p className="text-sm text-purple-700 mb-3">设置学期托管的日期范围和学费</p>
                                    
                                    {/* 学期学费设置 */}
                                    <div className="mb-4">
                                        <label className="block text-xs font-medium text-purple-700 mb-2">学期学费（元）</label>
                                        <div className="flex gap-2 mb-2">
                                            <button
                                                type="button"
                                                onClick={() => setFormData(prev => ({ ...prev, monthly_payment: '3800' }))}
                                                className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                    formData.monthly_payment === '3800'
                                                        ? 'bg-purple-600 text-white'
                                                        : 'bg-purple-200 text-purple-700 hover:bg-purple-300'
                                                }`}
                                            >
                                                3800元
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setFormData(prev => ({ ...prev, monthly_payment: '4200' }))}
                                                className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                    formData.monthly_payment === '4200'
                                                        ? 'bg-purple-600 text-white'
                                                        : 'bg-purple-200 text-purple-700 hover:bg-purple-300'
                                                }`}
                                            >
                                                4200元
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setFormData(prev => ({ ...prev, monthly_payment: '4800' }))}
                                                className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                    formData.monthly_payment === '4800'
                                                        ? 'bg-purple-600 text-white'
                                                        : 'bg-purple-200 text-purple-700 hover:bg-purple-300'
                                                }`}
                                            >
                                                4800元
                                            </button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <input
                                                type="number"
                                                value={formData.monthly_payment || ''}
                                                onChange={(e) => setFormData(prev => ({ ...prev, monthly_payment: e.target.value }))}
                                                className="flex-1 px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="自定义学费金额"
                                                min="0"
                                                step="0.01"
                                            />
                                            <span className="text-sm text-purple-600">元</span>
                                        </div>
                                    </div>
                                    
                                    {/* 学期日期选择 */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label className="block text-xs font-medium text-purple-700 mb-1">学期开始日期</label>
                                            <input
                                                type="date"
                                                value={formData.registration_date || ''}
                                                onChange={(e) => {
                                                    const newDate = e.target.value;
                                                    setFormData(prev => ({ ...prev, registration_date: newDate }));
                                                }}
                                                className="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-medium text-purple-700 mb-1">学期结束日期</label>
                                            <input
                                                type="date"
                                                value={formData.next_renewal_date || ''}
                                                onChange={(e) => {
                                                    const endDate = e.target.value;
                                                    setFormData(prev => ({ ...prev, next_renewal_date: endDate }));
                                                }}
                                                className="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                            />
                                        </div>
                                    </div>
                                    

                                    <div className="text-sm text-purple-600 bg-purple-100 rounded-lg p-3">
                                        <p className="font-medium mb-1">学期托管说明：</p>
                                        <p>• 学期开始日期：学生入学日期</p>
                                        <p>• 学期结束日期：本学期最后一天</p>
                                        <p>• 系统将在学期结束后提醒续费</p>
                                    </div>
                                </div>
                            )}
                            
                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    disabled={submitting}
                                    className={`flex-1 py-2 px-4 rounded-lg transition-colors ${
                                        submitting 
                                            ? 'bg-neutral-400 text-white cursor-not-allowed' 
                                            : 'bg-primary-500 text-white hover:bg-primary-700'
                                    }`}
                                >
                                    {submitting ? '提交中...' : (student ? '保存' : '添加')}
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    disabled={submitting}
                                    className={`flex-1 py-2 px-4 rounded-lg transition-colors ${
                                        submitting
                                            ? 'bg-neutral-100 text-neutral-400 cursor-not-allowed'
                                            : 'bg-neutral-200 text-neutral-700 hover:bg-neutral-300'
                                    }`}
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                        
                        {/* 自定义家长称呼弹窗 */}
                        {showCustomParentInput && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="glass-morphism rounded-xl p-6 w-full max-w-sm m-4">
                                    <h4 className="text-lg font-semibold text-neutral-900 mb-4">自定义家长称呼</h4>
                                    <p className="text-sm text-neutral-600 mb-3">
                                        学生姓名：<span className="font-medium text-neutral-900">{formData.name}</span>
                                    </p>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-neutral-700 mb-2">
                                            请输入称呼（如：爷爷、奶奶、叔叔等）
                                        </label>
                                        <input
                                            type="text"
                                            value={customSuffix}
                                            onChange={(e) => setCustomSuffix(e.target.value)}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            placeholder="输入称呼"
                                            autoFocus
                                        />
                                    </div>
                                    <div className="flex space-x-3">
                                        <button
                                            type="button"
                                            onClick={confirmCustomParent}
                                            className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                                        >
                                            确定
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setShowCustomParentInput(false);
                                                setCustomSuffix('');
                                            }}
                                            className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* 自定义当月缴费弹窗 */}
                        {showCustomPaymentInput && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="glass-morphism rounded-xl p-6 w-full max-w-sm m-4">
                                    <h4 className="text-lg font-semibold text-neutral-900 mb-4">自定义当月缴费</h4>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-neutral-700 mb-2">
                                            请输入缴费金额（元）
                                        </label>
                                        <input
                                            type="number"
                                            value={customPayment}
                                            onChange={(e) => setCustomPayment(e.target.value)}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            placeholder="输入金额"
                                            min="0"
                                            step="0.01"
                                            autoFocus
                                        />
                                    </div>
                                    <div className="flex space-x-3">
                                        <button
                                            type="button"
                                            onClick={confirmCustomPayment}
                                            className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                                        >
                                            确定
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setShowCustomPaymentInput(false);
                                                setCustomPayment('');
                                            }}
                                            className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 学生详情模态框组件
        const StudentDetailModal = ({ student, onClose }) => {
            const [examScores, setExamScores] = useState([]);
            const [attendanceStats, setAttendanceStats] = useState(null);
            const [learningMaterials, setLearningMaterials] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('scores');

            useEffect(() => {
                loadStudentDetails();
            }, [student]);

            const loadStudentDetails = async () => {
                try {
                    setLoading(true);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    // 加载考试分数
                    const { data: scores } = await supabase
                        .from('exam_scores')
                        .select('*')
                        .eq('student_name', student.name)
                        .order('exam_date', { ascending: false });

                    setExamScores(scores || []);

                    // 加载出勤记录统计
                    const { data: attendance } = await supabase
                        .from('attendance_records')
                        .select('*')
                        .eq('student_name', student.name);

                    if (attendance) {
                        const total = attendance.length;
                        const present = attendance.filter(a => a.status === 'present').length;
                        const absent = attendance.filter(a => a.status === 'absent').length;
                        const late = attendance.filter(a => a.status === 'late').length;
                        
                        setAttendanceStats({
                            total,
                            present,
                            absent,
                            late,
                            presentRate: total > 0 ? ((present / total) * 100).toFixed(1) : 0
                        });
                    }

                    // 加载该年级的学习资料
                    const { data: materials } = await supabase
                        .from('files')
                        .select('*')
                        .eq('grade', student.grade)
                        .eq('is_active', true)
                        .order('created_at', { ascending: false });

                    setLearningMaterials(materials || []);
                } catch (error) {
                    console.error('加载学生详情失败:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleDownloadFile = async (file) => {
                try {
                    const { data, error } = await supabase.storage
                        .from('learning-materials')
                        .download(file.file_path);

                    if (error) throw error;

                    // 创建下载链接
                    const url = window.URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.file_name;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // 更新下载次数
                    await supabase
                        .from('files')
                        .update({ download_count: file.download_count + 1 })
                        .eq('id', file.id);
                } catch (error) {
                    console.error('下载文件失败:', error);
                    alert('下载失败：' + error.message);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                        {/* 头部 */}
                        <div className="p-6 border-b border-neutral-200">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h3 className="text-2xl font-bold text-neutral-900">{student.name}</h3>
                                    <p className="text-neutral-600 mt-1">{formatGradeClass(student.grade, student.class)}</p>
                                    {student.school && (
                                        <p className="text-neutral-500 text-sm mt-1">
                                            <span className="inline-flex items-center">
                                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                                </svg>
                                                {student.school}
                                            </span>
                                        </p>
                                    )}
                                </div>
                                <button 
                                    onClick={onClose}
                                    className="text-neutral-400 hover:text-neutral-600 transition-colors"
                                >
                                    <CloseIcon />
                                </button>
                            </div>
                        </div>

                        {/* Tab导航 */}
                        <div className="flex border-b border-neutral-200 px-6">
                            <button
                                onClick={() => setActiveTab('scores')}
                                className={`px-4 py-3 font-medium transition-colors border-b-2 ${
                                    activeTab === 'scores'
                                        ? 'border-primary-500 text-primary-500'
                                        : 'border-transparent text-neutral-600 hover:text-neutral-900'
                                }`}
                            >
                                考试成绩
                            </button>
                            <button
                                onClick={() => setActiveTab('attendance')}
                                className={`px-4 py-3 font-medium transition-colors border-b-2 ${
                                    activeTab === 'attendance'
                                        ? 'border-primary-500 text-primary-500'
                                        : 'border-transparent text-neutral-600 hover:text-neutral-900'
                                }`}
                            >
                                出勤记录
                            </button>
                            <button
                                onClick={() => setActiveTab('materials')}
                                className={`px-4 py-3 font-medium transition-colors border-b-2 ${
                                    activeTab === 'materials'
                                        ? 'border-primary-500 text-primary-500'
                                        : 'border-transparent text-neutral-600 hover:text-neutral-900'
                                }`}
                            >
                                学习资料
                            </button>
                        </div>

                        {/* 内容区域 */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {loading ? (
                                <div className="flex items-center justify-center py-12">
                                    <div className="text-center">
                                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                                        <p className="mt-2 text-neutral-600">加载中...</p>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    {/* 考试成绩标签页 */}
                                    {activeTab === 'scores' && (
                                        <div className="space-y-4">
                                            {examScores.length === 0 ? (
                                                <p className="text-center text-neutral-500 py-8">暂无考试记录</p>
                                            ) : (
                                                <div className="grid gap-4">
                                                    {examScores.map((score) => (
                                                        <div key={score.id} className="glass-morphism rounded-lg p-4">
                                                            <div className="flex justify-between items-start">
                                                                <div className="flex-1">
                                                                    <h4 className="font-semibold text-neutral-900">{score.exam_type}</h4>
                                                                    <p className="text-sm text-neutral-600 mt-1">
                                                                        科目：{score.subject} | 日期：{score.exam_date}
                                                                    </p>
                                                                    {score.notes && (
                                                                        <p className="text-sm text-neutral-500 mt-1">备注：{score.notes}</p>
                                                                    )}
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="text-2xl font-bold text-primary-500">
                                                                        {score.score}
                                                                    </div>
                                                                    <div className="text-sm text-neutral-500">
                                                                        满分 {score.full_score}
                                                                    </div>
                                                                    {score.grade && (
                                                                        <span className="inline-block mt-1 px-2 py-1 text-xs rounded-full bg-primary-50 text-primary-700">
                                                                            {score.grade}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* 出勤记录标签页 */}
                                    {activeTab === 'attendance' && (
                                        <div className="space-y-6">
                                            {attendanceStats ? (
                                                <>
                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                        <div className="glass-morphism rounded-lg p-4">
                                                            <div className="text-sm text-neutral-600">总出勤天数</div>
                                                            <div className="text-2xl font-bold text-neutral-900 mt-1">
                                                                {attendanceStats.total}
                                                            </div>
                                                        </div>
                                                        <div className="glass-morphism rounded-lg p-4">
                                                            <div className="text-sm text-neutral-600">出勤</div>
                                                            <div className="text-2xl font-bold text-green-600 mt-1">
                                                                {attendanceStats.present}
                                                            </div>
                                                        </div>
                                                        <div className="glass-morphism rounded-lg p-4">
                                                            <div className="text-sm text-neutral-600">缺勤</div>
                                                            <div className="text-2xl font-bold text-red-600 mt-1">
                                                                {attendanceStats.absent}
                                                            </div>
                                                        </div>
                                                        <div className="glass-morphism rounded-lg p-4">
                                                            <div className="text-sm text-neutral-600">迟到</div>
                                                            <div className="text-2xl font-bold text-warning mt-1">
                                                                {attendanceStats.late}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="glass-morphism rounded-lg p-4">
                                                        <div className="text-sm text-neutral-600 mb-2">出勤率</div>
                                                        <div className="flex items-center">
                                                            <div className="flex-1 bg-neutral-200 rounded-full h-3 overflow-hidden">
                                                                <div 
                                                                    className="bg-green-500 h-full transition-all duration-500"
                                                                    style={{ width: `${attendanceStats.presentRate}%` }}
                                                                ></div>
                                                            </div>
                                                            <div className="ml-4 text-xl font-bold text-green-600">
                                                                {attendanceStats.presentRate}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                </>
                                            ) : (
                                                <p className="text-center text-neutral-500 py-8">暂无出勤记录</p>
                                            )}
                                        </div>
                                    )}

                                    {/* 学习资料标签页 */}
                                    {activeTab === 'materials' && (
                                        <div className="space-y-4">
                                            {learningMaterials.length === 0 ? (
                                                <p className="text-center text-neutral-500 py-8">暂无学习资料</p>
                                            ) : (
                                                <div className="grid gap-3">
                                                    {learningMaterials.map((file) => (
                                                        <div key={file.id} className="glass-morphism rounded-lg p-4 hover:shadow-lg transition-shadow">
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center flex-1 min-w-0">
                                                                    <FileIcon />
                                                                    <div className="ml-3 flex-1 min-w-0">
                                                                        <h4 className="font-medium text-neutral-900 truncate">{file.file_name}</h4>
                                                                        <p className="text-sm text-neutral-600">
                                                                            {file.subject && `${file.subject} | `}
                                                                            {(file.file_size / 1024 / 1024).toFixed(2)} MB
                                                                            {file.download_count > 0 && ` | 下载 ${file.download_count} 次`}
                                                                        </p>
                                                                        {file.description && (
                                                                            <p className="text-sm text-neutral-500 mt-1">{file.description}</p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => handleDownloadFile(file)}
                                                                    className="ml-4 flex items-center space-x-1 text-primary-500 hover:text-primary-700 transition-colors"
                                                                >
                                                                    <DownloadIcon />
                                                                    <span className="text-sm">下载</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* 底部 */}
                        <div className="p-6 border-t border-neutral-200">
                            <button
                                onClick={onClose}
                                className="w-full bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                            >
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 文件管理组件
        const FileManagement = () => {
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showUploadModal, setShowUploadModal] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [filterGrade, setFilterGrade] = useState('all');
            const [filterSubject, setFilterSubject] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                loadFiles();
            }, []);

            const loadFiles = async () => {
                try {
                    setLoading(true);
                    const { data, error } = await supabase
                        .from('files')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setFiles(data || []);
                } catch (error) {
                    console.error('加载文件失败:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    setUploading(true);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { data: profile } = await supabase
                        .from('user_profiles')
                        .select('full_name')
                        .eq('id', user.id)
                        .single();

                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}_${file.name}`;
                    const filePath = `${user.id}/${fileName}`;

                    const { error: uploadError } = await supabase.storage
                        .from('learning-materials')
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;

                    const fileData = {
                        user_id: user.id,
                        file_name: file.name,
                        file_path: filePath,
                        file_size: file.size,
                        file_type: file.type,
                        grade: document.getElementById('upload_grade').value || null,
                        subject: document.getElementById('upload_subject').value || null,
                        category: document.getElementById('upload_category').value,
                        description: document.getElementById('upload_description').value,
                        uploaded_by: profile?.full_name || '未知',
                        is_active: true,
                        download_count: 0
                    };

                    const { error: dbError } = await supabase
                        .from('files')
                        .insert([fileData]);

                    if (dbError) throw dbError;

                    alert('文件上传成功！');
                    setShowUploadModal(false);
                    loadFiles();
                    e.target.value = '';
                } catch (error) {
                    console.error('上传文件失败:', error);
                    alert('上传失败：' + error.message);
                } finally {
                    setUploading(false);
                }
            };

            const handleDownloadFile = async (file) => {
                try {
                    const { data, error } = await supabase.storage
                        .from('learning-materials')
                        .download(file.file_path);

                    if (error) throw error;

                    const url = window.URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.file_name;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    await supabase
                        .from('files')
                        .update({ download_count: file.download_count + 1 })
                        .eq('id', file.id);

                    loadFiles();
                } catch (error) {
                    console.error('下载文件失败:', error);
                    alert('下载失败：' + error.message);
                }
            };

            const handleDeleteFile = async (file) => {
                if (!confirm('确定要删除这个文件吗？')) return;

                try {
                    await supabase.storage
                        .from('learning-materials')
                        .remove([file.file_path]);

                    await supabase
                        .from('files')
                        .delete()
                        .eq('id', file.id);

                    loadFiles();
                } catch (error) {
                    console.error('删除文件失败:', error);
                    alert('删除失败：' + error.message);
                }
            };

            const filteredFiles = files.filter(file => {
                const matchGrade = filterGrade === 'all' || file.grade === filterGrade;
                const matchSubject = filterSubject === 'all' || file.subject === filterSubject;
                const matchSearch = file.file_name.toLowerCase().includes(searchTerm.toLowerCase());
                return matchGrade && matchSubject && matchSearch;
            });

            if (loading) {
                return (
                    <div className="flex items-center justify-center p-12">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                            <p className="mt-2 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-neutral-900">文件管理</h2>
                            <p className="text-neutral-600">管理学习资料和文件</p>
                        </div>
                        <button 
                            onClick={() => setShowUploadModal(true)}
                            className="flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                        >
                            <UploadIcon />
                            <span>上传文件</span>
                        </button>
                    </div>

                    <div className="glass-morphism rounded-xl p-6">
                        <div className="flex flex-col sm:flex-row gap-4 mb-6">
                            <input
                                type="text"
                                placeholder="搜索文件名..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            />
                            <select
                                value={filterGrade}
                                onChange={(e) => setFilterGrade(e.target.value)}
                                className="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            >
                                <option value="all">所有年级</option>
                                <option value="一年级">一年级</option>
                                <option value="二年级">二年级</option>
                                <option value="三年级">三年级</option>
                                <option value="四年级">四年级</option>
                                <option value="五年级">五年级</option>
                                <option value="六年级">六年级</option>
                                <option value="七年级">七年级</option>
                                <option value="八年级">八年级</option>
                                <option value="九年级">九年级</option>
                            </select>
                            <select
                                value={filterSubject}
                                onChange={(e) => setFilterSubject(e.target.value)}
                                className="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            >
                                <option value="all">所有科目</option>
                                <option value="语文">语文</option>
                                <option value="数学">数学</option>
                                <option value="英语">英语</option>
                                <option value="科学">科学</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>

                        {filteredFiles.length === 0 ? (
                            <p className="text-center text-neutral-500 py-12">暂无文件</p>
                        ) : (
                            <div className="grid gap-4">
                                {filteredFiles.map((file) => (
                                    <div key={file.id} className="glass-morphism rounded-lg p-4 hover:shadow-lg transition-shadow">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center flex-1 min-w-0">
                                                <FileIcon />
                                                <div className="ml-3 flex-1 min-w-0">
                                                    <h4 className="font-medium text-neutral-900 truncate">{file.file_name}</h4>
                                                    <p className="text-sm text-neutral-600">
                                                        {file.grade && `${file.grade} | `}
                                                        {file.subject && `${file.subject} | `}
                                                        {(file.file_size / 1024 / 1024).toFixed(2)} MB
                                                        {file.download_count > 0 && ` | 下载 ${file.download_count} 次`}
                                                    </p>
                                                    {file.description && (
                                                        <p className="text-sm text-neutral-500 mt-1">{file.description}</p>
                                                    )}
                                                    <p className="text-xs text-neutral-400 mt-1">
                                                        上传者：{file.uploaded_by} | {new Date(file.created_at).toLocaleDateString()}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="flex items-center space-x-2 ml-4">
                                                <button
                                                    onClick={() => handleDownloadFile(file)}
                                                    className="p-2 text-primary-500 hover:text-primary-700 transition-colors"
                                                    title="下载"
                                                >
                                                    <DownloadIcon />
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteFile(file)}
                                                    className="p-2 text-red-500 hover:text-red-700 transition-colors"
                                                    title="删除"
                                                >
                                                    <DeleteIcon />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* 上传文件模态框 */}
                    {showUploadModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="glass-morphism rounded-xl p-6 w-full max-w-md">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">上传文件</h3>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">选择文件</label>
                                        <input
                                            type="file"
                                            onChange={handleFileUpload}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                            disabled={uploading}
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">年级</label>
                                        <select
                                            id="upload_grade"
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                        >
                                            <option value="">不限年级</option>
                                            <option value="一年级">一年级</option>
                                            <option value="二年级">二年级</option>
                                            <option value="三年级">三年级</option>
                                            <option value="四年级">四年级</option>
                                            <option value="五年级">五年级</option>
                                            <option value="六年级">六年级</option>
                                            <option value="七年级">七年级</option>
                                            <option value="八年级">八年级</option>
                                            <option value="九年级">九年级</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">科目</label>
                                        <select
                                            id="upload_subject"
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                        >
                                            <option value="">不限科目</option>
                                            <option value="语文">语文</option>
                                            <option value="数学">数学</option>
                                            <option value="英语">英语</option>
                                            <option value="科学">科学</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">分类</label>
                                        <select
                                            id="upload_category"
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                        >
                                            <option value="学习资料">学习资料</option>
                                            <option value="通知文件">通知文件</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">描述</label>
                                        <textarea
                                            id="upload_description"
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                            rows="3"
                                            placeholder="文件描述（可选）"
                                        />
                                    </div>
                                </div>

                                <div className="flex space-x-3 mt-6">
                                    <button
                                        onClick={() => setShowUploadModal(false)}
                                        className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                        disabled={uploading}
                                    >
                                        取消
                                    </button>
                                </div>

                                {uploading && (
                                    <div className="mt-4 text-center text-sm text-neutral-600">
                                        正在上传，请稍候...
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 学习计划管理组件（完整版）
        const StudyPlanManagement = () => {
            const { selectedMonth: globalSelectedMonth, getMonthRange } = React.useContext(GlobalMonthContext);
            const [plans, setPlans] = useState([]);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddModal, setShowAddModal] = useState(false);
            const [importing, setImporting] = useState(false);
            const [editingPlan, setEditingPlan] = useState(null);
            const [filterGrade, setFilterGrade] = useState('all');
            const [filterSubject, setFilterSubject] = useState('all');
            const [filterStatus, setFilterStatus] = useState('all');
            const [viewMode, setViewMode] = useState('list'); // list, calendar, statistics
            const [selectedPlan, setSelectedPlan] = useState(null);
            const [showMaterialsModal, setShowMaterialsModal] = useState(false);
            const [showRecordsModal, setShowRecordsModal] = useState(false);

            // 科目对应的练习类型
            const practiceTypes = {
                '语文': ['控笔', '练字', '听写', '阅读', '作文'],
                '数学': ['基础计算', '校内易错题', '拓展奥数'],
                '英语': ['听读', '记单词', '记短句', '记作文']
            };

            useEffect(() => {
                loadData();
            }, [globalSelectedMonth]); // 当全局月份改变时重新加载数据

            // 图表初始化 useEffect
            useEffect(() => {
                if (viewMode !== 'statistics' || plans.length === 0) return;

                // 使用 setTimeout 确保 DOM 已经渲染
                const timer = setTimeout(() => {
                    initializeCharts();
                }, 100);

                return () => {
                    clearTimeout(timer);
                    destroyCharts();
                };
            }, [viewMode, plans]);

            const destroyCharts = () => {
                if (window.subjectChartInstance) {
                    window.subjectChartInstance.destroy();
                    window.subjectChartInstance = null;
                }
                if (window.statusChartInstance) {
                    window.statusChartInstance.destroy();
                    window.statusChartInstance = null;
                }
                if (window.progressChartInstance) {
                    window.progressChartInstance.destroy();
                    window.progressChartInstance = null;
                }
            };

            const initializeCharts = () => {
                // 销毁旧图表实例
                destroyCharts();

                // 计算统计数据
                const subjectStats = {};
                plans.forEach(plan => {
                    if (!subjectStats[plan.subject]) {
                        subjectStats[plan.subject] = { total: 0 };
                    }
                    subjectStats[plan.subject].total++;
                });

                const statusStats = {
                    '待开始': plans.filter(p => p.status === '待开始').length,
                    '进行中': plans.filter(p => p.status === '进行中').length,
                    '已完成': plans.filter(p => p.status === '已完成').length,
                    '暂停': plans.filter(p => p.status === '暂停').length
                };

                const progressRanges = {
                    '0-20%': plans.filter(p => p.progress >= 0 && p.progress < 20).length,
                    '20-40%': plans.filter(p => p.progress >= 20 && p.progress < 40).length,
                    '40-60%': plans.filter(p => p.progress >= 40 && p.progress < 60).length,
                    '60-80%': plans.filter(p => p.progress >= 60 && p.progress < 80).length,
                    '80-100%': plans.filter(p => p.progress >= 80 && p.progress <= 100).length
                };

                // 科目分布饼图
                const subjectCanvas = document.getElementById('subjectChart');
                if (subjectCanvas) {
                    const subjectCtx = subjectCanvas.getContext('2d');
                    window.subjectChartInstance = new Chart(subjectCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(subjectStats),
                            datasets: [{
                                label: '计划数量',
                                data: Object.values(subjectStats).map(s => s.total),
                                backgroundColor: [
                                    'rgba(139, 92, 246, 0.8)',
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(251, 146, 60, 0.8)',
                                    'rgba(244, 63, 94, 0.8)',
                                ],
                                borderColor: 'rgba(255, 255, 255, 1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: { size: 14 },
                                        padding: 15
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: ${value} 个 (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // 状态分布柱状图
                const statusCanvas = document.getElementById('statusChart');
                if (statusCanvas) {
                    const statusCtx = statusCanvas.getContext('2d');
                    window.statusChartInstance = new Chart(statusCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(statusStats),
                            datasets: [{
                                label: '计划数量',
                                data: Object.values(statusStats),
                                backgroundColor: [
                                    'rgba(156, 163, 175, 0.8)',
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(34, 197, 94, 0.8)',
                                    'rgba(234, 179, 8, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                ],
                                borderColor: [
                                    'rgba(156, 163, 175, 1)',
                                    'rgba(59, 130, 246, 1)',
                                    'rgba(34, 197, 94, 1)',
                                    'rgba(234, 179, 8, 1)',
                                    'rgba(239, 68, 68, 1)',
                                ],
                                borderWidth: 2,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `数量: ${context.parsed.y} 个`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 },
                                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                                },
                                x: {
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }

                // 进度分布柱状图
                const progressCanvas = document.getElementById('progressChart');
                if (progressCanvas) {
                    const progressCtx = progressCanvas.getContext('2d');
                    window.progressChartInstance = new Chart(progressCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(progressRanges),
                            datasets: [{
                                label: '计划数量',
                                data: Object.values(progressRanges),
                                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                                borderColor: 'rgba(139, 92, 246, 1)',
                                borderWidth: 2,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            const total = plans.length;
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `数量: ${value} 个 (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 },
                                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                                },
                                x: {
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
            };

            const loadData = async () => {
                try {
                    setLoading(true);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    // 获取月份范围
                    const { start, end } = getMonthRange();

                    // 加载学习计划（包含关联的学生，按月份筛选）
                    const { data: plansData, error: plansError } = await supabase
                        .from('learning_plans')
                        .select(`
                            *,
                            learning_plan_students(student_id, student_name)
                        `)
                        .eq('user_id', user.id)
                        .gte('start_date', start)
                        .lte('start_date', end)
                        .order('created_at', { ascending: false });

                    if (plansError) throw plansError;

                    // 加载学生数据（只获取已入学并缴费的学生）
                    const { data: studentsData, error: studentsError } = await supabase
                        .from('students')
                        .select('id, name, grade')
                        .eq('user_id', user.id)
                        .not('registration_date', 'is', null)
                        .gt('monthly_payment', 0)
                        .order('name');

                    if (studentsError) throw studentsError;

                    setPlans(plansData || []);
                    setStudents(studentsData || []);
                } catch (error) {
                    console.error('加载数据失败:', error);
                    alert('加载数据失败：' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const downloadExcelTemplate = () => {
                const template = [
                    ['计划标题','年级','科目','练习类型','计划类型','内容','开始日期','结束日期','预计用时(分钟)','难度','学生姓名(逗号分隔)']
                ];
                const ws = XLSX.utils.aoa_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '学习计划模板');
                XLSX.writeFile(wb, '学习计划导入模板.xlsx');
            };

            const handleExcelImport = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                try {
                    setImporting(true);
                    const data = await file.arrayBuffer();
                    const wb = XLSX.read(new Uint8Array(data), { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    if (!rows || rows.length <= 1) {
                        alert('Excel内容为空或格式不正确');
                        setImporting(false);
                        e.target.value='';
                        return;
                    }
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');
                    let ok = 0, fail = 0;
                    for (let i=1;i<rows.length;i++){
                        const r = rows[i];
                        const title = r[0];
                        const grade = parseInt(r[1]);
                        const subject = r[2];
                        const practice_type = r[3] || '';
                        const plan_type = r[4] || '日常练习';
                        const content = r[5] || '';
                        const start_date = r[6] || '';
                        const end_date = r[7] || '';
                        const estimated_time = parseInt(r[8] || 30);
                        const difficulty = r[9] || '中等';
                        const namesStr = r[10] || '';
                        if (!title || !grade || !subject || !start_date || !end_date){ fail++; continue; }
                        const { data: newPlan, error: insErr } = await supabase
                            .from('learning_plans')
                            .insert([{ user_id: user.id, title, grade, subject, practice_type, plan_type, content, start_date, end_date, estimated_time, difficulty, status: '待开始', progress: 0 }])
                            .select()
                            .single();
                        if (insErr){ fail++; continue; }
                        const names = namesStr.split(',').map(s=>s.trim()).filter(Boolean);
                        if (names.length>0){
                            const { data: studs } = await supabase.from('students').select('id,name').eq('user_id', user.id).in('name', names);
                            const recs = (studs||[]).map(s=>({ plan_id: newPlan.id, student_id: s.id, student_name: s.name, user_id: user.id }));
                            if (recs.length>0){ await supabase.from('learning_plan_students').insert(recs); }
                        }
                        ok++;
                    }
                    await loadData();
                    alert(`导入完成：成功 ${ok} 条，失败 ${fail} 条`);
                } catch(err){
                    console.error('导入学习计划失败:', err);
                    alert('导入失败：'+err.message);
                } finally {
                    setImporting(false);
                    e.target.value='';
                }
            };

            const handleSavePlan = async (planData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    if (editingPlan) {
                        // 更新现有计划
                        const { error: updateError } = await supabase
                            .from('learning_plans')
                            .update({
                                title: planData.title,
                                grade: planData.grade,
                                subject: planData.subject,
                                practice_type: planData.practice_type,
                                plan_type: planData.plan_type,
                                content: planData.content,
                                start_date: planData.start_date,
                                end_date: planData.end_date,
                                estimated_time: planData.estimated_time,
                                difficulty: planData.difficulty,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', editingPlan.id);

                        if (updateError) throw updateError;

                        // 更新学生关联
                        await supabase
                            .from('learning_plan_students')
                            .delete()
                            .eq('plan_id', editingPlan.id);

                        if (planData.student_ids && planData.student_ids.length > 0) {
                            const studentRecords = planData.student_ids.map(sid => {
                                const student = students.find(s => s.id === parseInt(sid));
                                return {
                                    plan_id: editingPlan.id,
                                    student_id: parseInt(sid),
                                    student_name: student?.name || '',
                                    user_id: user.id
                                };
                            });

                            const { error: studentsError } = await supabase
                                .from('learning_plan_students')
                                .insert(studentRecords);

                            if (studentsError) throw studentsError;
                        }
                    } else {
                        // 创建新计划
                        const { data: newPlan, error: insertError } = await supabase
                            .from('learning_plans')
                            .insert([{
                                user_id: user.id,
                                title: planData.title,
                                grade: planData.grade,
                                subject: planData.subject,
                                practice_type: planData.practice_type,
                                plan_type: planData.plan_type,
                                content: planData.content,
                                start_date: planData.start_date,
                                end_date: planData.end_date,
                                estimated_time: planData.estimated_time,
                                difficulty: planData.difficulty,
                                status: '待开始',
                                progress: 0
                            }])
                            .select()
                            .single();

                        if (insertError) throw insertError;

                        // 添加学生关联
                        if (planData.student_ids && planData.student_ids.length > 0) {
                            const studentRecords = planData.student_ids.map(sid => {
                                const student = students.find(s => s.id === parseInt(sid));
                                return {
                                    plan_id: newPlan.id,
                                    student_id: parseInt(sid),
                                    student_name: student?.name || '',
                                    user_id: user.id
                                };
                            });

                            const { error: studentsError } = await supabase
                                .from('learning_plan_students')
                                .insert(studentRecords);

                            if (studentsError) throw studentsError;
                        }
                    }

                    setShowAddModal(false);
                    setEditingPlan(null);
                    loadData();
                    alert(editingPlan ? '计划更新成功' : '计划创建成功');
                } catch (error) {
                    console.error('保存学习计划失败:', error);
                    alert('保存失败：' + error.message);
                }
            };

            const handleDeletePlan = async (id) => {
                try {
                    const { error } = await supabase
                        .from('learning_plans')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    await loadData();
                    alert('删除成功');
                } catch (error) {
                    console.error('删除学习计划失败:', error);
                    alert('删除失败：' + error.message);
                }
            };

            const handleUpdateStatus = async (planId, newStatus) => {
                try {
                    const { error } = await supabase
                        .from('learning_plans')
                        .update({ status: newStatus, updated_at: new Date().toISOString() })
                        .eq('id', planId);

                    if (error) throw error;
                    loadData();
                } catch (error) {
                    console.error('更新状态失败:', error);
                    alert('更新失败：' + error.message);
                }
            };

            const handleUpdateProgress = async (planId, newProgress) => {
                try {
                    const updates = { 
                        progress: newProgress,
                        updated_at: new Date().toISOString()
                    };
                    
                    if (newProgress >= 100) {
                        updates.status = '已完成';
                    } else if (newProgress > 0) {
                        updates.status = '进行中';
                    }

                    const { error } = await supabase
                        .from('learning_plans')
                        .update(updates)
                        .eq('id', planId);

                    if (error) throw error;
                    loadData();
                } catch (error) {
                    console.error('更新进度失败:', error);
                    alert('更新失败：' + error.message);
                }
            };

            // 筛选计划
            const filteredPlans = plans.filter(plan => {
                if (filterGrade !== 'all' && plan.grade !== parseInt(filterGrade)) return false;
                if (filterSubject !== 'all' && plan.subject !== filterSubject) return false;
                if (filterStatus !== 'all' && plan.status !== filterStatus) return false;
                return true;
            });

            // 统计数据
            const statistics = {
                total: plans.length,
                pending: plans.filter(p => p.status === '待开始').length,
                inProgress: plans.filter(p => p.status === '进行中').length,
                completed: plans.filter(p => p.status === '已完成').length,
                avgProgress: plans.length > 0 
                    ? (plans.reduce((sum, p) => sum + (p.progress || 0), 0) / plans.length).toFixed(1)
                    : 0
            };

            // 统计分析视图
            const renderStatisticsView = () => {
                // 按科目统计
                const subjectStats = {};
                plans.forEach(plan => {
                    if (!subjectStats[plan.subject]) {
                        subjectStats[plan.subject] = {
                            total: 0,
                            completed: 0,
                            avgProgress: 0,
                            progressSum: 0
                        };
                    }
                    subjectStats[plan.subject].total++;
                    if (plan.status === '已完成') {
                        subjectStats[plan.subject].completed++;
                    }
                    subjectStats[plan.subject].progressSum += plan.progress || 0;
                });

                Object.keys(subjectStats).forEach(subject => {
                    const stats = subjectStats[subject];
                    stats.avgProgress = (stats.progressSum / stats.total).toFixed(1);
                    stats.completionRate = ((stats.completed / stats.total) * 100).toFixed(1);
                });

                // 按状态统计
                const statusStats = {
                    '待开始': plans.filter(p => p.status === '待开始').length,
                    '进行中': plans.filter(p => p.status === '进行中').length,
                    '已完成': plans.filter(p => p.status === '已完成').length,
                    '暂停': plans.filter(p => p.status === '暂停').length
                };

                // 进度分布统计
                const progressRanges = {
                    '0-20%': plans.filter(p => p.progress >= 0 && p.progress < 20).length,
                    '20-40%': plans.filter(p => p.progress >= 20 && p.progress < 40).length,
                    '40-60%': plans.filter(p => p.progress >= 40 && p.progress < 60).length,
                    '60-80%': plans.filter(p => p.progress >= 60 && p.progress < 80).length,
                    '80-100%': plans.filter(p => p.progress >= 80 && p.progress <= 100).length
                };

                return (
                    <div className="space-y-6">
                        <h3 className="text-lg font-semibold text-neutral-900">统计分析</h3>
                        
                        {/* 科目分布饼图 */}
                        <div>
                            <h4 className="text-md font-semibold text-neutral-800 mb-3">科目分布</h4>
                            <div className="glass-morphism rounded-xl p-6">
                                <div style={{ height: '350px', position: 'relative' }}>
                                    <canvas id="subjectChart"></canvas>
                                </div>
                            </div>
                        </div>

                        {/* 科目详细统计 */}
                        <div>
                            <h4 className="text-md font-semibold text-neutral-800 mb-3">科目详细数据</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {Object.keys(subjectStats).map(subject => (
                                    <div key={subject} className="glass-morphism rounded-xl p-4">
                                        <h5 className="font-semibold text-neutral-900 mb-2">{subject}</h5>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-neutral-600">总计划数</span>
                                                <span className="font-semibold text-primary-500">{subjectStats[subject].total}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-neutral-600">已完成</span>
                                                <span className="font-semibold text-green-600">{subjectStats[subject].completed}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-neutral-600">完成率</span>
                                                <span className="font-semibold text-blue-600">{subjectStats[subject].completionRate}%</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-neutral-600">平均进度</span>
                                                <span className="font-semibold text-purple-600">{subjectStats[subject].avgProgress}%</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 状态分布柱状图 */}
                        <div>
                            <h4 className="text-md font-semibold text-neutral-800 mb-3">状态分布</h4>
                            <div className="glass-morphism rounded-xl p-6">
                                <div style={{ height: '300px', position: 'relative' }}>
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>

                        {/* 进度分布柱状图 */}
                        <div>
                            <h4 className="text-md font-semibold text-neutral-800 mb-3">进度分布</h4>
                            <div className="glass-morphism rounded-xl p-6">
                                <div style={{ height: '300px', position: 'relative' }}>
                                    <canvas id="progressChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center p-12">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                            <p className="mt-2 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* 头部 */}
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-neutral-900">学习计划管理</h2>
                            <p className="text-neutral-600">为学生制定和跟踪学习计划</p>
                        </div>
                        <div className="flex gap-2">
                            <button 
                                onClick={() => {
                                    setEditingPlan(null);
                                    setShowAddModal(true);
                                }}
                                className="flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                            >
                                <PlusIcon />
                                <span>新建计划</span>
                            </button>
                            <button
                                onClick={downloadExcelTemplate}
                                className="flex items-center space-x-2 bg-neutral-100 text-neutral-700 px-4 py-2 rounded-lg hover:bg-neutral-200 transition-colors border border-neutral-300"
                            >
                                <DownloadIcon />
                                <span>下载导入模板</span>
                            </button>
                            <button
                                onClick={() => document.getElementById('studyPlanExcelInput').click()}
                                className="flex items-center space-x-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                                disabled={importing}
                            >
                                <UploadIcon />
                                <span>{importing ? '导入中...' : '导入Excel'}</span>
                            </button>
                            <input id="studyPlanExcelInput" type="file" accept=".xlsx,.xls" onChange={handleExcelImport} className="hidden" />
                        </div>
                    </div>

                    {/* 统计卡片 */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div className="glass-morphism rounded-xl p-4">
                            <div className="text-2xl font-bold text-primary-500">{statistics.total}</div>
                            <div className="text-sm text-neutral-600">总计划数</div>
                        </div>
                        <div className="glass-morphism rounded-xl p-4">
                            <div className="text-2xl font-bold text-neutral-500">{statistics.pending}</div>
                            <div className="text-sm text-neutral-600">待开始</div>
                        </div>
                        <div className="glass-morphism rounded-xl p-4">
                            <div className="text-2xl font-bold text-blue-500">{statistics.inProgress}</div>
                            <div className="text-sm text-neutral-600">进行中</div>
                        </div>
                        <div className="glass-morphism rounded-xl p-4">
                            <div className="text-2xl font-bold text-green-500">{statistics.completed}</div>
                            <div className="text-sm text-neutral-600">已完成</div>
                        </div>
                        <div className="glass-morphism rounded-xl p-4">
                            <div className="text-2xl font-bold text-purple-500">{statistics.avgProgress}%</div>
                            <div className="text-sm text-neutral-600">平均进度</div>
                        </div>
                    </div>

                    {/* 视图切换标签 */}
                    <div className="flex space-x-2 border-b border-neutral-200">
                        <button
                            onClick={() => setViewMode('list')}
                            className={`px-4 py-2 font-medium transition-colors ${
                                viewMode === 'list'
                                    ? 'border-b-2 border-primary-500 text-primary-500'
                                    : 'text-neutral-600 hover:text-neutral-900'
                            }`}
                        >
                            计划列表
                        </button>
                        <button
                            onClick={() => setViewMode('statistics')}
                            className={`px-4 py-2 font-medium transition-colors ${
                                viewMode === 'statistics'
                                    ? 'border-b-2 border-primary-500 text-primary-500'
                                    : 'text-neutral-600 hover:text-neutral-900'
                            }`}
                        >
                            统计分析
                        </button>
                    </div>

                    {/* 筛选栏（仅在列表视图显示） */}
                    {viewMode === 'list' && (
                    <div className="glass-morphism rounded-xl p-4">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">年级筛选</label>
                                <select
                                    value={filterGrade}
                                    onChange={(e) => setFilterGrade(e.target.value)}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value="all">所有年级</option>
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(g => (
                                        <option key={g} value={g}>{g}年级</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">科目筛选</label>
                                <select
                                    value={filterSubject}
                                    onChange={(e) => setFilterSubject(e.target.value)}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value="all">所有科目</option>
                                    <option value="语文">语文</option>
                                    <option value="数学">数学</option>
                                    <option value="英语">英语</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">状态筛选</label>
                                <select
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value="all">所有状态</option>
                                    <option value="待开始">待开始</option>
                                    <option value="进行中">进行中</option>
                                    <option value="已完成">已完成</option>
                                    <option value="暂停">暂停</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">显示筛选结果</label>
                                <div className="px-3 py-2 bg-neutral-100 rounded-lg text-neutral-700 font-medium">
                                    共 {filteredPlans.length} 个计划
                                </div>
                            </div>
                        </div>
                    </div>
                    )}

                    {/* 条件渲染不同视图 */}
                    {viewMode === 'list' && (
                    <div className="glass-morphism rounded-xl p-6">
                        {filteredPlans.length === 0 ? (
                            <p className="text-center text-neutral-500 py-12">暂无符合条件的学习计划</p>
                        ) : (
                            <div className="grid gap-4">
                                {filteredPlans.map((plan) => (
                                    <div key={plan.id} className="glass-morphism rounded-lg p-5 hover:shadow-lg transition-shadow">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <h3 className="text-lg font-semibold text-neutral-900">{plan.title}</h3>
                                                    <span className="px-2 py-1 text-xs rounded bg-neutral-100 text-neutral-700">
                                                        {plan.grade}年级
                                                    </span>
                                                    <span className="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">
                                                        {plan.subject}
                                                    </span>
                                                    <span className="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">
                                                        {plan.practice_type}
                                                    </span>
                                                </div>
                                                <p className="text-sm text-neutral-600">
                                                    学生：{plan.learning_plan_students?.map(s => s.student_name).join(', ') || '未分配'} | 
                                                    时间：{plan.start_date} 至 {plan.end_date} | 
                                                    难度：{plan.difficulty} | 
                                                    预计用时：{plan.estimated_time}分钟
                                                </p>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <select
                                                    value={plan.status}
                                                    onChange={(e) => handleUpdateStatus(plan.id, e.target.value)}
                                                    className={`px-3 py-1 text-xs rounded-full border-0 ${
                                                        plan.status === '待开始' ? 'bg-neutral-100 text-neutral-800' :
                                                        plan.status === '进行中' ? 'bg-blue-100 text-blue-800' :
                                                        plan.status === '已完成' ? 'bg-green-100 text-green-800' :
                                                        plan.status === '暂停' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}
                                                >
                                                    <option value="待开始">待开始</option>
                                                    <option value="进行中">进行中</option>
                                                    <option value="已完成">已完成</option>
                                                    <option value="暂停">暂停</option>
                                                </select>
                                            </div>
                                        </div>

                                        {plan.content && (
                                            <p className="text-neutral-700 mb-3 text-sm">{plan.content}</p>
                                        )}

                                        {/* 进度条 */}
                                        <div className="mb-3">
                                            <div className="flex justify-between text-sm text-neutral-600 mb-1">
                                                <span>学习进度</span>
                                                <span>{plan.progress}%</span>
                                            </div>
                                            <div className="w-full bg-neutral-200 rounded-full h-2">
                                                <div 
                                                    className={`h-2 rounded-full transition-all duration-500 ${
                                                        plan.progress >= 100 ? 'bg-green-500' :
                                                        plan.progress >= 50 ? 'bg-blue-500' :
                                                        'bg-primary-500'
                                                    }`}
                                                    style={{ width: `${plan.progress}%` }}
                                                ></div>
                                            </div>
                                        </div>

                                        {/* 操作按钮 */}
                                        <div className="flex items-center justify-between mt-4 pt-4 border-t border-neutral-200">
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    onClick={() => handleUpdateProgress(plan.id, Math.max(0, plan.progress - 10))}
                                                    className="px-3 py-1 text-sm bg-neutral-100 text-neutral-700 rounded hover:bg-neutral-200"
                                                >
                                                    -10%
                                                </button>
                                                <button
                                                    onClick={() => handleUpdateProgress(plan.id, Math.min(100, plan.progress + 10))}
                                                    className="px-3 py-1 text-sm bg-primary-500 text-white rounded hover:bg-primary-600"
                                                >
                                                    +10%
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setSelectedPlan(plan);
                                                        setShowMaterialsModal(true);
                                                    }}
                                                    className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                                >
                                                    学习资料
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setSelectedPlan(plan);
                                                        setShowRecordsModal(true);
                                                    }}
                                                    className="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200"
                                                >
                                                    完成记录
                                                </button>
                                            </div>
                                            <div className="flex space-x-2">
                                                <button
                                                    onClick={() => {
                                                        setEditingPlan(plan);
                                                        setShowAddModal(true);
                                                    }}
                                                    className="p-1 text-neutral-600 hover:text-primary-500"
                                                >
                                                    <EditIcon />
                                                </button>
                                                <button
                                                    onClick={() => handleDeletePlan(plan.id)}
                                                    className="p-1 text-neutral-600 hover:text-red-500"
                                                >
                                                    <DeleteIcon />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    )}

                    {/* 统计分析视图 */}
                    {viewMode === 'statistics' && (
                        <div className="glass-morphism rounded-xl p-6">
                            {renderStatisticsView()}
                        </div>
                    )}

                    {/* 新建/编辑计划模态框 */}
                    {showAddModal && (
                        <LearningPlanForm
                            plan={editingPlan}
                            students={students}
                            practiceTypes={practiceTypes}
                            onSave={handleSavePlan}
                            onCancel={() => {
                                setShowAddModal(false);
                                setEditingPlan(null);
                            }}
                        />
                    )}

                    {/* 学习资料模态框 */}
                    {showMaterialsModal && selectedPlan && (
                        <MaterialsModal
                            plan={selectedPlan}
                            onClose={() => {
                                setShowMaterialsModal(false);
                                setSelectedPlan(null);
                            }}
                            onRefresh={loadData}
                        />
                    )}

                    {/* 完成记录模态框 */}
                    {showRecordsModal && selectedPlan && (
                        <CompletionRecordsModal
                            plan={selectedPlan}
                            students={students}
                            onClose={() => {
                                setShowRecordsModal(false);
                                setSelectedPlan(null);
                            }}
                            onRefresh={loadData}
                        />
                    )}
                </div>
            );
        };        // 学习计划表单组件
        const LearningPlanForm = ({ plan, students, practiceTypes, onSave, onCancel }) => {
            const [formData, setFormData] = useState(plan ? {
                title: plan.title || '',
                grade: plan.grade || 1,
                subject: plan.subject || '语文',
                practice_type: plan.practice_type || '',
                plan_type: plan.plan_type || '日常练习',
                content: plan.content || '',
                start_date: plan.start_date || '',
                end_date: plan.end_date || '',
                estimated_time: plan.estimated_time || 30,
                difficulty: plan.difficulty || '中等',
                student_ids: plan.learning_plan_students?.map(s => s.student_id) || []
            } : {
                title: '',
                grade: 1,
                subject: '语文',
                practice_type: '',
                plan_type: '日常练习',
                content: '',
                start_date: new Date().toISOString().split('T')[0],
                end_date: '',
                estimated_time: 30,
                difficulty: '中等',
                student_ids: []
            });

            // 根据科目更新练习类型选项
            const currentPracticeTypes = practiceTypes[formData.subject] || [];
            
            // 如果切换科目时当前练习类型不在新科目的选项中，重置为第一个选项
            useEffect(() => {
                if (formData.practice_type && !currentPracticeTypes.includes(formData.practice_type)) {
                    setFormData(prev => ({
                        ...prev,
                        practice_type: currentPracticeTypes[0] || ''
                    }));
                }
            }, [formData.subject]);

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!formData.student_ids || formData.student_ids.length === 0) {
                    alert('请至少选择一个学生');
                    return;
                }

                if (!formData.end_date) {
                    alert('请选择结束日期');
                    return;
                }

                if (new Date(formData.end_date) < new Date(formData.start_date)) {
                    alert('结束日期不能早于开始日期');
                    return;
                }

                onSave(formData);
            };

            const toggleStudent = (studentId) => {
                setFormData(prev => {
                    const ids = prev.student_ids || [];
                    const index = ids.indexOf(studentId);
                    if (index > -1) {
                        return { ...prev, student_ids: ids.filter(id => id !== studentId) };
                    } else {
                        return { ...prev, student_ids: [...ids, studentId] };
                    }
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold text-neutral-900 mb-4">
                            {plan ? '编辑学习计划' : '新建学习计划'}
                        </h3>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* 基本信息 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">计划标题</label>
                                    <input
                                        type="text"
                                        value={formData.title}
                                        onChange={(e) => setFormData({...formData, title: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        placeholder="如：三年级语文听写练习计划"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">年级</label>
                                    <select
                                        value={formData.grade}
                                        onChange={(e) => setFormData({...formData, grade: parseInt(e.target.value)})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        required
                                    >
                                        {[1, 2, 3, 4, 5, 6].map(g => (
                                            <option key={g} value={g}>{g}年级</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">科目</label>
                                    <select
                                        value={formData.subject}
                                        onChange={(e) => setFormData({...formData, subject: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        required
                                    >
                                        <option value="语文">语文</option>
                                        <option value="数学">数学</option>
                                        <option value="英语">英语</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">练习类型</label>
                                    <select
                                        value={formData.practice_type}
                                        onChange={(e) => setFormData({...formData, practice_type: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        required
                                    >
                                        <option value="">请选择</option>
                                        {currentPracticeTypes.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">计划类型</label>
                                    <select
                                        value={formData.plan_type}
                                        onChange={(e) => setFormData({...formData, plan_type: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        required
                                    >
                                        <option value="日常练习">日常练习</option>
                                        <option value="周计划">周计划</option>
                                        <option value="月计划">月计划</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">难度等级</label>
                                    <select
                                        value={formData.difficulty}
                                        onChange={(e) => setFormData({...formData, difficulty: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        required
                                    >
                                        <option value="简单">简单</option>
                                        <option value="中等">中等</option>
                                        <option value="困难">困难</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">开始日期</label>
                                    <input
                                        type="date"
                                        value={formData.start_date}
                                        onChange={(e) => setFormData({...formData, start_date: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">结束日期</label>
                                    <input
                                        type="date"
                                        value={formData.end_date}
                                        onChange={(e) => setFormData({...formData, end_date: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        required
                                    />
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">预计完成时间（分钟）</label>
                                    <input
                                        type="number"
                                        value={formData.estimated_time}
                                        onChange={(e) => setFormData({...formData, estimated_time: parseInt(e.target.value)})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        min="1"
                                        required
                                    />
                                </div>

                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">计划内容</label>
                                    <textarea
                                        value={formData.content}
                                        onChange={(e) => setFormData({...formData, content: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                        rows="4"
                                        placeholder="详细描述练习内容、学习目标等..."
                                        required
                                    />
                                </div>
                            </div>

                            {/* 学生选择 */}
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-2">选择学生（可多选）</label>
                                <div className="glass-morphism rounded-lg p-4 max-h-60 overflow-y-auto">
                                    {students.length === 0 ? (
                                        <p className="text-neutral-500 text-center py-4">暂无学生，请先在学生管理中添加学生</p>
                                    ) : (
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                            {students.map(student => (
                                                <label 
                                                    key={student.id}
                                                    className={`flex items-center space-x-2 p-2 rounded cursor-pointer transition-colors ${
                                                        formData.student_ids?.includes(student.id)
                                                            ? 'bg-primary-100 border-2 border-primary-500'
                                                            : 'bg-neutral-50 border-2 border-transparent hover:bg-neutral-100'
                                                    }`}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={formData.student_ids?.includes(student.id) || false}
                                                        onChange={() => toggleStudent(student.id)}
                                                        className="rounded border-neutral-300"
                                                    />
                                                    <span className="text-sm font-medium text-neutral-900">
                                                        {student.name} ({student.grade}年级)
                                                    </span>
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <p className="text-sm text-neutral-500 mt-1">
                                    已选择 {formData.student_ids?.length || 0} 个学生
                                </p>
                            </div>

                            {/* 按钮 */}
                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                                >
                                    {plan ? '保存更改' : '创建计划'}
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 学习资料管理模态框
        const MaterialsModal = ({ plan, onClose, onRefresh }) => {
            const [materials, setMaterials] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddForm, setShowAddForm] = useState(false);
            const [newMaterial, setNewMaterial] = useState({
                material_name: '',
                material_type: 'PDF',
                material_url: ''
            });

            useEffect(() => {
                loadMaterials();
            }, []);

            const loadMaterials = async () => {
                try {
                    setLoading(true);
                    const { data, error } = await supabase
                        .from('learning_plan_materials')
                        .select('*')
                        .eq('plan_id', plan.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setMaterials(data || []);
                } catch (error) {
                    console.error('加载资料失败:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddMaterial = async () => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { error } = await supabase
                        .from('learning_plan_materials')
                        .insert([{
                            plan_id: plan.id,
                            material_name: newMaterial.material_name,
                            material_type: newMaterial.material_type,
                            material_url: newMaterial.material_url,
                            user_id: user.id
                        }]);

                    if (error) throw error;

                    setNewMaterial({ material_name: '', material_type: 'PDF', material_url: '' });
                    setShowAddForm(false);
                    loadMaterials();
                    alert('资料添加成功');
                } catch (error) {
                    console.error('添加资料失败:', error);
                    alert('添加失败：' + error.message);
                }
            };

            const handleDeleteMaterial = async (id) => {
                if (!confirm('确定要删除这个资料吗？')) return;

                try {
                    const { error } = await supabase
                        .from('learning_plan_materials')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    loadMaterials();
                    alert('删除成功');
                } catch (error) {
                    console.error('删除资料失败:', error);
                    alert('删除失败：' + error.message);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-neutral-900">学习资料管理</h3>
                            <button onClick={onClose} className="text-neutral-500 hover:text-neutral-700">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <div className="mb-4 p-4 bg-neutral-50 rounded-lg">
                            <h4 className="font-medium text-neutral-900">{plan.title}</h4>
                            <p className="text-sm text-neutral-600">{plan.subject} - {plan.practice_type}</p>
                        </div>

                        <button
                            onClick={() => setShowAddForm(!showAddForm)}
                            className="mb-4 flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                        >
                            <PlusIcon />
                            <span>添加资料</span>
                        </button>

                        {showAddForm && (
                            <div className="mb-4 p-4 glass-morphism rounded-lg">
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">资料名称</label>
                                        <input
                                            type="text"
                                            value={newMaterial.material_name}
                                            onChange={(e) => setNewMaterial({...newMaterial, material_name: e.target.value})}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                            placeholder="如：第三单元练习题"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">资料类型</label>
                                        <select
                                            value={newMaterial.material_type}
                                            onChange={(e) => setNewMaterial({...newMaterial, material_type: e.target.value})}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                        >
                                            <option value="PDF">PDF</option>
                                            <option value="链接">链接</option>
                                            <option value="图片">图片</option>
                                            <option value="视频">视频</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">资料地址</label>
                                        <input
                                            type="text"
                                            value={newMaterial.material_url}
                                            onChange={(e) => setNewMaterial({...newMaterial, material_url: e.target.value})}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                            placeholder="文件路径或URL"
                                        />
                                    </div>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={handleAddMaterial}
                                            className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600"
                                            disabled={!newMaterial.material_name || !newMaterial.material_url}
                                        >
                                            确认添加
                                        </button>
                                        <button
                                            onClick={() => setShowAddForm(false)}
                                            className="px-4 py-2 bg-neutral-200 text-neutral-700 rounded-lg hover:bg-neutral-300"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {loading ? (
                            <div className="text-center py-8">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                            </div>
                        ) : materials.length === 0 ? (
                            <p className="text-center text-neutral-500 py-8">暂无学习资料</p>
                        ) : (
                            <div className="space-y-2">
                                {materials.map(material => (
                                    <div key={material.id} className="flex items-center justify-between p-3 glass-morphism rounded-lg">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <span className="font-medium text-neutral-900">{material.material_name}</span>
                                                <span className="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">
                                                    {material.material_type}
                                                </span>
                                            </div>
                                            <p className="text-sm text-neutral-600 mt-1 truncate">{material.material_url}</p>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <a
                                                href={material.material_url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                            >
                                                查看
                                            </a>
                                            <button
                                                onClick={() => handleDeleteMaterial(material.id)}
                                                className="p-1 text-neutral-600 hover:text-red-500"
                                            >
                                                <DeleteIcon />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="mt-6 pt-4 border-t border-neutral-200">
                            <button
                                onClick={onClose}
                                className="w-full px-4 py-2 bg-neutral-200 text-neutral-700 rounded-lg hover:bg-neutral-300"
                            >
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            );
        };        // 完成记录管理模态框
        const CompletionRecordsModal = ({ plan, students, onClose, onRefresh }) => {
            const [records, setRecords] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddForm, setShowAddForm] = useState(false);
            const [newRecord, setNewRecord] = useState({
                student_id: '',
                student_name: '',
                time_spent: 0,
                quality_rating: 3,
                notes: ''
            });

            useEffect(() => {
                loadRecords();
            }, []);

            const loadRecords = async () => {
                try {
                    setLoading(true);
                    const { data, error } = await supabase
                        .from('learning_plan_records')
                        .select('*')
                        .eq('plan_id', plan.id)
                        .order('completed_at', { ascending: false });

                    if (error) throw error;
                    setRecords(data || []);
                } catch (error) {
                    console.error('加载完成记录失败:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddRecord = async () => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    if (!newRecord.student_id) {
                        alert('请选择学生');
                        return;
                    }

                    const student = students.find(s => s.id === parseInt(newRecord.student_id));

                    const { error } = await supabase
                        .from('learning_plan_records')
                        .insert([{
                            plan_id: plan.id,
                            student_id: parseInt(newRecord.student_id),
                            student_name: student?.name || '',
                            time_spent: newRecord.time_spent,
                            quality_rating: newRecord.quality_rating,
                            notes: newRecord.notes,
                            user_id: user.id
                        }]);

                    if (error) throw error;

                    setNewRecord({
                        student_id: '',
                        student_name: '',
                        time_spent: 0,
                        quality_rating: 3,
                        notes: ''
                    });
                    setShowAddForm(false);
                    loadRecords();
                    alert('记录添加成功');
                } catch (error) {
                    console.error('添加记录失败:', error);
                    alert('添加失败：' + error.message);
                }
            };

            const handleDeleteRecord = async (id) => {
                if (!confirm('确定要删除这条记录吗？')) return;

                try {
                    const { error } = await supabase
                        .from('learning_plan_records')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    loadRecords();
                    alert('删除成功');
                } catch (error) {
                    console.error('删除记录失败:', error);
                    alert('删除失败：' + error.message);
                }
            };

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const planStudents = students.filter(student => 
                plan.learning_plan_students?.some(ps => ps.student_id === student.id)
            );

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-neutral-900">完成记录</h3>
                            <button onClick={onClose} className="text-neutral-500 hover:text-neutral-700">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <div className="mb-4 p-4 bg-neutral-50 rounded-lg">
                            <h4 className="font-medium text-neutral-900">{plan.title}</h4>
                            <p className="text-sm text-neutral-600">
                                {plan.subject} - {plan.practice_type} | 进度：{plan.progress}%
                            </p>
                        </div>

                        <button
                            onClick={() => setShowAddForm(!showAddForm)}
                            className="mb-4 flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                        >
                            <PlusIcon />
                            <span>添加完成记录</span>
                        </button>

                        {showAddForm && (
                            <div className="mb-4 p-4 glass-morphism rounded-lg">
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">选择学生</label>
                                        <select
                                            value={newRecord.student_id}
                                            onChange={(e) => setNewRecord({...newRecord, student_id: e.target.value})}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                        >
                                            <option value="">请选择学生</option>
                                            {planStudents.map(student => (
                                                <option key={student.id} value={student.id}>
                                                    {student.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">用时（分钟）</label>
                                        <input
                                            type="number"
                                            value={newRecord.time_spent}
                                            onChange={(e) => setNewRecord({...newRecord, time_spent: parseInt(e.target.value)})}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                            min="0"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">
                                            完成质量评分（1-5星）
                                        </label>
                                        <div className="flex items-center space-x-2">
                                            {[1, 2, 3, 4, 5].map(rating => (
                                                <button
                                                    key={rating}
                                                    type="button"
                                                    onClick={() => setNewRecord({...newRecord, quality_rating: rating})}
                                                    className={`text-2xl ${
                                                        newRecord.quality_rating >= rating
                                                            ? 'text-yellow-400'
                                                            : 'text-neutral-300'
                                                    }`}
                                                >
                                                    ★
                                                </button>
                                            ))}
                                            <span className="text-sm text-neutral-600 ml-2">
                                                {newRecord.quality_rating}星
                                            </span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-neutral-700 mb-1">备注</label>
                                        <textarea
                                            value={newRecord.notes}
                                            onChange={(e) => setNewRecord({...newRecord, notes: e.target.value})}
                                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg"
                                            rows="3"
                                            placeholder="记录完成情况、遇到的问题等..."
                                        />
                                    </div>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={handleAddRecord}
                                            className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600"
                                        >
                                            确认添加
                                        </button>
                                        <button
                                            onClick={() => setShowAddForm(false)}
                                            className="px-4 py-2 bg-neutral-200 text-neutral-700 rounded-lg hover:bg-neutral-300"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {loading ? (
                            <div className="text-center py-8">
                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                            </div>
                        ) : records.length === 0 ? (
                            <p className="text-center text-neutral-500 py-8">暂无完成记录</p>
                        ) : (
                            <div className="space-y-3">
                                {records.map(record => (
                                    <div key={record.id} className="glass-morphism rounded-lg p-4">
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className="font-medium text-neutral-900">{record.student_name}</span>
                                                    <span className="text-sm text-neutral-500">
                                                        {formatDate(record.completed_at)}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-4 text-sm text-neutral-600">
                                                    <span>用时：{record.time_spent}分钟</span>
                                                    <div className="flex items-center">
                                                        <span className="mr-1">质量：</span>
                                                        {[1, 2, 3, 4, 5].map(star => (
                                                            <span
                                                                key={star}
                                                                className={star <= record.quality_rating ? 'text-yellow-400' : 'text-neutral-300'}
                                                            >
                                                                ★
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => handleDeleteRecord(record.id)}
                                                className="p-1 text-neutral-600 hover:text-red-500"
                                            >
                                                <DeleteIcon />
                                            </button>
                                        </div>
                                        {record.notes && (
                                            <p className="text-sm text-neutral-700 mt-2 p-2 bg-neutral-50 rounded">
                                                {record.notes}
                                            </p>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="mt-6 pt-4 border-t border-neutral-200">
                            <button
                                onClick={onClose}
                                className="w-full px-4 py-2 bg-neutral-200 text-neutral-700 rounded-lg hover:bg-neutral-300"
                            >
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 收支管理组件
        const IncomeExpenseManagement = () => {
            const { selectedMonth: globalSelectedMonth, getMonthRange } = React.useContext(GlobalMonthContext);
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                loadTransactions();
            }, [globalSelectedMonth]);

            const loadTransactions = async () => {
                try {
                    setLoading(true);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { start, end } = getMonthRange();

                    const { data, error } = await supabase
                        .from('transactions')
                        .select('*')
                        .eq('user_id', user.id)
                        .gte('transaction_date', start)
                        .lte('transaction_date', end)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setTransactions(data || []);
                } catch (error) {
                    console.error('加载收入记录失败:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filteredTransactions = transactions.filter(t => 
                !searchTerm || t.student_name?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const totalIncome = transactions.filter(t => t.status === 'paid').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

            if (loading) {
                return (
                    <div className="flex items-center justify-center py-20">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                            <p className="mt-4 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-2xl font-bold text-neutral-900">收支管理</h2>
                            <p className="text-neutral-600">学生缴费记录管理</p>
                        </div>
                    </div>

                    <div className="glass-morphism rounded-xl p-6">
                        <div className="mb-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">当月总收入</p>
                                    <p className="text-3xl font-bold text-green-600">¥{totalIncome.toFixed(2)}</p>
                                </div>
                                <input
                                    type="text"
                                    placeholder="搜索学生姓名..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                />
                            </div>
                        </div>

                        <div className="overflow-x-auto">
                            {filteredTransactions.length === 0 ? (
                                <p className="text-neutral-500 text-center py-8">暂无收入记录</p>
                            ) : (
                                <table className="w-full">
                                    <thead>
                                        <tr className="border-b border-neutral-200">
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">学生姓名</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">缴费日期</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">金额</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">支付方式</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">状态</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">备注</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredTransactions.map((transaction) => (
                                            <tr key={transaction.id} className="border-b border-neutral-100 hover:bg-neutral-0 transition-colors">
                                                <td className="py-4 px-4 font-medium text-neutral-900">{transaction.student_name}</td>
                                                <td className="py-4 px-4 text-neutral-700">
                                                    {new Date(transaction.transaction_date).toLocaleDateString('zh-CN')}
                                                </td>
                                                <td className="py-4 px-4">
                                                    <span className="font-medium text-green-600">
                                                        ¥{parseFloat(transaction.amount || 0).toFixed(2)}
                                                    </span>
                                                </td>
                                                <td className="py-4 px-4 text-neutral-700">{transaction.payment_method || '-'}</td>
                                                <td className="py-4 px-4">
                                                    <span className={`px-3 py-1 text-xs rounded-full ${
                                                        transaction.status === 'paid' ? 'bg-green-100 text-green-800' :
                                                        transaction.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}>
                                                        {transaction.status === 'paid' ? '已支付' :
                                                         transaction.status === 'pending' ? '待支付' : '逾期'}
                                                    </span>
                                                </td>
                                                <td className="py-4 px-4 text-neutral-700">{transaction.notes || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 财务管理组件
        const Finance = () => {
            const { selectedMonth: globalSelectedMonth, getMonthRange, studentDataRefresh } = React.useContext(GlobalMonthContext);
            const [activeTab, setActiveTab] = useState('income');
            const [transactions, setTransactions] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showExpenseForm, setShowExpenseForm] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [showIncomeForm, setShowIncomeForm] = useState(false);
            const [editingIncome, setEditingIncome] = useState(null);
            const [showDeleteIncomeConfirm, setShowDeleteIncomeConfirm] = useState(false);
            const [deletingIncomeId, setDeletingIncomeId] = useState(null);
            const [showDeleteExpenseConfirm, setShowDeleteExpenseConfirm] = useState(false);
            const [deletingExpenseId, setDeletingExpenseId] = useState(null);
            const [filterStatus, setFilterStatus] = useState('all');
            const [refreshTrigger, setRefreshTrigger] = useState(0); // 用于手动刷新数据

            useEffect(() => {
                loadData();
            }, [globalSelectedMonth, refreshTrigger, studentDataRefresh]); // 当全局月份改变、手动刷新或学生数据更新时重新加载数据

            const loadData = async () => {
                try {
                    setLoading(true);
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    // 获取月份范围
                    const { start, end } = getMonthRange();

                    const [transRes, expensesRes, studRes] = await Promise.all([
                        supabase.from('transactions').select('*')
                            .eq('user_id', user.id)
                            .gte('transaction_date', start)
                            .lte('transaction_date', end)
                            .order('created_at', { ascending: false }),
                        supabase.from('expenses').select('*')
                            .eq('user_id', user.id)
                            .gte('expense_date', start)
                            .lte('expense_date', end)
                            .order('expense_date', { ascending: false }),
                        // 获取所有在读学生（所有在读学生都应出现在财务管理中）
                        supabase.from('students').select('*')
                            .eq('user_id', user.id)
                            .eq('status', 'active')
                            .order('name')
                    ]);

                    if (transRes.error) throw transRes.error;
                    if (expensesRes.error) throw expensesRes.error;
                    if (studRes.error) throw studRes.error;

                    console.log('[财务管理] 获取到的学生列表:', studRes.data);
                    console.log('[财务管理] 学生数量:', studRes.data ? studRes.data.length : 0);
                    console.log('[财务管理] 获取到的交易记录:', transRes.data);
                    console.log('[财务管理] 交易记录数量:', transRes.data ? transRes.data.length : 0);
                    setTransactions(transRes.data || []);
                    setExpenses(expensesRes.data || []);
                    setStudents(studRes.data || []);
                } catch (error) {
                    console.error('加载财务数据失败:', error);
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            const activeNames = new Set(students.map(s => s.name));
            console.log('[财务管理] 在读学生名单:', Array.from(activeNames));
            console.log('[财务管理] 所有交易记录:', transactions);
            
            const filteredTransactions = transactions.filter(t => {
                const statusOk = filterStatus === 'all' || t.status === filterStatus;
                // 对于学生缴费记录，检查学生是否在当前在读学生列表中
                // 对于手动添加的收入记录，显示所有记录
                const isActiveStudent = t.student_name ? activeNames.has(t.student_name) : true;
                const isManualIncome = t.source === 'manual_income';
                const isStudentPayment = t.source === 'student_payment';
                const shouldShow = statusOk && (isManualIncome || isStudentPayment || isActiveStudent);
                
                if (!shouldShow && t.student_name) {
                    console.log(`[财务管理] 过滤掉交易记录: ${t.student_name}, 原因: 状态=${t.status}, 在读=${isActiveStudent}, 手动=${isManualIncome}, 学生缴费=${isStudentPayment}, 来源=${t.source}`);
                }
                
                return shouldShow;
            });
            
            console.log('[财务管理] 过滤后的交易记录数量:', filteredTransactions.length);
            const filteredExpenses = expenses;

            // 计算收入数据
            const totalRevenue = transactions.filter(t => t.status === 'paid').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const pendingAmount = transactions.filter(t => t.status === 'pending').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const overdueAmount = transactions.filter(t => t.status === 'overdue').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            // 计算支出数据
            const totalExpense = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            
            // 计算收支平衡
            const balance = totalRevenue - totalExpense;

            const handleUpdateStatus = async (id, newStatus) => {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .update({ status: newStatus })
                        .eq('id', id);

                    if (error) throw error;
                    setTransactions(transactions.map(t => 
                        t.id === id ? { ...t, status: newStatus } : t
                    ));
                } catch (error) {
                    console.error('更新状态失败:', error);
                    alert('更新失败：' + error.message);
                }
            };

            const handleAddExpense = async (expenseData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { data, error } = await supabase
                        .from('expenses')
                        .insert([{
                            ...expenseData,
                            user_id: user.id,
                            expense_date: expenseData.expense_date || new Date().toISOString().split('T')[0]
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    setExpenses([data, ...expenses]);
                    setShowExpenseForm(false);
                } catch (error) {
                    console.error('添加支出失败:', error);
                    alert('添加失败：' + error.message);
                }
            };

            const handleUpdateExpense = async (expenseData) => {
                try {
                    const { error } = await supabase
                        .from('expenses')
                        .update(expenseData)
                        .eq('id', editingExpense.id);

                    if (error) throw error;
                    setExpenses(expenses.map(e => 
                        e.id === editingExpense.id ? { ...e, ...expenseData } : e
                    ));
                    setEditingExpense(null);
                } catch (error) {
                    console.error('更新支出失败:', error);
                    alert('更新失败：' + error.message);
                }
            };

            const handleDeleteExpense = async (id) => {
                console.log('handleDeleteExpense被调用，ID:', id);
                setShowDeleteExpenseConfirm(true);
                setDeletingExpenseId(id);
            };

            const confirmDeleteExpense = async () => {
                if (!deletingExpenseId) return;
                
                console.log('开始删除支出记录，ID:', deletingExpenseId);
                try {
                    const { error } = await supabase
                        .from('expenses')
                        .delete()
                        .eq('id', deletingExpenseId);

                    if (error) {
                        console.error('删除时发生错误:', error);
                        throw error;
                    }
                    console.log('删除成功，更新本地状态');
                    setExpenses(expenses.filter(e => e.id !== deletingExpenseId));
                    console.log('本地状态已更新');
                    setShowDeleteExpenseConfirm(false);
                    setDeletingExpenseId(null);
                } catch (error) {
                    console.error('删除支出失败:', error);
                    alert('删除失败：' + error.message);
                    setShowDeleteExpenseConfirm(false);
                    setDeletingExpenseId(null);
                }
            };

            const closeDeleteExpenseConfirm = () => {
                setShowDeleteExpenseConfirm(false);
                setDeletingExpenseId(null);
            };

            // 添加收入记录
            const handleAddIncome = async (incomeData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { data, error } = await supabase
                        .from('transactions')
                        .insert([{
                            ...incomeData,
                            user_id: user.id,
                            source: 'manual_income', // 标记为手动添加的收入
                            transaction_date: incomeData.transaction_date || new Date().toISOString().split('T')[0]
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    setTransactions([data, ...transactions]);
                    setShowIncomeForm(false);
                    try {
                        if (incomeData.student_name && incomeData.type === '学费收入') {
                            const next = calculateNextRenewalDate(incomeData.transaction_date || new Date().toISOString().split('T')[0]);
                            const { data: stud } = await supabase
                                .from('students')
                                .select('id')
                                .eq('user_id', user.id)
                                .eq('name', incomeData.student_name)
                                .maybeSingle();
                            await supabase.from('students').update({ next_renewal_date: next }).eq('user_id', user.id).eq('name', incomeData.student_name);
                            if (stud?.id) {
                                await supabase.from('payment_records').upsert({ student_id: stud.id, user_id: user.id, status: 'active', next_due_date: next }, { onConflict: 'student_id' });
                            }
                        }
                    } catch(e) {}
                    alert('添加成功');
                } catch (error) {
                    console.error('添加收入失败:', error);
                    alert('添加失败：' + error.message);
                }
            };

            // 更新收入记录
            const handleUpdateIncome = async (incomeData) => {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .update(incomeData)
                        .eq('id', editingIncome.id);

                    if (error) throw error;
                    setTransactions(transactions.map(t => 
                        t.id === editingIncome.id ? { ...t, ...incomeData } : t
                    ));
                    try {
                        if (incomeData.student_name && incomeData.type === '学费收入') {
                            const next = calculateNextRenewalDate(incomeData.transaction_date || new Date().toISOString().split('T')[0]);
                            const { data: { user } } = await supabase.auth.getUser();
                            if (user) {
                                await supabase.from('students').update({ next_renewal_date: next }).eq('user_id', user.id).eq('name', incomeData.student_name);
                                await supabase.from('payment_records').upsert({ student_id: editingIncome?.student_id || null, user_id: user.id, status: 'active', next_due_date: next }, { onConflict: 'student_id' });
                            }
                        }
                    } catch(e) {}
                    setEditingIncome(null);
                    alert('更新成功');
                } catch (error) {
                    console.error('更新收入失败:', error);
                    alert('更新失败：' + error.message);
                }
            };

            // 删除收入记录
            const handleDeleteIncome = async (id, source) => {
                setShowDeleteIncomeConfirm(true);
                setDeletingIncomeId(id);
            };

            const confirmDeleteIncome = async () => {
                if (!deletingIncomeId) return;
                
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .delete()
                        .eq('id', deletingIncomeId);

                    if (error) throw error;
                    setTransactions(transactions.filter(t => t.id !== deletingIncomeId));
                    setShowDeleteIncomeConfirm(false);
                    setDeletingIncomeId(null);
                    alert('删除成功');
                } catch (error) {
                    console.error('删除收入失败:', error);
                    alert('删除失败：' + error.message);
                    setShowDeleteIncomeConfirm(false);
                    setDeletingIncomeId(null);
                }
            };

            const closeDeleteIncomeConfirm = () => {
                setShowDeleteIncomeConfirm(false);
                setDeletingIncomeId(null);
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center p-12">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                            <p className="mt-2 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="p-6">
                        <div className="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded">
                            <p className="font-bold">加载失败</p>
                            <p>{error}</p>
                            <button onClick={loadData} className="mt-2 text-sm underline">重试</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-neutral-900">财务管理</h2>
                            <p className="text-neutral-600">收入支出统一管理与分析</p>
                        </div>
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => setRefreshTrigger(prev => prev + 1)}
                                className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex items-center gap-2"
                                title="刷新学生列表和财务数据"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                <span className="hidden sm:inline">刷新数据</span>
                            </button>
                            <span className="text-sm text-neutral-600">
                                当前显示: {globalSelectedMonth === 'all' ? '全部月份' : globalSelectedMonth}
                            </span>
                        </div>
                    </div>

                    {/* 财务概览 - 收支平衡对比 */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">总收入</p>
                                    <p className="text-2xl font-bold text-green-600">¥{totalRevenue.toFixed(2)}</p>
                                </div>
                                <div className="p-3 rounded-lg bg-green-500 text-white">
                                    <FinanceIcon />
                                </div>
                            </div>
                        </div>
                        
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">总支出</p>
                                    <p className="text-2xl font-bold text-red-600">¥{totalExpense.toFixed(2)}</p>
                                </div>
                                <div className="p-3 rounded-lg bg-red-500 text-white">
                                    <FinanceIcon />
                                </div>
                            </div>
                        </div>

                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">收支平衡</p>
                                    <p className={`text-2xl font-bold ${balance >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                        ¥{balance.toFixed(2)}
                                    </p>
                                </div>
                                <div className={`p-3 rounded-lg ${balance >= 0 ? 'bg-blue-500' : 'bg-orange-500'} text-white`}>
                                    <FinanceIcon />
                                </div>
                            </div>
                        </div>
                        
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">待收金额</p>
                                    <p className="text-2xl font-bold text-yellow-600">¥{pendingAmount.toFixed(2)}</p>
                                </div>
                                <div className="p-3 rounded-lg bg-yellow-500 text-white">
                                    <FinanceIcon />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 标签页切换 */}
                    <div className="glass-morphism rounded-xl p-2">
                        <div className="flex gap-2">
                            <button
                                onClick={() => setActiveTab('income')}
                                className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all ${
                                    activeTab === 'income'
                                        ? 'bg-primary-500 text-white shadow-md'
                                        : 'text-neutral-600 hover:bg-neutral-100'
                                }`}
                            >
                                收入记录
                            </button>
                            <button
                                onClick={() => setActiveTab('expense')}
                                className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all ${
                                    activeTab === 'expense'
                                        ? 'bg-primary-500 text-white shadow-md'
                                        : 'text-neutral-600 hover:bg-neutral-100'
                                }`}
                            >
                                支出记录
                            </button>
                            <button
                                onClick={() => setActiveTab('comparison')}
                                className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all ${
                                    activeTab === 'comparison'
                                        ? 'bg-primary-500 text-white shadow-md'
                                        : 'text-neutral-600 hover:bg-neutral-100'
                                }`}
                            >
                                收支对比
                            </button>
                        </div>
                    </div>

                    {/* 收入管理标签页 */}
                    {activeTab === 'income' && (
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                                <h3 className="text-lg font-semibold text-neutral-900">收入记录</h3>
                                <button 
                                    onClick={() => setShowIncomeForm(true)}
                                    className="flex items-center space-x-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                                >
                                    <PlusIcon />
                                    <span>添加收入</span>
                                </button>
                            </div>

                            <div className="glass-morphism rounded-xl p-6">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                    <h3 className="text-lg font-semibold text-neutral-900">交易记录</h3>
                                    <select
                                        value={filterStatus}
                                        onChange={(e) => setFilterStatus(e.target.value)}
                                        className="px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="all">全部状态</option>
                                        <option value="paid">已支付</option>
                                        <option value="pending">待支付</option>
                                        <option value="overdue">逾期</option>
                                    </select>
                                </div>

                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-neutral-200">
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">学生</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">类型</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">金额</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">日期</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">来源</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">状态</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredTransactions.length === 0 ? (
                                                <tr>
                                                    <td colSpan="7" className="py-8 text-center text-neutral-500">暂无收入记录</td>
                                                </tr>
                                            ) : (
                                                filteredTransactions.map((transaction) => {
                                                    // 判断记录来源：如果有source字段使用source，否则基于notes判断
                                                    const recordSource = transaction.source || 
                                                        (transaction.notes && (transaction.notes.includes('首次缴费') || transaction.notes.includes('学费') || transaction.notes.includes('编辑后缴费')) ? 'student_payment' : 'manual_income');
                                                    const isStudentPayment = recordSource === 'student_payment';
                                                    
                                                    return (
                                                        <tr key={transaction.id} className="border-b border-neutral-100 hover:bg-neutral-50 transition-colors">
                                                            <td className="py-4 px-4 font-medium text-neutral-900">{transaction.student_name}</td>
                                                            <td className="py-4 px-4 text-neutral-700">{transaction.type}</td>
                                                            <td className="py-4 px-4 font-semibold text-neutral-900">¥{transaction.amount}</td>
                                                            <td className="py-4 px-4 text-neutral-700">{transaction.transaction_date}</td>
                                                            <td className="py-4 px-4">
                                                                <span className={`text-xs px-2 py-1 rounded-full ${
                                                                    isStudentPayment 
                                                                        ? 'bg-blue-100 text-blue-800' 
                                                                        : 'bg-purple-100 text-purple-800'
                                                                }`}>
                                                                    {isStudentPayment ? '学生缴费' : '手动添加'}
                                                                </span>
                                                            </td>
                                                            <td className="py-4 px-4">
                                                                <select
                                                                    value={transaction.status}
                                                                    onChange={(e) => handleUpdateStatus(transaction.id, e.target.value)}
                                                                    className={`text-xs px-2 py-1 rounded-full border-0 ${
                                                                        transaction.status === 'paid' ? 'bg-green-100 text-green-800' :
                                                                        transaction.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                                        'bg-red-100 text-red-800'
                                                                    }`}
                                                                >
                                                                    <option value="paid">已支付</option>
                                                                    <option value="pending">待支付</option>
                                                                    <option value="overdue">逾期</option>
                                                                </select>
                                                            </td>
                                                            <td className="py-4 px-4">
                                                                <div className="flex gap-2">
                                                                    <button 
                                                                        onClick={() => setEditingIncome(transaction)}
                                                                        className="p-1 text-neutral-600 hover:text-primary-500"
                                                                        title="编辑"
                                                                    >
                                                                        <EditIcon />
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => handleDeleteIncome(transaction.id, recordSource)}
                                                                        className="p-1 text-neutral-600 hover:text-red-500"
                                                                        title="删除"
                                                                    >
                                                                        <DeleteIcon />
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 支出管理标签页 */}
                    {activeTab === 'expense' && (
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                                <h3 className="text-lg font-semibold text-neutral-900">支出记录</h3>
                                <button 
                                    onClick={() => setShowExpenseForm(true)}
                                    className="flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                                >
                                    <PlusIcon />
                                    <span>添加支出</span>
                                </button>
                            </div>

                            <div className="glass-morphism rounded-xl p-6">
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-neutral-200">
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">分类</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">金额</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">日期</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">说明</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredExpenses.length === 0 ? (
                                                <tr>
                                                    <td colSpan="5" className="py-8 text-center text-neutral-500">暂无支出记录</td>
                                                </tr>
                                            ) : (
                                                filteredExpenses.map((expense) => (
                                                    <tr key={expense.id} className="border-b border-neutral-100 hover:bg-neutral-0 transition-colors">
                                                        <td className="py-4 px-4 font-medium text-neutral-900">{expense.category}</td>
                                                        <td className="py-4 px-4 font-semibold text-red-600">¥{expense.amount}</td>
                                                        <td className="py-4 px-4 text-neutral-700">{expense.expense_date}</td>
                                                        <td className="py-4 px-4 text-neutral-700">{expense.description || '-'}</td>
                                                        <td className="py-4 px-4">
                                                            <div className="flex gap-2">
                                                                <button 
                                                                    onClick={() => setEditingExpense(expense)}
                                                                    className="p-1.5 text-neutral-400 hover:text-primary-500 hover:bg-primary-50 rounded-lg transition-colors"
                                                                    title="编辑"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                    </svg>
                                                                </button>
                                                                <button 
                                                                    onClick={(e) => {
                                                                        console.log('删除按钮被点击，记录ID:', expense.id);
                                                                        e.preventDefault();
                                                                        e.stopPropagation();
                                                                        handleDeleteExpense(expense.id);
                                                                    }}
                                                                    className="p-1.5 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                                    title="删除"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 收支对比标签页 */}
                    {activeTab === 'comparison' && (
                        <div className="space-y-6">
                            <h3 className="text-lg font-semibold text-neutral-900">收支对比分析</h3>
                            
                            {/* 收支对比卡片 */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="glass-morphism rounded-xl p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h4 className="text-sm font-medium text-neutral-600">总收入</h4>
                                        <div className="p-2 rounded-lg bg-green-100 text-green-600">
                                            <FinanceIcon />
                                        </div>
                                    </div>
                                    <p className="text-3xl font-bold text-green-600 mb-2">¥{totalRevenue.toFixed(2)}</p>
                                    <p className="text-xs text-neutral-500">已支付金额</p>
                                </div>
                                
                                <div className="glass-morphism rounded-xl p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h4 className="text-sm font-medium text-neutral-600">总支出</h4>
                                        <div className="p-2 rounded-lg bg-red-100 text-red-600">
                                            <FinanceIcon />
                                        </div>
                                    </div>
                                    <p className="text-3xl font-bold text-red-600 mb-2">¥{totalExpense.toFixed(2)}</p>
                                    <p className="text-xs text-neutral-500">所有支出金额</p>
                                </div>
                                
                                <div className="glass-morphism rounded-xl p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h4 className="text-sm font-medium text-neutral-600">净利润</h4>
                                        <div className={`p-2 rounded-lg ${balance >= 0 ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}`}>
                                            <FinanceIcon />
                                        </div>
                                    </div>
                                    <p className={`text-3xl font-bold mb-2 ${balance >= 0 ? 'text-blue-600' : 'text-orange-600'}`}>
                                        ¥{balance.toFixed(2)}
                                    </p>
                                    <p className="text-xs text-neutral-500">
                                        {balance >= 0 ? '盈利' : '亏损'}
                                    </p>
                                </div>
                            </div>

                            {/* 支出分类统计 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h4 className="text-lg font-semibold text-neutral-900 mb-4">支出分类统计</h4>
                                <div className="space-y-3">
                                    {(() => {
                                        const categoryStats = {};
                                        filteredExpenses.forEach(expense => {
                                            const category = expense.category || '未分类';
                                            if (!categoryStats[category]) {
                                                categoryStats[category] = 0;
                                            }
                                            categoryStats[category] += parseFloat(expense.amount || 0);
                                        });
                                        
                                        const totalExpenseAmount = Object.values(categoryStats).reduce((sum, val) => sum + val, 0);
                                        
                                        return Object.entries(categoryStats)
                                            .sort((a, b) => b[1] - a[1])
                                            .map(([category, amount]) => (
                                                <div key={category} className="flex items-center justify-between">
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between mb-1">
                                                            <span className="text-sm font-medium text-neutral-700">{category}</span>
                                                            <span className="text-sm font-bold text-neutral-900">¥{amount.toFixed(2)}</span>
                                                        </div>
                                                        <div className="w-full bg-neutral-200 rounded-full h-2">
                                                            <div 
                                                                className="bg-primary-500 h-2 rounded-full transition-all"
                                                                style={{ width: `${totalExpenseAmount > 0 ? (amount / totalExpenseAmount * 100) : 0}%` }}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                    <span className="ml-4 text-xs text-neutral-500">
                                                        {totalExpenseAmount > 0 ? ((amount / totalExpenseAmount * 100).toFixed(1)) : 0}%
                                                    </span>
                                                </div>
                                            ));
                                    })()}
                                </div>
                            </div>

                            {/* 收入类型统计 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h4 className="text-lg font-semibold text-neutral-900 mb-4">收入类型统计</h4>
                                <div className="space-y-3">
                                    {(() => {
                                        const typeStats = {};
                                        filteredTransactions.filter(t => t.status === 'paid').forEach(trans => {
                                            const type = trans.type || '其他';
                                            if (!typeStats[type]) {
                                                typeStats[type] = 0;
                                            }
                                            typeStats[type] += parseFloat(trans.amount || 0);
                                        });
                                        
                                        return Object.entries(typeStats)
                                            .sort((a, b) => b[1] - a[1])
                                            .map(([type, amount]) => (
                                                <div key={type} className="flex items-center justify-between">
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between mb-1">
                                                            <span className="text-sm font-medium text-neutral-700">{type}</span>
                                                            <span className="text-sm font-bold text-neutral-900">¥{amount.toFixed(2)}</span>
                                                        </div>
                                                        <div className="w-full bg-neutral-200 rounded-full h-2">
                                                            <div 
                                                                className="bg-green-500 h-2 rounded-full transition-all"
                                                                style={{ width: `${totalRevenue > 0 ? (amount / totalRevenue * 100) : 0}%` }}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                    <span className="ml-4 text-xs text-neutral-500">
                                                        {totalRevenue > 0 ? ((amount / totalRevenue * 100).toFixed(1)) : 0}%
                                                    </span>
                                                </div>
                                            ));
                                    })()}
                                </div>
                            </div>

                            {/* 财务健康度 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h4 className="text-lg font-semibold text-neutral-900 mb-4">财务健康度</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm text-neutral-600">收支比率</span>
                                            <span className="text-sm font-bold text-neutral-900">
                                                {totalRevenue > 0 ? ((totalExpense / totalRevenue * 100).toFixed(1)) : 0}%
                                            </span>
                                        </div>
                                        <div className="w-full bg-neutral-200 rounded-full h-3">
                                            <div 
                                                className={`h-3 rounded-full transition-all ${
                                                    (totalExpense / totalRevenue * 100) < 50 ? 'bg-green-500' :
                                                    (totalExpense / totalRevenue * 100) < 80 ? 'bg-yellow-500' : 'bg-red-500'
                                                }`}
                                                style={{ width: `${Math.min(totalRevenue > 0 ? (totalExpense / totalRevenue * 100) : 0, 100)}%` }}
                                            ></div>
                                        </div>
                                        <p className="text-xs text-neutral-500 mt-1">
                                            {(totalExpense / totalRevenue * 100) < 50 ? '健康' :
                                             (totalExpense / totalRevenue * 100) < 80 ? '良好' : '需要注意'}
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm text-neutral-600">待收款占比</span>
                                            <span className="text-sm font-bold text-neutral-900">
                                                {(totalRevenue + pendingAmount) > 0 ? ((pendingAmount / (totalRevenue + pendingAmount) * 100).toFixed(1)) : 0}%
                                            </span>
                                        </div>
                                        <div className="w-full bg-neutral-200 rounded-full h-3">
                                            <div 
                                                className="bg-yellow-500 h-3 rounded-full transition-all"
                                                style={{ width: `${(totalRevenue + pendingAmount) > 0 ? (pendingAmount / (totalRevenue + pendingAmount) * 100) : 0}%` }}
                                            ></div>
                                        </div>
                                        <p className="text-xs text-neutral-500 mt-1">
                                            待收金额 ¥{pendingAmount.toFixed(2)}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 添加支出表单 */}
                    {showExpenseForm && (
                        <ExpenseForm 
                            onSave={handleAddExpense}
                            onCancel={() => setShowExpenseForm(false)}
                        />
                    )}

                    {/* 编辑支出表单 */}
                    {editingExpense && (
                        <ExpenseForm 
                            expense={editingExpense}
                            onSave={handleUpdateExpense}
                            onCancel={() => setEditingExpense(null)}
                        />
                    )}

                    {/* 添加收入表单 */}
                    {showIncomeForm && (
                        <IncomeForm 
                            students={students}
                            onSave={handleAddIncome}
                            onCancel={() => setShowIncomeForm(false)}
                        />
                    )}

                    {/* 编辑收入表单 */}
                    {editingIncome && (
                        <IncomeForm 
                            students={students}
                            income={editingIncome}
                            onSave={handleUpdateIncome}
                            onCancel={() => setEditingIncome(null)}
                        />
                    )}

                    {/* 删除收入确认对话框 */}
                    {showDeleteIncomeConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="glass-morphism rounded-xl p-6 w-full max-w-md">
                                <div className="flex items-center mb-4">
                                    <svg className="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <h3 className="text-lg font-semibold text-neutral-900">确认删除</h3>
                                </div>
                                <p className="text-neutral-600 mb-6">删除后数据将无法恢复，确定要删除这条记录吗？</p>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={closeDeleteIncomeConfirm}
                                        className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={confirmDeleteIncome}
                                        className="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors"
                                    >
                                        确认删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 删除支出确认对话框 */}
                    {showDeleteExpenseConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="glass-morphism rounded-xl p-6 w-full max-w-md">
                                <div className="flex items-center mb-4">
                                    <svg className="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <h3 className="text-lg font-semibold text-neutral-900">确认删除</h3>
                                </div>
                                <p className="text-neutral-600 mb-6">删除后数据将无法恢复，确定要删除这条记录吗？</p>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={closeDeleteExpenseConfirm}
                                        className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={confirmDeleteExpense}
                                        className="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors"
                                    >
                                        确认删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 支出表单组件
        const ExpenseForm = ({ expense, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                category: expense?.category || '',
                amount: expense?.amount || '',
                expense_date: expense?.expense_date || new Date().toISOString().split('T')[0],
                description: expense?.description || '',
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-md">
                        <h3 className="text-lg font-semibold text-neutral-900 mb-4">
                            {expense ? '编辑支出记录' : '添加支出记录'}
                        </h3>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">支出分类</label>
                                <select
                                    value={formData.category}
                                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                >
                                    <option value="">选择分类</option>
                                    <option value="房租">房租</option>
                                    <option value="水电费">水电费</option>
                                    <option value="食材采购">食材采购</option>
                                    <option value="教学用品">教学用品</option>
                                    <option value="办公用品">办公用品</option>
                                    <option value="员工工资">员工工资</option>
                                    <option value="设备维修">设备维修</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">金额</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.amount}
                                    onChange={(e) => setFormData({...formData, amount: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入金额"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">支出日期</label>
                                <input
                                    type="date"
                                    value={formData.expense_date}
                                    onChange={(e) => setFormData({...formData, expense_date: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">说明</label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入支出说明"
                                    rows="3"
                                />
                            </div>
                            
                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                                >
                                    {expense ? '更新' : '添加'}
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 收入表单组件
        const IncomeForm = ({ students, income, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                student_name: income?.student_name || '',
                type: income?.type || '',
                amount: income?.amount || '',
                transaction_date: income?.transaction_date || new Date().toISOString().split('T')[0],
                status: income?.status || 'paid',
                payment_method: income?.payment_method || '现金',
                notes: income?.notes || '',
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold text-neutral-900 mb-4">
                            {income ? '编辑收入记录' : '添加收入记录'}
                        </h3>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">学生</label>
                                <select
                                    value={formData.student_name}
                                    onChange={(e) => setFormData({...formData, student_name: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                    disabled={!!income}
                                >
                                    <option value="">选择学生</option>
                                    {students.map(student => (
                                        <option key={student.id} value={student.name}>{student.name}</option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">收入类型</label>
                                <select
                                    value={formData.type}
                                    onChange={(e) => setFormData({...formData, type: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                >
                                    <option value="">选择类型</option>
                                    <option value="学费收入">学费收入</option>
                                    <option value="餐费收入">餐费收入</option>
                                    <option value="补课费">补课费</option>
                                    <option value="教材费">教材费</option>
                                    <option value="活动费">活动费</option>
                                    <option value="其他收入">其他收入</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">金额</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.amount}
                                    onChange={(e) => setFormData({...formData, amount: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入金额"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">收入日期</label>
                                <input
                                    type="date"
                                    value={formData.transaction_date}
                                    onChange={(e) => setFormData({...formData, transaction_date: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">支付状态</label>
                                <select
                                    value={formData.status}
                                    onChange={(e) => setFormData({...formData, status: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                >
                                    <option value="paid">已支付</option>
                                    <option value="pending">待支付</option>
                                    <option value="overdue">逾期</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">支付方式</label>
                                <select
                                    value={formData.payment_method}
                                    onChange={(e) => setFormData({...formData, payment_method: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                >
                                    <option value="现金">现金</option>
                                    <option value="微信">微信</option>
                                    <option value="支付宝">支付宝</option>
                                    <option value="银行转账">银行转账</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">备注</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入备注说明"
                                    rows="3"
                                />
                            </div>
                            
                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors"
                                >
                                    {income ? '更新' : '添加'}
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 考勤管理组件
        const Attendance = () => {
            const { selectedMonth: globalSelectedMonth, getMonthRange, studentDataRefresh } = React.useContext(GlobalMonthContext);
            const [attendanceData, setAttendanceData] = useState([]);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [refreshTrigger, setRefreshTrigger] = useState(0); // 用于手动刷新数据
            
            // 延期相关状态
            const [showExtensionModal, setShowExtensionModal] = useState(false);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [extensionDays, setExtensionDays] = useState(1);
            const [extensionReason, setExtensionReason] = useState('');
            const [extensionRecords, setExtensionRecords] = useState([]);
            const [locallyUndoneRecords, setLocallyUndoneRecords] = useState(new Set()); // 本地跟踪已撤销的记录

            // 判断是否应该显示考勤记录（使用全局工作日函数）
            const shouldShowAttendance = (dateStr) => {
                return isWorkday(dateStr);
            };

            useEffect(() => {
                fetchAttendanceData();
                fetchStudents();
                fetchExtensionRecords();
            }, [globalSelectedMonth, selectedDate, refreshTrigger, studentDataRefresh]); // 当全局月份、选定日期、手动刷新或学生数据更新时重新加载

            const fetchExtensionRecords = async () => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    // 获取延期记录，包含撤销相关字段
                    const { data, error } = await supabase
                        .from('attendance_extensions')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    
                    // 确保每条记录都有撤销相关字段，如果没有则设置默认值
                    // 同时结合本地撤销状态
                    const processedData = (data || []).map(record => {
                        const isLocallyUndone = locallyUndoneRecords.has(record.id);
                        // 支持新的status字段和旧的is_undone字段
                        const isUndone = record.status === 'cancelled' || record.is_undone || isLocallyUndone || false;
                        const undoneAt = record.cancelled_at || record.undone_at || (isLocallyUndone ? new Date().toISOString() : null);
                        const undoneBy = record.cancelled_by || record.undone_by || (isLocallyUndone ? user.id : null);
                        
                        return {
                            ...record,
                            is_undone: isUndone,
                            undone_at: undoneAt,
                            undone_by: undoneBy
                        };
                    });
                    
                    setExtensionRecords(processedData);
                } catch (err) {
                    console.error('获取延期记录失败:', err);
                    // 如果数据库字段不存在，尝试降级处理
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (!user) return;

                        // 尝试获取不包含撤销字段的记录
                        const { data, error } = await supabase
                            .from('attendance_extensions')
                            .select('id, user_id, student_id, student_name, extension_days, reason, previous_renewal_date, new_renewal_date, created_at')
                            .eq('user_id', user.id)
                            .order('created_at', { ascending: false });

                        if (error) throw error;
                        
                        // 为降级数据添加默认撤销字段，结合本地撤销状态
                        const processedData = (data || []).map(record => {
                            const isLocallyUndone = locallyUndoneRecords.has(record.id);
                            return {
                                ...record,
                                is_undone: isLocallyUndone || false,
                                undone_at: isLocallyUndone ? new Date().toISOString() : null,
                                undone_by: isLocallyUndone ? user.id : null,
                                status: isLocallyUndone ? 'cancelled' : 'active',
                                cancelled_at: isLocallyUndone ? new Date().toISOString() : null,
                                cancelled_by: isLocallyUndone ? user.id : null
                            };
                        });
                        
                        setExtensionRecords(processedData);
                        console.warn('使用降级模式获取延期记录，撤销功能可能受限');
                    } catch (fallbackErr) {
                        console.error('降级获取延期记录也失败:', fallbackErr);
                        setExtensionRecords([]);
                    }
                }
            };

            // 打开延期模态框
            const openExtensionModal = (studentName) => {
                setSelectedStudent({ student_name: studentName });
                setExtensionDays(1);
                setExtensionReason('');
                setShowExtensionModal(true);
            };

            // 处理延期申请
            const handleExtension = async () => {
                if (!selectedStudent || extensionDays < 1) {
                    alert('请选择学生并输入有效的延期天数');
                    return;
                }

                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    // 获取学生当前信息
                    const student = students.find(s => s.name === selectedStudent.student_name);
                    if (!student) throw new Error('找不到学生信息');

                    // 修正延期逻辑：基于当前缴费日期计算延期
                    // 如果没有当前缴费日期，则使用入学时间作为基础
                    const currentDate = student.next_renewal_date ? student.next_renewal_date : 
                                      (student.registration_date ? student.registration_date : new Date().toISOString().split('T')[0]);
                    
                    // 根据学生类型计算延期后的日期
                    const finalRenewalDate = calculateExtensionDate(currentDate, extensionDays, student.student_type);

                    // 更新学生的下次缴费日期
                    const { error: updateError } = await supabase
                        .from('students')
                        .update({ next_renewal_date: finalRenewalDate })
                        .eq('id', student.id);

                    if (updateError) throw updateError;

                    // 添加延期记录
                    const { error: insertError } = await supabase
                        .from('attendance_extensions')
                        .insert([{
                            user_id: user.id,
                            student_id: student.id,
                            student_name: student.name,
                            extension_days: extensionDays,
                            reason: extensionReason,
                            previous_renewal_date: student.next_renewal_date,
                            new_renewal_date: finalRenewalDate,
                            created_at: new Date().toISOString()
                        }]);

                    if (insertError) throw insertError;

                    // 刷新数据
                    await fetchStudents();
                    await fetchExtensionRecords();
                    await fetchAttendanceData();

                    // 关闭模态框
                    setShowExtensionModal(false);
                    setSelectedStudent(null);
                    setExtensionDays(1);
                    setExtensionReason('');

                    alert('延期申请成功！');
                } catch (err) {
                    console.error('延期申请失败:', err);
                    alert('延期申请失败: ' + err.message);
                }
            };

            // 撤销延期操作
            const handleUndoExtension = async (record) => {
                if (!confirm(`确定要撤销 ${record.student_name} 的延期操作吗？\n这将恢复原来的缴费日期。`)) {
                    return;
                }

                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        alert('用户未登录');
                        return;
                    }

                    // 获取学生信息
                    const { data: studentData, error: studentError } = await supabase
                        .from('students')
                        .select('*')
                        .eq('user_id', user.id)
                        .eq('name', record.student_name)
                        .single();

                    if (studentError || !studentData) {
                        alert('获取学生信息失败');
                        return;
                    }

                    // 恢复原来的缴费日期
                    const { error: updateError } = await supabase
                        .from('students')
                        .update({ 
                            next_renewal_date: record.previous_renewal_date 
                        })
                        .eq('id', studentData.id);

                    if (updateError) {
                        throw updateError;
                    }

                    // 将延期记录标记为已撤销
                    let dbUpdateSuccess = false;
                    try {
                        // 尝试使用新的status字段（如果存在）
                        const { error: markError } = await supabase
                            .from('attendance_extensions')
                            .update({ 
                                status: 'cancelled',
                                cancelled_at: new Date().toISOString(),
                                cancelled_by: user.id,
                                cancel_reason: '用户撤销延期操作'
                            })
                            .eq('id', record.id);

                        if (markError) {
                            console.error('使用status字段标记失败:', markError);
                            // 回退到旧的is_undone字段
                            const { error: fallbackError } = await supabase
                                .from('attendance_extensions')
                                .update({ 
                                    is_undone: true,
                                    undone_at: new Date().toISOString(),
                                    undone_by: user.id
                                })
                                .eq('id', record.id);
                            
                            if (fallbackError) {
                                console.error('使用is_undone字段标记也失败:', fallbackError);
                            } else {
                                dbUpdateSuccess = true;
                            }
                        } else {
                            dbUpdateSuccess = true;
                        }
                    } catch (markErr) {
                        console.error('标记延期记录时发生错误:', markErr);
                    }

                    // 如果数据库更新失败，在本地跟踪已撤销的记录
                    if (!dbUpdateSuccess) {
                        setLocallyUndoneRecords(prev => new Set([...prev, record.id]));
                        console.log('已在本地跟踪已撤销的记录:', record.id);
                    }

                    // 刷新延期记录
                    await fetchExtensionRecords();
                    
                    // 同时刷新学生数据和考勤数据，确保缴费日期更新
                    await fetchStudents();
                    await fetchAttendanceData();
                    
                    alert('延期操作已成功撤销！');
                    
                } catch (err) {
                    console.error('撤销延期操作失败:', err);
                    alert('撤销延期操作失败: ' + err.message);
                }
            };

            const fetchStudents = async () => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    // 获取所有在读学生（只要状态为active，就应该出现在考勤管理中）
                    const { data, error } = await supabase
                        .from('students')
                        .select('id, name, student_type, status, next_renewal_date')
                        .eq('user_id', user.id)
                        .eq('status', 'active')
                        .order('name');

                    if (error) throw error;
                    console.log('[考勤管理] 获取到的学生列表:', data);
                    setStudents(data || []);
                } catch (err) {
                    console.error('获取学生列表失败:', err);
                }
            };

            const fetchAttendanceData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('用户未登录');
                        return;
                    }

                    // 获取月份范围
                    const { start, end } = getMonthRange();

                    // 获取选定月份的考勤记录
                    const { data: attendanceRecords, error: attendanceError } = await supabase
                        .from('attendance_records')
                        .select('*')
                        .eq('user_id', user.id)
                        .gte('attendance_date', start)
                        .lte('attendance_date', end)
                        .order('attendance_date', { ascending: false });

                    if (attendanceError) throw attendanceError;

                    // 默认出勤逻辑：为符合条件且当天无记录的学生自动创建出勤记录
                    const today = new Date().toISOString().split('T')[0];
                    const isTodayWorkday = shouldShowAttendance(today);
                    console.log('[默认出勤] 今天日期:', today, '是否为工作日:', isTodayWorkday);
                    
                    if (isTodayWorkday) { // 检查今天是否为工作日
                        console.log('[默认出勤] 开始检查符合条件的学生...');
                        // 获取所有在读学生（只要状态为active，就应该自动创建出勤记录）
                        const { data: eligibleStudents, error: studentsError } = await supabase
                            .from('students')
                            .select('id, name, student_type, status, next_renewal_date')
                            .eq('user_id', user.id)
                            .eq('status', 'active');

                        console.log('[默认出勤] 查询结果 - 符合条件的学生数量:', eligibleStudents?.length || 0);
                        if (studentsError) {
                            console.error('[默认出勤] 查询学生失败:', studentsError);
                        }

                        if (eligibleStudents && eligibleStudents.length > 0) {
                            console.log('[默认出勤] 符合条件的学生:', eligibleStudents.map(s => s.name).join(', '));
                            // 检查哪些学生今天还没有考勤记录
                            const todayRecords = attendanceRecords.filter(r => r.attendance_date === today);
                            const recordedStudents = new Set(todayRecords.map(r => r.student_name));
                            console.log('[默认出勤] 今天已有考勤记录的学生:', Array.from(recordedStudents).join(', '));
                            
                            const studentsNeedingRecord = eligibleStudents.filter(
                                s => !recordedStudents.has(s.name)
                            );
                            console.log('[默认出勤] 需要创建记录的学生数量:', studentsNeedingRecord.length);

                            // 为没有记录的学生创建默认出勤记录
                            if (studentsNeedingRecord.length > 0) {
                                console.log('[默认出勤] 开始创建默认出勤记录...');
                                const checkInTime = '17:40'; // 默认出勤时间为下午5点40
                                
                                const defaultRecords = studentsNeedingRecord.map(student => ({
                                    user_id: user.id,
                                    student_name: student.name,
                                    attendance_date: today,
                                    check_in_time: checkInTime,
                                    status: 'present'
                                }));

                                const { error: insertError } = await supabase
                                    .from('attendance_records')
                                    .insert(defaultRecords);

                                if (insertError) {
                                    console.error('[默认出勤] 创建默认出勤记录失败:', insertError);
                                } else {
                                    console.log(`[默认出勤] ✅ 已为 ${studentsNeedingRecord.length} 名学生创建默认出勤记录`);
                                    // 重新获取考勤记录以包含新创建的记录
                                    const { data: updatedRecords } = await supabase
                                        .from('attendance_records')
                                        .select('*')
                                        .eq('user_id', user.id)
                                        .gte('attendance_date', start)
                                        .lte('attendance_date', end)
                                        .order('attendance_date', { ascending: false });
                                    
                                    if (updatedRecords) {
                                        attendanceRecords.length = 0;
                                        attendanceRecords.push(...updatedRecords);
                                    }
                                }
                            } else {
                                console.log('[默认出勤] 所有符合条件的学生今天都已有考勤记录');
                            }
                        } else {
                            console.log('[默认出勤] 没有符合条件的学生');
                        }
                    } else {
                        console.log('[默认出勤] 今天是周末或节假日，不创建默认出勤记录');
                    }

                    const dateForView = selectedDate || new Date().toISOString().split('T')[0];
                    const { data: activeStudentsRes } = await supabase
                        .from('students')
                        .select('id, name, student_type, status, next_renewal_date, created_at')
                        .eq('user_id', user.id)
                        .eq('status', 'active');
                    const activeStudents = activeStudentsRes || [];
                    const activeNames = new Set(activeStudents.map(s => s.name));
                    const recordsForDay = (attendanceRecords || []).filter(r => r.attendance_date === dateForView);
                    const formattedRecords = recordsForDay
                        .filter(r => activeNames.has(r.student_name))
                        .map(r => ({
                            ...r,
                            checkIn: r.check_in_time || '-',
                            checkOut: r.check_out_time || '-',
                            synthetic: false
                        }));
                    const missing = activeStudents
                        .filter(s => !formattedRecords.find(r => r.student_name === s.name))
                        .map(s => ({
                            id: `synthetic-${s.id}-${dateForView}`,
                            student_name: s.name,
                            attendance_date: dateForView,
                            checkIn: '-',
                            checkOut: '-',
                            status: 'absent',
                            synthetic: true
                        }));
                    // 按学生创建时间排序，保持与学生管理页面相同的顺序
                    // 学生管理页面按 created_at 降序排列，这里也采用相同的逻辑
                    const sortedData = [...formattedRecords, ...missing].sort((a, b) => {
                        // 通过学生姓名查找对应的学生信息
                        const studentA = activeStudents.find(s => s.name === a.student_name);
                        const studentB = activeStudents.find(s => s.name === b.student_name);
                        
                        // 如果找不到学生信息，按姓名排序
                        if (!studentA || !studentB) {
                            return b.student_name.localeCompare(a.student_name);
                        }
                        
                        // 按创建时间降序排列（最新的在前）
                        return new Date(studentB.created_at) - new Date(studentA.created_at);
                    });
                    setAttendanceData(sortedData);
                } catch (err) {
                    console.error('获取考勤数据失败:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleStatusChange = async (id, status) => {
                try {
                    const record = attendanceData.find(r => r.id === id);
                    if (!record) return;
                    if (record.synthetic) {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (!user) throw new Error('用户未登录');
                        const { data: inserted, error } = await supabase
                            .from('attendance_records')
                            .insert([{ 
                                user_id: user.id, 
                                student_name: record.student_name, 
                                attendance_date: record.attendance_date, 
                                check_in_time: status === 'present' ? '17:40' : null,
                                status 
                            }])
                            .select()
                            .single();
                        if (error) throw error;
                        setAttendanceData(attendanceData.map(r => r.id === id ? {
                            ...inserted,
                            checkIn: inserted.check_in_time || '-',
                            checkOut: inserted.check_out_time || '-',
                            synthetic: false
                        } : r));
                        return;
                    }
                    const { error } = await supabase
                        .from('attendance_records')
                        .update({ status })
                        .eq('id', id);
                    if (error) throw error;
                    setAttendanceData(attendanceData.map(record => 
                        record.id === id ? { ...record, status } : record
                    ));
                    if (status === 'leave') {
                        try {
                            const { data: { user } } = await supabase.auth.getUser();
                            if (user) {
                                const todayStr = record.attendance_date;
                                const d = new Date(todayStr);
                                const dayStr = (date) => date.toISOString().split('T')[0];
                                const d1 = new Date(d); d1.setDate(d.getDate()-1);
                                const d2 = new Date(d); d2.setDate(d.getDate()-2);
                                const { data: prev1 } = await supabase.from('attendance_records').select('status').eq('user_id', user.id).eq('student_name', record.student_name).eq('attendance_date', dayStr(d1)).maybeSingle();
                                const { data: prev2 } = await supabase.from('attendance_records').select('status').eq('user_id', user.id).eq('student_name', record.student_name).eq('attendance_date', dayStr(d2)).maybeSingle();
                                const streak = (prev1?.status === 'leave' ? 1 : 0) + (prev2?.status === 'leave' ? 1 : 0) + 1;
                                if (streak >= 3) {
                                    // 连续3天请假提醒
                                }
                            }
                        } catch(e) {}
                    }
                } catch (err) {
                    console.error('更新考勤状态失败:', err);
                    alert('更新失败: ' + err.message);
                }
            };





            if (loading) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-lg text-neutral-600">加载中...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p className="text-red-600">加载失败: {error}</p>
                        <button 
                            onClick={fetchAttendanceData}
                            className="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                        >
                            重试
                        </button>
                    </div>
                );
            }

            const presentCount = attendanceData.filter(r => r.status === 'present').length;
            const absentCount = attendanceData.filter(r => r.status === 'absent' || r.status === 'leave').length;
            const lateCount = attendanceData.filter(r => r.status === 'late').length;

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <div className="flex items-center gap-3 mb-1">
                                <h2 className="text-2xl font-bold text-neutral-900">考勤管理</h2>
                            </div>
                            <p className="text-neutral-600">学生出勤情况管理</p>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-neutral-200 shadow-sm">
                                <CalendarIcon />
                                <input
                                    type="date"
                                    value={selectedDate}
                                    onChange={(e) => setSelectedDate(e.target.value)}
                                    className="border-0 focus:ring-0 text-sm font-medium text-neutral-700 bg-transparent cursor-pointer"
                                />
                            </div>
                            <button
                                onClick={() => setRefreshTrigger(prev => prev + 1)}
                                className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex items-center gap-2"
                                title="刷新学生列表和考勤数据"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                <span className="hidden sm:inline">刷新数据</span>
                            </button>

                        </div>
                    </div>

                    {/* 考勤统计 */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">出勤人数</p>
                                    <p className="text-2xl font-bold text-green-600">{presentCount}</p>
                                </div>
                                <div className="p-3 rounded-lg bg-green-500 text-white">
                                    <AttendanceIcon />
                                </div>
                            </div>
                        </div>
                        
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">请假人数</p>
                                    <p className="text-2xl font-bold text-yellow-600">{absentCount}</p>
                                </div>
                                <div className="p-3 rounded-lg bg-yellow-500 text-white">
                                    <AttendanceIcon />
                                </div>
                            </div>
                        </div>
                        
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">迟到人数</p>
                                    <p className="text-2xl font-bold text-orange-600">{lateCount}</p>
                                </div>
                                <div className="p-3 rounded-lg bg-orange-500 text-white">
                                    <AttendanceIcon />
                                </div>
                            </div>
                        </div>
                        
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-neutral-600">出勤率</p>
                                    <p className="text-2xl font-bold text-primary-500">
                                        {Math.round((presentCount / attendanceData.length) * 100)}%
                                    </p>
                                </div>
                                <div className="p-3 rounded-lg bg-primary-500 text-white">
                                    <AttendanceIcon />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="glass-morphism rounded-xl p-6">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                            <h3 className="text-lg font-semibold text-neutral-900">考勤记录</h3>
                            <div className="flex gap-3">
                                <span className="text-sm text-neutral-600">
                                    工作日17:40自动出勤，学生录入后自动同步
                                </span>
                            </div>
                        </div>


                        <div className="overflow-x-auto">
                            {attendanceData.length === 0 ? (
                                <p className="text-neutral-500 text-center py-8">暂无考勤记录</p>
                            ) : (
                                <table className="w-full">
                                    <thead>
                                        <tr className="border-b border-neutral-200">
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">学生</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">签到时间</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">托管方式</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">下次缴费时间</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">状态</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {attendanceData.map((record) => {
                                            // 找到对应的学生
                                            const student = students.find(s => s.name === record.student_name);
                                            
                                            return (
                                                <tr key={record.id} className="border-b border-neutral-100 hover:bg-neutral-0 transition-colors">
                                                    <td className="py-4 px-4 font-medium text-neutral-900">{record.student_name}</td>
                                                    <td className="py-4 px-4 text-neutral-700">{record.checkIn}</td>
                                                    <td className="py-4 px-4 text-neutral-700">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${
                                                            student?.student_type === '日托' ? 'bg-blue-100 text-blue-800' :
                                                            student?.student_type === '月托' ? 'bg-green-100 text-green-800' :
                                                            student?.student_type === '学期' ? 'bg-purple-100 text-purple-800' :
                                                            'bg-neutral-100 text-neutral-800'
                                                        }`}>
                                                            {student?.student_type || '-'}
                                                        </span>
                                                    </td>
                                                    <td className="py-4 px-4 text-neutral-700">{student?.next_renewal_date || '-'}</td>
                                                    <td className="py-4 px-4">
                                                        <select
                                                            value={record.status}
                                                            onChange={(e) => handleStatusChange(record.id, e.target.value)}
                                                            className={`text-sm px-3 py-1 rounded-full border-0 ${
                                                                record.status === 'present' ? 'bg-green-100 text-green-800' :
                                                                record.status === 'absent' ? 'bg-red-100 text-red-800' :
                                                                record.status === 'late' ? 'bg-orange-100 text-orange-800' :
                                                                'bg-yellow-100 text-yellow-800'
                                                            }`}
                                                        >
                                                            <option value="present">正常</option>
                                                            <option value="late">迟到</option>
                                                            <option value="absent">缺勤</option>
                                                            <option value="leave">请假</option>
                                                        </select>
                                                    </td>
                                                    <td className="py-4 px-4">
                                                        <button
                                                            onClick={() => openExtensionModal(record.student_name)}
                                                            className="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
                                                        >
                                                            延期
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            )}
                        </div>

                        {/* 延期记录表格 */}
                        <div className="bg-white rounded-lg shadow p-6 mt-6">
                            <h3 className="text-lg font-medium mb-4">延期操作记录</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                学生姓名
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                延期天数
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                延期原因
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                原缴费日期
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                新缴费日期
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                操作时间
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                操作
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {extensionRecords.length === 0 ? (
                                            <tr>
                                                <td colSpan="7" className="px-6 py-4 text-center text-gray-500">
                                                    暂无延期记录
                                                </td>
                                            </tr>
                                        ) : (
                                            extensionRecords.map((record) => (
                                                <tr key={record.id} className={record.is_undone ? 'bg-gray-50 opacity-75' : ''}>
                                                    <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${
                                                        record.is_undone ? 'text-gray-400 line-through' : 'text-gray-900'
                                                    }`}>
                                                        {record.student_name}
                                                        {record.is_undone && (
                                                            <span className="ml-2 text-xs text-red-500 font-normal">(已撤销)</span>
                                                        )}
                                                    </td>
                                                    <td className={`px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${
                                                        record.is_undone ? 'line-through' : ''
                                                    }`}>
                                                        {record.extension_days}天
                                                    </td>
                                                    <td className={`px-6 py-4 text-sm text-gray-500 ${
                                                        record.is_undone ? 'line-through' : ''
                                                    }`}>
                                                        {record.reason || '无'}
                                                    </td>
                                                    <td className={`px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${
                                                        record.is_undone ? 'line-through' : ''
                                                    }`}>
                                                        {record.previous_renewal_date ? new Date(record.previous_renewal_date).toLocaleDateString('zh-CN') : '-'}
                                                    </td>
                                                    <td className={`px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${
                                                        record.is_undone ? 'line-through' : ''
                                                    }`}>
                                                        {record.new_renewal_date ? new Date(record.new_renewal_date).toLocaleDateString('zh-CN') : '-'}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        {new Date(record.created_at).toLocaleString('zh-CN')}
                                                        {record.is_undone && record.undone_at && (
                                                            <div className="text-xs text-red-500 mt-1">
                                                                撤销于: {new Date(record.undone_at).toLocaleString('zh-CN')}
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        {!record.is_undone ? (
                                                            <button
                                                                onClick={() => handleUndoExtension(record)}
                                                                className="text-red-600 hover:text-red-800 text-xs bg-red-50 hover:bg-red-100 px-2 py-1 rounded transition-colors"
                                                                title="撤销此延期操作"
                                                            >
                                                                撤销
                                                            </button>
                                                        ) : (
                                                            <span className="text-gray-400 text-xs">已撤销</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* 延期模态框 */}
                        {showExtensionModal && (
                            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                                <div className="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                                    <div className="mt-3">
                                        <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                                            学生延期申请
                                        </h3>
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                学生姓名
                                            </label>
                                            <input
                                                type="text"
                                                value={selectedStudent?.student_name || ''}
                                                disabled
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
                                            />
                                        </div>
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                学生类型
                                            </label>
                                            <div className="flex items-center">
                                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                    selectedStudent?.student_type === '日托' ? 'bg-blue-100 text-blue-800' :
                                                    selectedStudent?.student_type === '月托' ? 'bg-green-100 text-green-800' :
                                                    selectedStudent?.student_type === '学期' ? 'bg-purple-100 text-purple-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`}>
                                                    {selectedStudent?.student_type || '-'}
                                                </span>
                                                <span className="ml-2 text-xs text-gray-500">
                                                    {selectedStudent?.student_type === '日托' ? '（按工作日计算）' : '（按自然日计算）'}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                延期天数
                                            </label>
                                            <input
                                                type="number"
                                                min="1"
                                                value={extensionDays}
                                                onChange={(e) => setExtensionDays(parseInt(e.target.value) || 1)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                            />
                                            {/* 快捷天数按钮 */}
                                            <div className="mt-2 flex flex-wrap gap-2">
                                                <button
                                                    type="button"
                                                    onClick={() => setExtensionDays(1)}
                                                    className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors"
                                                >
                                                    +1天
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setExtensionDays(3)}
                                                    className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors"
                                                >
                                                    +3天
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setExtensionDays(7)}
                                                    className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors"
                                                >
                                                    +1周
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setExtensionDays(15)}
                                                    className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors"
                                                >
                                                    +15天
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setExtensionDays(30)}
                                                    className="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors"
                                                >
                                                    +1月
                                                </button>
                                            </div>
                                        </div>
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                延期原因（可选）
                                            </label>
                                            <textarea
                                                value={extensionReason}
                                                onChange={(e) => setExtensionReason(e.target.value)}
                                                rows="3"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                placeholder="请输入延期原因..."
                                            />
                                        </div>
                                        <div className="flex justify-end space-x-2">
                                            <button
                                                onClick={() => setShowExtensionModal(false)}
                                                className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                                            >
                                                取消
                                            </button>
                                            <button
                                                onClick={handleExtension}
                                                className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
                                            >
                                                确认延期
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 行业惯例说明 */}
                        <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div className="flex items-start space-x-2">
                                <svg className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <p className="text-sm font-semibold text-blue-900 mb-1">行业惯例提示</p>
    
                                </div>
                            </div>
                        </div>
                    </div>




                </div>
            );
        };

// ==================== 完整增强版作业管理组件 ====================

        // 作业管理主组件
        const Homework = () => {
            const [homeworks, setHomeworks] = useState([]);
            const [students, setStudents] = useState([]);
            const [submissions, setSubmissions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [showStatsModal, setShowStatsModal] = useState(false);
            const [editingHomework, setEditingHomework] = useState(null);
            
            // 筛选状态
            const [filters, setFilters] = useState({
                subject: 'all',
                homework_type: 'all',
                priority: 'all',
                status: 'all',
                dateRange: 'all'
            });
            
            // 统计数据
            const [stats, setStats] = useState(null);
            
            useEffect(() => {
                fetchData();
            }, []);
            
            const fetchData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('用户未登录');
                        return;
                    }

                    // 获取作业列表
                    const { data: homeworksData, error: homeworksError } = await supabase
                        .from('homeworks')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false });

                    if (homeworksError) throw homeworksError;

                    // 获取学生列表（获取所有状态为active的学生，与其他模块保持一致）
                    const { data: studentsData, error: studentsError } = await supabase
                        .from('students')
                        .select('id, name, grade')
                        .eq('user_id', user.id)
                        .eq('status', 'active')
                        .order('name');

                    if (studentsError) throw studentsError;

                    // 获取提交记录
                    const { data: submissionsData, error: submissionsError } = await supabase
                        .from('homework_submissions')
                        .select('*')
                        .eq('user_id', user.id);

                    if (submissionsError) throw submissionsError;

                    setHomeworks(homeworksData || []);
                    setStudents(studentsData || []);
                    setSubmissions(submissionsData || []);
                    
                    // 计算统计数据
                    calculateStats(homeworksData || [], submissionsData || []);
                } catch (err) {
                    console.error('获取数据失败:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const calculateStats = (homeworksData, submissionsData) => {
                const now = new Date();
                const total = homeworksData.length;
                const completed = homeworksData.filter(h => h.status === 'completed').length;
                const overdue = homeworksData.filter(h => 
                    new Date(h.due_date) < now && h.status !== 'completed'
                ).length;
                
                // 按科目统计
                const bySubject = {};
                homeworksData.forEach(h => {
                    if (h.subject) {
                        bySubject[h.subject] = (bySubject[h.subject] || 0) + 1;
                    }
                });
                
                // 按优先级统计
                const byPriority = {
                    high: homeworksData.filter(h => h.priority === 'high').length,
                    medium: homeworksData.filter(h => h.priority === 'medium').length,
                    low: homeworksData.filter(h => h.priority === 'low').length
                };
                
                // 完成率
                const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                setStats({
                    total,
                    completed,
                    overdue,
                    inProgress: total - completed - overdue,
                    completionRate,
                    bySubject,
                    byPriority
                });
            };
            
            const handleAddHomework = async (homeworkData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;

                    const { error } = await supabase
                        .from('homeworks')
                        .insert([{
                            user_id: user.id,
                            ...homeworkData,
                            assign_date: homeworkData.assign_date || new Date().toISOString().split('T')[0],
                            status: 'active'
                        }]);

                    if (error) throw error;
                    
                    await fetchData();
                    setShowAddForm(false);
                    alert('作业创建成功');
                } catch (err) {
                    console.error('添加作业失败:', err);
                    alert('添加失败: ' + err.message);
                }
            };
            
            const handleUpdateHomework = async (homeworkData) => {
                try {
                    const { error } = await supabase
                        .from('homeworks')
                        .update(homeworkData)
                        .eq('id', editingHomework.id);

                    if (error) throw error;
                    
                    await fetchData();
                    setEditingHomework(null);
                    alert('作业更新成功');
                } catch (err) {
                    console.error('更新作业失败:', err);
                    alert('更新失败: ' + err.message);
                }
            };
            
            const handleDeleteHomework = async (id) => {
                if (!confirm('确定删除此作业吗？')) return;
                
                try {
                    const { error } = await supabase
                        .from('homeworks')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    await fetchData();
                    alert('作业删除成功');
                } catch (err) {
                    console.error('删除作业失败:', err);
                    alert('删除失败: ' + err.message);
                }
            };
            
            const handleExportExcel = () => {
                try {
                    const exportData = filteredHomeworks.map(hw => ({
                        '标题': hw.title,
                        '科目': hw.subject || '-',
                        '类型': getHomeworkTypeLabel(hw.homework_type || hw.type),
                        '优先级': getPriorityLabel(hw.priority || 'medium'),
                        '班级': hw.class,
                        '布置日期': hw.assign_date,
                        '截止日期': hw.due_date,
                        '状态': getStatusLabel(hw.status),
                        '完成率': `${hw.completion_rate || 0}%`,
                        '描述': hw.description || '-'
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "作业列表");
                    XLSX.writeFile(wb, `作业列表_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    alert('Excel导出成功');
                } catch (err) {
                    console.error('导出失败:', err);
                    alert('导出失败: ' + err.message);
                }
            };
            
            // 筛选逻辑
            const filteredHomeworks = homeworks.filter(hw => {
                if (filters.subject !== 'all' && hw.subject !== filters.subject) return false;
                if (filters.homework_type !== 'all' && (hw.homework_type || hw.type) !== filters.homework_type) return false;
                if (filters.priority !== 'all' && (hw.priority || 'medium') !== filters.priority) return false;
                if (filters.status !== 'all' && hw.status !== filters.status) return false;
                
                // 日期范围筛选
                if (filters.dateRange !== 'all') {
                    const dueDate = new Date(hw.due_date);
                    const now = new Date();
                    const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                    
                    if (filters.dateRange === 'today' && diffDays !== 0) return false;
                    if (filters.dateRange === 'week' && (diffDays < 0 || diffDays > 7)) return false;
                    if (filters.dateRange === 'month' && (diffDays < 0 || diffDays > 30)) return false;
                    if (filters.dateRange === 'overdue' && diffDays >= 0) return false;
                }
                
                return true;
            });
            
            // 辅助函数
            const getHomeworkTypeLabel = (type) => {
                const labels = {
                    practice: '练习',
                    exam: '考试',
                    review: '复习',
                    project: '项目',
                    reading: '阅读',
                    other: '其他',
                    '练习': '练习',
                    '阅读': '阅读',
                    '背诵': '背诵',
                    '报告': '报告'
                };
                return labels[type] || type;
            };
            
            const getPriorityLabel = (priority) => {
                const labels = {
                    high: '高',
                    medium: '中',
                    low: '低'
                };
                return labels[priority] || '中';
            };
            
            const getStatusLabel = (status) => {
                const labels = {
                    active: '进行中',
                    completed: '已完成',
                    cancelled: '已取消'
                };
                return labels[status] || status;
            };
            
            const getPriorityColor = (priority) => {
                const colors = {
                    high: 'bg-red-100 text-red-700',
                    medium: 'bg-yellow-100 text-yellow-700',
                    low: 'bg-green-100 text-green-700'
                };
                return colors[priority] || 'bg-gray-100 text-gray-700';
            };
            
            if (loading) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                            <p className="mt-4 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="p-6">
                        <div className="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded-lg">
                            错误：{error}
                            <button 
                                onClick={fetchData}
                                className="ml-4 underline hover:no-underline"
                            >
                                重试
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full overflow-y-auto">
                    <div className="p-6 space-y-6">
                        {/* 页面头部 */}
                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <div className="flex items-center gap-3 mb-1">
                                    <h2 className="text-2xl font-bold text-neutral-900">作业管理</h2>
                                    <span className="text-sm text-neutral-500 bg-neutral-100 px-3 py-1 rounded-full">
                                        {new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
                                    </span>
                                </div>
                                <p className="text-neutral-600 mt-1">管理和跟踪学生作业完成情况</p>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={() => setShowStatsModal(true)}
                                    className="bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors flex items-center space-x-2"
                                >
                                    <ChartIcon />
                                    <span>统计分析</span>
                                </button>
                                <button
                                    onClick={() => setShowImportModal(true)}
                                    className="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2"
                                >
                                    <UploadIcon />
                                    <span>导入作业</span>
                                </button>
                                <button
                                    onClick={handleExportExcel}
                                    className="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2"
                                >
                                    <DownloadIcon />
                                    <span>导出Excel</span>
                                </button>
                                <button
                                    onClick={() => setShowAddForm(true)}
                                    className="bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors flex items-center space-x-2"
                                >
                                    <PlusIcon />
                                    <span>添加作业</span>
                                </button>
                            </div>
                        </div>

                        {/* 统计卡片 */}
                        {stats && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                                <div className="glass-morphism rounded-xl p-4 card-hover">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-neutral-600">总作业数</p>
                                            <p className="text-2xl font-bold text-neutral-900 mt-1">{stats.total}</p>
                                        </div>
                                        <div className="p-3 rounded-lg bg-blue-500 text-white">
                                            <HomeworkIcon />
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-morphism rounded-xl p-4 card-hover">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-neutral-600">进行中</p>
                                            <p className="text-2xl font-bold text-blue-600 mt-1">{stats.inProgress}</p>
                                        </div>
                                        <div className="p-3 rounded-lg bg-blue-400 text-white">
                                            <ClockIcon />
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-morphism rounded-xl p-4 card-hover">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-neutral-600">已完成</p>
                                            <p className="text-2xl font-bold text-green-600 mt-1">{stats.completed}</p>
                                        </div>
                                        <div className="p-3 rounded-lg bg-green-500 text-white">
                                            <CheckIcon />
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-morphism rounded-xl p-4 card-hover">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-neutral-600">已逾期</p>
                                            <p className="text-2xl font-bold text-red-600 mt-1">{stats.overdue}</p>
                                        </div>
                                        <div className="p-3 rounded-lg bg-red-500 text-white">
                                            <AlertIcon />
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-morphism rounded-xl p-4 card-hover">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-sm font-medium text-neutral-600">完成率</p>
                                            <p className="text-2xl font-bold text-primary-500 mt-1">{stats.completionRate}%</p>
                                        </div>
                                        <div className="p-3 rounded-lg bg-primary-500 text-white">
                                            <ChartIcon />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 筛选器 */}
                        <div className="glass-morphism rounded-xl p-4">
                            <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                <div>
                                    <label className="block text-xs font-medium text-neutral-600 mb-1">科目</label>
                                    <select
                                        value={filters.subject}
                                        onChange={(e) => setFilters({...filters, subject: e.target.value})}
                                        className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="all">全部</option>
                                        <option value="语文">语文</option>
                                        <option value="数学">数学</option>
                                        <option value="英语">英语</option>
                                        <option value="物理">物理</option>
                                        <option value="化学">化学</option>
                                        <option value="生物">生物</option>
                                        <option value="历史">历史</option>
                                        <option value="地理">地理</option>
                                        <option value="政治">政治</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-neutral-600 mb-1">类型</label>
                                    <select
                                        value={filters.homework_type}
                                        onChange={(e) => setFilters({...filters, homework_type: e.target.value})}
                                        className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="all">全部</option>
                                        <option value="practice">练习</option>
                                        <option value="exam">考试</option>
                                        <option value="review">复习</option>
                                        <option value="project">项目</option>
                                        <option value="reading">阅读</option>
                                        <option value="other">其他</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-neutral-600 mb-1">优先级</label>
                                    <select
                                        value={filters.priority}
                                        onChange={(e) => setFilters({...filters, priority: e.target.value})}
                                        className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="all">全部</option>
                                        <option value="high">高</option>
                                        <option value="medium">中</option>
                                        <option value="low">低</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-neutral-600 mb-1">状态</label>
                                    <select
                                        value={filters.status}
                                        onChange={(e) => setFilters({...filters, status: e.target.value})}
                                        className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="all">全部</option>
                                        <option value="active">进行中</option>
                                        <option value="completed">已完成</option>
                                        <option value="cancelled">已取消</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-neutral-600 mb-1">截止日期</label>
                                    <select
                                        value={filters.dateRange}
                                        onChange={(e) => setFilters({...filters, dateRange: e.target.value})}
                                        className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="all">全部</option>
                                        <option value="today">今天</option>
                                        <option value="week">本周</option>
                                        <option value="month">本月</option>
                                        <option value="overdue">已逾期</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="mt-3 flex justify-between items-center">
                                <p className="text-sm text-neutral-600">
                                    显示 {filteredHomeworks.length} / {homeworks.length} 条作业
                                </p>
                                {(filters.subject !== 'all' || filters.homework_type !== 'all' || filters.priority !== 'all' || filters.status !== 'all' || filters.dateRange !== 'all') && (
                                    <button
                                        onClick={() => setFilters({
                                            subject: 'all',
                                            homework_type: 'all',
                                            priority: 'all',
                                            status: 'all',
                                            dateRange: 'all'
                                        })}
                                        className="text-sm text-primary-500 hover:text-primary-700"
                                    >
                                        清除筛选
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* 作业列表 */}
                        <div className="glass-morphism rounded-xl overflow-hidden">
                            {filteredHomeworks.length === 0 ? (
                                <div className="p-12 text-center text-neutral-500">
                                    <p>暂无作业数据</p>
                                    <button
                                        onClick={() => setShowAddForm(true)}
                                        className="mt-4 text-primary-500 hover:text-primary-700 underline"
                                    >
                                        添加第一个作业
                                    </button>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-neutral-100 border-b border-neutral-200">
                                            <tr>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">作业标题</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">科目</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">类型</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">优先级</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">截止日期</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">完成率</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">状态</th>
                                                <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-neutral-200">
                                            {filteredHomeworks.map((homework) => (
                                                <tr key={homework.id} className="hover:bg-neutral-50">
                                                    <td className="px-4 py-3">
                                                        <div>
                                                            <p className="font-medium text-neutral-900">{homework.title}</p>
                                                            {homework.content_text && (
                                                                <p className="text-xs text-neutral-600 mt-1 truncate max-w-xs">
                                                                    {homework.content_text}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm text-neutral-900">
                                                        {homework.subject || '-'}
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <span className="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                                            {getHomeworkTypeLabel(homework.homework_type || homework.type)}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${getPriorityColor(homework.priority || 'medium')}`}>
                                                            {getPriorityLabel(homework.priority || 'medium')}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 text-sm text-neutral-900">
                                                        {homework.due_date}
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex items-center space-x-2">
                                                            <div className="flex-1 bg-neutral-200 rounded-full h-2 w-16">
                                                                <div 
                                                                    className="bg-primary-500 h-2 rounded-full transition-all"
                                                                    style={{ width: `${homework.completion_rate || 0}%` }}
                                                                ></div>
                                                            </div>
                                                            <span className="text-xs text-neutral-600">
                                                                {homework.completion_rate || 0}%
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <span className={`px-2 py-1 text-xs rounded-full ${
                                                            homework.status === 'completed' ? 'bg-green-100 text-green-800' :
                                                            homework.status === 'active' ? 'bg-blue-100 text-blue-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            {getStatusLabel(homework.status)}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="flex space-x-2">
                                                            <button
                                                                onClick={() => setEditingHomework(homework)}
                                                                className="text-primary-500 hover:text-primary-700 p-1"
                                                                title="编辑"
                                                            >
                                                                <EditIcon />
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeleteHomework(homework.id)}
                                                                className="text-red-500 hover:text-red-700 p-1"
                                                                title="删除"
                                                            >
                                                                <DeleteIcon />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* 添加/编辑作业表单 */}
                    {(showAddForm || editingHomework) && (
                        <HomeworkFormEnhanced
                            homework={editingHomework}
                            students={students}
                            onSubmit={editingHomework ? handleUpdateHomework : handleAddHomework}
                            onCancel={() => {
                                setShowAddForm(false);
                                setEditingHomework(null);
                            }}
                        />
                    )}

                    {/* 导入模态框 */}
                    {showImportModal && (
                        <ImportModal
                            onClose={() => setShowImportModal(false)}
                            onImport={fetchData}
                        />
                    )}

                    {/* 统计分析模态框 */}
                    {showStatsModal && stats && (
                        <StatsModal
                            stats={stats}
                            homeworks={homeworks}
                            onClose={() => setShowStatsModal(false)}
                        />
                    )}
                </div>
            );
        };


        // 增强版作业表单组件
        const HomeworkFormEnhanced = ({ homework, students, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                title: homework?.title || '',
                subject: homework?.subject || '',
                homework_type: homework?.homework_type || homework?.type || 'practice',
                priority: homework?.priority || 'medium',
                class: homework?.class || '',
                due_date: homework?.due_date || '',
                description: homework?.description || '',
                content_text: homework?.content_text || '',
                content_images: homework?.content_images || [],
                selected_students: homework?.selected_students || []
            });
            
            const [uploadingImages, setUploadingImages] = useState(false);
            
            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                setUploadingImages(true);
                try {
                    const uploadedUrls = [];
                    for (const file of files) {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `homework_${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                        const filePath = `homework-images/${fileName}`;
                        
                        const { error: uploadError } = await supabase.storage
                            .from('homework_files')
                            .upload(filePath, file);
                        
                        if (uploadError) throw uploadError;
                        
                        const { data } = supabase.storage
                            .from('homework_files')
                            .getPublicUrl(filePath);
                        
                        uploadedUrls.push(data.publicUrl);
                    }
                    
                    setFormData({
                        ...formData,
                        content_images: [...formData.content_images, ...uploadedUrls]
                    });
                } catch (err) {
                    console.error('图片上传失败:', err);
                    alert('图片上传失败: ' + err.message);
                } finally {
                    setUploadingImages(false);
                }
            };
            
            const removeImage = (index) => {
                const newImages = formData.content_images.filter((_, i) => i !== index);
                setFormData({ ...formData, content_images: newImages });
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-3xl my-8">
                        <h3 className="text-lg font-semibold text-neutral-900 mb-6">
                            {homework ? '编辑作业' : '添加作业'}
                        </h3>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {/* 基本信息 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        作业标题 <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.title}
                                        onChange={(e) => setFormData({...formData, title: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="如：数学练习册第3页"
                                        required
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        科目 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={formData.subject}
                                        onChange={(e) => setFormData({...formData, subject: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="">选择科目</option>
                                        <option value="语文">语文</option>
                                        <option value="数学">数学</option>
                                        <option value="英语">英语</option>
                                        <option value="物理">物理</option>
                                        <option value="化学">化学</option>
                                        <option value="生物">生物</option>
                                        <option value="历史">历史</option>
                                        <option value="地理">地理</option>
                                        <option value="政治">政治</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        作业类型 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={formData.homework_type}
                                        onChange={(e) => setFormData({...formData, homework_type: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="practice">练习</option>
                                        <option value="exam">考试</option>
                                        <option value="review">复习</option>
                                        <option value="project">项目</option>
                                        <option value="reading">阅读</option>
                                        <option value="other">其他</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        优先级 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={formData.priority}
                                        onChange={(e) => setFormData({...formData, priority: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="low">低</option>
                                        <option value="medium">中</option>
                                        <option value="high">高</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        班级 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        value={formData.class}
                                        onChange={(e) => setFormData({...formData, class: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="">选择班级</option>
                                        <option value="三年级">三年级</option>
                                        <option value="四年级">四年级</option>
                                        <option value="五年级">五年级</option>
                                        <option value="六年级">六年级</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        截止日期 <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="date"
                                        value={formData.due_date}
                                        onChange={(e) => setFormData({...formData, due_date: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    />
                                </div>
                            </div>
                            
                            {/* 作业内容 */}
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">
                                    作业描述
                                </label>
                                <textarea
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    rows="3"
                                    placeholder="简要描述作业要求..."
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">
                                    详细内容（文字）
                                </label>
                                <textarea
                                    value={formData.content_text}
                                    onChange={(e) => setFormData({...formData, content_text: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    rows="4"
                                    placeholder="详细的作业内容、要求等..."
                                />
                            </div>
                            
                            {/* 图片上传 */}
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-2">
                                    作业图片
                                </label>
                                <div className="space-y-3">
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="file"
                                            multiple
                                            accept="image/*"
                                            onChange={handleImageUpload}
                                            className="hidden"
                                            id="image-upload"
                                            disabled={uploadingImages}
                                        />
                                        <label
                                            htmlFor="image-upload"
                                            className={`inline-flex items-center space-x-2 px-4 py-2 rounded-lg cursor-pointer transition-colors ${
                                                uploadingImages
                                                    ? 'bg-neutral-300 text-neutral-500 cursor-not-allowed'
                                                    : 'bg-blue-500 text-white hover:bg-blue-600'
                                            }`}
                                        >
                                            <ImageIcon />
                                            <span>{uploadingImages ? '上传中...' : '选择图片'}</span>
                                        </label>
                                        <span className="text-xs text-neutral-600">支持多张图片</span>
                                    </div>
                                    
                                    {formData.content_images.length > 0 && (
                                        <div className="grid grid-cols-3 gap-3">
                                            {formData.content_images.map((url, index) => (
                                                <div key={index} className="relative group">
                                                    <img 
                                                        src={url} 
                                                        alt={`作业图片 ${index + 1}`}
                                                        className="w-full h-32 object-cover rounded-lg border border-neutral-300"
                                                    />
                                                    <button
                                                        type="button"
                                                        onClick={() => removeImage(index)}
                                                        className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                                    >
                                                        <CloseIcon />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* 学生选择（可选） */}
                            {students.length > 0 && (
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-2">
                                        指定学生（可选，留空表示全班）
                                    </label>
                                    <div className="max-h-40 overflow-y-auto border border-neutral-300 rounded-lg p-3 space-y-2">
                                        {students.map(student => (
                                            <label key={student.id} className="flex items-center space-x-2">
                                                <input
                                                    type="checkbox"
                                                    checked={formData.selected_students.includes(student.id)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setFormData({
                                                                ...formData,
                                                                selected_students: [...formData.selected_students, student.id]
                                                            });
                                                        } else {
                                                            setFormData({
                                                                ...formData,
                                                                selected_students: formData.selected_students.filter(id => id !== student.id)
                                                            });
                                                        }
                                                    }}
                                                    className="rounded border-neutral-300"
                                                />
                                                <span className="text-sm text-neutral-700">
                                                    {student.name} ({student.grade})
                                                </span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* 按钮 */}
                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    disabled={uploadingImages}
                                    className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {homework ? '更新作业' : '创建作业'}
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };


        // 导入模态框组件
        const ImportModal = ({ onClose, onImport }) => {
            const [importText, setImportText] = useState('');
            const [importing, setImporting] = useState(false);
            
            const handleTextImport = async () => {
                if (!importText.trim()) {
                    alert('请输入要导入的内容');
                    return;
                }
                
                setImporting(true);
                try {
                    // 简单的文本解析逻辑
                    const lines = importText.split('\n').filter(line => line.trim());
                    const homeworksToImport = [];
                    
                    for (const line of lines) {
                        // 尝试解析格式: 科目 标题 截止日期
                        const parts = line.split(/\s+/);
                        if (parts.length >= 2) {
                            homeworksToImport.push({
                                subject: parts[0],
                                title: parts.slice(1, -1).join(' ') || parts[1],
                                due_date: parts[parts.length - 1],
                                homework_type: 'practice',
                                priority: 'medium',
                                class: '全部',
                                description: line
                            });
                        }
                    }
                    
                    if (homeworksToImport.length === 0) {
                        alert('未能解析出有效的作业信息');
                        return;
                    }
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) return;
                    
                    const { error } = await supabase
                        .from('homeworks')
                        .insert(homeworksToImport.map(hw => ({
                            ...hw,
                            user_id: user.id,
                            assign_date: new Date().toISOString().split('T')[0],
                            status: 'active'
                        })));
                    
                    if (error) throw error;
                    
                    alert(`成功导入 ${homeworksToImport.length} 条作业`);
                    onImport();
                    onClose();
                } catch (err) {
                    console.error('导入失败:', err);
                    alert('导入失败: ' + err.message);
                } finally {
                    setImporting(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-neutral-900">导入作业</h3>
                            <button
                                onClick={onClose}
                                className="p-2 hover:bg-neutral-100 rounded-lg transition-colors"
                            >
                                <CloseIcon />
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-2">
                                    粘贴作业内容（每行一条）
                                </label>
                                <p className="text-xs text-neutral-600 mb-2">
                                    格式示例：数学 练习册第10页 2025-11-15
                                </p>
                                <textarea
                                    value={importText}
                                    onChange={(e) => setImportText(e.target.value)}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    rows="10"
                                    placeholder="语文 背诵课文第3课 2025-11-10&#10;数学 练习册第10页 2025-11-12&#10;英语 单词表Unit5 2025-11-15"
                                />
                            </div>
                            
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p className="text-sm text-blue-800 font-medium mb-2">导入说明：</p>
                                <ul className="text-xs text-blue-700 space-y-1">
                                    <li>• 每行一条作业记录</li>
                                    <li>• 格式：科目 作业内容 截止日期</li>
                                    <li>• 使用空格分隔各字段</li>
                                    <li>• 日期格式：YYYY-MM-DD</li>
                                </ul>
                            </div>
                            
                            <div className="flex space-x-3 pt-2">
                                <button
                                    onClick={handleTextImport}
                                    disabled={importing}
                                    className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {importing ? '导入中...' : '开始导入'}
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 统计分析模态框组件
        const StatsModal = ({ stats, homeworks, onClose }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-4xl my-8">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-semibold text-neutral-900">统计分析</h3>
                            <button
                                onClick={onClose}
                                className="p-2 hover:bg-neutral-100 rounded-lg transition-colors"
                            >
                                <CloseIcon />
                            </button>
                        </div>
                        
                        <div className="space-y-6">
                            {/* 总体统计 */}
                            <div>
                                <h4 className="text-md font-semibold text-neutral-900 mb-3">总体情况</h4>
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <div className="bg-blue-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">总作业数</p>
                                        <p className="text-2xl font-bold text-blue-600">{stats.total}</p>
                                    </div>
                                    <div className="bg-green-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">已完成</p>
                                        <p className="text-2xl font-bold text-green-600">{stats.completed}</p>
                                    </div>
                                    <div className="bg-yellow-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">进行中</p>
                                        <p className="text-2xl font-bold text-yellow-600">{stats.inProgress}</p>
                                    </div>
                                    <div className="bg-red-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">已逾期</p>
                                        <p className="text-2xl font-bold text-red-600">{stats.overdue}</p>
                                    </div>
                                    <div className="bg-purple-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">完成率</p>
                                        <p className="text-2xl font-bold text-purple-600">{stats.completionRate}%</p>
                                    </div>
                                </div>
                            </div>
                            
                            {/* 按科目统计 */}
                            <div>
                                <h4 className="text-md font-semibold text-neutral-900 mb-3">科目分布</h4>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {Object.entries(stats.bySubject).map(([subject, count]) => (
                                        <div key={subject} className="bg-neutral-50 rounded-lg p-3 flex justify-between items-center">
                                            <span className="text-sm font-medium text-neutral-700">{subject}</span>
                                            <span className="text-lg font-bold text-primary-500">{count}</span>
                                        </div>
                                    ))}
                                    {Object.keys(stats.bySubject).length === 0 && (
                                        <div className="col-span-full text-center text-neutral-500 py-4">
                                            暂无科目统计数据
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* 按优先级统计 */}
                            <div>
                                <h4 className="text-md font-semibold text-neutral-900 mb-3">优先级分布</h4>
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="bg-red-50 rounded-lg p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm font-medium text-neutral-700">高优先级</span>
                                            <span className="text-xl font-bold text-red-600">{stats.byPriority.high}</span>
                                        </div>
                                        <div className="w-full bg-red-200 rounded-full h-2">
                                            <div 
                                                className="bg-red-600 h-2 rounded-full"
                                                style={{ width: `${stats.total > 0 ? (stats.byPriority.high / stats.total * 100) : 0}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                    <div className="bg-yellow-50 rounded-lg p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm font-medium text-neutral-700">中优先级</span>
                                            <span className="text-xl font-bold text-yellow-600">{stats.byPriority.medium}</span>
                                        </div>
                                        <div className="w-full bg-yellow-200 rounded-full h-2">
                                            <div 
                                                className="bg-yellow-600 h-2 rounded-full"
                                                style={{ width: `${stats.total > 0 ? (stats.byPriority.medium / stats.total * 100) : 0}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                    <div className="bg-green-50 rounded-lg p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm font-medium text-neutral-700">低优先级</span>
                                            <span className="text-xl font-bold text-green-600">{stats.byPriority.low}</span>
                                        </div>
                                        <div className="w-full bg-green-200 rounded-full h-2">
                                            <div 
                                                className="bg-green-600 h-2 rounded-full"
                                                style={{ width: `${stats.total > 0 ? (stats.byPriority.low / stats.total * 100) : 0}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* 最近作业 */}
                            <div>
                                <h4 className="text-md font-semibold text-neutral-900 mb-3">最近添加</h4>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {homeworks.slice(0, 10).map(hw => (
                                        <div key={hw.id} className="bg-neutral-50 rounded-lg p-3 flex justify-between items-center">
                                            <div className="flex-1">
                                                <p className="font-medium text-neutral-900">{hw.title}</p>
                                                <p className="text-xs text-neutral-600">
                                                    {hw.subject} • {hw.due_date}
                                                </p>
                                            </div>
                                            <span className={`px-2 py-1 text-xs rounded-full ${
                                                hw.status === 'completed' ? 'bg-green-100 text-green-800' :
                                                hw.status === 'active' ? 'bg-blue-100 text-blue-800' :
                                                'bg-gray-100 text-gray-800'
                                            }`}>
                                                {hw.status === 'completed' ? '已完成' :
                                                 hw.status === 'active' ? '进行中' : '已取消'}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-6">
                            <button
                                onClick={onClose}
                                className="w-full bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                            >
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // 成绩管理组件
        const Grades = () => {
            const { selectedMonth: globalSelectedMonth, getMonthRange, studentDataRefresh } = React.useContext(GlobalMonthContext);
            const [examScores, setExamScores] = useState([]);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [activeView, setActiveView] = useState('list'); // list, statistics, trends
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [selectedTrendStudent, setSelectedTrendStudent] = useState(''); // 用于趋势图的学生选择
            const [showHistoryModal, setShowHistoryModal] = useState(false); // 历史成绩模态框
            const [historyStudent, setHistoryStudent] = useState(null); // 查看历史成绩的学生
            // 新增功能状态
            const [filters, setFilters] = useState({
                student: '',
                subject: '',
                examType: '',
                dateFrom: '',
                dateTo: ''
            });
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage] = useState(20);
            const [selectedScores, setSelectedScores] = useState([]);
            const [editingScore, setEditingScore] = useState(null);
            const [showFilters, setShowFilters] = useState(false);

            useEffect(() => {
                fetchData();
            }, [globalSelectedMonth, studentDataRefresh]); // 当全局月份改变或学生数据更新时重新加载数据

            // 当切换到趋势视图时渲染图表
            useEffect(() => {
                if (activeView === 'trends' && examScores.length > 0) {
                    // 确保Chart.js已加载并且DOM已渲染
                    const initCharts = () => {
                        if (typeof Chart !== 'undefined') {
                            renderCharts();
                        } else {
                            // 如果Chart还未加载，等待后重试
                            setTimeout(initCharts, 100);
                        }
                    };
                    
                    // 延迟执行以确保DOM渲染完成
                    setTimeout(initCharts, 200);
                }
            }, [activeView, examScores]);

            const fetchData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('用户未登录');
                        return;
                    }

                    // 获取月份范围
                    const { start, end } = getMonthRange();

                    // 并行获取学生数据和成绩数据（成绩数据按月份筛选）
                    // 只获取在读学生（所有在读学生都应该出现在成绩管理中）
                    const [studentsResult, scoresResult] = await Promise.all([
                        supabase.from('students').select('*')
                            .eq('user_id', user.id)
                            .eq('status', 'active')
                            .order('name'),
                        supabase.from('exam_scores').select('*')
                            .eq('user_id', user.id)
                            .gte('exam_date', start)
                            .lte('exam_date', end)
                            .order('exam_date', { ascending: false })
                    ]);

                    if (studentsResult.error) throw studentsResult.error;
                    if (scoresResult.error) throw scoresResult.error;

                    console.log('获取到的学生数据:', studentsResult.data);
                    console.log('获取到的成绩数据:', scoresResult.data);
                    console.log('成绩记录数量:', scoresResult.data ? scoresResult.data.length : 0);

                    setStudents(studentsResult.data || []);
                    setExamScores(scoresResult.data || []);
                } catch (err) {
                    console.error('获取数据失败:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddScore = async (scoreData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { data, error } = await supabase
                        .from('exam_scores')
                        .insert([{
                            ...scoreData,
                            user_id: user.id
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    setExamScores([data, ...examScores]);
                    setShowAddForm(false);
                    setSelectedStudent(null);
                    window.alert('成绩录入成功');
                } catch (err) {
                    console.error('录入成绩失败:', err);
                    window.alert('录入失败：' + err.message);
                }
            };

            const handleDeleteScore = async (id) => {
                console.log('handleDeleteScore被调用, ID:', id);
                console.log('准备弹出确认对话框...');
                const confirmed = window.confirm('确定要删除这条成绩记录吗？');
                console.log('用户确认结果:', confirmed);
                if (!confirmed) return;
                
                try {
                    console.log('开始删除操作...');
                    const { error } = await supabase
                        .from('exam_scores')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    console.log('删除成功，更新状态...');
                    setExamScores(examScores.filter(s => s.id !== id));
                    window.alert('删除成功');
                } catch (err) {
                    console.error('删除失败:', err);
                    window.alert('删除失败：' + err.message);
                }
            };

            // 编辑成绩
            const handleEditScore = async (scoreData) => {
                try {
                    const { data, error } = await supabase
                        .from('exam_scores')
                        .update(scoreData)
                        .eq('id', editingScore.id)
                        .select()
                        .single();

                    if (error) throw error;
                    setExamScores(examScores.map(s => s.id === editingScore.id ? data : s));
                    setEditingScore(null);
                    alert('修改成功');
                } catch (err) {
                    console.error('修改失败:', err);
                    alert('修改失败：' + err.message);
                }
            };

            // 批量删除
            const handleBatchDelete = async () => {
                if (selectedScores.length === 0) {
                    alert('请选择要删除的记录');
                    return;
                }

                if (!confirm(`确定要删除选中的 ${selectedScores.length} 条记录吗？`)) return;

                try {
                    const { error } = await supabase
                        .from('exam_scores')
                        .delete()
                        .in('id', selectedScores);

                    if (error) throw error;
                    setExamScores(examScores.filter(s => !selectedScores.includes(s.id)));
                    setSelectedScores([]);
                    alert('批量删除成功');
                } catch (err) {
                    console.error('批量删除失败:', err);
                    alert('批量删除失败：' + err.message);
                }
            };

            // Excel 导出
            const exportToExcel = () => {
                try {
                    // 检查是否有数据
                    if (!filteredScores || filteredScores.length === 0) {
                        alert('当前没有成绩数据可导出');
                        return;
                    }

                    // 显示导出开始提示
                    console.log('正在导出成绩数据...');
                    
                    const dataToExport = filteredScores.map(score => {
                        // 通过学生姓名查找对应的年级
                        const student = students.find(s => s.name === score.student_name);
                        const studentGrade = student ? student.grade : '未知';
                        
                        return {
                            '学生姓名': score.student_name,
                            '年级': studentGrade,
                            '科目': score.subject,
                            '分数': score.score,
                            '满分': score.full_score,
                            '等级': score.grade || (
                                score.score >= 90 ? '优秀' :
                                score.score >= 80 ? '良好' :
                                score.score >= 70 ? '中等' :
                                score.score >= 60 ? '及格' : '不及格'
                            ),
                            '考试类型': score.exam_type,
                            '考试日期': score.exam_date,
                            '备注': score.notes || ''
                        };
                    });

                    // 生成文件名（包含月份信息）
                    let fileName;
                    if (globalSelectedMonth === 'all') {
                        fileName = `成绩数据_全部.xlsx`;
                    } else {
                        fileName = `成绩数据_${globalSelectedMonth}.xlsx`;
                    }

                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '成绩记录');
                    XLSX.writeFile(wb, fileName);
                    
                    // 导出成功提示
                    alert(`导出成功！\n文件名：${fileName}\n记录数：${dataToExport.length} 条`);
                } catch (error) {
                    console.error('导出Excel失败:', error);
                    alert('导出失败：' + error.message);
                }
            };

            // Excel 导入
            const handleExcelImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            const { data: { user } } = await supabase.auth.getUser();
                            if (!user) throw new Error('用户未登录');

                            let successCount = 0;
                            let errorCount = 0;
                            const errors = [];

                            for (let i = 0; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                
                                const scoreData = {
                                    user_id: user.id,
                                    student_name: row['学生姓名'],
                                    subject: row['科目'],
                                    exam_type: row['考试类型'] || '月考',
                                    exam_date: row['考试日期'],
                                    score: parseFloat(row['得分']),
                                    full_score: parseFloat(row['满分']) || 100,
                                    notes: row['备注'] || ''
                                };

                                try {
                                    const { error } = await supabase
                                        .from('exam_scores')
                                        .insert([scoreData]);

                                    if (error) throw error;
                                    successCount++;
                                } catch (err) {
                                    errors.push(`第${i+2}行：${err.message}`);
                                    errorCount++;
                                }
                            }

                            let message = `导入完成！成功：${successCount} 条`;
                            if (errorCount > 0) {
                                message += `，失败：${errorCount} 条\n\n失败详情：\n${errors.join('\n')}`;
                            }
                            alert(message);
                            fetchData();
                            e.target.value = '';
                        } catch (error) {
                            console.error('解析Excel失败:', error);
                            alert('解析Excel失败：' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('读取文件失败:', error);
                    alert('读取文件失败：' + error.message);
                }
            };

            // 下载Excel模板
            const downloadExcelTemplate = () => {
                const template = [
                    ['学生姓名', '科目', '考试类型', '考试日期', '得分', '满分', '备注'],
                    ['张三', '语文', '月考', '2025-11-01', '85', '100', ''],
                    ['李四', '数学', '期中考试', '2025-11-05', '92', '100', '表现优秀']
                ];
                const ws = XLSX.utils.aoa_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '成绩导入模板');
                XLSX.writeFile(wb, '成绩导入模板.xlsx');
            };

            // 筛选后的成绩
            const filteredScores = examScores.filter(score => {
                if (filters.student && !score.student_name.includes(filters.student)) return false;
                if (filters.subject && score.subject !== filters.subject) return false;
                if (filters.examType && score.exam_type !== filters.examType) return false;
                if (filters.dateFrom && score.exam_date < filters.dateFrom) return false;
                if (filters.dateTo && score.exam_date > filters.dateTo) return false;
                return true;
            });

            // 分页数据
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentScores = filteredScores.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredScores.length / itemsPerPage);

            // 切换选择
            const toggleSelectScore = (id) => {
                if (selectedScores.includes(id)) {
                    setSelectedScores(selectedScores.filter(sid => sid !== id));
                } else {
                    setSelectedScores([...selectedScores, id]);
                }
            };

            // 全选/取消全选
            const toggleSelectAll = () => {
                if (selectedScores.length === currentScores.length) {
                    setSelectedScores([]);
                } else {
                    setSelectedScores(currentScores.map(s => s.id));
                }
            };

            // 计算统计数据
            const calculateStatistics = () => {
                if (examScores.length === 0) return {};

                const subjectStats = {};
                examScores.forEach(score => {
                    if (!subjectStats[score.subject]) {
                        subjectStats[score.subject] = {
                            scores: [],
                            total: 0,
                            count: 0
                        };
                    }
                    subjectStats[score.subject].scores.push(parseFloat(score.score));
                    subjectStats[score.subject].total += parseFloat(score.score);
                    subjectStats[score.subject].count += 1;
                });

                Object.keys(subjectStats).forEach(subject => {
                    const stat = subjectStats[subject];
                    stat.average = (stat.total / stat.count).toFixed(2);
                    stat.highest = Math.max(...stat.scores).toFixed(2);
                    stat.lowest = Math.min(...stat.scores).toFixed(2);
                    stat.passRate = ((stat.scores.filter(s => s >= 60).length / stat.count) * 100).toFixed(1);
                });

                return subjectStats;
            };

            // 渲染图表
            const renderCharts = () => {
                // 检查Chart是否可用
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js 未加载');
                    return;
                }

                // 科目平均分对比图
                const subjectCanvas = document.getElementById('subjectChart');
                if (subjectCanvas) {
                    // 清理现有图表实例
                    const existingChart = Chart.getChart(subjectCanvas);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    const ctx = subjectCanvas.getContext('2d');
                    const stats = calculateStatistics();
                    const subjects = Object.keys(stats);
                    
                    if (subjects.length > 0) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: subjects,
                                datasets: [{
                                    label: '平均分',
                                    data: subjects.map(s => parseFloat(stats[s].average)),
                                    backgroundColor: 'rgba(0, 122, 255, 0.7)',
                                    borderColor: 'rgba(0, 122, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '分';
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: '各科目平均分对比'
                                    }
                                }
                            }
                        });
                    }
                }

                // 成绩分布饼图
                const gradeCanvas = document.getElementById('gradeDistribution');
                if (gradeCanvas && examScores.length > 0) {
                    // 清理现有图表实例
                    const existingChart = Chart.getChart(gradeCanvas);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    const ctx = gradeCanvas.getContext('2d');
                    const excellent = examScores.filter(s => parseFloat(s.score) >= 90).length;
                    const good = examScores.filter(s => parseFloat(s.score) >= 80 && parseFloat(s.score) < 90).length;
                    const medium = examScores.filter(s => parseFloat(s.score) >= 70 && parseFloat(s.score) < 80).length;
                    const pass = examScores.filter(s => parseFloat(s.score) >= 60 && parseFloat(s.score) < 70).length;
                    const fail = examScores.filter(s => parseFloat(s.score) < 60).length;

                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['优秀(90+)', '良好(80-89)', '中等(70-79)', '及格(60-69)', '不及格(<60)'],
                            datasets: [{
                                data: [excellent, good, medium, pass, fail],
                                backgroundColor: [
                                    'rgba(40, 167, 69, 0.7)',
                                    'rgba(0, 122, 255, 0.7)',
                                    'rgba(255, 193, 7, 0.7)',
                                    'rgba(255, 152, 0, 0.7)',
                                    'rgba(220, 53, 69, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(40, 167, 69, 1)',
                                    'rgba(0, 122, 255, 1)',
                                    'rgba(255, 193, 7, 1)',
                                    'rgba(255, 152, 0, 1)',
                                    'rgba(220, 53, 69, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                title: {
                                    display: true,
                                    text: '成绩等级分布'
                                }
                            }
                        }
                    });
                }

                // 学生成绩趋势折线图
                const studentTrendCanvas = document.getElementById('studentTrendChart');
                if (studentTrendCanvas && examScores.length > 0) {
                    const existingChart = Chart.getChart(studentTrendCanvas);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    const ctx = studentTrendCanvas.getContext('2d');
                    
                    // 根据选择的学生筛选数据
                    const filteredData = selectedTrendStudent 
                        ? examScores.filter(s => s.student_name === selectedTrendStudent)
                        : examScores;

                    if (filteredData.length === 0) {
                        return;
                    }

                    // 按日期排序
                    const sortedData = [...filteredData].sort((a, b) => 
                        new Date(a.exam_date) - new Date(b.exam_date)
                    );

                    // 如果选择了特定学生，显示该学生每次考试的成绩
                    if (selectedTrendStudent) {
                        // 按科目分组
                        const subjectData = {};
                        sortedData.forEach(score => {
                            if (!subjectData[score.subject]) {
                                subjectData[score.subject] = [];
                            }
                            subjectData[score.subject].push({
                                date: score.exam_date,
                                score: parseFloat(score.score)
                            });
                        });

                        const datasets = Object.keys(subjectData).map((subject, index) => {
                            const colors = [
                                'rgba(0, 122, 255, 1)',
                                'rgba(40, 167, 69, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(220, 53, 69, 1)',
                                'rgba(255, 152, 0, 1)',
                                'rgba(102, 16, 242, 1)'
                            ];
                            return {
                                label: subject,
                                data: subjectData[subject].map(d => d.score),
                                borderColor: colors[index % colors.length],
                                backgroundColor: colors[index % colors.length].replace('1)', '0.1)'),
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            };
                        });

                        const labels = [...new Set(sortedData.map(s => s.exam_date))].sort();

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '分';
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${selectedTrendStudent} - 成绩趋势`
                                    },
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    } else {
                        // 显示所有学生的平均分趋势
                        const dateScores = {};
                        sortedData.forEach(score => {
                            if (!dateScores[score.exam_date]) {
                                dateScores[score.exam_date] = [];
                            }
                            dateScores[score.exam_date].push(parseFloat(score.score));
                        });

                        const labels = Object.keys(dateScores).sort();
                        const averages = labels.map(date => {
                            const scores = dateScores[date];
                            return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
                        });

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: '班级平均分',
                                    data: averages,
                                    borderColor: 'rgba(0, 122, 255, 1)',
                                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '分';
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '全班成绩趋势'
                                    }
                                }
                            }
                        });
                    }
                }

                // 班级平均分对比柱状图（各学生对比）
                const classComparisonCanvas = document.getElementById('classComparisonChart');
                if (classComparisonCanvas && examScores.length > 0) {
                    const existingChart = Chart.getChart(classComparisonCanvas);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    const ctx = classComparisonCanvas.getContext('2d');
                    
                    // 计算每个学生的平均分
                    const studentAverages = {};
                    examScores.forEach(score => {
                        if (!studentAverages[score.student_name]) {
                            studentAverages[score.student_name] = {
                                total: 0,
                                count: 0
                            };
                        }
                        studentAverages[score.student_name].total += parseFloat(score.score);
                        studentAverages[score.student_name].count += 1;
                    });

                    const students = Object.keys(studentAverages).sort();
                    const averages = students.map(student => 
                        (studentAverages[student].total / studentAverages[student].count).toFixed(2)
                    );

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: students,
                            datasets: [{
                                label: '平均分',
                                data: averages,
                                backgroundColor: students.map((_, index) => {
                                    const colors = [
                                        'rgba(0, 122, 255, 0.7)',
                                        'rgba(40, 167, 69, 0.7)',
                                        'rgba(255, 193, 7, 0.7)',
                                        'rgba(220, 53, 69, 0.7)',
                                        'rgba(255, 152, 0, 0.7)',
                                        'rgba(102, 16, 242, 0.7)'
                                    ];
                                    return colors[index % colors.length];
                                }),
                                borderColor: students.map((_, index) => {
                                    const colors = [
                                        'rgba(0, 122, 255, 1)',
                                        'rgba(40, 167, 69, 1)',
                                        'rgba(255, 193, 7, 1)',
                                        'rgba(220, 53, 69, 1)',
                                        'rgba(255, 152, 0, 1)',
                                        'rgba(102, 16, 242, 1)'
                                    ];
                                    return colors[index % colors.length];
                                }),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '分';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: '学生平均分对比'
                                }
                            }
                        }
                    });
                }

                // 按月份统计的时间趋势图
                const monthlyTrendCanvas = document.getElementById('monthlyTrendChart');
                if (monthlyTrendCanvas && examScores.length > 0) {
                    const existingChart = Chart.getChart(monthlyTrendCanvas);
                    if (existingChart) {
                        existingChart.destroy();
                    }

                    const ctx = monthlyTrendCanvas.getContext('2d');
                    
                    // 按月份分组统计
                    const monthlyData = {};
                    examScores.forEach(score => {
                        const date = new Date(score.exam_date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = {
                                scores: [],
                                count: 0
                            };
                        }
                        monthlyData[monthKey].scores.push(parseFloat(score.score));
                        monthlyData[monthKey].count += 1;
                    });

                    const months = Object.keys(monthlyData).sort();
                    const averages = months.map(month => 
                        (monthlyData[month].scores.reduce((a, b) => a + b, 0) / monthlyData[month].count).toFixed(2)
                    );
                    const counts = months.map(month => monthlyData[month].count);

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: '月平均分',
                                    data: averages,
                                    borderColor: 'rgba(0, 122, 255, 1)',
                                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                    yAxisID: 'y'
                                },
                                {
                                    label: '考试次数',
                                    data: counts,
                                    borderColor: 'rgba(40, 167, 69, 1)',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '分';
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: '平均分'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    grid: {
                                        drawOnChartArea: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + '次';
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: '考试次数'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '按月份统计的成绩趋势'
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            };

            // 渲染成绩列表视图
            const renderListView = () => {
                // 计算每个学生的最近一次成绩
                const studentWithLatestScores = students.map(student => {
                    const studentScores = examScores.filter(score => score.student_name === student.name);
                    // 获取最近一次成绩（examScores已按日期降序排列）
                    const latestScore = studentScores.length > 0 ? studentScores[0] : null;
                    return {
                        student,
                        latestScore
                    };
                });

                return (
                <div className="space-y-6">
                    {/* 操作按钮区 */}
                    <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                        <div>
                            <h3 className="text-lg font-semibold text-neutral-900">成绩记录</h3>
                            <p className="text-sm text-neutral-600">
                                共 {students.length} 名在读学生
                            </p>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <button
                                onClick={downloadExcelTemplate}
                                className="flex items-center space-x-2 bg-neutral-100 text-neutral-700 px-4 py-2 rounded-lg hover:bg-neutral-200 transition-colors border border-neutral-300"
                            >
                                <DownloadIcon />
                                <span>下载模板</span>
                            </button>
                            <button
                                onClick={() => document.getElementById('excelImportInput').click()}
                                className="flex items-center space-x-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                            >
                                <UploadIcon />
                                <span>导入Excel</span>
                            </button>
                            <input
                                id="excelImportInput"
                                type="file"
                                accept=".xlsx,.xls"
                                onChange={handleExcelImport}
                                className="hidden"
                            />
                            <button
                                onClick={exportToExcel}
                                className="flex items-center space-x-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                            >
                                <ExportIcon />
                                <span>导出Excel</span>
                            </button>
                        </div>
                    </div>

                    {/* 成绩列表 */}
                    <div className="glass-morphism rounded-xl p-6">
                        {students.length === 0 ? (
                            <p className="text-neutral-500 text-center py-8">暂无在读学生</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead>
                                        <tr className="border-b border-neutral-200">
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">学生</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">年级</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">最近考试</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">科目</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">成绩</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">等级</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {studentWithLatestScores.map(({ student, latestScore }) => (
                                            <tr key={student.id} className="border-b border-neutral-100 hover:bg-neutral-0 transition-colors">
                                                <td className="py-4 px-4">
                                                    <button
                                                        onClick={() => {
                                                            setHistoryStudent(student);
                                                            setShowHistoryModal(true);
                                                        }}
                                                        className="font-medium text-primary-500 hover:text-primary-700 hover:underline text-left transition-colors"
                                                    >
                                                        {student.name}
                                                    </button>
                                                </td>
                                                <td className="py-4 px-4 text-neutral-700">{student.grade}</td>
                                                <td className="py-4 px-4 text-neutral-700">
                                                    {latestScore ? latestScore.exam_date : '-'}
                                                </td>
                                                <td className="py-4 px-4 text-neutral-700">
                                                    {latestScore ? latestScore.subject : '-'}
                                                </td>
                                                <td className="py-4 px-4">
                                                    {latestScore ? (
                                                        <span className={`font-semibold ${
                                                            latestScore.score >= 90 ? 'text-green-600' :
                                                            latestScore.score >= 80 ? 'text-blue-600' :
                                                            latestScore.score >= 70 ? 'text-yellow-600' :
                                                            latestScore.score >= 60 ? 'text-orange-600' :
                                                            'text-red-600'
                                                        }`}>
                                                            {latestScore.score}
                                                            {latestScore.score < 60 && (
                                                                <span className="ml-1 text-xs bg-red-100 text-red-800 px-1 rounded">预警</span>
                                                            )}
                                                        </span>
                                                    ) : (
                                                        <span className="text-neutral-400">未录入</span>
                                                    )}
                                                </td>
                                                <td className="py-4 px-4">
                                                    {latestScore ? (
                                                        <span className={`px-2 py-1 text-xs rounded-full ${
                                                            latestScore.score >= 90 ? 'bg-green-100 text-green-800' :
                                                            latestScore.score >= 80 ? 'bg-blue-100 text-blue-800' :
                                                            latestScore.score >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                                            latestScore.score >= 60 ? 'bg-orange-100 text-orange-800' :
                                                            'bg-red-100 text-red-800'
                                                        }`}>
                                                            {latestScore.grade || (
                                                                latestScore.score >= 90 ? '优秀' :
                                                                latestScore.score >= 80 ? '良好' :
                                                                latestScore.score >= 70 ? '中等' :
                                                                latestScore.score >= 60 ? '及格' : '不及格'
                                                            )}
                                                        </span>
                                                    ) : (
                                                        <span className="text-neutral-400">-</span>
                                                    )}
                                                </td>
                                                <td className="py-4 px-4">
                                                    <button
                                                        onClick={() => {
                                                            setSelectedStudent(student);
                                                            setShowAddForm(true);
                                                        }}
                                                        className="px-3 py-1 bg-primary-500 text-white text-sm rounded-lg hover:bg-primary-700 transition-colors"
                                                    >
                                                        录入成绩
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
            };

            // 渲染统计分析视图
            const renderStatisticsView = () => {
                const stats = calculateStatistics();
                const subjects = Object.keys(stats);

                // 计算个人统计
                const studentStats = {};
                students.forEach(student => {
                    const studentScores = examScores.filter(s => s.student_name === student.name);
                    if (studentScores.length > 0) {
                        const scores = studentScores.map(s => parseFloat(s.score));
                        studentStats[student.name] = {
                            count: studentScores.length,
                            average: (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2),
                            highest: Math.max(...scores).toFixed(2),
                            lowest: Math.min(...scores).toFixed(2),
                            passRate: ((scores.filter(s => s >= 60).length / scores.length) * 100).toFixed(1)
                        };
                    }
                });

                return (
                    <div className="space-y-6">
                        <h3 className="text-lg font-semibold text-neutral-900">成绩统计分析</h3>

                        {/* 科目统计 */}
                        <div>
                            <h4 className="text-md font-semibold text-neutral-800 mb-3">科目统计</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {subjects.map(subject => (
                                    <div key={subject} className="glass-morphism rounded-xl p-6 card-hover">
                                        <h4 className="text-sm font-semibold text-neutral-600 mb-4">{subject}</h4>
                                        <div className="space-y-2">
                                            <div className="flex justify-between">
                                                <span className="text-xs text-neutral-600">平均分</span>
                                                <span className="text-sm font-bold text-primary-500">{stats[subject].average}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-xs text-neutral-600">最高分</span>
                                                <span className="text-sm font-semibold text-green-600">{stats[subject].highest}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-xs text-neutral-600">最低分</span>
                                                <span className="text-sm font-semibold text-red-600">{stats[subject].lowest}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-xs text-neutral-600">及格率</span>
                                                <span className="text-sm font-semibold text-blue-600">{stats[subject].passRate}%</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 学生个人统计 */}
                        <div>
                            <h4 className="text-md font-semibold text-neutral-800 mb-3">学生个人统计</h4>
                            <div className="glass-morphism rounded-xl p-6">
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b border-neutral-200">
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">学生</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">考试次数</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">平均分</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">最高分</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">最低分</th>
                                                <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">及格率</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.keys(studentStats).map(studentName => (
                                                <tr key={studentName} className="border-b border-neutral-100 hover:bg-neutral-0 transition-colors">
                                                    <td className="py-3 px-4 font-medium text-neutral-900">{studentName}</td>
                                                    <td className="py-3 px-4 text-neutral-700">{studentStats[studentName].count}</td>
                                                    <td className="py-3 px-4">
                                                        <span className="font-semibold text-primary-500">
                                                            {studentStats[studentName].average}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4">
                                                        <span className="font-semibold text-green-600">
                                                            {studentStats[studentName].highest}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4">
                                                        <span className="font-semibold text-red-600">
                                                            {studentStats[studentName].lowest}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4">
                                                        <span className="font-semibold text-blue-600">
                                                            {studentStats[studentName].passRate}%
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {Object.keys(studentStats).length === 0 && (
                                    <p className="text-neutral-500 text-center py-8">暂无学生统计数据</p>
                                )}
                            </div>
                        </div>

                        {subjects.length === 0 && Object.keys(studentStats).length === 0 && (
                            <p className="text-neutral-500 text-center py-8">暂无统计数据</p>
                        )}
                    </div>
                );
            };

            // 渲染趋势图表视图
            const renderTrendsView = () => {
                // 获取所有学生名单（去重）
                const studentNames = [...new Set(examScores.map(s => s.student_name))].filter(Boolean).sort();

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-neutral-900">成绩趋势分析</h3>
                            
                            {/* 学生选择器 */}
                            <div className="flex items-center space-x-3">
                                <label className="text-sm font-medium text-neutral-700">选择学生：</label>
                                <select
                                    value={selectedTrendStudent}
                                    onChange={(e) => {
                                        setSelectedTrendStudent(e.target.value);
                                        // 触发图表重新渲染
                                        setTimeout(() => renderCharts(), 100);
                                    }}
                                    className="px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white"
                                >
                                    <option value="">全部学生</option>
                                    {studentNames.map(name => (
                                        <option key={name} value={name}>{name}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        {/* 第一行图表：科目平均分、成绩分布 */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="glass-morphism rounded-xl p-6">
                                <div style={{ height: '300px' }}>
                                    <canvas id="subjectChart"></canvas>
                                </div>
                            </div>

                            <div className="glass-morphism rounded-xl p-6">
                                <div style={{ height: '300px' }}>
                                    <canvas id="gradeDistribution"></canvas>
                                </div>
                            </div>
                        </div>

                        {/* 第二行图表：学生成绩趋势、班级平均分对比 */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="glass-morphism rounded-xl p-6">
                                <div style={{ height: '300px' }}>
                                    <canvas id="studentTrendChart"></canvas>
                                </div>
                            </div>

                            <div className="glass-morphism rounded-xl p-6">
                                <div style={{ height: '300px' }}>
                                    <canvas id="classComparisonChart"></canvas>
                                </div>
                            </div>
                        </div>

                        {/* 第三行图表：按月份时间趋势 */}
                        <div className="glass-morphism rounded-xl p-6">
                            <div style={{ height: '350px' }}>
                                <canvas id="monthlyTrendChart"></canvas>
                            </div>
                        </div>

                        {examScores.length === 0 && (
                            <p className="text-neutral-500 text-center py-8">暂无数据可供分析</p>
                        )}
                    </div>
                );
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center p-12">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                            <p className="mt-2 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="p-6">
                        <div className="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded">
                            <p className="font-bold">加载失败</p>
                            <p>{error}</p>
                            <button 
                                onClick={fetchData}
                                className="mt-2 text-sm underline hover:no-underline"
                            >
                                重试
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div>
                        <h2 className="text-2xl font-bold text-neutral-900">成绩管理</h2>
                        <p className="text-neutral-600">学生成绩录入与分析</p>
                    </div>

                    {/* 视图切换标签 */}
                    <div className="flex space-x-2 border-b border-neutral-200">
                        <button
                            onClick={() => setActiveView('list')}
                            className={`px-4 py-2 font-medium transition-colors ${
                                activeView === 'list'
                                    ? 'border-b-2 border-primary-500 text-primary-500'
                                    : 'text-neutral-600 hover:text-neutral-900'
                            }`}
                        >
                            成绩列表
                        </button>
                        <button
                            onClick={() => setActiveView('statistics')}
                            className={`px-4 py-2 font-medium transition-colors ${
                                activeView === 'statistics'
                                    ? 'border-b-2 border-primary-500 text-primary-500'
                                    : 'text-neutral-600 hover:text-neutral-900'
                            }`}
                        >
                            统计分析
                        </button>
                        <button
                            onClick={() => setActiveView('trends')}
                            className={`px-4 py-2 font-medium transition-colors ${
                                activeView === 'trends'
                                    ? 'border-b-2 border-primary-500 text-primary-500'
                                    : 'text-neutral-600 hover:text-neutral-900'
                            }`}
                        >
                            趋势图表
                        </button>
                    </div>

                    {/* 渲染对应视图 */}
                    {activeView === 'list' && renderListView()}
                    {activeView === 'statistics' && renderStatisticsView()}
                    {activeView === 'trends' && renderTrendsView()}

                    {/* 成绩录入表单 */}
                    {showAddForm && (
                        <ScoreForm 
                            students={students}
                            selectedStudent={selectedStudent}
                            onSave={handleAddScore}
                            onCancel={() => {
                                setShowAddForm(false);
                                setSelectedStudent(null);
                            }}
                        />
                    )}

                    {/* 成绩编辑表单 */}
                    {editingScore && (
                        <ScoreEditForm
                            score={editingScore}
                            students={students}
                            onSave={handleEditScore}
                            onCancel={() => setEditingScore(null)}
                        />
                    )}

                    {/* 历史成绩模态框 */}
                    {showHistoryModal && historyStudent && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass-morphism rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                                <div className="p-6 border-b border-neutral-200">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-xl font-semibold text-neutral-900">
                                            {historyStudent.name} - 历史成绩记录
                                        </h3>
                                        <button
                                            onClick={() => {
                                                setShowHistoryModal(false);
                                                setHistoryStudent(null);
                                            }}
                                            className="p-2 hover:bg-neutral-100 rounded-lg transition-colors"
                                        >
                                            <CloseIcon />
                                        </button>
                                    </div>
                                </div>
                                <div className="p-6 overflow-y-auto flex-1">
                                    {(() => {
                                        const studentHistoryScores = examScores
                                            .filter(score => score.student_name === historyStudent.name)
                                            .sort((a, b) => new Date(b.exam_date) - new Date(a.exam_date));
                                        
                                        if (studentHistoryScores.length === 0) {
                                            return (
                                                <p className="text-neutral-500 text-center py-8">该学生暂无成绩记录</p>
                                            );
                                        }

                                        return (
                                            <div className="overflow-x-auto">
                                                <table className="w-full">
                                                    <thead>
                                                        <tr className="border-b border-neutral-200">
                                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">考试日期</th>
                                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">科目</th>
                                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">考试类型</th>
                                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">成绩</th>
                                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">等级</th>
                                                            <th className="text-left py-3 px-4 text-xs font-semibold text-neutral-400 uppercase">备注</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {studentHistoryScores.map(score => (
                                                            <tr key={score.id} className="border-b border-neutral-100 hover:bg-neutral-0 transition-colors">
                                                                <td className="py-3 px-4 text-neutral-700">{score.exam_date}</td>
                                                                <td className="py-3 px-4 font-medium text-neutral-900">{score.subject}</td>
                                                                <td className="py-3 px-4 text-neutral-700">{score.exam_type || '-'}</td>
                                                                <td className="py-3 px-4">
                                                                    <span className={`font-semibold ${
                                                                        score.score >= 90 ? 'text-green-600' :
                                                                        score.score >= 80 ? 'text-blue-600' :
                                                                        score.score >= 70 ? 'text-yellow-600' :
                                                                        score.score >= 60 ? 'text-orange-600' :
                                                                        'text-red-600'
                                                                    }`}>
                                                                        {score.score}
                                                                    </span>
                                                                </td>
                                                                <td className="py-3 px-4">
                                                                    <span className={`px-2 py-1 text-xs rounded-full ${
                                                                        score.score >= 90 ? 'bg-green-100 text-green-800' :
                                                                        score.score >= 80 ? 'bg-blue-100 text-blue-800' :
                                                                        score.score >= 70 ? 'bg-yellow-100 text-yellow-800' :
                                                                        score.score >= 60 ? 'bg-orange-100 text-orange-800' :
                                                                        'bg-red-100 text-red-800'
                                                                    }`}>
                                                                        {score.grade || (
                                                                            score.score >= 90 ? '优秀' :
                                                                            score.score >= 80 ? '良好' :
                                                                            score.score >= 70 ? '中等' :
                                                                            score.score >= 60 ? '及格' : '不及格'
                                                                        )}
                                                                    </span>
                                                                </td>
                                                                <td className="py-3 px-4 text-neutral-700 text-sm">{score.notes || '-'}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 成绩录入表单组件
        const ScoreForm = ({ students, selectedStudent, onSave, onCancel }) => {
            // 获取选中的学生（如果有）
            const initialStudent = selectedStudent ? selectedStudent.name : '';
            
            const [formData, setFormData] = useState({
                student_name: initialStudent,
                subject: '语文',
                exam_type: '月考',
                exam_date: new Date().toISOString().split('T')[0],
                score: '',
                full_score: 100,
                grade: '',
                notes: ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold text-neutral-900 mb-4">
                            {selectedStudent ? `为 ${selectedStudent.name} 录入成绩` : '录入成绩'}
                        </h3>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">学生</label>
                                    <select
                                        value={formData.student_name}
                                        onChange={(e) => setFormData({...formData, student_name: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="" disabled>选择学生</option>
                                        {students.map(student => (
                                            <option key={student.id} value={student.name}>{student.name}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">科目</label>
                                    <select
                                        value={formData.subject}
                                        onChange={(e) => setFormData({...formData, subject: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="语文">语文</option>
                                        <option value="数学">数学</option>
                                        <option value="英语">英语</option>
                                        <option value="物理">物理</option>
                                        <option value="化学">化学</option>
                                        <option value="生物">生物</option>
                                        <option value="历史">历史</option>
                                        <option value="地理">地理</option>
                                        <option value="政治">政治</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">考试类型</label>
                                    <select
                                        value={formData.exam_type}
                                        onChange={(e) => setFormData({...formData, exam_type: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="月考">月考</option>
                                        <option value="期中考试">期中考试</option>
                                        <option value="期末考试">期末考试</option>
                                        <option value="周测">周测</option>
                                        <option value="单元测试">单元测试</option>
                                        <option value="模拟考试">模拟考试</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">考试日期</label>
                                    <input
                                        type="date"
                                        value={formData.exam_date}
                                        onChange={(e) => setFormData({...formData, exam_date: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">得分</label>
                                    <input
                                        type="number"
                                        value={formData.score}
                                        onChange={(e) => setFormData({...formData, score: parseFloat(e.target.value)})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="输入分数"
                                        min="0"
                                        max={formData.full_score}
                                        step="0.5"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">满分</label>
                                    <input
                                        type="number"
                                        value={formData.full_score}
                                        onChange={(e) => setFormData({...formData, full_score: parseFloat(e.target.value)})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="满分"
                                        min="1"
                                        required
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">备注</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    rows="3"
                                    placeholder="选填，可添加备注信息..."
                                />
                            </div>

                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                                >
                                    保存
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 成绩编辑表单组件
        const ScoreEditForm = ({ score, students, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                student_name: score.student_name || '',
                subject: score.subject || '语文',
                exam_type: score.exam_type || '月考',
                exam_date: score.exam_date || new Date().toISOString().split('T')[0],
                score: score.score || '',
                full_score: score.full_score || 100,
                grade: score.grade || '',
                notes: score.notes || ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold text-neutral-900 mb-4">编辑成绩</h3>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">学生</label>
                                    <select
                                        value={formData.student_name}
                                        onChange={(e) => setFormData({...formData, student_name: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="" disabled>选择学生</option>
                                        {students.map(student => (
                                            <option key={student.id} value={student.name}>{student.name}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">科目</label>
                                    <select
                                        value={formData.subject}
                                        onChange={(e) => setFormData({...formData, subject: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="语文">语文</option>
                                        <option value="数学">数学</option>
                                        <option value="英语">英语</option>
                                        <option value="物理">物理</option>
                                        <option value="化学">化学</option>
                                        <option value="生物">生物</option>
                                        <option value="历史">历史</option>
                                        <option value="地理">地理</option>
                                        <option value="政治">政治</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">考试类型</label>
                                    <select
                                        value={formData.exam_type}
                                        onChange={(e) => setFormData({...formData, exam_type: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="月考">月考</option>
                                        <option value="期中考试">期中考试</option>
                                        <option value="期末考试">期末考试</option>
                                        <option value="周测">周测</option>
                                        <option value="单元测试">单元测试</option>
                                        <option value="模拟考试">模拟考试</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">考试日期</label>
                                    <input
                                        type="date"
                                        value={formData.exam_date}
                                        onChange={(e) => setFormData({...formData, exam_date: e.target.value})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">得分</label>
                                    <input
                                        type="number"
                                        value={formData.score}
                                        onChange={(e) => setFormData({...formData, score: parseFloat(e.target.value)})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="输入分数"
                                        min="0"
                                        max={formData.full_score}
                                        step="0.5"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">满分</label>
                                    <input
                                        type="number"
                                        value={formData.full_score}
                                        onChange={(e) => setFormData({...formData, full_score: parseFloat(e.target.value)})}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="满分"
                                        min="1"
                                        required
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">备注</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    rows="3"
                                    placeholder="选填，可添加备注信息..."
                                />
                            </div>

                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                                >
                                    保存修改
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 设置面板组件
        const Settings = () => {
            // 状态管理
            const [settings, setSettings] = useState({
                // 机构信息
                institutionName: '',
                institutionPhone: '',
                institutionAddress: '',
                institutionDescription: '',
                
                // 系统偏好
                defaultTuitionFee: '',
                defaultMealFee: '',
                enableNotifications: true,
                notificationAdvanceDays: 7,
                quickTuitionA: 800,
                quickTuitionB: 1000,
                dailyCarePrice: 59,
                
                // 家长称谓
                parentTitle: '家长',
                
                // 费用类型
                feeTypes: [
                    { id: 1, name: '学费', defaultAmount: '', description: '每学期或每月的学费' },
                    { id: 2, name: '餐费', defaultAmount: '', description: '每日或每月的餐饮费用' },
                    { id: 3, name: '补课费', defaultAmount: '', description: '课外辅导费用' },
                    { id: 4, name: '活动费', defaultAmount: '', description: '课外活动费用' },
                    { id: 5, name: '其他', defaultAmount: '', description: '其他杂项费用' },
                ],
                
                // 月缴续费配置
                enableMonthlyRenewal: true,
                renewalReminderDays: 3,
                renewalCalculationMethod: 'rolling', // 'rolling' 或 'fixed'
                nasEnabled: false,
                nasWebDavUrl: '',
                nasUsername: '',
                nasPassword: '',
                nasBackupPath: '/backups/tgnew_backup.json',
                nextSemesterStartDate: '',
                semesterLengthDays: 120,
                
                // 学期时间自定义设置
                enableCustomSemesterDates: true,
                springStartDate: '02-20',
                springEndDate: '07-10',
                autumnStartDate: '09-01',
                autumnEndDate: '01-20',
            });

            const [editingFeeType, setEditingFeeType] = useState(null);
            const [saving, setSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showNasPreview, setShowNasPreview] = useState(false);

            // 从localStorage加载设置
            useEffect(() => {
                const savedSettings = localStorage.getItem('systemSettings');
                if (savedSettings) {
                    try {
                        const parsed = JSON.parse(savedSettings);
                        setSettings(prev => ({ ...prev, ...parsed }));
                    } catch (error) {
                        console.error('加载设置失败:', error);
                    }
                }
            }, []);

            // 保存设置到localStorage
            const saveSettings = async () => {
                setSaving(true);
                try {
                    localStorage.setItem('systemSettings', JSON.stringify(settings));
                    // 同步机构名称到学校名称
                    if (settings.institutionName) {
                        localStorage.setItem('schoolName', settings.institutionName);
                    }
                    setSaveMessage('设置保存成功！');
                    setTimeout(() => setSaveMessage(''), 3000);
                } catch (error) {
                    console.error('保存设置失败:', error);
                    setSaveMessage('保存失败，请重试');
                } finally {
                    setSaving(false);
                }
            };

            // 重置为默认设置
            const confirmReset = () => {
                const defaultSettings = {
                    institutionName: '',
                    institutionPhone: '',
                    institutionAddress: '',
                    institutionDescription: '',
                    defaultTuitionFee: '',
                    defaultMealFee: '',
                    enableNotifications: true,
                    notificationAdvanceDays: 7,
                    quickTuitionA: 800,
                    quickTuitionB: 1000,
                    dailyCarePrice: 59,
                    parentTitle: '家长',
                    feeTypes: [
                        { id: 1, name: '学费', defaultAmount: '', description: '每学期或每月的学费' },
                        { id: 2, name: '餐费', defaultAmount: '', description: '每日或每月的餐饮费用' },
                        { id: 3, name: '补课费', defaultAmount: '', description: '课外辅导费用' },
                        { id: 4, name: '活动费', defaultAmount: '', description: '课外活动费用' },
                        { id: 5, name: '其他', defaultAmount: '', description: '其他杂项费用' },
                    ],
                    enableMonthlyRenewal: true,
                    renewalReminderDays: 3,
                    renewalCalculationMethod: 'rolling',
                    nasEnabled: false,
                    nasWebDavUrl: '',
                    nasUsername: '',
                    nasPassword: '',
                    nasBackupPath: '/backups/tgnew_backup.json',
                    nextSemesterStartDate: '',
                    semesterLengthDays: 120,
                    
                    // 学期时间自定义设置
                    enableCustomSemesterDates: true,
                    springStartDate: '02-20',
                    springEndDate: '07-10',
                    autumnStartDate: '09-01',
                    autumnEndDate: '01-20',
                    enableSemesterReminder: true,
                    semesterReminderDays: 7,
                };
                setSettings(defaultSettings);
                localStorage.removeItem('systemSettings');
                setSaveMessage('已重置为默认设置');
                setTimeout(() => setSaveMessage(''), 3000);
                setShowResetConfirm(false);
            };

            // 更新机构信息
            const updateInstitutionInfo = (field, value) => {
                setSettings(prev => ({ ...prev, [field]: value }));
            };

            // 更新系统偏好
            const updateSystemPreference = (field, value) => {
                setSettings(prev => ({ ...prev, [field]: value }));
            };

            // 更新学期时间设置
            const updateSemesterDate = (semester, field, value) => {
                const settingField = semester === 'spring' ? `${semester}${field}` : `${semester}${field}`;
                updateSystemPreference(settingField, value);
            };

            // 更新费用类型
            const updateFeeType = (id, field, value) => {
                setSettings(prev => ({
                    ...prev,
                    feeTypes: prev.feeTypes.map(type => 
                        type.id === id ? { ...type, [field]: value } : type
                    )
                }));
            };

            return (
                <div className="space-y-6">
                    {/* 页面标题 */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-2xl font-bold text-neutral-900">系统设置</h2>
                            <p className="text-neutral-600 mt-1">配置系统参数和机构信息</p>
                        </div>
                        <div className="flex space-x-3">
                            <button
                                onClick={() => setShowResetConfirm(true)}
                                className="flex items-center space-x-2 px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors"
                            >
                                <AlertIcon />
                                <span>重置默认</span>
                            </button>
                            <button
                                onClick={saveSettings}
                                disabled={saving}
                                className="flex items-center space-x-2 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50"
                            >
                                <CheckIcon />
                                <span>{saving ? '保存中...' : '保存设置'}</span>
                            </button>
                        </div>
                    </div>

                    {/* 保存提示消息 */}
                    {saveMessage && (
                        <div className={`p-4 rounded-lg ${saveMessage.includes('成功') ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                            {saveMessage}
                        </div>
                    )}

                    {/* 机构信息设置 */}
                    <div className="glass-morphism rounded-xl p-6">
                        <div className="flex items-center space-x-2 mb-4">
                            <InfoIcon />
                            <h3 className="text-lg font-semibold text-neutral-900">机构信息</h3>
                        </div>
                        <p className="text-sm text-neutral-600 mb-4">设置您的托管班机构基本信息，这些信息将在系统各处显示</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">机构名称</label>
                                <input
                                    type="text"
                                    value={settings.institutionName}
                                    onChange={(e) => updateInstitutionInfo('institutionName', e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="例如：蓝月牙教育托管班"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">联系电话</label>
                                <input
                                    type="tel"
                                    value={settings.institutionPhone}
                                    onChange={(e) => updateInstitutionInfo('institutionPhone', e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="例如：13800138000"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">机构地址</label>
                                <input
                                    type="text"
                                    value={settings.institutionAddress}
                                    onChange={(e) => updateInstitutionInfo('institutionAddress', e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="例如：XX市XX区XX街道XX号"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">机构简介</label>
                                <textarea
                                    value={settings.institutionDescription}
                                    onChange={(e) => updateInstitutionInfo('institutionDescription', e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    rows="3"
                                    placeholder="简要描述您的机构特色和服务..."
                                />
                            </div>
                        </div>
                    </div>

                    {/* 系统偏好设置 */}
                    <div className="glass-morphism rounded-xl p-6">
                        <div className="flex items-center space-x-2 mb-4">
                            <ToolboxIcon />
                            <h3 className="text-lg font-semibold text-neutral-900">系统偏好</h3>
                        </div>
                        <p className="text-sm text-neutral-600 mb-4">配置系统默认行为和通知设置</p>
                        
                        <div className="space-y-4">
                            

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">日托价格（元/天）</label>
                                    <input
                                        type="number"
                                        value={settings.dailyCarePrice}
                                        onChange={(e) => updateSystemPreference('dailyCarePrice', parseFloat(e.target.value) || 59)}
                                        className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="例如：59"
                                        min="0"
                                        step="0.01"
                                    />
                                    <p className="text-xs text-neutral-500 mt-1">设置日托的每日收费标准</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">学费快捷金额 A（元）</label>
                                    <input
                                        type="number"
                                        value={settings.quickTuitionA}
                                        onChange={(e) => updateSystemPreference('quickTuitionA', parseInt(e.target.value) || 0)}
                                        className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="例如：800"
                                        min="0"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">学费快捷金额 B（元）</label>
                                    <input
                                        type="number"
                                        value={settings.quickTuitionB}
                                        onChange={(e) => updateSystemPreference('quickTuitionB', parseInt(e.target.value) || 0)}
                                        className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="例如：1000"
                                        min="0"
                                    />
                                </div>
                                <p className="text-xs text-neutral-500 md:col-span-2">用于学生表单的学费快捷按钮</p>
                            </div>

                            <div>
                                <label className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={settings.enableNotifications}
                                        onChange={(e) => updateSystemPreference('enableNotifications', e.target.checked)}
                                        className="w-5 h-5 text-primary-500 border-neutral-300 rounded focus:ring-primary-500"
                                    />
                                    <span className="text-sm font-medium text-neutral-700">启用系统通知</span>
                                </label>
                                <p className="text-xs text-neutral-500 mt-1 ml-7">开启后系统将发送到期提醒等通知</p>
                            </div>

                            {/* 学期时间自定义设置 */}
                            <div className="border-t border-neutral-200 pt-4">
                                <label className="flex items-center space-x-2 cursor-pointer mb-3">
                                    <input
                                        type="checkbox"
                                        checked={settings.enableCustomSemesterDates}
                                        onChange={(e) => updateSystemPreference('enableCustomSemesterDates', e.target.checked)}
                                        className="w-5 h-5 text-primary-500 border-neutral-300 rounded focus:ring-primary-500"
                                    />
                                    <span className="text-sm font-medium text-neutral-700">启用自定义学期时间</span>
                                </label>
                                
                                {settings.enableCustomSemesterDates && (
                                    <div className="space-y-4 ml-7">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-neutral-700 mb-1">春季学期开始</label>
                                                <input
                                                    type="date"
                                                    value={`2024-${settings.springStartDate}`}
                                                    onChange={(e) => {
                                                        const date = e.target.value;
                                                        const monthDay = date.substring(5); // 提取 MM-DD 部分
                                                        updateSystemPreference('springStartDate', monthDay);
                                                    }}
                                                    className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                                />
                                                <p className="text-xs text-neutral-500 mt-1">选择春季学期开始的日期</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-neutral-700 mb-1">春季学期结束</label>
                                                <input
                                                    type="date"
                                                    value={`2024-${settings.springEndDate}`}
                                                    onChange={(e) => {
                                                        const date = e.target.value;
                                                        const monthDay = date.substring(5); // 提取 MM-DD 部分
                                                        updateSystemPreference('springEndDate', monthDay);
                                                    }}
                                                    className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                                />
                                                <p className="text-xs text-neutral-500 mt-1">选择春季学期结束的日期</p>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-neutral-700 mb-1">秋季学期开始</label>
                                                <input
                                                    type="date"
                                                    value={`2024-${settings.autumnStartDate}`}
                                                    onChange={(e) => {
                                                        const date = e.target.value;
                                                        const monthDay = date.substring(5); // 提取 MM-DD 部分
                                                        updateSystemPreference('autumnStartDate', monthDay);
                                                    }}
                                                    className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                                />
                                                <p className="text-xs text-neutral-500 mt-1">选择秋季学期开始的日期</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-neutral-700 mb-1">秋季学期结束</label>
                                                <input
                                                    type="date"
                                                    value={`2025-${settings.autumnEndDate}`} // 秋季结束是次年，用2025年
                                                    onChange={(e) => {
                                                        const date = e.target.value;
                                                        const monthDay = date.substring(5); // 提取 MM-DD 部分
                                                        updateSystemPreference('autumnEndDate', monthDay);
                                                    }}
                                                    className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                                />
                                                <p className="text-xs text-neutral-500 mt-1">选择秋季学期结束的日期（次年）</p>
                                            </div>
                                        </div>
                                        <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                            <p className="text-sm text-blue-800">
                                                <span className="font-semibold">当前设置：</span>
                                                春季 {settings.springStartDate} 至 {settings.springEndDate}，
                                                秋季 {settings.autumnStartDate} 至 {settings.autumnEndDate}
                                            </p>
                                        </div>
                                        
                                        {/* 学期时间提醒设置 */}
                                        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                            <div className="flex items-center justify-between mb-3">
                                                <label className="flex items-center space-x-2 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={settings.enableSemesterReminder !== false}
                                                        onChange={(e) => updateSystemPreference('enableSemesterReminder', e.target.checked)}
                                                        className="w-5 h-5 text-green-500 border-neutral-300 rounded focus:ring-green-500"
                                                    />
                                                    <span className="text-sm font-medium text-neutral-700">启用学期时间设置提醒</span>
                                                </label>
                                                <select
                                                    className="text-xs border border-neutral-300 rounded px-2 py-1"
                                                    value={settings.semesterReminderDays || 7}
                                                    onChange={(e) => updateSystemPreference('semesterReminderDays', parseInt(e.target.value))}
                                                >
                                                    <option value={3}>开学前3天</option>
                                                    <option value={7}>开学前7天</option>
                                                    <option value={14}>开学前14天</option>
                                                    <option value={30}>开学前30天</option>
                                                </select>
                                            </div>
                                            <p className="text-xs text-green-700">
                                                在每学期开学前自动提醒设置学期时间，确保学期管理准确无误
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>


                        </div>
                    </div>

                    <div className="glass-morphism rounded-xl p-6">
                        <div className="flex items-center space-x-2 mb-4">
                            <FileIcon />
                            <h3 className="text-lg font-semibold text-neutral-900">NAS 备份配置</h3>
                        </div>
                        <p className="text-sm text-neutral-600 mb-4">配置通过 WebDAV 将数据备份到 NAS</p>
                        <div className="space-y-4">
                            <div>
                                <label className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={settings.nasEnabled}
                                        onChange={(e) => updateSystemPreference('nasEnabled', e.target.checked)}
                                        className="w-5 h-5 text-primary-500 border-neutral-300 rounded focus:ring-primary-500"
                                    />
                                    <span className="text-sm font-medium text-neutral-700">启用 NAS 备份</span>
                                </label>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">WebDAV 基址</label>
                                <input
                                    type="text"
                                    value={settings.nasWebDavUrl}
                                    onChange={(e) => updateSystemPreference('nasWebDavUrl', e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="例如：http://nas.local:5005/remote.php/dav/files/user"
                                />
                                <p className="text-xs text-neutral-500 mt-1">不要以斜杠结尾</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">用户名</label>
                                    <input
                                        type="text"
                                        value={settings.nasUsername}
                                        onChange={(e) => updateSystemPreference('nasUsername', e.target.value)}
                                        className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="NAS 登录用户名"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">密码</label>
                                    <input
                                        type="password"
                                        value={settings.nasPassword}
                                        onChange={(e) => updateSystemPreference('nasPassword', e.target.value)}
                                        className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="NAS 登录密码"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">备份路径</label>
                                <input
                                    type="text"
                                    value={settings.nasBackupPath}
                                    onChange={(e) => updateSystemPreference('nasBackupPath', e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="例如：/backups/tgnew_backup.json"
                                />
                                <p className="text-xs text-neutral-500 mt-1">以斜杠开头的相对路径</p>
                            </div>
                            <div className="pt-2">
                                <button
                                    onClick={() => setShowNasPreview(!showNasPreview)}
                                    className="px-4 py-2 bg-neutral-900 text-white rounded-lg hover:bg-neutral-800"
                                >
                                    {showNasPreview ? '隐藏当前配置' : '查看当前配置'}
                                </button>
                                {showNasPreview && (
                                    <div className="mt-3 p-3 bg-neutral-50 border border-neutral-200 rounded-lg text-sm text-neutral-700">
                                        <div>启用：{String(settings.nasEnabled)}</div>
                                        <div>WebDAV：{settings.nasWebDavUrl || '-'}</div>
                                        <div>用户名：{settings.nasUsername || '-'}</div>
                                        <div>备份路径：{settings.nasBackupPath || '-'}</div>
                                        <p className="text-xs text-neutral-500 mt-2">密码不显示，已保存在本地设置中</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* 家长称谓设置 */}
                    <div className="glass-morphism rounded-xl p-6">
                        <div className="flex items-center space-x-2 mb-4">
                            <UserIcon />
                            <h3 className="text-lg font-semibold text-neutral-900">家长称谓</h3>
                        </div>
                        <p className="text-sm text-neutral-600 mb-4">自定义对家长的称呼方式</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">家长称谓</label>
                                <input
                                    type="text"
                                    value={settings.parentTitle}
                                    onChange={(e) => updateSystemPreference('parentTitle', e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="例如：家长、监护人"
                                />
                                <p className="text-xs text-neutral-500 mt-1">在学生信息中显示为"XX家长"</p>
                            </div>

                            <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-sm text-blue-800">
                                    <span className="font-semibold">提示：</span>
                                    您可以根据地区习惯自定义称呼，例如："家长"、"监护人"、"父母"等
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* 费用类型管理 */}
                    <div className="glass-morphism rounded-xl p-6">
                        <div className="flex items-center space-x-2 mb-4">
                            <FinanceIcon />
                            <h3 className="text-lg font-semibold text-neutral-900">费用类型管理</h3>
                        </div>
                        <p className="text-sm text-neutral-600 mb-4">管理各类收费标准，设置默认金额和说明</p>
                        
                        <div className="space-y-3">
                            {settings.feeTypes.map((feeType) => (
                                <div key={feeType.id} className="border border-neutral-200 rounded-lg p-4 hover:border-primary-300 transition-colors">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-xs font-medium text-neutral-600 mb-1">费用名称</label>
                                            <input
                                                type="text"
                                                value={feeType.name}
                                                onChange={(e) => updateFeeType(feeType.id, 'name', e.target.value)}
                                                className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-xs font-medium text-neutral-600 mb-1">默认金额（元）</label>
                                            <input
                                                type="number"
                                                value={feeType.defaultAmount}
                                                onChange={(e) => updateFeeType(feeType.id, 'defaultAmount', e.target.value)}
                                                className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                                placeholder="0"
                                                min="0"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-xs font-medium text-neutral-600 mb-1">说明</label>
                                            <input
                                                type="text"
                                                value={feeType.description}
                                                onChange={(e) => updateFeeType(feeType.id, 'description', e.target.value)}
                                                className="w-full px-3 py-2 text-sm border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            />
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                            <p className="text-sm text-amber-800">
                                <span className="font-semibold">最佳实践：</span>
                                设置准确的默认金额有助于提高录入效率，减少手动输入错误
                            </p>
                        </div>
                    </div>

                    {/* 月缴续费配置 - 已默认开启，配置区域已隐藏 */}
                    {/* 默认设置：enableMonthlyRenewal: true, renewalReminderDays: 3, renewalCalculationMethod: 'rolling' */}

                    {/* 操作指引 */}
                    <div className="glass-morphism rounded-xl p-6 border-2 border-primary-200 bg-primary-50">
                        <div className="flex items-start space-x-3">
                            <div className="p-2 bg-primary-100 rounded-lg text-primary-600">
                                <InfoIcon />
                            </div>
                            <div className="flex-1">
                                <h4 className="font-semibold text-neutral-900 mb-2">使用说明</h4>
                                <ul className="space-y-1 text-sm text-neutral-700">
                                    <li>• 所有设置修改后需点击"保存设置"按钮才会生效</li>
                                    <li>• 设置数据保存在本地浏览器中，清除浏览器数据会丢失</li>
                                    <li>• 如需恢复默认设置，可点击"重置默认"按钮</li>
                                    <li>• 建议定期备份重要配置信息</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    {/* 重置确认对话框 */}
                    {showResetConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="glass-morphism rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                                <div className="flex items-start space-x-3 mb-4">
                                    <div className="p-2 bg-amber-100 rounded-lg text-amber-600">
                                        <AlertIcon />
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="text-lg font-semibold text-neutral-900 mb-2">确认重置设置</h3>
                                        <p className="text-sm text-neutral-600">
                                            确定要将所有设置重置为默认值吗？此操作将清除所有自定义配置，且无法撤销。
                                        </p>
                                    </div>
                                </div>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={() => setShowResetConfirm(false)}
                                        className="flex-1 px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition-colors"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={confirmReset}
                                        className="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                    >
                                        确认重置
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 用户管理组件
        const UserManagement = () => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [selectedUsers, setSelectedUsers] = useState([]);

            useEffect(() => {
                fetchUsers();
            }, []);

            const fetchUsers = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data, error } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setUsers(data || []);
                } catch (err) {
                    console.error('获取用户列表失败:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleAddUser = async (userData) => {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) throw new Error('未登录');

                    // 显示加载状态
                    const submitButton = document.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.textContent = '创建中...';
                        submitButton.disabled = true;
                    }

                    const { data, error } = await supabase.functions.invoke('test-user-create', {
                        body: userData
                    });

                    if (error) {
                        console.error('Edge Function错误:', error);
                        throw new Error(`服务器错误: ${error.message || '未知错误'}`);
                    }
                    
                    if (data.error) {
                        console.error('业务错误:', data.error);
                        throw new Error(data.error.message || data.error.code || '创建失败');
                    }

                    // 成功
                    await fetchUsers();
                    setShowAddForm(false);
                    
                    // 显示成功消息并刷新
                    window.alert(`用户创建成功！\n姓名: ${userData.full_name}\n手机: ${userData.phone}\n角色: ${userData.role}`);
                    
                } catch (err) {
                    console.error('创建用户失败:', err);
                    const errorMessage = err.message || '未知错误';
                    window.alert(`创建失败：${errorMessage}\n\n请检查：\n1. 手机号是否已存在\n2. 是否有管理员权限\n3. 网络连接是否正常`);
                } finally {
                    // 恢复按钮状态
                    const submitButton = document.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.textContent = '创建用户';
                        submitButton.disabled = false;
                    }
                }
            };

            const handleUpdateUser = async (userData) => {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) throw new Error('未登录');

                    const { data, error } = await supabase.functions.invoke('manage-user-update', {
                        body: { ...userData, user_id: editingUser.id }
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error.message);

                    await fetchUsers();
                    setEditingUser(null);
                    window.alert('用户更新成功');
                } catch (err) {
                    console.error('更新用户失败:', err);
                    window.alert('更新失败：' + err.message);
                }
            };

            const handleDeleteUser = async (userId) => {
                const confirmed = window.confirm('确定要删除这个用户吗？');
                if (!confirmed) return;

                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) throw new Error('未登录');

                    const { data, error } = await supabase.functions.invoke('manage-user-delete', {
                        body: { user_ids: [userId] }
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error.message);

                    await fetchUsers();
                    window.alert('用户删除成功');
                } catch (err) {
                    console.error('删除用户失败:', err);
                    window.alert('删除失败：' + err.message);
                }
            };

            const handleBatchDelete = async () => {
                if (selectedUsers.length === 0) {
                    window.alert('请选择要删除的用户');
                    return;
                }

                const confirmed = window.confirm(`确定要删除选中的 ${selectedUsers.length} 个用户吗？`);
                if (!confirmed) return;

                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) throw new Error('未登录');

                    const { data, error } = await supabase.functions.invoke('manage-user-delete', {
                        body: { user_ids: selectedUsers }
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error.message);

                    await fetchUsers();
                    setSelectedUsers([]);
                    window.alert(`成功删除 ${data.data.deleted} 个用户`);
                } catch (err) {
                    console.error('批量删除失败:', err);
                    window.alert('批量删除失败：' + err.message);
                }
            };

            const toggleSelectUser = (userId) => {
                setSelectedUsers(prev =>
                    prev.includes(userId)
                        ? prev.filter(id => id !== userId)
                        : [...prev, userId]
                );
            };

            const toggleSelectAll = () => {
                if (selectedUsers.length === users.length) {
                    setSelectedUsers([]);
                } else {
                    setSelectedUsers(users.map(u => u.id));
                }
            };

            const getRoleLabel = (role) => {
                const roles = {
                    admin: '管理员',
                    teacher: '教师',
                    student: '学生',
                    parent: '家长'
                };
                return roles[role] || role;
            };

            const getRoleBadgeColor = (role) => {
                const colors = {
                    admin: 'bg-red-100 text-red-700',
                    teacher: 'bg-blue-100 text-blue-700',
                    student: 'bg-green-100 text-green-700',
                    parent: 'bg-yellow-100 text-yellow-700'
                };
                return colors[role] || 'bg-gray-100 text-gray-700';
            };

            const getStatusBadgeColor = (status) => {
                return status === 'active' 
                    ? 'bg-green-100 text-green-700' 
                    : 'bg-gray-100 text-gray-700';
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                            <p className="mt-4 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="p-6">
                        <div className="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded-lg">
                            错误：{error}
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full overflow-y-auto">
                    <div className="p-6 space-y-6">
                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-neutral-900">用户管理</h2>
                                <p className="text-neutral-600 mt-1">管理系统中的所有用户账号</p>
                            </div>
                            <div className="flex gap-2">
                                {selectedUsers.length > 0 && (
                                    <button
                                        onClick={handleBatchDelete}
                                        className="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center space-x-2"
                                    >
                                        <DeleteIcon />
                                        <span>批量删除 ({selectedUsers.length})</span>
                                    </button>
                                )}
                                <button
                                    onClick={() => setShowAddForm(true)}
                                    className="bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors flex items-center space-x-2"
                                >
                                    <PlusIcon />
                                    <span>添加用户</span>
                                </button>
                            </div>
                        </div>

                        <div className="glass-morphism rounded-xl overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-neutral-100 border-b border-neutral-200">
                                        <tr>
                                            <th className="px-4 py-3 text-left">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedUsers.length === users.length && users.length > 0}
                                                    onChange={toggleSelectAll}
                                                    className="rounded border-neutral-300"
                                                />
                                            </th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">姓名</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">手机号码</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">角色</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">部门</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">状态</th>
                                            <th className="px-4 py-3 text-left text-sm font-semibold text-neutral-900">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-neutral-200">
                                        {users.map((user) => (
                                            <tr key={user.id} className="hover:bg-neutral-50">
                                                <td className="px-4 py-3">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedUsers.includes(user.id)}
                                                        onChange={() => toggleSelectUser(user.id)}
                                                        className="rounded border-neutral-300"
                                                    />
                                                </td>
                                                <td className="px-4 py-3 text-sm text-neutral-900">{user.full_name || '-'}</td>
                                                <td className="px-4 py-3 text-sm text-neutral-900">{user.phone || '-'}</td>
                                                <td className="px-4 py-3">
                                                    <span className={`inline-block px-2 py-1 rounded-full text-xs font-medium ${getRoleBadgeColor(user.role)}`}>
                                                        {getRoleLabel(user.role)}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-sm text-neutral-600">{user.department || '-'}</td>
                                                <td className="px-4 py-3">
                                                    <span className={`inline-block px-2 py-1 rounded-full text-xs font-medium ${getStatusBadgeColor(user.status)}`}>
                                                        {user.status === 'active' ? '活跃' : '停用'}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="flex space-x-2">
                                                        <button
                                                            onClick={() => setEditingUser(user)}
                                                            className="text-primary-500 hover:text-primary-700 p-1"
                                                            title="编辑"
                                                        >
                                                            <EditIcon />
                                                        </button>
                                                        <button
                                                            onClick={() => handleDeleteUser(user.id)}
                                                            className="text-red-500 hover:text-red-700 p-1"
                                                            title="删除"
                                                        >
                                                            <DeleteIcon />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                        {users.length === 0 && (
                                            <tr>
                                                <td colSpan="7" className="px-4 py-8 text-center text-neutral-600">
                                                    暂无用户数据
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {showAddForm && (
                        <UserForm
                            onSubmit={handleAddUser}
                            onCancel={() => setShowAddForm(false)}
                        />
                    )}

                    {editingUser && (
                        <UserForm
                            user={editingUser}
                            onSubmit={handleUpdateUser}
                            onCancel={() => setEditingUser(null)}
                        />
                    )}
                </div>
            );
        };

        // 用户表单组件
        const UserForm = ({ user, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                phone: user?.phone || '',
                password: '',
                full_name: user?.full_name || '',
                role: user?.role || 'teacher',
                department: user?.department || '',
                status: user?.status || 'active',
                notes: user?.notes || ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!user && !formData.password) {
                    window.alert('密码不能为空');
                    return;
                }

                if (!formData.phone) {
                    window.alert('手机号不能为空');
                    return;
                }

                // 验证手机号格式
                if (!isValidPhone(formData.phone)) {
                    window.alert('请输入有效的11位手机号码');
                    return;
                }

                const submitData = { ...formData };
                if (user && !formData.password) {
                    delete submitData.password;
                }

                onSubmit(submitData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="glass-morphism rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <h3 className="text-xl font-bold text-neutral-900 mb-4">
                            {user ? '编辑用户' : '添加用户'}
                        </h3>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        手机号 <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="tel"
                                        name="phone"
                                        value={formData.phone}
                                        onChange={(e) => {
                                            const value = e.target.value.replace(/\D/g, '');
                                            if (value.length <= 11) {
                                                handleChange({ target: { name: 'phone', value } });
                                            }
                                        }}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="请输入11位手机号码"
                                        maxLength="11"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        密码 {!user && <span className="text-red-500">*</span>}
                                    </label>
                                    <input
                                        type="password"
                                        name="password"
                                        value={formData.password}
                                        onChange={handleChange}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder={user ? '留空则不修改' : '请输入密码'}
                                        required={!user}
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">姓名</label>
                                    <input
                                        type="text"
                                        name="full_name"
                                        value={formData.full_name}
                                        onChange={handleChange}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="请输入姓名"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">
                                        角色 <span className="text-red-500">*</span>
                                    </label>
                                    <select
                                        name="role"
                                        value={formData.role}
                                        onChange={handleChange}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="admin">管理员</option>
                                        <option value="teacher">教师</option>
                                        <option value="student">学生</option>
                                        <option value="parent">家长</option>
                                    </select>
                                </div>



                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">部门</label>
                                    <input
                                        type="text"
                                        name="department"
                                        value={formData.department}
                                        onChange={handleChange}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="请输入部门"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">状态</label>
                                    <select
                                        name="status"
                                        value={formData.status}
                                        onChange={handleChange}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="active">活跃</option>
                                        <option value="inactive">停用</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">备注</label>
                                <textarea
                                    name="notes"
                                    value={formData.notes}
                                    onChange={handleChange}
                                    rows="3"
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="请输入备注信息"
                                />
                            </div>

                            <div className="flex space-x-3 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors font-medium"
                                >
                                    {user ? '更新' : '创建'}
                                </button>
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                >
                                    取消
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

// ==================== 数据库管理组件 ====================

        const DatabaseManagement = () => {
            const [activeTab, setActiveTab] = useState('tables'); // tables, records, status, settings
            const [tables, setTables] = useState([]);
            const [selectedTable, setSelectedTable] = useState('');
            const [tableRecords, setTableRecords] = useState([]);
            const [tableColumns, setTableColumns] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [totalRecords, setTotalRecords] = useState(0);
            const [dbStatus, setDbStatus] = useState({});
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [pageSize, setPageSize] = useState(50);
            const [sortField, setSortField] = useState('');
            const [sortOrder, setSortOrder] = useState('asc');
            const [backupStatus, setBackupStatus] = useState('');
            const [lastBackupTime, setLastBackupTime] = useState('');
            const [confirmDialog, setConfirmDialog] = useState({
                show: false,
                title: '',
                message: '',
                onConfirm: null,
                onCancel: null
            });
            const [selectedRecords, setSelectedRecords] = useState(new Set()); // 存储选中的记录ID
            const [selectAll, setSelectAll] = useState(false); // 全选状态

            // 数据库表定义
            const tableDefinitions = {
                students: {
                    name: '学生信息',
                    description: '存储学生基本信息',
                    columns: ['id', 'name', 'grade', 'class', 'parent_name', 'phone', 'address', 'daily_consumption', 'enrollment_date', 'status', 'student_type', 'created_at', 'updated_at'],
                    key: 'id'
                },
                transactions: {
                    name: '财务交易',
                    description: '存储所有财务交易记录',
                    columns: ['id', 'student_id', 'type', 'amount', 'description', 'transaction_date', 'payment_method', 'reference_number', 'created_at', 'updated_at'],
                    key: 'id'
                },
                payment_records: {
                    name: '缴费记录',
                    description: '存储学生缴费记录',
                    columns: ['id', 'student_id', 'amount', 'payment_date', 'next_due_date', 'status', 'payment_method', 'notes', 'created_at', 'updated_at'],
                    key: 'id'
                },
                attendance_records: {
                    name: '考勤记录',
                    description: '存储学生考勤信息',
                    columns: ['id', 'student_id', 'attendance_date', 'status', 'check_in_time', 'check_out_time', 'notes', 'created_at', 'updated_at'],
                    key: 'id'
                },
                exam_scores: {
                    name: '考试成绩',
                    description: '存储学生考试成绩',
                    columns: ['id', 'student_id', 'exam_name', 'subject', 'score', 'total_score', 'exam_date', 'notes', 'created_at', 'updated_at'],
                    key: 'id'
                },
                learning_plans: {
                    name: '学习计划',
                    description: '存储学习计划信息',
                    columns: ['id', 'student_id', 'plan_name', 'start_date', 'end_date', 'status', 'description', 'created_at', 'updated_at'],
                    key: 'id'
                },
                notifications: {
                    name: '通知记录',
                    description: '存储系统通知',
                    columns: ['id', 'recipient_phone', 'message', 'type', 'status', 'send_date', 'created_at', 'updated_at'],
                    key: 'id'
                },
                user_profiles: {
                    name: '用户信息',
                    description: '存储用户基本信息',
                    columns: ['id', 'phone', 'full_name', 'role', 'department', 'status', 'created_at', 'updated_at'],
                    key: 'id'
                },
                expenses: {
                    name: '支出记录',
                    description: '存储系统支出记录',
                    columns: ['id', 'user_id', 'amount', 'description', 'expense_date', 'category', 'payment_method', 'notes', 'created_at', 'updated_at'],
                    key: 'id'
                },
                learning_plan_students: {
                    name: '学习计划学生关联',
                    description: '存储学习计划与学生的关联关系',
                    columns: ['id', 'learning_plan_id', 'student_id', 'student_name', 'created_at', 'updated_at'],
                    key: 'id'
                },
                homeworks: {
                    name: '作业管理',
                    description: '存储作业发布和批改信息',
                    columns: ['id', 'user_id', 'title', 'content', 'subject', 'grade', 'class', 'due_date', 'status', 'created_at', 'updated_at'],
                    key: 'id'
                },
                study_plans: {
                    name: '学习计划详情',
                    description: '存储学习计划的详细内容',
                    columns: ['id', 'user_id', 'plan_name', 'description', 'start_date', 'end_date', 'status', 'created_at', 'updated_at'],
                    key: 'id'
                }
            };

            useEffect(() => {
                loadTableList();
                loadDatabaseStatus();
                loadBackupInfo();
            }, []);

            useEffect(() => {
                if (selectedTable && activeTab === 'records') {
                    loadTableRecords();
                }
            }, [selectedTable, currentPage, pageSize, sortField, sortOrder]);

            // 当切换表时，清空选中记录
            useEffect(() => {
                setSelectedRecords(new Set());
                setSelectAll(false);
            }, [selectedTable]);

            const loadTableList = async () => {
                try {
                    setLoading(true);
                    const tableNames = Object.keys(tableDefinitions);
                    const tableInfo = [];
                    
                    for (const tableName of tableNames) {
                        try {
                            const { count, error } = await supabase
                                .from(tableName)
                                .select('*', { count: 'exact', head: true });
                            
                            if (!error) {
                                tableInfo.push({
                                    name: tableName,
                                    displayName: tableDefinitions[tableName].name,
                                    description: tableDefinitions[tableName].description,
                                    recordCount: count || 0
                                });
                            }
                        } catch (err) {
                            console.error(`获取表 ${tableName} 记录数失败:`, err);
                        }
                    }
                    
                    setTables(tableInfo);
                } catch (err) {
                    console.error('加载表列表失败:', err);
                    setError('加载表列表失败: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const loadTableRecords = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    let query = supabase.from(selectedTable).select('*');
                    
                    // 搜索过滤
                    if (searchTerm) {
                        const searchColumns = tableDefinitions[selectedTable]?.columns.filter(col => 
                            ['name', 'phone', 'description', 'message', 'plan_name', 'exam_name', 'subject'].includes(col)
                        ) || [];
                        
                        if (searchColumns.length > 0) {
                            query = query.or(searchColumns.map(col => `${col}.ilike.%${searchTerm}%`).join(','));
                        }
                    }
                    
                    // 排序
                    if (sortField) {
                        query = query.order(sortField, { ascending: sortOrder === 'asc' });
                    } else {
                        query = query.order('created_at', { ascending: false });
                    }
                    
                    // 分页
                    const start = (currentPage - 1) * pageSize;
                    query = query.range(start, start + pageSize - 1);
                    
                    const { data, error, count } = await query;
                    
                    if (error) throw error;
                    
                    setTableRecords(data || []);
                    setTotalRecords(count || 0);
                    
                    // 获取表结构信息
                    if (data && data.length > 0) {
                        const columns = Object.keys(data[0]);
                        setTableColumns(columns);
                    }
                } catch (err) {
                    console.error('加载表记录失败:', err);
                    setError('加载表记录失败: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // 处理单个记录的选中/取消选中
            const handleRecordSelect = (recordId) => {
                const newSelectedRecords = new Set(selectedRecords);
                if (newSelectedRecords.has(recordId)) {
                    newSelectedRecords.delete(recordId);
                } else {
                    newSelectedRecords.add(recordId);
                }
                setSelectedRecords(newSelectedRecords);
                setSelectAll(newSelectedRecords.size === tableRecords.length);
            };

            // 处理全选/取消全选
            const handleSelectAll = () => {
                if (selectAll) {
                    setSelectedRecords(new Set());
                } else {
                    const allIds = tableRecords.map(record => record.id);
                    setSelectedRecords(new Set(allIds));
                }
                setSelectAll(!selectAll);
            };

            // 批量删除选中的记录
            const handleBatchDelete = () => {
                if (selectedRecords.size === 0) {
                    setError('请先选择要删除的记录');
                    return;
                }

                setConfirmDialog({
                    show: true,
                    title: '批量删除确认',
                    message: `确定要删除选中的 ${selectedRecords.size} 条记录吗？此操作不可撤销。`,
                    onConfirm: async () => {
                        try {
                            setLoading(true);
                            const recordIds = Array.from(selectedRecords);
                            
                            // 批量删除记录
                            const { error } = await supabase
                                .from(selectedTable)
                                .delete()
                                .in('id', recordIds);
                            
                            if (error) throw error;
                            
                            // 刷新记录列表
                            await loadTableRecords();
                            setSelectedRecords(new Set());
                            setSelectAll(false);
                            
                            setError(null);
                        } catch (err) {
                            console.error('批量删除失败:', err);
                            setError('批量删除失败: ' + err.message);
                        } finally {
                            setLoading(false);
                        }
                    },
                    onCancel: () => {}
                });
            };

            const loadDatabaseStatus = async () => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    
                    // 获取数据库统计信息
                    const stats = {};
                    for (const tableName of Object.keys(tableDefinitions)) {
                        try {
                            const { count } = await supabase
                                .from(tableName)
                                .select('*', { count: 'exact', head: true });
                            stats[tableName] = count || 0;
                        } catch (err) {
                            stats[tableName] = 0;
                        }
                    }
                    
                    // 获取数据库大小信息（模拟）
                    const totalRecords = Object.values(stats).reduce((sum, count) => sum + count, 0);
                    const estimatedSize = totalRecords * 2; // 粗略估计：每条记录约2KB
                    
                    setDbStatus({
                        totalTables: Object.keys(tableDefinitions).length,
                        totalRecords: totalRecords,
                        estimatedSize: estimatedSize,
                        lastUpdated: new Date().toLocaleString(),
                        user: user?.email || '未知用户',
                        connectionStatus: '已连接'
                    });
                } catch (err) {
                    console.error('加载数据库状态失败:', err);
                    setDbStatus({
                        error: '无法获取数据库状态'
                    });
                }
            };

            const loadBackupInfo = () => {
                try {
                    const lastBackup = localStorage.getItem('lastBackupTime');
                    if (lastBackup) {
                        setLastBackupTime(lastBackup);
                    }
                } catch (err) {
                    console.error('加载备份信息失败:', err);
                }
            };

            const showConfirmDialog = (title, message, onConfirm, onCancel = null) => {
                setConfirmDialog({
                    show: true,
                    title,
                    message,
                    onConfirm: () => {
                        setConfirmDialog(prev => ({ ...prev, show: false }));
                        if (onConfirm) onConfirm();
                    },
                    onCancel: () => {
                        setConfirmDialog(prev => ({ ...prev, show: false }));
                        if (onCancel) onCancel();
                    }
                });
            };

            const handleTableSelect = (tableName) => {
                setSelectedTable(tableName);
                setCurrentPage(1);
                setActiveTab('records');
            };

            const handleAddRecord = () => {
                setEditingRecord(null);
                setShowAddForm(true);
            };

            const handleEditRecord = (record) => {
                setEditingRecord(record);
                setShowAddForm(true);
            };

            const handleDeleteRecord = (record) => {
                showConfirmDialog(
                    '删除确认',
                    `确定要删除这条记录吗？\n\n表：${tableDefinitions[selectedTable]?.name}\nID：${record[tableDefinitions[selectedTable]?.key]}`,
                    async () => {
                        try {
                            const key = tableDefinitions[selectedTable]?.key;
                            const { error } = await supabase
                                .from(selectedTable)
                                .delete()
                                .eq(key, record[key]);

                            if (error) throw error;

                            showConfirmDialog('成功', '记录删除成功', null, null);
                            loadTableRecords();
                        } catch (err) {
                            console.error('删除记录失败:', err);
                            showConfirmDialog('错误', '删除失败：' + err.message, null, null);
                        }
                    }
                );
            };

            const handleSaveRecord = async (formData) => {
                try {
                    if (editingRecord) {
                        // 更新记录
                        const key = tableDefinitions[selectedTable]?.key;
                        const { error } = await supabase
                            .from(selectedTable)
                            .update(formData)
                            .eq(key, editingRecord[key]);

                        if (error) throw error;
                        showConfirmDialog('成功', '记录更新成功', null, null);
                    } else {
                        // 添加新记录
                        const { error } = await supabase
                            .from(selectedTable)
                            .insert(formData);

                        if (error) throw error;
                        showConfirmDialog('成功', '记录添加成功', null, null);
                    }

                    setShowAddForm(false);
                    loadTableRecords();
                } catch (err) {
                    console.error('保存记录失败:', err);
                    showConfirmDialog('错误', '保存失败：' + err.message, null, null);
                }
            };

            const handleBackup = () => {
                showConfirmDialog(
                    '备份确认',
                    '确定要备份数据库吗？这将创建所有数据的完整备份。',
                    async () => {
                        try {
                            setBackupStatus('正在备份...');
                            
                            const backupData = {};
                            for (const tableName of Object.keys(tableDefinitions)) {
                                try {
                                    const { data } = await supabase
                                        .from(tableName)
                                        .select('*');
                                    backupData[tableName] = data || [];
                                } catch (err) {
                                    console.error(`备份表 ${tableName} 失败:`, err);
                                }
                            }

                            // 保存到本地存储
                            const backupString = JSON.stringify(backupData, null, 2);
                            const backupTime = new Date().toISOString();
                            localStorage.setItem('databaseBackup', backupString);
                            localStorage.setItem('lastBackupTime', backupTime);
                            
                            setLastBackupTime(backupTime);
                            setBackupStatus('备份完成');
                            
                            // 创建下载文件
                            const blob = new Blob([backupString], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `database_backup_${new Date().toISOString().split('T')[0]}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            setTimeout(() => setBackupStatus(''), 3000);
                        } catch (err) {
                            console.error('备份失败:', err);
                            setBackupStatus('备份失败');
                            setTimeout(() => setBackupStatus(''), 3000);
                        }
                    }
                );
            };

            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        showConfirmDialog(
                            '恢复确认',
                            '确定要恢复数据库吗？这将覆盖现有数据！',
                            () => {
                                // 这里可以实现恢复逻辑
                                showConfirmDialog('信息', '恢复功能需要谨慎实现，请联系系统管理员', null, null);
                            }
                        );
                    } catch (err) {
                        console.error('恢复失败:', err);
                        showConfirmDialog('错误', '恢复失败：文件格式错误', null, null);
                    }
                };
                reader.readAsText(file);
            };

            const handleClearCache = () => {
                showConfirmDialog(
                    '清除缓存确认',
                    '确定要清除缓存吗？',
                    () => {
                        try {
                            // 清除各种缓存
                            localStorage.removeItem('cachedData');
                            localStorage.removeItem('lastFetchTime');
                            sessionStorage.clear();
                            
                            showConfirmDialog('成功', '缓存清除成功', null, () => {
                                window.location.reload();
                            });
                        } catch (err) {
                            console.error('清除缓存失败:', err);
                            showConfirmDialog('错误', '清除缓存失败', null, null);
                        }
                    }
                );
            };

            const handleExportData = () => {
                try {
                    const exportData = {
                        tableName: selectedTable,
                        exportTime: new Date().toISOString(),
                        records: tableRecords
                    };
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${selectedTable}_export_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error('导出失败:', err);
                    showConfirmDialog('错误', '导出失败：' + err.message, null, null);
                }
            };

            const formatValue = (value, column) => {
                if (value === null || value === undefined) return '-';
                
                if (column.includes('date') || column.includes('time')) {
                    return new Date(value).toLocaleString();
                }
                
                if (typeof value === 'boolean') {
                    return value ? '是' : '否';
                }
                
                if (typeof value === 'number') {
                    return value.toLocaleString();
                }
                
                return String(value);
            };

            const RecordForm = ({ record, onSave, onCancel }) => {
                const [formData, setFormData] = useState(record || {});
                
                const handleChange = (field, value) => {
                    setFormData(prev => ({ ...prev, [field]: value }));
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onSave(formData);
                };

                const columns = tableDefinitions[selectedTable]?.columns || tableColumns;
                const editableColumns = columns.filter(col => 
                    !['id', 'created_at', 'updated_at', 'user_id'].includes(col)
                );

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="glass-morphism rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <h3 className="text-xl font-bold text-neutral-900 mb-4">
                                {record ? '编辑记录' : '添加记录'} - {tableDefinitions[selectedTable]?.name}
                            </h3>
                            
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {editableColumns.map(column => (
                                        <div key={column}>
                                            <label className="block text-sm font-medium text-neutral-700 mb-1">
                                                {column}
                                            </label>
                                            <input
                                                type="text"
                                                value={formData[column] || ''}
                                                onChange={(e) => handleChange(column, e.target.value)}
                                                className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                                placeholder={`请输入 ${column}`}
                                            />
                                        </div>
                                    ))}
                                </div>

                                <div className="flex space-x-3 pt-4">
                                    <button
                                        type="submit"
                                        className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors font-medium"
                                    >
                                        保存
                                    </button>
                                    <button
                                        type="button"
                                        onClick={onCancel}
                                        className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                    >
                                        取消
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            return (
                <div className="space-y-6">
                    {/* 页面标题 */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-2xl font-bold text-neutral-900">数据库管理</h2>
                            <p className="text-neutral-600 mt-1">管理和维护系统数据库</p>
                        </div>
                        <div className="flex space-x-3">
                            <button
                                onClick={handleBackup}
                                disabled={!!backupStatus}
                                className="flex items-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50"
                            >
                                <DatabaseIcon />
                                <span>{backupStatus || '备份数据库'}</span>
                            </button>
                            <label className="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors cursor-pointer">
                                <DatabaseIcon />
                                <span>恢复数据库</span>
                                <input
                                    type="file"
                                    accept=".json"
                                    onChange={handleRestore}
                                    className="hidden"
                                />
                            </label>
                        </div>
                    </div>

                    {/* 错误提示 */}
                    {error && (
                        <div className="bg-red-50 text-red-700 p-4 rounded-lg">
                            {error}
                        </div>
                    )}

                    {/* 标签页导航 */}
                    <div className="border-b border-neutral-200">
                        <nav className="-mb-px flex space-x-8">
                            {[
                                { id: 'tables', name: '数据表', icon: <DatabaseIcon /> },
                                { id: 'records', name: '记录管理', icon: <StudentsIcon /> },
                                { id: 'status', name: '数据库状态', icon: <InfoIcon /> },
                                { id: 'settings', name: '数据库设置', icon: <SettingsIcon /> }
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`
                                        flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm
                                        ${activeTab === tab.id
                                            ? 'border-primary-500 text-primary-600'
                                            : 'border-transparent text-neutral-500 hover:text-neutral-700 hover:border-neutral-300'
                                        }
                                    `}
                                >
                                    {tab.icon}
                                    <span>{tab.name}</span>
                                </button>
                            ))}
                        </nav>
                    </div>

                    {/* 数据表列表 */}
                    {activeTab === 'tables' && (
                        <div className="glass-morphism rounded-xl p-6">
                            <h3 className="text-lg font-semibold text-neutral-900 mb-4">数据库表列表</h3>
                            {loading ? (
                                <div className="text-center py-8">
                                    <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                                    <p className="mt-2 text-neutral-600">加载中...</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {tables.map(table => (
                                        <div
                                            key={table.name}
                                            className="p-4 border border-neutral-200 rounded-lg hover:bg-neutral-50 cursor-pointer transition-colors"
                                            onClick={() => handleTableSelect(table.name)}
                                        >
                                            <div className="flex items-center justify-between mb-2">
                                                <h4 className="font-medium text-neutral-900">{table.displayName}</h4>
                                                <span className="text-sm text-neutral-500 bg-neutral-100 px-2 py-1 rounded">
                                                    {table.recordCount} 条
                                                </span>
                                            </div>
                                            <p className="text-sm text-neutral-600">{table.description}</p>
                                            <div className="mt-3 text-xs text-neutral-500">
                                                表名: {table.name}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* 记录管理 */}
                    {activeTab === 'records' && (
                        <div className="space-y-4">
                            <div className="glass-morphism rounded-xl p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-semibold text-neutral-900">
                                        {tableDefinitions[selectedTable]?.name || '记录管理'}
                                    </h3>
                                    <div className="flex space-x-3">
                                        {selectedTable && (
                                            <>
                                                <button
                                                    onClick={handleAddRecord}
                                                    className="flex items-center space-x-2 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors"
                                                >
                                                    <PlusIcon />
                                                    <span>添加记录</span>
                                                </button>
                                                <button
                                                    onClick={handleExportData}
                                                    className="flex items-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                                                >
                                                    <ExportIcon />
                                                    <span>导出数据</span>
                                                </button>
                                                {selectedRecords.size > 0 && (
                                                    <button
                                                        onClick={handleBatchDelete}
                                                        className="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                                    >
                                                        <DeleteIcon />
                                                        <span>批量删除 ({selectedRecords.size})</span>
                                                    </button>
                                                )}
                                            </>
                                        )}
                                    </div>
                                </div>

                                {/* 表选择器 */}
                                <div className="mb-4">
                                    <select
                                        value={selectedTable}
                                        onChange={(e) => handleTableSelect(e.target.value)}
                                        className="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    >
                                        <option value="">请选择数据表</option>
                                        {Object.entries(tableDefinitions).map(([key, def]) => (
                                            <option key={key} value={key}>{def.name}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* 搜索和过滤 */}
                                {selectedTable && (
                                    <div className="mb-4">
                                        <input
                                            type="text"
                                            placeholder="搜索记录..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        />
                                    </div>
                                )}

                                {/* 记录列表 */}
                                {selectedTable && (
                                    <div className="overflow-x-auto">
                                        {loading ? (
                                            <div className="text-center py-8">
                                                <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                                                <p className="mt-2 text-neutral-600">加载中...</p>
                                            </div>
                                        ) : tableRecords.length === 0 ? (
                                            <div className="text-center py-8 text-neutral-500">
                                                暂无记录
                                            </div>
                                        ) : (
                                            <div>
                                                {/* 全选复选框 */}
                                                <div className="mb-3 flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectAll}
                                                        onChange={handleSelectAll}
                                                        className="mr-2 h-4 w-4 text-primary-600 focus:ring-primary-500 border-neutral-300 rounded"
                                                    />
                                                    <label className="text-sm text-neutral-700">全选</label>
                                                </div>
                                                
                                                <div className="space-y-2">
                                                    {tableRecords.map((record, index) => (
                                                        <div key={index} className="p-4 border border-neutral-200 rounded-lg">
                                                            <div className="flex items-center justify-between mb-2">
                                                                <div className="flex items-center">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedRecords.has(record.id)}
                                                                        onChange={() => handleRecordSelect(record.id)}
                                                                        className="mr-2 h-4 w-4 text-primary-600 focus:ring-primary-500 border-neutral-300 rounded"
                                                                    />
                                                                    <div className="text-sm text-neutral-500">
                                                                        ID: {record.id}
                                                                    </div>
                                                                </div>
                                                                <div className="flex space-x-2">
                                                                    <button
                                                                        onClick={() => handleEditRecord(record)}
                                                                        className="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
                                                                    >
                                                                        编辑
                                                                    </button>
                                                                    <button
                                                                        onClick={() => handleDeleteRecord(record)}
                                                                        className="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors"
                                                                    >
                                                                        删除
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 text-sm">
                                                                {tableColumns.slice(0, 8).map(column => (
                                                                    <div key={column} className="flex flex-col">
                                                                        <span className="text-neutral-500">{column}:</span>
                                                                        <span className="font-medium truncate">
                                                                            {formatValue(record[column], column)}
                                                                        </span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* 数据库状态 */}
                    {activeTab === 'status' && (
                        <div className="space-y-4">
                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">数据库状态</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="p-4 bg-blue-50 rounded-lg">
                                        <div className="text-2xl font-bold text-blue-600">{dbStatus.totalTables || 0}</div>
                                        <div className="text-sm text-blue-700">总表数</div>
                                    </div>
                                    <div className="p-4 bg-green-50 rounded-lg">
                                        <div className="text-2xl font-bold text-green-600">{dbStatus.totalRecords || 0}</div>
                                        <div className="text-sm text-green-700">总记录数</div>
                                    </div>
                                    <div className="p-4 bg-yellow-50 rounded-lg">
                                        <div className="text-2xl font-bold text-yellow-600">{dbStatus.estimatedSize || 0} KB</div>
                                        <div className="text-sm text-yellow-700">估计大小</div>
                                    </div>
                                    <div className="p-4 bg-purple-50 rounded-lg">
                                        <div className="text-lg font-bold text-purple-600">{dbStatus.connectionStatus || '未知'}</div>
                                        <div className="text-sm text-purple-700">连接状态</div>
                                    </div>
                                </div>
                            </div>

                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">各表记录统计</h3>
                                <div className="space-y-2">
                                    {tables.map(table => (
                                        <div key={table.name} className="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                                            <div>
                                                <div className="font-medium">{table.displayName}</div>
                                                <div className="text-sm text-neutral-500">{table.description}</div>
                                            </div>
                                            <div className="text-lg font-bold text-primary-600">{table.recordCount}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">系统信息</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-neutral-600">最后更新:</span>
                                        <span>{dbStatus.lastUpdated || '未知'}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-neutral-600">当前用户:</span>
                                        <span>{dbStatus.user || '未知'}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-neutral-600">最后备份:</span>
                                        <span>{lastBackupTime || '从未备份'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 数据库设置 */}
                    {activeTab === 'settings' && (
                        <div className="space-y-4">
                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">数据库设置</h3>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between p-4 bg-neutral-50 rounded-lg">
                                        <div>
                                            <div className="font-medium">清除缓存</div>
                                            <div className="text-sm text-neutral-500">清除本地缓存数据，重新加载</div>
                                        </div>
                                        <button
                                            onClick={handleClearCache}
                                            className="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors"
                                        >
                                            清除缓存
                                        </button>
                                    </div>
                                    
                                    <div className="flex items-center justify-between p-4 bg-neutral-50 rounded-lg">
                                        <div>
                                            <div className="font-medium">自动备份</div>
                                            <div className="text-sm text-neutral-500">设置自动备份频率（需要配置）</div>
                                        </div>
                                        <select className="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                            <option value="">关闭</option>
                                            <option value="daily">每天</option>
                                            <option value="weekly">每周</option>
                                            <option value="monthly">每月</option>
                                        </select>
                                    </div>
                                    
                                    <div className="flex items-center justify-between p-4 bg-neutral-50 rounded-lg">
                                        <div>
                                            <div className="font-medium">数据保留期限</div>
                                            <div className="text-sm text-neutral-500">设置历史数据的保留时间</div>
                                        </div>
                                        <select className="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                            <option value="0">永久保留</option>
                                            <option value="30">30天</option>
                                            <option value="90">90天</option>
                                            <option value="180">180天</option>
                                            <option value="365">1年</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">高级设置</h3>
                                <div className="space-y-4">
                                    <div className="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                        <div className="flex items-center space-x-2 text-yellow-800">
                                            <AlertIcon />
                                            <span className="font-medium">警告</span>
                                        </div>
                                        <p className="text-sm text-yellow-700 mt-2">
                                            以下操作可能影响数据库完整性，请谨慎操作。
                                        </p>
                                    </div>
                                    
                                    <div className="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                                        <div>
                                            <div className="font-medium text-red-800">重置数据库</div>
                                            <div className="text-sm text-red-600">清除所有数据，恢复到初始状态</div>
                                        </div>
                                        <button
                                            onClick={() => window.alert('此操作需要管理员权限，请联系系统管理员')}
                                            className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                        >
                                            重置数据库
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 记录表单模态框 */}
                    {showAddForm && (
                        <RecordForm
                            record={editingRecord}
                            onSave={handleSaveRecord}
                            onCancel={() => setShowAddForm(false)}
                        />
                    )}

                    {/* 确认对话框模态框 */}
                    {confirmDialog.show && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="glass-morphism rounded-2xl p-6 w-full max-w-md">
                                <h3 className="text-lg font-bold text-neutral-900 mb-4">{confirmDialog.title}</h3>
                                <p className="text-neutral-700 mb-6">{confirmDialog.message}</p>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={() => {
                                            if (confirmDialog.onConfirm) {
                                                confirmDialog.onConfirm();
                                            }
                                            setConfirmDialog({ show: false, title: '', message: '', onConfirm: null, onCancel: null });
                                        }}
                                        className="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors font-medium"
                                    >
                                        确认
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (confirmDialog.onCancel) {
                                                confirmDialog.onCancel();
                                            }
                                            setConfirmDialog({ show: false, title: '', message: '', onConfirm: null, onCancel: null });
                                        }}
                                        className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                                    >
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

// ==================== 完整通知管理系统组件 ====================

        // 通知管理中心主组件
        const NotificationCenter = () => {
            const [activeTab, setActiveTab] = useState('send'); // send, history, stats, templates
            const [notifications, setNotifications] = useState([]);
            const [templates, setTemplates] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [students, setStudents] = useState([]);
            const [showSendForm, setShowSendForm] = useState(false);
            const [showTemplateForm, setShowTemplateForm] = useState(false);
            const [editingTemplate, setEditingTemplate] = useState(null);
            const [lowBalanceStudents, setLowBalanceStudents] = useState([]);
            
            useEffect(() => {
                fetchData();
            }, []);
            
            const fetchData = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('用户未登录');
                        return;
                    }

                    // 并行获取所有数据
                    const [notificationsRes, studentsRes, templatesRes] = await Promise.all([
                        supabase
                            .from('notifications')
                            .select('*')
                            .eq('user_id', user.id)
                            .order('created_at', { ascending: false }),
                        supabase
                            .from('students')
                            .select('id, name, grade, daily_consumption')
                            .eq('user_id', user.id),
                        supabase
                            .from('notification_templates')
                            .select('*')
                            .eq('user_id', user.id)
                            .order('created_at', { ascending: false })
                    ]);

                    if (notificationsRes.error) throw notificationsRes.error;
                    if (studentsRes.error) throw studentsRes.error;
                    if (templatesRes.error) throw templatesRes.error;

                    setNotifications(notificationsRes.data || []);
                    setStudents(studentsRes.data || []);
                    setTemplates(templatesRes.data || []);
                    
                    // 计算余额不足3天的学生（已移除余额功能）
                    const lowBalance = []; // 空数组，不再计算低余额学生
                    setLowBalanceStudents(lowBalance);
                } catch (err) {
                    console.error('获取数据失败:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };
            
            const handleSendNotification = async (notificationData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');
                    
                    const { data: session } = await supabase.auth.getSession();
                    const token = session?.session?.access_token;

                    const { data, error } = await supabase.functions.invoke('send-notification', {
                        body: notificationData,
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error.message);

                    await fetchData();
                    setShowSendForm(false);
                    alert('通知发送成功');
                } catch (err) {
                    console.error('发送通知失败:', err);
                    alert('发送失败: ' + err.message);
                }
            };
            
            // 发送缴费倒计时通知
            const handleSendCountdownNotifications = async () => {
                if (lowBalanceStudents.length === 0) {
                    alert('当前没有需要提醒的学生');
                    return;
                }
                
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');
                    
                    const { data: session } = await supabase.auth.getSession();
                    const token = session?.session?.access_token;
                    
                    // 为每个学生生成通知
                    for (const student of lowBalanceStudents) {
                        const notificationData = {
                            title: '缴费提醒',
                            content: `尊敬的家长，您好！学生 ${student.name} 的日托服务即将到期，请及时续费，谢谢！`,
                            type: 'renewal',
                            priority: 'important',
                            recipient_ids: [student.id]
                        };
                        
                        await supabase.functions.invoke('send-notification', {
                            body: notificationData,
                            headers: {
                                Authorization: `Bearer ${token}`
                            }
                        });
                    }
                    
                    alert(`已成功发送${lowBalanceStudents.length}条缴费倒计时通知`);
                    await fetchData();
                } catch (err) {
                    console.error('发送倒计时通知失败:', err);
                    alert('发送失败: ' + err.message);
                }
            };
            
            // 模板管理
            const handleSaveTemplate = async (templateData) => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');
                    
                    const { data: session } = await supabase.auth.getSession();
                    const token = session?.session?.access_token;

                    if (editingTemplate) {
                        // 更新模板
                        const { data, error } = await supabase.functions.invoke('manage-notification-template', {
                            body: {
                                action: 'update',
                                template_id: editingTemplate.id,
                                ...templateData
                            },
                            headers: {
                                Authorization: `Bearer ${token}`
                            }
                        });
                        
                        if (error) throw error;
                        if (data.error) throw new Error(data.error.message);
                    } else {
                        // 创建新模板
                        const { data, error } = await supabase.functions.invoke('manage-notification-template', {
                            body: {
                                action: 'create',
                                ...templateData
                            },
                            headers: {
                                Authorization: `Bearer ${token}`
                            }
                        });
                        
                        if (error) throw error;
                        if (data.error) throw new Error(data.error.message);
                    }

                    await fetchData();
                    setShowTemplateForm(false);
                    setEditingTemplate(null);
                    alert('模板保存成功');
                } catch (err) {
                    console.error('保存模板失败:', err);
                    alert('保存失败: ' + err.message);
                }
            };
            
            const handleDeleteTemplate = async (templateId) => {
                if (!confirm('确定要删除此模板吗？')) return;
                
                try {
                    const { data: session } = await supabase.auth.getSession();
                    const token = session?.session?.access_token;

                    const { data, error } = await supabase.functions.invoke('manage-notification-template', {
                        body: {
                            action: 'delete',
                            template_id: templateId
                        },
                        headers: {
                            Authorization: `Bearer ${token}`
                        }
                    });
                    
                    if (error) throw error;
                    if (data.error) throw new Error(data.error.message);

                    await fetchData();
                    alert('模板删除成功');
                } catch (err) {
                    console.error('删除模板失败:', err);
                    alert('删除失败: ' + err.message);
                }
            };
            
            // 统计数据计算
            const calculateStats = () => {
                const total = notifications.length;
                const sent = notifications.filter(n => n.status === 'sent').length;
                const scheduled = notifications.filter(n => n.status === 'scheduled').length;
                
                // 按类型统计
                const typeStats = {};
                notifications.forEach(n => {
                    typeStats[n.type] = (typeStats[n.type] || 0) + 1;
                });
                
                return {
                    total,
                    sent,
                    scheduled,
                    readRate: total > 0 ? Math.round((sent / total) * 100) : 0,
                    typeStats
                };
            };
            
            const stats = calculateStats();
            
            if (loading) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-lg text-neutral-600">加载中...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p className="text-red-600">加载失败: {error}</p>
                        <button 
                            onClick={fetchData}
                            className="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                        >
                            重试
                        </button>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div>
                        <h2 className="text-2xl font-bold text-neutral-900">通知管理</h2>
                        <p className="text-neutral-600">发送和管理系统通知</p>
                    </div>

                    {/* 标签导航 */}
                    <div className="glass-morphism rounded-xl p-2 overflow-x-auto">
                        <div className="flex space-x-2 min-w-max">
                            <button
                                onClick={() => setActiveTab('send')}
                                className={`px-4 py-2 rounded-lg transition-colors whitespace-nowrap ${
                                    activeTab === 'send'
                                        ? 'bg-primary-500 text-white'
                                        : 'text-neutral-700 hover:bg-neutral-100'
                                }`}
                            >
                                发送通知
                            </button>
                            <button
                                onClick={() => setActiveTab('countdown')}
                                className={`px-4 py-2 rounded-lg transition-colors whitespace-nowrap ${
                                    activeTab === 'countdown'
                                        ? 'bg-primary-500 text-white'
                                        : 'text-neutral-700 hover:bg-neutral-100'
                                }`}
                            >
                                缴费倒计时
                                {lowBalanceStudents.length > 0 && (
                                    <span className="ml-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">
                                        {lowBalanceStudents.length}
                                    </span>
                                )}
                            </button>
                            <button
                                onClick={() => setActiveTab('templates')}
                                className={`px-4 py-2 rounded-lg transition-colors whitespace-nowrap ${
                                    activeTab === 'templates'
                                        ? 'bg-primary-500 text-white'
                                        : 'text-neutral-700 hover:bg-neutral-100'
                                }`}
                            >
                                通知模板
                            </button>
                            <button
                                onClick={() => setActiveTab('history')}
                                className={`px-4 py-2 rounded-lg transition-colors whitespace-nowrap ${
                                    activeTab === 'history'
                                        ? 'bg-primary-500 text-white'
                                        : 'text-neutral-700 hover:bg-neutral-100'
                                }`}
                            >
                                通知历史
                            </button>
                            <button
                                onClick={() => setActiveTab('stats')}
                                className={`px-4 py-2 rounded-lg transition-colors whitespace-nowrap ${
                                    activeTab === 'stats'
                                        ? 'bg-primary-500 text-white'
                                        : 'text-neutral-700 hover:bg-neutral-100'
                                }`}
                            >
                                统计分析
                            </button>
                        </div>
                    </div>

                    {/* 发送通知标签 */}
                    {activeTab === 'send' && (
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-semibold text-neutral-900">发送新通知</h3>
                                {!showSendForm && (
                                    <button
                                        onClick={() => setShowSendForm(true)}
                                        className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-700 transition-colors"
                                    >
                                        创建通知
                                    </button>
                                )}
                            </div>

                            {showSendForm ? (
                                <NotificationForm
                                    students={students}
                                    templates={templates}
                                    onSubmit={handleSendNotification}
                                    onCancel={() => setShowSendForm(false)}
                                />
                            ) : (
                                <div className="text-center text-neutral-600 py-8">
                                    点击"创建通知"按钮开始发送新通知
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* 缴费倒计时标签 */}
                    {activeTab === 'countdown' && (
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-semibold text-neutral-900">缴费倒计时提醒</h3>
                                {lowBalanceStudents.length > 0 && (
                                    <button
                                        onClick={handleSendCountdownNotifications}
                                        className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors"
                                    >
                                        批量发送提醒
                                    </button>
                                )}
                            </div>
                            
                            {lowBalanceStudents.length > 0 ? (
                                <div className="space-y-3">
                                    {lowBalanceStudents.map(student => (
                                        <div key={student.id} className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-neutral-900">{student.name}</h4>
                                                    <p className="text-sm text-neutral-600 mt-1">年级：{student.grade}</p>
                                                </div>

                                            </div>
                                            <div className="mt-3 grid grid-cols-2 gap-3 text-sm">
                                                <div className="bg-white rounded p-2">
                                                    <span className="text-neutral-600">每日费用：</span>
                                                    <span className="font-semibold">￥{student.dailyCost.toFixed(2)}</span>
                                                </div>
                                                <div className="bg-white rounded p-2">
                                                    <span className="text-neutral-600">剩余天数：</span>
                                                    <span className="font-semibold text-red-600">{student.daysRemaining}天</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-12">
                                    <div className="sketch-icon mx-auto mb-4">
                                        <svg className="sketch-success" viewBox="0 0 24 24">
                                            <circle cx="12" cy="12" r="10" className="sketch-check-circle"/>
                                            <path d="M8 12l3 3 5-6"/>
                                        </svg>
                                    </div>
                                    <p className="text-lg text-green-600 font-semibold">所有学生余额充足</p>
                                    <p className="text-sm text-neutral-600 mt-2">当前没有余额不足3天的学生</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* 通知模板标签 */}
                    {activeTab === 'templates' && (
                        <div className="glass-morphism rounded-xl p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-lg font-semibold text-neutral-900">通知模板</h3>
                                {!showTemplateForm && (
                                    <button
                                        onClick={() => {
                                            setShowTemplateForm(true);
                                            setEditingTemplate(null);
                                        }}
                                        className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-700 transition-colors"
                                    >
                                        新建模板
                                    </button>
                                )}
                            </div>

                            {showTemplateForm ? (
                                <TemplateForm
                                    template={editingTemplate}
                                    onSubmit={handleSaveTemplate}
                                    onCancel={() => {
                                        setShowTemplateForm(false);
                                        setEditingTemplate(null);
                                    }}
                                />
                            ) : (
                                <>
                                    {templates.length > 0 ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {templates.map(template => (
                                                <div key={template.id} className="bg-neutral-50 border border-neutral-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <h4 className="font-semibold text-neutral-900">{template.name}</h4>
                                                            <span className="inline-block mt-1 px-2 py-0.5 text-xs bg-blue-100 text-blue-800 rounded">
                                                                {template.type}
                                                            </span>
                                                        </div>
                                                        <div className="flex space-x-2">
                                                            <button
                                                                onClick={() => {
                                                                    setEditingTemplate(template);
                                                                    setShowTemplateForm(true);
                                                                }}
                                                                className="text-sm text-blue-600 hover:text-blue-800"
                                                            >
                                                                编辑
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeleteTemplate(template.id)}
                                                                className="text-sm text-red-600 hover:text-red-800"
                                                            >
                                                                删除
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="text-sm space-y-2">
                                                        <p className="text-neutral-700"><strong>标题：</strong>{template.title}</p>
                                                        <p className="text-neutral-600 line-clamp-2">{template.content}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center text-neutral-600 py-8">
                                            暂无模板，点击"新建模板"开始创建
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}

                    {/* 通知历史标签 */}
                    {activeTab === 'history' && (
                        <div className="glass-morphism rounded-xl p-6">
                            <h3 className="text-lg font-semibold text-neutral-900 mb-6">通知历史</h3>
                            {notifications.length > 0 ? (
                                <div className="space-y-3">
                                    {notifications.map(notification => (
                                        <div key={notification.id} className="bg-neutral-50 rounded-lg p-4 border border-neutral-200">
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-neutral-900">{notification.title}</h4>
                                                    <p className="text-sm text-neutral-600 mt-1">{notification.content}</p>
                                                </div>
                                                <span className={`px-3 py-1 text-xs rounded-full ml-4 ${
                                                    notification.status === 'sent' ? 'bg-green-100 text-green-800' :
                                                    notification.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`}>
                                                    {notification.status === 'sent' ? '已发送' :
                                                     notification.status === 'scheduled' ? '待发送' : notification.status}
                                                </span>
                                            </div>
                                            <div className="flex items-center space-x-4 text-xs text-neutral-600 mt-2">
                                                <span>类型: {notification.type}</span>
                                                <span>优先级: {notification.priority || '普通'}</span>
                                                <span>发送时间: {new Date(notification.created_at).toLocaleString('zh-CN')}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center text-neutral-600 py-8">
                                    暂无通知记录
                                </div>
                            )}
                        </div>
                    )}

                    {/* 统计分析标签 */}
                    {activeTab === 'stats' && (
                        <div className="space-y-6">
                            {/* 总体统计 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">总体统计</h3>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-blue-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">总发送数</p>
                                        <p className="text-2xl font-bold text-blue-600">{stats.total}</p>
                                    </div>
                                    <div className="bg-green-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">已发送</p>
                                        <p className="text-2xl font-bold text-green-600">{stats.sent}</p>
                                    </div>
                                    <div className="bg-yellow-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">待发送</p>
                                        <p className="text-2xl font-bold text-yellow-600">{stats.scheduled}</p>
                                    </div>
                                    <div className="bg-purple-50 rounded-lg p-4 text-center">
                                        <p className="text-sm text-neutral-600 mb-1">发送率</p>
                                        <p className="text-2xl font-bold text-purple-600">{stats.readRate}%</p>
                                    </div>
                                </div>
                            </div>

                            {/* 按类型统计 */}
                            <div className="glass-morphism rounded-xl p-6">
                                <h3 className="text-lg font-semibold text-neutral-900 mb-4">类型分布</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {Object.entries(stats.typeStats).map(([type, count]) => (
                                        <div key={type} className="bg-neutral-50 rounded-lg p-3 flex justify-between items-center">
                                            <span className="text-sm font-medium text-neutral-700">{type}</span>
                                            <span className="text-lg font-bold text-primary-500">{count}</span>
                                        </div>
                                    ))}
                                    {Object.keys(stats.typeStats).length === 0 && (
                                        <div className="col-span-full text-center text-neutral-500 py-4">
                                            暂无统计数据
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 通知发送表单组件
        const NotificationForm = ({ students, templates, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                title: '',
                content: '',
                type: 'renewal', // 默认续费提醒
                priority: 'normal',
                target_type: 'all',
                recipient_ids: []
            });
            
            const [selectAll, setSelectAll] = useState(false);
            const [selectedTemplate, setSelectedTemplate] = useState('');
            
            const notificationTypes = [
                { value: 'renewal', label: '续费提醒' },
                { value: 'holiday', label: '节假日提醒' },
                { value: 'tutoring', label: '加辅提醒' },
                { value: 'homework', label: '作业提醒' },
                { value: 'grade', label: '成绩通知' },
                { value: 'attendance', label: '考勤异常' },
                { value: 'custom', label: '自定义通知' }
            ];
            
            const priorities = [
                { value: 'normal', label: '普通' },
                { value: 'urgent', label: '紧急' },
                { value: 'important', label: '重要' }
            ];
            
            // 应用模板
            const handleApplyTemplate = (templateId) => {
                const template = templates && templates.find(t => t.id === templateId);
                if (template) {
                    setFormData({
                        ...formData,
                        title: template.title,
                        content: template.content,
                        type: template.type
                    });
                    setSelectedTemplate(templateId);
                }
            };
            
            const handleSelectAll = (checked) => {
                setSelectAll(checked);
                if (checked) {
                    setFormData({
                        ...formData,
                        recipient_ids: students.map(s => s.id)
                    });
                } else {
                    setFormData({
                        ...formData,
                        recipient_ids: []
                    });
                }
            };
            
            const handleStudentToggle = (studentId) => {
                const newIds = formData.recipient_ids.includes(studentId)
                    ? formData.recipient_ids.filter(id => id !== studentId)
                    : [...formData.recipient_ids, studentId];
                    
                setFormData({
                    ...formData,
                    recipient_ids: newIds
                });
                setSelectAll(newIds.length === students.length);
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.recipient_ids.length === 0) {
                    alert('请至少选择一个接收者');
                    return;
                }
                onSubmit(formData);
            };
            
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    {/* 模板选择 */}
                    {templates && templates.length > 0 && (
                        <div>
                            <label className="block text-sm font-medium text-neutral-700 mb-1">
                                使用模板（可选）
                            </label>
                            <select
                                value={selectedTemplate}
                                onChange={(e) => handleApplyTemplate(e.target.value)}
                                className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            >
                                <option value="">选择一个模板...</option>
                                {templates.map(template => (
                                    <option key={template.id} value={template.id}>
                                        {template.name} ({template.type})
                                    </option>
                                ))}
                            </select>
                        </div>
                    )}
                    
                    {/* 通知标题 */}
                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-1">
                            通知标题 <span className="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            placeholder="请输入通知标题"
                            required
                        />
                    </div>
                    
                    {/* 通知内容 */}
                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-1">
                            通知内容 <span className="text-red-500">*</span>
                        </label>
                        <textarea
                            value={formData.content}
                            onChange={(e) => setFormData({...formData, content: e.target.value})}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            rows="4"
                            placeholder="请输入通知内容"
                            required
                        />
                    </div>
                    
                    {/* 通知类型和优先级 */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-neutral-700 mb-1">
                                通知类型 <span className="text-red-500">*</span>
                            </label>
                            <select
                                value={formData.type}
                                onChange={(e) => setFormData({...formData, type: e.target.value})}
                                className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                required
                            >
                                {notificationTypes.map(type => (
                                    <option key={type.value} value={type.value}>{type.label}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-neutral-700 mb-1">
                                优先级 <span className="text-red-500">*</span>
                            </label>
                            <select
                                value={formData.priority}
                                onChange={(e) => setFormData({...formData, priority: e.target.value})}
                                className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                required
                            >
                                {priorities.map(priority => (
                                    <option key={priority.value} value={priority.value}>{priority.label}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    
                    {/* 接收者选择 */}
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <label className="block text-sm font-medium text-neutral-700">
                                接收者 <span className="text-red-500">*</span>
                            </label>
                            <label className="flex items-center space-x-2 text-sm">
                                <input
                                    type="checkbox"
                                    checked={selectAll}
                                    onChange={(e) => handleSelectAll(e.target.checked)}
                                    className="rounded border-neutral-300"
                                />
                                <span className="text-neutral-700">全选 ({formData.recipient_ids.length}/{students.length})</span>
                            </label>
                        </div>
                        <div className="max-h-48 overflow-y-auto border border-neutral-300 rounded-lg p-3 space-y-2">
                            {students.map(student => (
                                <label key={student.id} className="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        checked={formData.recipient_ids.includes(student.id)}
                                        onChange={() => handleStudentToggle(student.id)}
                                        className="rounded border-neutral-300"
                                    />
                                    <span className="text-sm text-neutral-700">
                                        {student.name} ({student.grade})
                                    </span>
                                </label>
                            ))}
                            {students.length === 0 && (
                                <div className="text-center text-neutral-500 py-4">
                                    暂无学生数据
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* 按钮 */}
                    <div className="flex space-x-3 pt-4">
                        <button
                            type="submit"
                            className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                        >
                            立即发送
                        </button>
                        <button
                            type="button"
                            onClick={onCancel}
                            className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                        >
                            取消
                        </button>
                    </div>
                </form>
            );
        };

        // 模板表单组件
        const TemplateForm = ({ template, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({
                name: template?.name || '',
                title: template?.title || '',
                content: template?.content || '',
                type: template?.type || 'renewal'
            });
            
            const templateTypes = [
                { value: 'renewal', label: '续费提醒' },
                { value: 'holiday', label: '节假日提醒' },
                { value: 'tutoring', label: '加辅提醒' },
                { value: 'homework', label: '作业提醒' },
                { value: 'grade', label: '成绩通知' },
                { value: 'attendance', label: '考勤异常' },
                { value: 'custom', label: '自定义通知' }
            ];
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };
            
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-1">
                            模板名称 <span className="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            value={formData.name}
                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            placeholder="例如：周末作业提醒"
                            required
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-1">
                            通知类型 <span className="text-red-500">*</span>
                        </label>
                        <select
                            value={formData.type}
                            onChange={(e) => setFormData({...formData, type: e.target.value})}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            required
                        >
                            {templateTypes.map(type => (
                                <option key={type.value} value={type.value}>{type.label}</option>
                            ))}
                        </select>
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-1">
                            通知标题 <span className="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            placeholder="请输入通知标题"
                            required
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-1">
                            通知内容 <span className="text-red-500">*</span>
                        </label>
                        <textarea
                            value={formData.content}
                            onChange={(e) => setFormData({...formData, content: e.target.value})}
                            className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            rows="6"
                            placeholder="请输入通知内容"
                            required
                        />
                    </div>
                    
                    <div className="flex space-x-3 pt-4">
                        <button
                            type="submit"
                            className="flex-1 bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors"
                        >
                            {template ? '更新模板' : '创建模板'}
                        </button>
                        <button
                            type="button"
                            onClick={onCancel}
                            className="flex-1 bg-neutral-200 text-neutral-700 py-2 px-4 rounded-lg hover:bg-neutral-300 transition-colors"
                        >
                            取消
                        </button>
                    </div>
                </form>
            );
        };

        // 增强版数据导出组件
        const DataExport = () => {
            const { selectedMonth: globalSelectedMonth, getMonthRange } = React.useContext(GlobalMonthContext);
            const [loading, setLoading] = useState(false);
            const [exportType, setExportType] = useState('students');
            const [format, setFormat] = useState('excel');
            const [filter, setFilter] = useState({
                grade: '',
                subject: '',
                startDate: '',
                endDate: ''
            });
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [nasStatus, setNasStatus] = useState('');

            // 通用Excel导出函数
            const exportToExcel = (data, sheetName, columns) => {
                if (!data || data.length === 0) {
                    setError('没有可导出的数据');
                    return;
                }

                const wsData = [];
                wsData.push(columns.map(col => col.header));
                
                data.forEach(item => {
                    const row = columns.map(col => {
                        const value = item[col.key];
                        if (value === null || value === undefined) return '';
                        if (col.format) return col.format(value);
                        return value;
                    });
                    wsData.push(row);
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                ws['!cols'] = columns.map(() => ({ wch: 15 }));
                XLSX.utils.book_append_sheet(wb, ws, sheetName);

                const date = new Date().toISOString().split('T')[0];
                const fileName = `${sheetName}_${date}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            // 导出学生信息
            const exportStudents = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    let query = supabase
                        .from('students')
                        .select('*')
                        .eq('user_id', user.id)
                        .order('name');

                    if (filter.grade) {
                        query = query.eq('grade', filter.grade);
                    }

                    const { data, error: fetchError } = await query;
                    if (fetchError) throw fetchError;

                    const columns = [
                        { header: '姓名', key: 'name' },
                        { header: '性别', key: 'gender' },
                        { header: '年龄', key: 'age' },
                        { header: '年级', key: 'grade' },
                        { header: '班级', key: 'class' },
                        { header: '家长姓名', key: 'parent' },
                        { header: '联系电话', key: 'phone' },
                        { header: '托管需求', key: 'custody_requirement' },
                        { header: '报名日期', key: 'enrollment_date', format: v => v ? new Date(v).toLocaleDateString('zh-CN') : '' },
                        { header: '状态', key: 'status' }
                    ];

                    if (format === 'excel') {
                        exportToExcel(data, '学生信息', columns);
                        setSuccess('学生信息导出成功！');
                    } else {
                        setError('仅支持Excel导出格式');
                    }
                } catch (err) {
                    console.error('导出失败:', err);
                    setError('导出失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // 导出成绩数据
            const exportGrades = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { start, end } = getMonthRange();
                    let query = supabase
                        .from('exam_scores')
                        .select('*')
                        .eq('user_id', user.id)
                        .gte('exam_date', start)
                        .lte('exam_date', end)
                        .order('exam_date', { ascending: false });

                    if (filter.subject) {
                        query = query.eq('subject', filter.subject);
                    }

                    const { data, error: fetchError } = await query;
                    if (fetchError) throw fetchError;

                    const columns = [
                        { header: '姓名', key: 'student_name' },
                        { header: '科目', key: 'subject' },
                        { header: '分数', key: 'score' },
                        { header: '满分', key: 'full_score' },
                        { header: '等级', key: 'grade' },
                        { header: '考试日期', key: 'exam_date', format: v => v ? new Date(v).toLocaleDateString('zh-CN') : '' },
                        { header: '考试类型', key: 'exam_type' },
                        { header: '备注', key: 'notes' }
                    ];

                    if (format === 'excel') {
                        exportToExcel(data, '成绩报表', columns);
                        setSuccess('成绩报表导出成功！');
                    } else {
                        setError('仅支持Excel导出格式');
                    }
                } catch (err) {
                    console.error('导出失败:', err);
                    setError('导出失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // 导出考勤数据
            const exportAttendance = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { start, end } = getMonthRange();
                    const { data, error: fetchError } = await supabase
                        .from('attendance_records')
                        .select('*')
                        .eq('user_id', user.id)
                        .gte('attendance_date', start)
                        .lte('attendance_date', end)
                        .order('attendance_date', { ascending: false });

                    if (fetchError) throw fetchError;

                    const columns = [
                        { header: '日期', key: 'attendance_date', format: v => v ? new Date(v).toLocaleDateString('zh-CN') : '' },
                        { header: '学生姓名', key: 'student_name' },
                        { header: '状态', key: 'status', format: v => {
                            const statusMap = { 'present': '出勤', 'absent': '缺勤', 'late': '迟到', 'leave': '请假' };
                            return statusMap[v] || v;
                        }},
                        { header: '签到时间', key: 'check_in_time' },
                        { header: '签退时间', key: 'check_out_time' },
                        { header: '备注', key: 'notes' }
                    ];

                    if (format === 'excel') {
                        exportToExcel(data, '考勤记录', columns);
                        setSuccess('考勤记录导出成功！');
                    } else {
                        setError('仅支持Excel导出格式');
                    }
                } catch (err) {
                    console.error('导出失败:', err);
                    setError('导出失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // 导出财务数据
            const exportFinance = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { start, end } = getMonthRange();
                    const { data, error: fetchError } = await supabase
                        .from('transactions')
                        .select('*')
                        .eq('user_id', user.id)
                        .gte('transaction_date', start)
                        .lte('transaction_date', end)
                        .order('created_at', { ascending: false });

                    if (fetchError) throw fetchError;

                    const columns = [
                        { header: '日期', key: 'transaction_date', format: v => v ? new Date(v).toLocaleDateString('zh-CN') : '' },
                        { header: '类型', key: 'type', format: v => v === 'income' ? '收入' : '支出' },
                        { header: '金额', key: 'amount' },
                        { header: '学生姓名', key: 'student_name' },
                        { header: '分类', key: 'category' },
                        { header: '支付方式', key: 'payment_method' },
                        { header: '备注', key: 'notes' }
                    ];

                    if (format === 'excel') {
                        exportToExcel(data, '财务报表', columns);
                        setSuccess('财务报表导出成功！');
                    } else {
                        setError('仅支持Excel导出格式');
                    }
                } catch (err) {
                    console.error('导出失败:', err);
                    setError('导出失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // 导出作业数据
            const exportHomework = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { start, end } = getMonthRange();
                    const { data, error: fetchError } = await supabase
                        .from('homeworks')
                        .select('*')
                        .eq('user_id', user.id)
                        .gte('created_at', start)
                        .lte('created_at', end)
                        .order('created_at', { ascending: false });

                    if (fetchError) throw fetchError;

                    const columns = [
                        { header: '标题', key: 'title' },
                        { header: '科目', key: 'subject' },
                        { header: '类型', key: 'homework_type' },
                        { header: '优先级', key: 'priority' },
                        { header: '班级', key: 'class' },
                        { header: '截止日期', key: 'due_date', format: v => v ? new Date(v).toLocaleDateString('zh-CN') : '' },
                        { header: '状态', key: 'status' },
                        { header: '描述', key: 'description' }
                    ];

                    if (format === 'excel') {
                        exportToExcel(data, '作业列表', columns);
                        setSuccess('作业数据导出成功！');
                    } else {
                        setError('仅支持Excel导出格式');
                    }
                } catch (err) {
                    console.error('导出失败:', err);
                    setError('导出失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // 导出通知数据
            const exportNotifications = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { start, end } = getMonthRange();
                    const { data, error: fetchError } = await supabase
                        .from('notifications')
                        .select('*')
                        .eq('sender_id', user.id)
                        .gte('created_at', start)
                        .lte('created_at', end)
                        .order('created_at', { ascending: false });

                    if (fetchError) throw fetchError;

                    const columns = [
                        { header: '标题', key: 'title' },
                        { header: '内容', key: 'content' },
                        { header: '类型', key: 'type' },
                        { header: '优先级', key: 'priority' },
                        { header: '状态', key: 'status' },
                        { header: '创建时间', key: 'created_at', format: v => v ? new Date(v).toLocaleString('zh-CN') : '' }
                    ];

                    if (format === 'excel') {
                        exportToExcel(data, '通知记录', columns);
                        setSuccess('通知数据导出成功！');
                    } else {
                        setError('仅支持Excel导出格式');
                    }
                } catch (err) {
                    console.error('导出失败:', err);
                    setError('导出失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // 导出学习计划
            const exportStudyPlans = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');

                    const { start, end } = getMonthRange();
                    const { data, error: fetchError } = await supabase
                        .from('study_plans')
                        .select('*')
                        .eq('user_id', user.id)
                        .gte('created_at', start)
                        .lte('created_at', end)
                        .order('created_at', { ascending: false });

                    if (fetchError) throw fetchError;

                    const columns = [
                        { header: '学生姓名', key: 'student_name' },
                        { header: '计划名称', key: 'plan_name' },
                        { header: '目标', key: 'goals' },
                        { header: '开始日期', key: 'start_date', format: v => v ? new Date(v).toLocaleDateString('zh-CN') : '' },
                        { header: '结束日期', key: 'end_date', format: v => v ? new Date(v).toLocaleDateString('zh-CN') : '' },
                        { header: '状态', key: 'status' },
                        { header: '进度', key: 'progress' }
                    ];

                    if (format === 'excel') {
                        exportToExcel(data, '学习计划', columns);
                        setSuccess('学习计划导出成功！');
                    } else {
                        setError('仅支持Excel导出格式');
                    }
                } catch (err) {
                    console.error('导出失败:', err);
                    setError('导出失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleExport = () => {
                setSuccess(null);
                setError(null);

                const exportFunctions = {
                    students: exportStudents,
                    grades: exportGrades,
                    attendance: exportAttendance,
                    finance: exportFinance,
                    homework: exportHomework,
                    notifications: exportNotifications,
                    studyPlans: exportStudyPlans
                };

                const exportFn = exportFunctions[exportType];
                if (exportFn) {
                    exportFn();
                } else {
                    setError('无效的导出类型');
                }
            };

            const collectAllDataForBackup = async () => {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('用户未登录');
                const tables = [
                    ['students', supabase.from('students').select('*').eq('user_id', user.id)],
                    ['transactions', supabase.from('transactions').select('*').eq('user_id', user.id)],
                    ['attendance_records', supabase.from('attendance_records').select('*').eq('user_id', user.id)],
                    ['payment_records', supabase.from('payment_records').select('*').eq('user_id', user.id)],
                    ['notifications', supabase.from('notifications').select('*').eq('user_id', user.id)],
                    ['learning_plans', supabase.from('learning_plans').select('*').eq('user_id', user.id)],
                    ['exam_scores', supabase.from('exam_scores').select('*').eq('user_id', user.id)],
                    ['homeworks', supabase.from('homeworks').select('*').eq('user_id', user.id)],
                    ['study_plans', supabase.from('study_plans').select('*').eq('user_id', user.id)]
                ];
                const results = await Promise.all(tables.map(([name, q]) => q.then(({ data, error }) => {
                    if (error) throw error;
                    return [name, data || []];
                })));
                const settingsStr = localStorage.getItem('systemSettings') || '{}';
                const settingsObj = JSON.parse(settingsStr);
                return {
                    meta: {
                        exportedAt: new Date().toISOString(),
                        appVersion: 'v3.5.0'
                    },
                    settings: settingsObj,
                    data: Object.fromEntries(results)
                };
            };

            const handleBackupToNAS = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    setSuccess(null);
                    setNasStatus('');
                    const settingsStr = localStorage.getItem('systemSettings') || '{}';
                    const cfg = JSON.parse(settingsStr);
                    if (!cfg.nasEnabled) throw new Error('NAS 备份未启用');
                    if (!cfg.nasWebDavUrl || !cfg.nasUsername || !cfg.nasPassword) {
                        throw new Error('NAS 配置不完整');
                    }
                    const backup = await collectAllDataForBackup();
                    const payload = JSON.stringify(backup);
                    const base = cfg.nasWebDavUrl.replace(/\/$/, '');
                    const path = (cfg.nasBackupPath || '/tgnew_backup.json');
                    const url = base + (path.startsWith('/') ? path : '/' + path);
                    const auth = btoa(`${cfg.nasUsername}:${cfg.nasPassword}`);
                    setNasStatus('正在上传到 NAS...');
                    const resp = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Basic ${auth}`
                        },
                        body: payload
                    });
                    if (!resp.ok) throw new Error(`上传失败：${resp.status}`);
                    setSuccess('备份到 NAS 成功');
                    setNasStatus('');
                } catch (err) {
                    setNasStatus('');
                    console.error(err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleRestoreFromNAS = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    setSuccess(null);
                    setNasStatus('');
                    const settingsStr = localStorage.getItem('systemSettings') || '{}';
                    const cfg = JSON.parse(settingsStr);
                    if (!cfg.nasEnabled) throw new Error('NAS 备份未启用');
                    if (!cfg.nasWebDavUrl || !cfg.nasUsername || !cfg.nasPassword) {
                        throw new Error('NAS 配置不完整');
                    }
                    const base = cfg.nasWebDavUrl.replace(/\/$/, '');
                    const path = (cfg.nasBackupPath || '/tgnew_backup.json');
                    const url = base + (path.startsWith('/') ? path : '/' + path);
                    const auth = btoa(`${cfg.nasUsername}:${cfg.nasPassword}`);
                    setNasStatus('正在从 NAS 恢复...');
                    const resp = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Basic ${auth}`
                        }
                    });
                    if (!resp.ok) throw new Error(`下载失败：${resp.status}`);
                    const json = await resp.json();
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) throw new Error('用户未登录');
                    const upsert = async (name, rows) => {
                        if (!rows || rows.length === 0) return;
                        const normalized = rows.map(r => ({ ...r, user_id: user.id }));
                        const { error } = await supabase.from(name).upsert(normalized, { onConflict: 'id' });
                        if (error) throw error;
                    };
                    const d = json && json.data ? json.data : {};
                    await upsert('students', d.students);
                    await upsert('transactions', d.transactions);
                    await upsert('attendance_records', d.attendance_records);
                    await upsert('payment_records', d.payment_records);
                    await upsert('notifications', d.notifications);
                    await upsert('learning_plans', d.learning_plans);
                    await upsert('exam_scores', d.exam_scores);
                    await upsert('homeworks', d.homeworks);
                    await upsert('study_plans', d.study_plans);
                    if (json && json.settings) {
                        localStorage.setItem('systemSettings', JSON.stringify(json.settings));
                    }
                    setSuccess('已从 NAS 恢复');
                    setNasStatus('');
                } catch (err) {
                    setNasStatus('');
                    console.error(err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="space-y-6">
                    <div>
                        <h2 className="text-2xl font-bold text-neutral-900">数据导出</h2>
                        <p className="text-neutral-600">导出系统中的各类数据报表</p>
                    </div>

                    {error && (
                        <div className="p-4 bg-red-50 border border-red-200 text-red-600 rounded-lg">
                            {error}
                        </div>
                    )}

                    {success && (
                        <div className="p-4 bg-green-50 border border-green-200 text-green-600 rounded-lg">
                            {success}
                        </div>
                    )}

                    <div className="glass-morphism rounded-xl p-6 space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-neutral-700 mb-2">
                                导出类型
                            </label>
                            <select
                                value={exportType}
                                onChange={(e) => setExportType(e.target.value)}
                                className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                            >
                                <option value="students">学生信息</option>
                                <option value="grades">成绩报表</option>
                                <option value="attendance">考勤记录</option>
                                <option value="finance">财务报表</option>
                                <option value="homework">作业数据</option>
                                <option value="notifications">通知记录</option>
                                <option value="studyPlans">学习计划</option>
                            </select>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-neutral-700 mb-2">
                                导出格式
                            </label>
                            <div className="flex space-x-4">
                                <label className="flex items-center space-x-2">
                                    <input
                                        type="radio"
                                        value="excel"
                                        checked={format === 'excel'}
                                        onChange={(e) => setFormat(e.target.value)}
                                        className="text-primary-500"
                                    />
                                    <span>Excel (.xlsx)</span>
                                </label>
                            </div>
                        </div>

                        {exportType === 'students' && (
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-2">
                                    年级筛选（可选）
                                </label>
                                <select
                                    value={filter.grade}
                                    onChange={(e) => setFilter({...filter, grade: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value="">全部年级</option>
                                    <option value="三年级">三年级</option>
                                    <option value="四年级">四年级</option>
                                    <option value="五年级">五年级</option>
                                    <option value="六年级">六年级</option>
                                </select>
                            </div>
                        )}

                        {exportType === 'grades' && (
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-2">
                                    科目筛选（可选）
                                </label>
                                <select
                                    value={filter.subject}
                                    onChange={(e) => setFilter({...filter, subject: e.target.value})}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                >
                                    <option value="">全部科目</option>
                                    <option value="语文">语文</option>
                                    <option value="数学">数学</option>
                                    <option value="英语">英语</option>
                                </select>
                            </div>
                        )}

                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p className="text-sm text-blue-800">
                                数据将按照当前选择的月份（{globalSelectedMonth}）进行筛选导出
                            </p>
                        </div>

                        <div className="flex items-center gap-3">
                            <button
                                onClick={handleExport}
                                disabled={loading}
                                className="flex-1 bg-primary-500 text-white py-3 rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 font-medium"
                            >
                                {loading ? '导出中...' : '开始导出'}
                            </button>
                            <button
                                onClick={handleBackupToNAS}
                                disabled={loading}
                                className="flex-1 bg-neutral-900 text-white py-3 rounded-lg hover:bg-neutral-800 transition-colors disabled:opacity-50 font-medium"
                            >
                                {loading ? '备份中...' : '备份到 NAS'}
                            </button>
                            <button
                                onClick={handleRestoreFromNAS}
                                disabled={loading}
                                className="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 font-medium"
                            >
                                {loading ? '恢复中...' : '从 NAS 恢复'}
                            </button>
                        </div>
                        {nasStatus && (
                            <div className="text-sm text-neutral-600">{nasStatus}</div>
                        )}
                    </div>
                </div>
            );
        };

        // 工具箱管理组件
        const ToolboxManagement = () => {
            const [tools, setTools] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [showPreviewModal, setShowPreviewModal] = useState(false);
            const [previewFullscreen, setPreviewFullscreen] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [deletingToolId, setDeletingToolId] = useState(null);
            const [currentTool, setCurrentTool] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [categoryFilter, setCategoryFilter] = useState('all');
            const [editor, setEditor] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                category: 'general',
                html_code: '',
                is_enabled: true
            });
            const [importHTML, setImportHTML] = useState('');
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);

            // 加载工具列表
            const loadTools = async () => {
                try {
                    setLoading(true);
                    const { data, error } = await supabase
                        .from('toolbox_tools')
                        .select('*')
                        .order('sort_order', { ascending: true })
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    setTools(data || []);
                } catch (err) {
                    console.error('加载工具失败:', err);
                    setError('加载工具列表失败：' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadTools();
            }, []);

            // 初始化CodeMirror编辑器
            useEffect(() => {
                if ((showAddModal || showEditModal) && !editor) {
                    setTimeout(() => {
                        const textarea = document.getElementById('html-editor');
                        if (textarea && window.CodeMirror) {
                            const cm = window.CodeMirror.fromTextArea(textarea, {
                                mode: 'htmlmixed',
                                theme: 'monokai',
                                lineNumbers: true,
                                lineWrapping: true,
                                autofocus: true,
                                tabSize: 2,
                                indentUnit: 2
                            });
                            cm.setSize('100%', '400px');
                            cm.on('change', (instance) => {
                                setFormData(prev => ({ ...prev, html_code: instance.getValue() }));
                            });
                            setEditor(cm);
                        }
                    }, 100);
                }
            }, [showAddModal, showEditModal]);

            // 清理编辑器
            useEffect(() => {
                if (!showAddModal && !showEditModal && editor) {
                    editor.toTextArea();
                    setEditor(null);
                }
            }, [showAddModal, showEditModal]);

            // 添加工具
            const handleAddTool = async () => {
                try {
                    setError(null);
                    setSuccess(null);

                    if (!formData.name || !formData.html_code) {
                        setError('请填写工具名称和HTML代码');
                        return;
                    }

                    // 获取当前用户
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('未登录，请先登录');
                        return;
                    }

                    const { data, error } = await supabase
                        .from('toolbox_tools')
                        .insert({
                            user_id: user.id,
                            name: formData.name,
                            description: formData.description || '',
                            category: formData.category || 'general',
                            html_code: formData.html_code,
                            is_enabled: formData.is_enabled !== undefined ? formData.is_enabled : true,
                            sort_order: 0
                        })
                        .select()
                        .single();

                    if (error) throw error;
                    
                    setSuccess('工具创建成功');
                    setShowAddModal(false);
                    setFormData({
                        name: '',
                        description: '',
                        category: 'general',
                        html_code: '',
                        is_enabled: true
                    });
                    await loadTools();
                } catch (err) {
                    console.error('添加工具失败:', err);
                    setError('添加工具失败：' + err.message);
                }
            };

            // 编辑工具
            const handleEditTool = async () => {
                try {
                    setError(null);
                    setSuccess(null);

                    if (!formData.name || !formData.html_code) {
                        setError('请填写工具名称和HTML代码');
                        return;
                    }

                    const { data, error } = await supabase
                        .from('toolbox_tools')
                        .update({
                            name: formData.name,
                            description: formData.description || '',
                            category: formData.category,
                            html_code: formData.html_code,
                            is_enabled: formData.is_enabled,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentTool.id)
                        .select()
                        .single();

                    if (error) throw error;
                    
                    setSuccess('工具更新成功');
                    setShowEditModal(false);
                    setCurrentTool(null);
                    await loadTools();
                } catch (err) {
                    console.error('编辑工具失败:', err);
                    setError('编辑工具失败：' + err.message);
                }
            };

            // 删除工具 - 打开确认对话框
            const handleDeleteTool = (toolId) => {
                setDeletingToolId(toolId);
                setShowDeleteConfirm(true);
            };

            // 确认删除工具
            const confirmDeleteTool = async () => {
                try {
                    setError(null);
                    setSuccess(null);

                    const { error } = await supabase
                        .from('toolbox_tools')
                        .delete()
                        .eq('id', deletingToolId);

                    if (error) throw error;
                    
                    setSuccess('工具删除成功');
                    setShowDeleteConfirm(false);
                    setDeletingToolId(null);
                    await loadTools();
                } catch (err) {
                    console.error('删除工具失败:', err);
                    setError('删除工具失败：' + err.message);
                    setShowDeleteConfirm(false);
                    setDeletingToolId(null);
                }
            };

            // 取消删除
            const cancelDeleteTool = () => {
                setShowDeleteConfirm(false);
                setDeletingToolId(null);
            };

            // 切换启用状态
            const handleToggleEnabled = async (toolId) => {
                try {
                    setError(null);
                    
                    // 获取当前工具
                    const tool = tools.find(t => t.id === toolId);
                    if (!tool) return;

                    const { error } = await supabase
                        .from('toolbox_tools')
                        .update({ 
                            is_enabled: !tool.is_enabled,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', toolId);

                    if (error) throw error;
                    await loadTools();
                } catch (err) {
                    console.error('切换状态失败:', err);
                    setError('切换状态失败：' + err.message);
                }
            };

            // 打开添加模态框
            const openAddModal = () => {
                setFormData({
                    name: '',
                    description: '',
                    category: 'general',
                    html_code: '',
                    is_enabled: true
                });
                setShowAddModal(true);
            };

            // 打开编辑模态框
            const openEditModal = (tool) => {
                setCurrentTool(tool);
                setFormData({
                    name: tool.name,
                    description: tool.description || '',
                    category: tool.category,
                    html_code: tool.html_code,
                    is_enabled: tool.is_enabled
                });
                setShowEditModal(true);
                
                // 设置编辑器值
                setTimeout(() => {
                    if (editor) {
                        editor.setValue(tool.html_code);
                    }
                }, 200);
            };

            // 打开预览模态框
            const openPreviewModal = (tool) => {
                setCurrentTool(tool);
                setShowPreviewModal(true);
            };

            // 打开导入HTML模态框
            const openImportModal = () => {
                console.log('打开导入HTML模态框');
                setImportHTML('');
                setShowImportModal(true);
            };

            // 处理文件上传导入
            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const htmlCode = event.target.result;
                    setImportHTML(htmlCode);
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            // 确认导入HTML
            const confirmImportHTML = async () => {
                if (!importHTML.trim()) {
                    setError('请输入或上传HTML代码');
                    return;
                }

                try {
                    // 尝试从HTML中提取标题
                    const titleMatch = importHTML.match(/<title>(.*?)<\/title>/i);
                    const h1Match = importHTML.match(/<h1[^>]*>(.*?)<\/h1>/i);
                    const suggestedName = titleMatch ? titleMatch[1] : 
                                         h1Match ? h1Match[1].replace(/<[^>]+>/g, '') : 
                                         '导入的工具';

                    // 获取当前用户
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        setError('未登录，请先登录');
                        return;
                    }

                    // 直接保存到数据库
                    const { data, error: insertError } = await supabase
                        .from('toolbox_tools')
                        .insert({
                            name: suggestedName,
                            description: '通过HTML导入',
                            category: 'imported',
                            html_code: importHTML,
                            is_enabled: true,
                            user_id: user.id,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .select()
                        .single();

                    if (insertError) throw insertError;

                    setSuccess('HTML工具导入成功！');
                    setShowImportModal(false);
                    setImportHTML('');
                    await loadTools();
                } catch (err) {
                    console.error('导入HTML失败:', err);
                    setError('导入失败：' + err.message);
                }
            };

            // 筛选工具
            const filteredTools = tools.filter(tool => {
                const matchesSearch = tool.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                     (tool.description && tool.description.toLowerCase().includes(searchTerm.toLowerCase()));
                const matchesCategory = categoryFilter === 'all' || tool.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            // 获取所有分类
            const categories = ['all', ...new Set(tools.map(t => t.category))];

            return (
                <div className="p-6 h-full overflow-y-auto">
                    <div className="max-w-7xl mx-auto">
                        {/* 标题和操作栏 */}
                        <div className="mb-6 flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-neutral-900">工具箱管理</h2>
                                <p className="text-sm text-neutral-600 mt-1">添加和管理自定义HTML工具</p>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={openImportModal}
                                    className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2"
                                >
                                    <UploadIcon />
                                    <span>导入HTML</span>
                                </button>
                                <button
                                    onClick={openAddModal}
                                    className="bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors flex items-center space-x-2"
                                >
                                    <PlusIcon />
                                    <span>添加工具</span>
                                </button>
                            </div>
                        </div>

                        {/* 提示信息 */}
                        {error && (
                            <div className="mb-4 p-4 bg-red-100 border border-red-300 text-red-700 rounded-lg">
                                {error}
                            </div>
                        )}

                        {success && (
                            <div className="mb-4 p-4 bg-green-100 border border-green-300 text-green-700 rounded-lg">
                                {success}
                            </div>
                        )}

                        {/* 搜索和筛选 */}
                        <div className="mb-6 glass-morphism rounded-2xl p-4 flex flex-col md:flex-row gap-4">
                            <div className="flex-1">
                                <input
                                    type="text"
                                    placeholder="搜索工具名称或描述..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                />
                            </div>
                            <div>
                                <select
                                    value={categoryFilter}
                                    onChange={(e) => setCategoryFilter(e.target.value)}
                                    className="w-full md:w-48 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                >
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>
                                            {cat === 'all' ? '所有分类' : cat}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        {/* 工具列表 */}
                        {loading ? (
                            <div className="text-center py-12">
                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                                <p className="mt-4 text-neutral-600">加载中...</p>
                            </div>
                        ) : filteredTools.length === 0 ? (
                            <div className="text-center py-12 glass-morphism rounded-2xl">
                                <p className="text-neutral-600">暂无工具，点击上方按钮添加新工具</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filteredTools.map(tool => (
                                    <div key={tool.id} className="glass-morphism rounded-2xl p-4 card-hover">
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex-1">
                                                <h3 className="font-semibold text-neutral-900 mb-1">{tool.name}</h3>
                                                <p className="text-xs text-neutral-600 mb-2">{tool.description || '无描述'}</p>
                                                <span className="inline-block px-2 py-1 bg-primary-100 text-primary-700 text-xs rounded">
                                                    {tool.category}
                                                </span>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    onClick={() => handleToggleEnabled(tool.id)}
                                                    className={`w-10 h-6 rounded-full transition-colors ${
                                                        tool.is_enabled ? 'bg-green-500' : 'bg-gray-300'
                                                    }`}
                                                    title={tool.is_enabled ? '已启用' : '已禁用'}
                                                >
                                                    <div className={`w-4 h-4 bg-white rounded-full transition-transform ${
                                                        tool.is_enabled ? 'translate-x-5' : 'translate-x-1'
                                                    }`} />
                                                </button>
                                            </div>
                                        </div>

                                        <div className="flex space-x-2 mt-4">
                                            <button
                                                onClick={() => openPreviewModal(tool)}
                                                className="flex-1 bg-primary-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-primary-700 transition-colors"
                                            >
                                                预览
                                            </button>
                                            <button
                                                onClick={() => openEditModal(tool)}
                                                className="flex-1 bg-gray-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors"
                                            >
                                                编辑
                                            </button>
                                            <button
                                                onClick={() => handleDeleteTool(tool.id)}
                                                className="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-colors"
                                            >
                                                删除
                                            </button>
                                        </div>

                                        <div className="mt-3 text-xs text-neutral-500">
                                            创建时间: {new Date(tool.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 添加工具模态框 */}
                        {showAddModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                    <h3 className="text-xl font-bold mb-4">添加新工具</h3>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">工具名称</label>
                                            <input
                                                type="text"
                                                value={formData.name}
                                                onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                placeholder="输入工具名称"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">工具描述</label>
                                            <textarea
                                                value={formData.description}
                                                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                rows="2"
                                                placeholder="输入工具描述（可选）"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">分类</label>
                                            <select
                                                value={formData.category}
                                                onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                            >
                                                <option value="general">通用工具</option>
                                                <option value="calculator">计算器</option>
                                                <option value="chart">图表</option>
                                                <option value="converter">转换器</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">HTML代码</label>
                                            <textarea
                                                id="html-editor"
                                                value={formData.html_code}
                                                onChange={(e) => setFormData(prev => ({ ...prev, html_code: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                                                rows="15"
                                                placeholder="输入完整的HTML代码..."
                                            />
                                        </div>

                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                id="is_enabled"
                                                checked={formData.is_enabled}
                                                onChange={(e) => setFormData(prev => ({ ...prev, is_enabled: e.target.checked }))}
                                                className="mr-2"
                                            />
                                            <label htmlFor="is_enabled" className="text-sm">启用此工具</label>
                                        </div>
                                    </div>

                                    <div className="mt-6 flex space-x-3">
                                        <button
                                            onClick={handleAddTool}
                                            className="flex-1 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                                        >
                                            添加工具
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowAddModal(false);
                                                setFormData({
                                                    name: '',
                                                    description: '',
                                                    category: 'general',
                                                    html_code: '',
                                                    is_enabled: true
                                                });
                                            }}
                                            className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 编辑工具模态框 */}
                        {showEditModal && currentTool && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                    <h3 className="text-xl font-bold mb-4">编辑工具</h3>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">工具名称</label>
                                            <input
                                                type="text"
                                                value={formData.name}
                                                onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                placeholder="输入工具名称"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">工具描述</label>
                                            <textarea
                                                value={formData.description}
                                                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                rows="2"
                                                placeholder="输入工具描述（可选）"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">分类</label>
                                            <select
                                                value={formData.category}
                                                onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                            >
                                                <option value="general">通用工具</option>
                                                <option value="calculator">计算器</option>
                                                <option value="chart">图表</option>
                                                <option value="converter">转换器</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-1">HTML代码</label>
                                            <textarea
                                                id="html-editor"
                                                value={formData.html_code}
                                                onChange={(e) => setFormData(prev => ({ ...prev, html_code: e.target.value }))}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                                                rows="15"
                                                placeholder="输入完整的HTML代码..."
                                            />
                                        </div>

                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                id="is_enabled_edit"
                                                checked={formData.is_enabled}
                                                onChange={(e) => setFormData(prev => ({ ...prev, is_enabled: e.target.checked }))}
                                                className="mr-2"
                                            />
                                            <label htmlFor="is_enabled_edit" className="text-sm">启用此工具</label>
                                        </div>
                                    </div>

                                    <div className="mt-6 flex space-x-3">
                                        <button
                                            onClick={handleEditTool}
                                            className="flex-1 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors"
                                        >
                                            保存更改
                                        </button>
                                        <button
                                            onClick={() => {
                                                setShowEditModal(false);
                                                setCurrentTool(null);
                                            }}
                                            className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 预览模态框 */}
                        {showPreviewModal && currentTool && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-0">
                                <div className={`${previewFullscreen ? 'w-full h-full rounded-none p-0' : 'bg-white rounded-2xl p-6 max-w-6xl w-full max-h-[90vh] overflow-y-auto'} bg-white`}>
                                    <div className={`${previewFullscreen ? 'px-6 pt-6' : ''} flex justify-between items-center mb-4`}
                                    >
                                        <h3 className="text-xl font-bold">{currentTool.name} - 预览</h3>
                                        <button
                                            onClick={() => {
                                                setShowPreviewModal(false);
                                                setCurrentTool(null);
                                                setPreviewFullscreen(false);
                                            }}
                                            className="text-gray-500 hover:text-gray-700 text-2xl"
                                        >
                                            ×
                                        </button>
                                    </div>
                                    
                                    <div className={`${previewFullscreen ? 'p-0 h-full' : 'p-4'} border border-neutral-300 ${previewFullscreen ? '' : 'rounded-lg'} bg-white min-h-[400px]`}> 
                                        <div className={`${previewFullscreen ? 'px-4 py-2' : 'mb-2'} flex justify-end items-center`}>
                                            <button
                                                onClick={() => setPreviewFullscreen(!previewFullscreen)}
                                                className="text-sm px-3 py-1 rounded bg-neutral-100 hover:bg-neutral-200 border border-neutral-300"
                                            >
                                                {previewFullscreen ? '退出全屏' : '全屏预览'}
                                            </button>
                                        </div>
                                        <iframe
                                            srcDoc={currentTool.html_code}
                                            className={`${previewFullscreen ? 'w-full h-full' : 'w-full h-[500px]'} border-0`}
                                            sandbox="allow-scripts allow-same-origin"
                                            title="工具预览"
                                        />
                                    </div>

                                    {!previewFullscreen && (
                                        <div className="mt-4 text-sm text-neutral-600">
                                            <p>提示: 工具在iframe中运行，某些功能可能受到限制</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 删除确认对话框 */}
                        {showDeleteConfirm && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl p-6 max-w-md w-full">
                                    <h3 className="text-xl font-bold mb-4 text-neutral-900">确认删除</h3>
                                    <p className="text-neutral-700 mb-6">
                                        确定要删除这个工具吗？此操作无法撤销。
                                    </p>
                                    <div className="flex space-x-3">
                                        <button
                                            onClick={confirmDeleteTool}
                                            className="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-semibold"
                                        >
                                            确认删除
                                        </button>
                                        <button
                                            onClick={cancelDeleteTool}
                                            className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 导入HTML模态框 */}
                        {showImportModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold text-neutral-900">导入HTML工具</h3>
                                        <button
                                            onClick={() => setShowImportModal(false)}
                                            className="text-gray-500 hover:text-gray-700 text-2xl"
                                        >
                                            ×
                                        </button>
                                    </div>

                                    <div className="space-y-4">
                                        {/* 文件上传方式 */}
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-700 mb-2">
                                                方式一：上传HTML文件
                                            </label>
                                            <input
                                                type="file"
                                                accept=".html,.htm"
                                                onChange={handleFileImport}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                            />
                                        </div>

                                        <div className="text-center text-neutral-500 text-sm">或</div>

                                        {/* 粘贴代码方式 */}
                                        <div>
                                            <label className="block text-sm font-medium text-neutral-700 mb-2">
                                                方式二：粘贴HTML代码
                                            </label>
                                            <textarea
                                                value={importHTML}
                                                onChange={(e) => setImportHTML(e.target.value)}
                                                className="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 font-mono text-sm"
                                                rows="15"
                                                placeholder="在此粘贴完整的HTML代码..."
                                            />
                                        </div>

                                        {/* 提示信息 */}
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                            <p className="text-sm text-blue-800">
                                                提示：导入的HTML会自动提取标题（title或h1标签）作为工具名称
                                            </p>
                                        </div>

                                        {/* 按钮 */}
                                        <div className="flex space-x-3">
                                            <button
                                                onClick={confirmImportHTML}
                                                disabled={!importHTML.trim()}
                                                className="flex-1 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
                                            >
                                                确认导入
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setShowImportModal(false);
                                                    setImportHTML('');
                                                }}
                                                className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                                            >
                                                取消
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 全局月份上下文
        const GlobalMonthContext = React.createContext();

        // 全局月份Provider组件
        const GlobalMonthProvider = ({ children }) => {
            // 获取当前年月（格式：2025-11）
            const getCurrentMonth = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                return `${year}-${month}`;
            };

            // 直接初始化当前月份，无需localStorage逻辑
            const [selectedMonth, setSelectedMonth] = useState(getCurrentMonth());
            const [studentDataRefresh, setStudentDataRefresh] = useState(0);

            const value = {
                selectedMonth,
                setSelectedMonth,
                getCurrentMonth,
                studentDataRefresh,
                refreshStudentData: () => setStudentDataRefresh(prev => prev + 1),
                // 获取月份的开始和结束时间戳（用于数据筛选）
                getMonthRange: () => {
                    const [year, month] = selectedMonth.split('-').map(Number);
                    const startDate = new Date(year, month - 1, 1);
                    const endDate = new Date(year, month, 0, 23, 59, 59, 999);
                    return {
                        start: startDate.toISOString(),
                        end: endDate.toISOString(),
                        startDate,
                        endDate
                    };
                }
            };

            return (
                <GlobalMonthContext.Provider value={value}>
                    {children}
                </GlobalMonthContext.Provider>
            );
        };

        // 月份选择器组件
        const MonthSelector = () => {
            const { selectedMonth, setSelectedMonth, getCurrentMonth } = React.useContext(GlobalMonthContext);
            const [isOpen, setIsOpen] = useState(false);

            // 生成月份选项列表（2020年1月 ~ 当前月份+12个月）
            const generateMonthOptions = () => {
                const options = [];
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                // 结束年月（当前月份+12个月）
                const endYear = currentMonth === 12 ? currentYear + 1 : currentYear + 1;
                const endMonth = currentMonth === 12 ? 12 : currentMonth;

                for (let year = 2020; year <= endYear; year++) {
                    const startMonth = year === 2020 ? 1 : 1;
                    const lastMonth = year === endYear ? endMonth : 12;
                    
                    for (let month = startMonth; month <= lastMonth; month++) {
                        const value = `${year}-${String(month).padStart(2, '0')}`;
                        const label = `${year}年${month}月`;
                        options.push({ value, label });
                    }
                }
                
                return options.reverse(); // 最新的月份在前面
            };

            const monthOptions = generateMonthOptions();

            // 格式化显示的月份
            const formatMonthDisplay = (monthStr) => {
                const [year, month] = monthStr.split('-');
                return `${year}年${parseInt(month)}月`;
            };

            const isCurrentMonth = selectedMonth === getCurrentMonth();

            // 获取当前时间（精确到秒）
            const getCurrentTime = () => {
                return new Date().toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            };

            const [currentTime, setCurrentTime] = useState(getCurrentTime());

            // 每秒更新时间
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(getCurrentTime());
                }, 1000);

                return () => clearInterval(timer);
            }, []);

            return (
                <div className="glass-morphism rounded-xl p-4 mb-6 flex items-center justify-end flex-wrap gap-4">
                    {/* 精确到秒的当前时间 - 苹果风格 */}
                    <div className="text-2xl font-sans font-medium text-neutral-800 tracking-normal">
                        {currentTime}
                    </div>
                    <div className="flex-1"></div>
                    <div className="flex items-center space-x-3">
                        {/* 数据月份标签 */}
                        <div className="flex items-center space-x-3">
                            <svg className="w-6 h-6 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span className="text-sm font-medium text-neutral-600">数据月份</span>
                        </div>
                        
                        {/* 月份选择下拉框 */}
                        <div className="relative">
                            <button
                                onClick={() => setIsOpen(!isOpen)}
                                className="flex items-center space-x-2 px-4 py-2 bg-white rounded-lg border border-neutral-300 hover:border-primary-500 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500"
                            >
                                <span className="text-lg font-semibold text-neutral-900">
                                    {formatMonthDisplay(selectedMonth)}
                                </span>
                                <svg 
                                    className={`w-5 h-5 text-neutral-600 transition-transform ${isOpen ? 'rotate-180' : ''}`} 
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>

                            {/* 下拉选项 */}
                            {isOpen && (
                                <div className="absolute top-full mt-2 right-0 w-48 max-h-80 overflow-y-auto bg-white rounded-lg shadow-xl border border-neutral-200 z-50">
                                    {monthOptions.map(option => (
                                        <button
                                            key={option.value}
                                            onClick={() => {
                                                setSelectedMonth(option.value);
                                                setIsOpen(false);
                                            }}
                                            className={`w-full text-left px-4 py-2 hover:bg-primary-50 transition-colors ${
                                                selectedMonth === option.value ? 'bg-primary-100 text-primary-700 font-semibold' : 'text-neutral-700'
                                            }`}
                                        >
                                            {option.label}
                                            {option.value === getCurrentMonth() && (
                                                <span className="ml-2 text-xs text-primary-500">(当前)</span>
                                            )}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* 返回当前月按钮 */}
                        {!isCurrentMonth && (
                            <button
                                onClick={() => setSelectedMonth(getCurrentMonth())}
                                className="flex items-center space-x-2 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>返回当前月</span>
                            </button>
                        )}
                    </div>

                    {/* 点击外部关闭下拉框 */}
                    {isOpen && (
                        <div 
                            className="fixed inset-0 z-40" 
                            onClick={() => setIsOpen(false)}
                        ></div>
                    )}
                </div>
            );
        };

        // 主应用组件
        const App = () => {
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [userName, setUserName] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('homework');
            const [isMobileOpen, setIsMobileOpen] = useState(false);
            const [isInitialLoad, setIsInitialLoad] = useState(true); // 添加初次加载标志

            // 检查用户登录状态
            useEffect(() => {
                checkUser();

                // 设置认证状态监听器
                const { data: { subscription } } = supabase.auth.onAuthStateChange(
                    (_event, session) => {
                        if (session?.user) {
                            setUser(session.user);
                            loadUserRole(session.user.id, false); // 非初次加载，不重置页面
                        } else {
                            setUser(null);
                            setUserRole(null);
                            setUserName(null);
                        }
                    }
                );

                return () => subscription.unsubscribe();
            }, []);
            
            // 监听导航事件
            useEffect(() => {
                const handleNavigate = (event) => {
                    const { page } = event.detail;
                    setActiveTab(page);
                };
                
                window.addEventListener('app-navigate', handleNavigate);
                
                return () => {
                    window.removeEventListener('app-navigate', handleNavigate);
                };
            }, []);

            const checkUser = async () => {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user) {
                        setUser(user);
                        await loadUserRole(user.id, true); // 初次加载，设置默认页面
                    }
                } catch (error) {
                    console.error('检查用户登录状态失败:', error);
                } finally {
                    setLoading(false);
                }
            };

            const loadUserRole = async (userId, shouldSetDefaultTab = false) => {
                try {
                    try {
                        console.log('loadUserRole - 开始获取用户角色，用户ID:', userId);
                        
                        const { data: profile, error } = await supabase
                            .from('user_profiles')
                            .select('role, full_name')
                            .eq('id', userId)
                            .maybeSingle();

                        if (error) {
                            console.error('获取用户角色失败:', error);
                            console.error('错误详情:', {
                                message: error.message,
                                code: error.code,
                                details: error.details,
                                hint: error.hint
                            });
                            
                            // 降级处理：使用默认角色
                            console.log('使用默认角色: teacher');
                            setUserRole('teacher');
                            setUserName('用户');
                            
                            // 设置默认页面
                            if (shouldSetDefaultTab) {
                                setActiveTab('homework');
                                setIsInitialLoad(false);
                            }
                        } else if (profile) {
                            console.log('成功获取用户角色:', profile.role);
                            setUserRole(profile.role);
                            setUserName(profile.full_name);
                            
                            // 只在初次加载时根据角色设置默认页面
                            if (shouldSetDefaultTab) {
                                if (profile.role === 'admin') {
                                    setActiveTab('dashboard');
                                } else {
                                    setActiveTab('homework');
                                }
                                setIsInitialLoad(false);
                            }
                        } else {
                            console.log('用户配置文件不存在，使用默认角色');
                            setUserRole('teacher');
                            setUserName('用户');
                            
                            if (shouldSetDefaultTab) {
                                setActiveTab('homework');
                                setIsInitialLoad(false);
                            }
                        }
                    } catch (fetchError) {
                        console.error('loadUserRole - 网络错误:', fetchError);
                        console.error('错误类型:', fetchError.constructor.name);
                        console.error('错误消息:', fetchError.message);
                        
                        // 网络错误降级处理
                        if (fetchError.message.includes('Failed to fetch')) {
                            console.log('检测到网络连接问题，使用离线模式');
                            // 只在第一次显示警告
                            if (!window.hasShownOfflineWarning) {
                                alert('网络连接失败，系统将以离线模式运行。部分功能可能受限。');
                                window.hasShownOfflineWarning = true;
                            }
                        }
                        
                        // 使用默认角色继续
                        setUserRole('teacher');
                        setUserName('用户');
                        
                        if (shouldSetDefaultTab) {
                            setActiveTab('homework');
                            setIsInitialLoad(false);
                        }
                    }
                } catch (error) {
                    console.error('加载用户角色失败:', error);
                    setUserRole('teacher');
                } finally {
                    setLoading(false);
                }
            };

            const handleLoginSuccess = (loggedInUser, role, name) => {
                setUser(loggedInUser);
                setUserRole(role);
                setUserName(name);
                // 根据角色设置初始页面
                if (role === 'admin') {
                    setActiveTab('dashboard');
                } else {
                    setActiveTab('homework');
                }
            };

            const handleLogout = async () => {
                try {
                    await supabase.auth.signOut();
                    setUser(null);
                    setUserRole(null);
                    setUserName(null);
                } catch (error) {
                    console.error('登出失败:', error);
                }
            };

            const renderContent = () => {
                // 根据用户角色和当前标签渲染内容
                switch (activeTab) {
                    case 'dashboard':
                        return userRole === 'admin' || userRole === 'teacher' ? <Dashboard /> : <Homework />;
                    case 'students':
                        return userRole === 'admin' ? <Students /> : <Homework />;
                    case 'income-expense':
                        return userRole === 'admin' ? <IncomeExpenseManagement /> : <Homework />;
                    case 'finance':
                        return userRole === 'admin' ? <Finance /> : <Homework />;
                    case 'attendance':
                        return userRole === 'admin' || userRole === 'teacher' ? <Attendance /> : <Homework />;
                    case 'grades':
                        return <Grades />;
                    case 'homework':
                        return <Homework />;
                    case 'files':
                        return userRole === 'admin' || userRole === 'teacher' ? <FileManagement /> : <Homework />;
                    case 'study-plans':
                        return userRole === 'admin' || userRole === 'teacher' ? <StudyPlanManagement /> : <Homework />;
                    case 'notifications':
                        return userRole === 'admin' ? <NotificationCenter /> : <Homework />;
                    case 'export':
                        return userRole === 'admin' ? <DataExport /> : <Homework />;
                    case 'toolbox':
                        return userRole === 'admin' || userRole === 'teacher' ? <ToolboxManagement /> : <Homework />;
                    case 'users':
                        return userRole === 'admin' ? <UserManagement /> : <Homework />;
                    case 'database':
                        return userRole === 'admin' ? <DatabaseManagement /> : <Homework />;
                    case 'settings':
                        return userRole === 'admin' ? <Settings /> : <Homework />;
                    default:
                        return userRole === 'admin' || userRole === 'teacher' ? <Dashboard /> : <Homework />;
                }
            };

            // 加载中状态
            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen bg-neutral-0">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                            <p className="mt-4 text-neutral-600">加载中...</p>
                        </div>
                    </div>
                );
            }

            // 未登录，显示登录页面
            if (!user || !userRole) {
                return <LoginPage onLoginSuccess={handleLoginSuccess} />;
            }

            // 已登录，显示主应用
            return (
                <div className="flex h-screen bg-neutral-0">
                    <Sidebar 
                        activeTab={activeTab}
                        setActiveTab={setActiveTab}
                        isMobileOpen={isMobileOpen}
                        setIsMobileOpen={setIsMobileOpen}
                        userRole={userRole}
                        userName={userName}
                        onLogout={handleLogout}
                    />
                    
                    <div className="flex-1 flex flex-col overflow-hidden">
                        {/* 移动端顶部导航 */}
                        <div className="md:hidden bg-neutral-100 p-4 flex items-center justify-between">
                            <button 
                                onClick={() => setIsMobileOpen(true)}
                                className="p-2 hover:bg-neutral-200 rounded-lg transition-colors"
                            >
                                <MenuIcon />
                            </button>
                            <h1 className="text-lg font-semibold text-neutral-900">托管班系统</h1>
                            <div></div>
                        </div>
                        
                        {/* 主内容区域 */}
                        <main className="flex-1 overflow-auto p-6">
                            <div className="max-w-7xl mx-auto">
                                {/* 全局月份选择器 */}
                                <MonthSelector />
                                
                                {/* 页面内容 */}
                                {renderContent()}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        // 渲染应用 - 使用 React 18 的 createRoot API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <GlobalMonthProvider>
                <App />
            </GlobalMonthProvider>
        );
    </script>

<script>
/**
 * Iframe 元素高亮注入脚本
 * 需要在目标网站中引入此脚本来支持跨域 iframe 高亮功能
 *
 * 使用方法：
 * 1. 将此脚本添加到目标网站的 HTML 中
 * 2. 或通过浏览器扩展、用户脚本等方式注入
 */

(function () {
  "use strict";

  // 检查是否在 iframe 中
  if (window.self === window.top) {
    return; // 不在 iframe 中，不执行
  }

  // 检查是否已经初始化过
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe 高亮脚本已加载");

  // 创建高亮覆盖层
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // 创建悬停高亮框（虚线边框）
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // 创建选中节点的常驻高亮框（实线边框）
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // 创建悬停标签显示
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // 创建选中节点标签
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // 存储当前选中的元素
  var selectedElement = null;
  var highlightEnabled = false;

  // 更新选中元素的高亮显示
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // 更新选中高亮框位置
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // 更新选中标签位置和内容
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    var labelWidth = selectedLabel.offsetWidth || 100; // 预估宽度
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // 优先检查唯一ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // ID唯一，无需继续向上
      }

      // 生成类名选择器（取第一个有效类名）
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // 生成位置索引（nth-child）
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // 处理根元素
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // 获取元素文本内容
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // 获取元素属性信息
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // 鼠标悬停事件处理
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免高亮 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 如果是已选中的元素，不显示悬停高亮
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // 更新悬停高亮框位置
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // 更新标签位置和内容
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // 计算标签位置，确保不超出视窗
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // 如果标签会超出顶部，显示在元素下方
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // 如果标签会超出右侧，向左调整
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // 发送消息到父窗口
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 鼠标离开事件处理
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // 如果鼠标移动到高亮相关元素上，不隐藏高亮
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 点击事件处理
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // 避免处理 html 和 body 元素
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // 检查是否是交互元素，这些元素需要保留默认行为
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // 如果高亮功能启用，对于非交互元素阻止默认行为和事件传播
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // 立即更新选中高亮
    updateSelectedHighlight(target);

    // 隐藏悬停高亮，因为现在是选中状态
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("无法发送消息到父窗口:", error);
    }
  }

  // 监听来自父窗口的消息
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // 启用高亮功能
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // 禁用高亮功能
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // 保持事件监听器，但通过 highlightEnabled 变量控制行为
    // 这样可以保留选中状态的显示
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // 不隐藏 selectedBox 和 selectedLabel，保留选中状态
  }

  // 完全禁用高亮功能（移除所有监听器）
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // 添加事件监听
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // 暴露全局函数供外部调用
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // 通过消息发送开关控制
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // 通知父窗口脚本已加载
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("无法发送就绪消息到父窗口:", error);
  }

  // 清理函数
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();
</script>
<style>

</style>


</body>
</html>